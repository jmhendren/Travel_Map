<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Map â€” Interactive Trip Planner</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    
    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
        }

        .container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        #map-container {
            flex: 1;
            position: relative;
            z-index: 1;
        }

        .leaflet-container {
            width: 100%;
            height: 100%;
            background: #f0f0f0;
        }

        /* Sidebar */
        .sidebar {
            width: 380px;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            z-index: 10;
            transition: transform 0.3s ease;
        }

        .sidebar.hidden {
            transform: translateX(100%);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 2px solid #e5e5e5;
            background: white;
            z-index: 11;
        }

        .sidebar-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Tabs for Itineraries */
        .itin-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .itin-tab {
            flex: 1 1 100%;
            padding: 10px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: #f9fafb;
            cursor: pointer;
            font-weight: 500;
            font-size: 12px;
            text-align: left;
            transition: all 0.2s;
            color: #6b7280;
        }

        .itin-tab:hover {
            border-color: #999;
            background: #f0f0f0;
        }

        .itin-tab.active {
            background: white;
            border-color: #333;
            color: #111827;
            font-weight: 600;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        /* Tab colors */
        .itin-tab-a.active { color: #2563EB; border-color: #2563EB; }
        .itin-tab-b.active { color: #059669; border-color: #059669; }
        .itin-tab-c.active { color: #D97706; border-color: #D97706; }
        .itin-tab-d.active { color: #DC2626; border-color: #DC2626; }
        .itin-tab-e.active { color: #7C3AED; border-color: #7C3AED; }

        /* Generated itinerary tabs */
        .itin-tab-generated { border-style: dashed !important; }
        .itin-tab-generated.active { border-style: solid !important; }
        .itin-tab-delete { cursor: pointer; margin-left: 6px; opacity: 0.5; font-size: 13px; font-weight: 700; }
        .itin-tab-delete:hover { opacity: 1; color: #DC2626; }

        /* Generator modal */
        .gen-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center; }
        .gen-overlay.active { display: flex; }
        .gen-modal { background: white; border-radius: 16px; padding: 24px; max-width: 480px; width: 92%; box-shadow: 0 10px 50px rgba(0,0,0,0.3); max-height: 85vh; overflow-y: auto; }
        .gen-modal-title { font-size: 16px; font-weight: 700; margin-bottom: 4px; color: #333; }
        .gen-modal-subtitle { font-size: 12px; color: #888; margin-bottom: 16px; }
        .gen-field { margin-bottom: 14px; }
        .gen-field label { display: block; font-size: 11px; font-weight: 600; color: #555; margin-bottom: 5px; }
        .gen-field input, .gen-field select, .gen-field textarea { width: 100%; padding: 9px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 12px; font-family: inherit; box-sizing: border-box; }
        .gen-field input:focus, .gen-field select:focus, .gen-field textarea:focus { outline: none; border-color: #7C3AED; }
        .gen-field textarea { resize: vertical; min-height: 56px; }
        .gen-interests { display: flex; flex-wrap: wrap; gap: 6px; }
        .gen-interest-chip { padding: 5px 12px; border: 1.5px solid #ddd; border-radius: 20px; font-size: 11px; font-weight: 500; cursor: pointer; background: white; color: #555; transition: all 0.15s; user-select: none; }
        .gen-interest-chip.selected { background: #7C3AED; color: white; border-color: #7C3AED; }
        .gen-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 18px; }
        .gen-btn { padding: 9px 22px; border: none; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.15s; }
        .gen-btn.primary { background: #7C3AED; color: white; }
        .gen-btn.primary:hover { background: #6D28D9; }
        .gen-btn.primary:disabled { background: #C4B5FD; cursor: not-allowed; }
        .gen-btn.secondary { background: #f0f0f0; color: #333; }
        .gen-btn.secondary:hover { background: #ddd; }
        .gen-spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: genSpin 0.6s linear infinite; margin-right: 6px; vertical-align: middle; }
        @keyframes genSpin { to { transform: rotate(360deg); } }
        .gen-generate-btn { width: 100%; padding: 12px; font-size: 13px; margin-top: 8px; }
        .gen-preview { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px; margin-top: 12px; max-height: 300px; overflow-y: auto; }
        .gen-preview-day { margin-bottom: 10px; }
        .gen-preview-day-title { font-size: 11px; font-weight: 700; color: #7C3AED; margin-bottom: 4px; }
        .gen-preview-item { font-size: 11px; color: #555; padding: 2px 0; }
        .gen-preview-item .type-badge { display: inline-block; font-size: 10px; font-weight: 600; color: #888; width: 70px; }
        .gen-profile-bar { display: flex; gap: 6px; margin-bottom: 14px; align-items: center; }
        .gen-profile-select { flex: 1; padding: 7px 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 11px; font-family: inherit; background: white; }
        .gen-profile-select:focus { outline: none; border-color: #7C3AED; }
        .gen-profile-btn { padding: 6px 10px; border: 1.5px solid #7C3AED; background: white; color: #7C3AED; border-radius: 8px; cursor: pointer; font-size: 10px; font-weight: 600; white-space: nowrap; transition: all 0.15s; }
        .gen-profile-btn:hover { background: #7C3AED; color: white; }
        .gen-profile-btn.danger { border-color: #DC2626; color: #DC2626; }
        .gen-profile-btn.danger:hover { background: #DC2626; color: white; }
        .gen-profile-save-row { display: none; gap: 6px; margin-bottom: 14px; align-items: center; }
        .gen-profile-save-row.active { display: flex; }
        .gen-profile-save-input { flex: 1; padding: 7px 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 11px; font-family: inherit; }
        .gen-profile-save-input:focus { outline: none; border-color: #7C3AED; }
        .gen-refine-bar { display: flex; gap: 6px; margin-top: 10px; align-items: center; }
        .gen-refine-input { flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 12px; font-family: inherit; }
        .gen-refine-input:focus { outline: none; border-color: #7C3AED; }
        .gen-refine-btn { padding: 8px 14px; border: none; background: #7C3AED; color: white; border-radius: 8px; cursor: pointer; font-size: 11px; font-weight: 600; transition: all 0.15s; white-space: nowrap; }
        .gen-refine-btn:hover { background: #6D28D9; }
        .gen-refine-btn:disabled { background: #C4B5FD; cursor: not-allowed; }
        .gen-refine-hint { font-size: 10px; color: #888; margin-top: 6px; }
        @media (max-width: 768px) {
            .gen-modal { max-width: 95%; padding: 16px; max-height: 80vh; }
        }

        /* View toggle */
        .view-toggle {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .toggle-btn {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            color: #666;
        }

        .toggle-btn:hover {
            border-color: #999;
        }

        .toggle-btn.active {
            background: #333;
            color: white;
            border-color: #333;
        }

        /* Sidebar content */
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            scroll-behavior: smooth;
        }

        /* Scrollbar styling */
        .sidebar-content::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-content::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .sidebar-content::-webkit-scrollbar-thumb {
            background: #bbb;
            border-radius: 3px;
        }

        .sidebar-content::-webkit-scrollbar-thumb:hover {
            background: #888;
        }

        /* Day Card */
        .day-card {
            margin-bottom: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            overflow: hidden;
            background: white;
            transition: box-shadow 0.2s;
        }

        .day-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .day-card-header {
            padding: 12px 15px;
            background: #f9f9f9;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .day-card-header:hover {
            background: #f0f0f0;
        }

        .day-card-header.active {
            background: #e8f4f8;
            border-bottom-color: #4ECDC4;
        }

        .day-card-toggle {
            color: #999;
            font-size: 12px;
            transition: transform 0.2s;
        }

        .day-card-toggle.open {
            transform: rotate(180deg);
        }

        .day-card-content {
            display: none;
            padding: 12px 15px;
            background: #fafafa;
            max-height: 500px;
            overflow-y: auto;
        }

        .day-card-content.open {
            display: block;
        }

        .day-item {
            padding: 8px 12px;
            margin-bottom: 6px;
            border-radius: 4px;
            font-size: 12px;
            border-left: 3px solid #ddd;
            background: #f0f0f0;
            word-break: break-word;
        }

        .day-item.has-coord {
            cursor: pointer;
            transition: all 0.2s;
        }

        .day-item.has-coord:hover {
            background-color: #e8e8e8;
            transform: translateX(2px);
        }

        /* Day item types */
        .day-item.hotel {
            border-left-color: #E63946;
            background-color: #ffe8eb;
        }

        .day-item.hotel.has-coord:hover {
            background-color: #ffd5df;
        }

        .day-item.breakfast,
        .day-item.lunch,
        .day-item.dinner {
            border-left-color: #F8A500;
            background-color: #fff4e6;
        }

        .day-item.breakfast.has-coord:hover,
        .day-item.lunch.has-coord:hover,
        .day-item.dinner.has-coord:hover {
            background-color: #ffebd2;
        }

        .day-item.nap {
            border-left-color: #999;
            background-color: #f0f0f0;
            font-style: italic;
            color: #666;
        }

        .day-item.sightseeing {
            border-left-color: #4ECDC4;
            background-color: #e8f9f7;
        }

        .day-item.sightseeing.has-coord:hover {
            background-color: #d1f3f0;
        }

        .day-item.optional {
            border-left-color: #9D4EDD;
            background-color: #f3e8ff;
        }

        .day-item.optional.has-coord:hover {
            background-color: #e8d5ff;
        }

        .day-item-type {
            display: inline-block;
            font-weight: 600;
            font-size: 10px;
            text-transform: uppercase;
            margin-right: 6px;
            opacity: 0.7;
        }

        .day-item-name {
            display: inline;
        }

        /* Show All Days button */
        .show-all-days-btn {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            background: #333;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.2s;
        }

        .show-all-days-btn:hover {
            background: #555;
        }

        .show-all-days-btn.active {
            background: #2563EB;
        }

        /* Categories View */
        .categories-content {
            padding: 20px;
        }

        .category-checkbox {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            cursor: pointer;
            background: #f9f9f9;
            border: 1px solid #eee;
            transition: all 0.2s;
        }

        .category-checkbox:hover {
            background: #f0f0f0;
        }

        .category-checkbox input[type="checkbox"] {
            margin-right: 10px;
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        .category-label {
            flex: 1;
            cursor: pointer;
            font-weight: 500;
            font-size: 13px;
            color: #333;
        }

        .category-color {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 6px;
            vertical-align: middle;
        }

        /* Legend */
        .legend {
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .legend-item:last-child {
            margin-bottom: 0;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            #map-container {
                flex: 1;
                z-index: 1;
            }

            .sidebar {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                max-height: 85vh;
                border-radius: 16px 16px 0 0;
                box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
                z-index: 100;
                transition: max-height 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                overflow: hidden;
            }

            .sidebar.mobile-collapsed {
                max-height: 145px;
            }

            .sidebar.mobile-half {
                max-height: 50vh;
            }

            .sidebar.mobile-expanded {
                max-height: 85vh;
            }

            .sidebar.hidden {
                transform: translateY(100%);
            }

            .sidebar.mobile-collapsed .sidebar-content,
            .sidebar.mobile-collapsed #categoriesCheckboxes,
            .sidebar.mobile-collapsed #itineraryTabs,
            .sidebar.mobile-collapsed #filterChipsRow,
            .sidebar.mobile-collapsed #regionFilterRow,
            .sidebar.mobile-collapsed #filterChipsCount,
            .sidebar.mobile-collapsed #destTitle,
            .sidebar.mobile-collapsed #destSubtitle {
                display: none !important;
            }

            .sidebar-drag-handle {
                width: 100%;
                padding: 12px 0 8px 0;
                text-align: center;
                cursor: grab;
                touch-action: none;
                flex-shrink: 0;
            }

            .sidebar-drag-handle::before {
                content: '';
                display: inline-block;
                width: 36px;
                height: 4px;
                background: #ccc;
                border-radius: 2px;
            }

            .sidebar-drag-handle:active {
                cursor: grabbing;
            }

            .sidebar-drag-handle:active::before {
                background: #999;
            }

            .sidebar-header {
                padding: 8px 15px 15px 15px;
            }

            .sidebar-title {
                font-size: 12px;
            }

            .itin-tabs {
                gap: 6px;
            }

            .itin-tab {
                flex: 1 1 100%;
                padding: 8px 12px;
                font-size: 10px;
            }

            .toggle-btn {
                font-size: 11px;
                padding: 6px 10px;
            }

            .sidebar-content {
                padding: 15px;
                overflow-y: auto;
            }

            .day-card-header {
                font-size: 12px;
                padding: 10px 12px;
            }

            .day-item {
                font-size: 11px;
                padding: 6px 10px;
            }

            .show-all-days-btn {
                padding: 8px;
                font-size: 11px;
                margin-bottom: 10px;
            }

            .categories-content {
                padding: 15px;
            }

            .category-checkbox {
                padding: 8px;
                margin-bottom: 6px;
            }

            .category-label {
                font-size: 12px;
            }

            /* Mobile expand hint chevron */
            .mobile-expand-hint {
                display: none;
                text-align: center;
                padding: 2px 0 6px 0;
                color: #aaa;
                font-size: 10px;
                letter-spacing: 0.5px;
            }
            .sidebar.mobile-collapsed .mobile-expand-hint {
                display: block;
            }
        }

        /* Leaflet popup styling */
        .leaflet-popup-content {
            font-size: 13px;
            padding: 8px;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .popup-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .popup-type {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            font-weight: 500;
        }
    
/* ============================================ */
/* SWAP PANEL & PERSISTENCE UI */
/* ============================================ */

.swap-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    display: none;
}
.swap-overlay.active { display: block; }

.swap-panel {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    width: 420px;
    max-width: 92vw;
    max-height: 80vh;
    display: none;
    flex-direction: column;
    z-index: 1001;
    overflow: hidden;
}
.swap-panel.active {
    display: flex;
}
.swap-panel-header {
    padding: 16px 20px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
}
.swap-panel-header h3 {
    margin: 0;
    font-size: 15px;
    font-weight: 700;
    color: #333;
}
.swap-panel-close {
    background: none;
    border: none;
    font-size: 22px;
    cursor: pointer;
    color: #999;
    padding: 0;
    width: 32px; height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    transition: all 0.15s;
}
.swap-panel-close:hover {
    background: #f0f0f0;
    color: #333;
}
.swap-panel-body {
    padding: 16px 20px;
    overflow-y: auto;
    flex: 1;
}
.swap-current {
    padding: 12px 14px;
    background: #e8f4f8;
    border: 1px solid #b2e0db;
    border-radius: 8px;
    margin-bottom: 16px;
}
.swap-current-label {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #0D9488;
    margin-bottom: 6px;
}
.swap-current-name {
    font-weight: 600;
    color: #333;
    font-size: 14px;
}
.swap-current-desc {
    font-size: 11px;
    color: #666;
    margin-top: 4px;
}
.swap-alts-label {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #999;
    margin-bottom: 10px;
}
.swap-alt-card {
    padding: 12px 14px;
    background: #f9f9f9;
    border: 1px solid #eee;
    border-radius: 8px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.15s;
}
.swap-alt-card:hover {
    background: #f0f0f0;
    border-color: #ccc;
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.06);
}
.swap-alt-name {
    font-weight: 600;
    color: #333;
    font-size: 13px;
}
.swap-alt-desc {
    font-size: 11px;
    color: #888;
    margin-top: 3px;
}
.swap-no-alts {
    padding: 24px;
    text-align: center;
    color: #999;
    font-size: 13px;
    background: #f9f9f9;
    border-radius: 8px;
}

/* Swap button in popups */
.popup-swap-btn {
    display: block;
    width: 100%;
    margin-top: 8px;
    padding: 6px 10px;
    background: #4ECDC4;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 11px;
    font-weight: 600;
    transition: background 0.15s;
}
.popup-swap-btn:hover {
    background: #3db8b0;
}

/* Swap icon in sidebar day items */
.day-item-swap {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 22px; height: 22px;
    background: none;
    border: 1px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
    color: #999;
    margin-left: 6px;
    flex-shrink: 0;
    transition: all 0.15s;
    padding: 0;
}
.day-item-swap:hover {
    background: #4ECDC4;
    color: white;
    border-color: #4ECDC4;
}

/* Day item layout adjustment for swap button */
.day-item {
    display: flex;
    align-items: center;
}
.day-item-name {
    flex: 1;
}

/* Reset button on day cards */
.day-reset-btn {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 8px;
    background: #fff3cd;
    border: 1px solid #F8A500;
    border-radius: 4px;
    cursor: pointer;
    font-size: 10px;
    font-weight: 600;
    color: #9a6700;
    transition: all 0.15s;
    white-space: nowrap;
}
.day-reset-btn:hover {
    background: #F8A500;
    color: white;
}

/* Modified indicator on day header */
.day-card-header.modified {
    border-left: 3px solid #F8A500;
}

@media (max-width: 768px) {
    .swap-panel {
        width: auto;
        max-width: 95vw;
        max-height: 70vh;
        top: auto;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
    }
}


/* ============================================ */
/* AI CHAT PANEL                                */
/* ============================================ */

.chat-fab {
    position: fixed;
    bottom: 24px;
    right: 24px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4ECDC4, #2563EB);
    color: white;
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 16px rgba(37, 99, 235, 0.4);
    z-index: 900;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    transition: all 0.2s;
}
.chat-fab:hover {
    transform: scale(1.08);
    box-shadow: 0 6px 24px rgba(37, 99, 235, 0.5);
}
.chat-fab.hidden { display: none; }

.chat-panel {
    position: fixed;
    bottom: 90px;
    right: 24px;
    width: 400px;
    max-width: calc(100vw - 48px);
    height: 520px;
    max-height: calc(100vh - 120px);
    background: white;
    border-radius: 16px;
    box-shadow: 0 10px 50px rgba(0,0,0,0.25);
    z-index: 901;
    display: none;
    flex-direction: column;
    overflow: hidden;
}
.chat-panel.active { display: flex; }

.chat-header {
    padding: 14px 16px;
    background: linear-gradient(135deg, #4ECDC4, #2563EB);
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
}
.chat-header-title {
    font-size: 14px;
    font-weight: 700;
}
.chat-header-context {
    font-size: 10px;
    opacity: 0.85;
    margin-top: 2px;
}
.chat-header-close {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.15s;
}
.chat-header-close:hover { background: rgba(255,255,255,0.35); }

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 12px 14px;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.chat-msg {
    max-width: 88%;
    padding: 10px 14px;
    border-radius: 12px;
    font-size: 13px;
    line-height: 1.5;
    word-wrap: break-word;
}
.chat-msg.assistant {
    align-self: flex-start;
    background: #f0f4f8;
    color: #333;
    border-bottom-left-radius: 4px;
}
.chat-msg.user {
    align-self: flex-end;
    background: #2563EB;
    color: white;
    border-bottom-right-radius: 4px;
}
.chat-msg.system {
    align-self: center;
    background: #fff3cd;
    color: #856404;
    font-size: 11px;
    padding: 6px 12px;
    border-radius: 8px;
    text-align: center;
    max-width: 95%;
}
.chat-msg.error {
    align-self: center;
    background: #f8d7da;
    color: #721c24;
    font-size: 11px;
    padding: 6px 12px;
    border-radius: 8px;
    text-align: center;
}

.chat-msg-day-preview {
    margin-top: 8px;
    padding: 8px 10px;
    background: rgba(0,0,0,0.04);
    border-radius: 8px;
    font-size: 11px;
}
.chat-msg-day-preview .preview-item {
    padding: 3px 0;
    display: flex;
    gap: 6px;
    align-items: center;
}
.chat-msg-day-preview .preview-type {
    font-weight: 600;
    font-size: 10px;
    text-transform: uppercase;
    min-width: 65px;
    color: #666;
}
.chat-msg-apply-btn {
    display: block;
    width: 100%;
    margin-top: 10px;
    padding: 8px;
    background: #4ECDC4;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 700;
    transition: background 0.15s;
}
.chat-msg-apply-btn:hover { background: #3db8b0; }
.chat-msg-apply-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
}

.chat-input-area {
    padding: 10px 14px;
    border-top: 1px solid #eee;
    display: flex;
    gap: 8px;
    flex-shrink: 0;
    align-items: flex-end;
}
.chat-input {
    flex: 1;
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 10px 14px;
    font-size: 13px;
    font-family: inherit;
    resize: none;
    max-height: 80px;
    min-height: 40px;
    line-height: 1.4;
    outline: none;
    transition: border-color 0.15s;
}
.chat-input:focus { border-color: #2563EB; }
.chat-send-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #2563EB;
    color: white;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
    transition: background 0.15s;
}
.chat-send-btn:hover { background: #1d4ed8; }
.chat-send-btn:disabled { background: #ccc; cursor: not-allowed; }

.chat-settings {
    padding: 10px 14px;
    border-top: 1px solid #eee;
    flex-shrink: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.chat-model-toggle {
    display: flex;
    gap: 4px;
}
.chat-model-btn {
    padding: 4px 10px;
    border: 1px solid #ddd;
    border-radius: 12px;
    background: white;
    cursor: pointer;
    font-size: 10px;
    font-weight: 600;
    color: #666;
    transition: all 0.15s;
}
.chat-model-btn.active {
    background: #333;
    color: white;
    border-color: #333;
}
.chat-settings-key {
    font-size: 10px;
    color: #999;
    cursor: pointer;
    text-decoration: underline;
}
.chat-settings-key:hover { color: #666; }

.chat-typing {
    display: flex;
    gap: 4px;
    padding: 8px 14px;
    align-self: flex-start;
}
.chat-typing span {
    width: 6px;
    height: 6px;
    background: #999;
    border-radius: 50%;
    animation: chatTyping 1.2s infinite;
}
.chat-typing span:nth-child(2) { animation-delay: 0.2s; }
.chat-typing span:nth-child(3) { animation-delay: 0.4s; }
@keyframes chatTyping {
    0%, 60%, 100% { opacity: 0.3; transform: translateY(0); }
    30% { opacity: 1; transform: translateY(-4px); }
}

/* API Key Setup Screen */
.chat-setup {
    flex: 1;
    padding: 24px 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
}
.chat-setup h3 {
    margin: 0 0 8px 0;
    font-size: 16px;
    color: #333;
}
.chat-setup p {
    margin: 0 0 16px 0;
    font-size: 12px;
    color: #666;
    line-height: 1.5;
}
.chat-setup input {
    width: 100%;
    padding: 10px 14px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 13px;
    font-family: monospace;
    margin-bottom: 12px;
}
.chat-setup button {
    padding: 10px 24px;
    background: #2563EB;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: background 0.15s;
}
.chat-setup button:hover { background: #1d4ed8; }
.chat-setup a {
    display: block;
    margin-top: 12px;
    font-size: 11px;
    color: #2563EB;
}

@media (max-width: 768px) {
    .chat-fab {
        bottom: 160px;
        right: 16px;
        width: 50px;
        height: 50px;
        font-size: 20px;
        z-index: 101;
    }
    .chat-panel {
        bottom: 0;
        right: 0;
        width: 100vw;
        max-width: 100vw;
        height: 85vh;
        max-height: 85vh;
        border-radius: 16px 16px 0 0;
    }
}

/* ============================================ */
/* CITY ACTIVITY BROWSER (Phase 1b)            */
/* ============================================ */

.browser-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.4);
    z-index: 900;
}
.browser-overlay.active { display: block; }

.city-browser {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 400px;
    height: 100vh;
    background: white;
    box-shadow: 2px 0 20px rgba(0,0,0,0.15);
    z-index: 901;
    flex-direction: column;
    transform: translateX(-100%);
    transition: transform 0.3s ease;
}
.city-browser.active {
    display: flex;
    transform: translateX(0);
}

.browser-header {
    padding: 16px;
    border-bottom: 1px solid #e5e5e5;
    background: linear-gradient(135deg, #4ECDC4, #2563EB);
    color: white;
}
.browser-header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}
.browser-header-title {
    font-size: 16px;
    font-weight: 700;
}
.browser-header-subtitle {
    font-size: 11px;
    opacity: 0.85;
    margin-top: 2px;
}
.browser-close {
    width: 32px; height: 32px;
    background: rgba(255,255,255,0.2);
    border: none;
    border-radius: 50%;
    color: white;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.15s;
}
.browser-close:hover { background: rgba(255,255,255,0.35); }

.browser-search {
    width: 100%;
    padding: 8px 12px;
    border: none;
    border-radius: 8px;
    font-size: 13px;
    background: rgba(255,255,255,0.9);
    outline: none;
    transition: background 0.15s;
}
.browser-search::placeholder { color: #999; }
.browser-search:focus { background: white; }

.browser-chips {
    display: flex;
    gap: 6px;
    padding: 10px 16px;
    overflow-x: auto;
    border-bottom: 1px solid #eee;
    background: #fafafa;
}
.browser-chips::-webkit-scrollbar { height: 0; }
.browser-chip {
    padding: 5px 12px;
    border: 1px solid #ddd;
    border-radius: 20px;
    font-size: 11px;
    cursor: pointer;
    white-space: nowrap;
    background: white;
    transition: all 0.2s;
}
.browser-chip:hover { border-color: #999; background: #f0f0f0; }
.browser-chip.active {
    background: #333;
    color: white;
    border-color: #333;
}

.browser-body {
    flex: 1;
    overflow-y: auto;
    padding: 12px 16px;
}
.browser-body::-webkit-scrollbar { width: 6px; }
.browser-body::-webkit-scrollbar-track { background: #f1f1f1; }
.browser-body::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
.browser-body::-webkit-scrollbar-thumb:hover { background: #999; }

.browser-group {
    margin-bottom: 20px;
}
.browser-group-title {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #666;
    margin-bottom: 8px;
    padding-bottom: 6px;
    border-bottom: 1px solid #eee;
}
.browser-activity {
    padding: 10px 12px;
    margin-bottom: 6px;
    border-radius: 8px;
    background: #f9f9f9;
    border: 1px solid #eee;
    cursor: pointer;
    transition: all 0.2s;
}
.browser-activity:hover {
    background: #e8f4f8;
    border-color: #4ECDC4;
    transform: translateX(2px);
}
.browser-activity.selected {
    background: #e8f4f8;
    border-color: #4ECDC4;
    box-shadow: 0 2px 8px rgba(78, 205, 196, 0.2);
}
.browser-activity-name {
    font-size: 13px;
    font-weight: 600;
    color: #333;
}
.browser-activity-desc {
    font-size: 11px;
    color: #666;
    margin-top: 2px;
}
.browser-activity-type {
    display: inline-block;
    font-size: 9px;
    font-weight: 600;
    text-transform: uppercase;
    padding: 2px 6px;
    border-radius: 3px;
    margin-top: 4px;
}
.browser-activity-type.hotel { background: #ffe8eb; color: #E63946; }
.browser-activity-type.restaurant { background: #fff4e6; color: #F8A500; }
.browser-activity-type.experience { background: #e8f9f7; color: #0D9488; }
.browser-activity-type.kid { background: #e8faf5; color: #059669; }
.browser-activity-type.market { background: #f3e8ff; color: #9D4EDD; }

.browser-slot-picker {
    display: none;
    margin-top: 8px;
    padding: 8px;
    background: white;
    border: 1px solid #4ECDC4;
    border-radius: 6px;
    animation: slotPickerFadeIn 0.2s ease;
}
@keyframes slotPickerFadeIn {
    from { opacity: 0; transform: translateY(-4px); }
    to { opacity: 1; transform: translateY(0); }
}
.browser-slot-picker.active { display: block; }
.browser-slot-title {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    color: #0D9488;
    margin-bottom: 6px;
}
.browser-slot-item {
    padding: 6px 10px;
    margin-bottom: 4px;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    background: #f0f0f0;
    border: 1px solid transparent;
    transition: all 0.15s;
}
.browser-slot-item:hover {
    background: #4ECDC4;
    color: white;
}
.browser-no-results {
    padding: 32px 16px;
    text-align: center;
    color: #999;
    font-size: 13px;
}

.day-browse-btn {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    padding: 3px 8px;
    background: #e8f4f8;
    border: 1px solid #4ECDC4;
    border-radius: 4px;
    cursor: pointer;
    font-size: 10px;
    font-weight: 600;
    color: #0D9488;
    transition: all 0.2s;
}
.day-browse-btn:hover {
    background: #4ECDC4;
    color: white;
}

@media (max-width: 768px) {
    .city-browser {
        top: auto;
        bottom: 0;
        left: 0;
        width: 100vw;
        height: 75vh;
        max-height: 75vh;
        border-radius: 16px 16px 0 0;
        transform: translateY(100%);
    }
    .city-browser.active {
        transform: translateY(0);
    }
    .browser-chips {
        padding: 8px 12px;
    }
    .browser-header {
        padding: 12px;
    }
    .day-browse-btn {
        font-size: 9px;
        padding: 2px 6px;
    }
}

/* ============================================ */
/* QUICK FILTER CHIPS (Phase 1c)               */
/* ============================================ */

.filter-chips-row {
    display: flex;
    gap: 5px;
    margin-top: 12px;
    flex-wrap: wrap;
}
.filter-chip {
    padding: 4px 10px;
    border: 1.5px solid #ddd;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 500;
    cursor: pointer;
    background: white;
    color: #555;
    transition: all 0.2s;
    white-space: nowrap;
    user-select: none;
}
.filter-chip:hover {
    border-color: #999;
    background: #f5f5f5;
}
.filter-chip.active {
    color: white;
    border-color: transparent;
}
.filter-chip[data-filter="hotels"].active {
    background: #E63946;
}
.filter-chip[data-filter="dining"].active {
    background: #F8A500;
}
.filter-chip[data-filter="sightseeing"].active {
    background: #2563EB;
}
.filter-chip[data-filter="cameras"].active {
    background: #6B7280;
}
.filter-chip[data-filter="skincare"].active {
    background: #EC4899;
}
.filter-chip[data-filter="kids"].active {
    background: #059669;
}
.filter-chip[data-filter="markets"].active {
    background: #9D4EDD;
}
.filter-chips-clear {
    padding: 4px 8px;
    border: none;
    border-radius: 20px;
    font-size: 10px;
    font-weight: 600;
    cursor: pointer;
    background: #f0f0f0;
    color: #999;
    transition: all 0.2s;
    white-space: nowrap;
}
.filter-chips-clear:hover {
    background: #ddd;
    color: #666;
}
.filter-chips-count {
    font-size: 10px;
    color: #999;
    margin-top: 4px;
    display: none;
}
.filter-chips-count.active {
    display: block;
}

@media (max-width: 768px) {
    .filter-chips-row {
        gap: 4px;
        margin-top: 8px;
    }
    .filter-chip {
        font-size: 10px;
        padding: 3px 8px;
    }
}

/* ============================================ */
/* GEOLOCATION - WHERE AM I? (Phase 1d)        */
/* ============================================ */

.geo-fab {
    position: fixed;
    bottom: 90px;
    right: 24px;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: none;
    background: white;
    color: #2563EB;
    font-size: 20px;
    cursor: pointer;
    box-shadow: 0 2px 12px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 899;
    transition: all 0.2s;
}
.geo-fab:hover {
    background: #2563EB;
    color: white;
    transform: scale(1.08);
    box-shadow: 0 4px 16px rgba(37,99,235,0.4);
}
.geo-fab.active {
    background: #2563EB;
    color: white;
}
.geo-fab.loading {
    animation: geoFabPulse 1.2s infinite;
}
@keyframes geoFabPulse {
    0%, 100% { box-shadow: 0 2px 12px rgba(37,99,235,0.3); }
    50% { box-shadow: 0 2px 20px rgba(37,99,235,0.6); }
}

/* Pulsing blue dot on map */
.geo-dot {
    width: 16px;
    height: 16px;
    background: #2563EB;
    border: 3px solid white;
    border-radius: 50%;
    box-shadow: 0 0 0 rgba(37,99,235,0.4);
    animation: geoDotPulse 2s infinite;
}
@keyframes geoDotPulse {
    0% { box-shadow: 0 0 0 0 rgba(37,99,235,0.5); }
    70% { box-shadow: 0 0 0 20px rgba(37,99,235,0); }
    100% { box-shadow: 0 0 0 0 rgba(37,99,235,0); }
}

/* Accuracy circle */
.geo-accuracy {
    background: rgba(37,99,235,0.08);
    border: 1px solid rgba(37,99,235,0.2);
    border-radius: 50%;
}

/* Nearby activities panel */
.nearby-panel {
    display: none;
    position: fixed;
    bottom: 148px;
    right: 24px;
    width: 340px;
    max-width: calc(100vw - 48px);
    max-height: 400px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.15);
    z-index: 899;
    flex-direction: column;
    overflow: hidden;
}
.nearby-panel.active {
    display: flex;
}
.nearby-header {
    padding: 12px 16px;
    background: #2563EB;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.nearby-header-left {
    display: flex;
    flex-direction: column;
}
.nearby-title {
    font-size: 14px;
    font-weight: 700;
}
.nearby-subtitle {
    font-size: 10px;
    opacity: 0.85;
    margin-top: 2px;
}
.nearby-close {
    width: 28px;
    height: 28px;
    background: rgba(255,255,255,0.2);
    border: none;
    border-radius: 50%;
    color: white;
    font-size: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}
.nearby-close:hover {
    background: rgba(255,255,255,0.35);
}
.nearby-body {
    flex: 1;
    overflow-y: auto;
    padding: 8px 0;
}
.nearby-body::-webkit-scrollbar { width: 5px; }
.nearby-body::-webkit-scrollbar-thumb { background: #ddd; border-radius: 3px; }
.nearby-item {
    padding: 8px 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: background 0.15s;
    border-bottom: 1px solid #f5f5f5;
}
.nearby-item:hover {
    background: #f0f7ff;
}
.nearby-item:last-child {
    border-bottom: none;
}
.nearby-item-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
}
.nearby-item-info {
    flex: 1;
    min-width: 0;
}
.nearby-item-name {
    font-size: 13px;
    font-weight: 600;
    color: #333;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.nearby-item-desc {
    font-size: 11px;
    color: #888;
    margin-top: 1px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.nearby-item-dist {
    font-size: 11px;
    font-weight: 600;
    color: #2563EB;
    white-space: nowrap;
    flex-shrink: 0;
}
.nearby-empty {
    padding: 24px 16px;
    text-align: center;
    color: #999;
    font-size: 13px;
}
.nearby-error {
    padding: 16px;
    text-align: center;
    color: #DC2626;
    font-size: 12px;
}

@media (max-width: 768px) {
    .geo-fab {
        bottom: 220px;
        right: 16px;
        width: 44px;
        height: 44px;
        font-size: 18px;
        z-index: 101;
    }
    .nearby-panel {
        bottom: 0;
        right: 0;
        left: 0;
        width: 100vw;
        max-width: 100vw;
        max-height: 60vh;
        border-radius: 16px 16px 0 0;
    }
}

/* ============================================ */
/* Phase 1e: Web Search Toggle + Citations      */
/* ============================================ */
.web-search-toggle {
    display: flex;
    align-items: center;
    gap: 6px;
}
.web-search-label {
    font-size: 10px;
    color: #666;
    font-weight: 600;
}
.web-search-switch {
    position: relative;
    width: 32px;
    height: 18px;
    background: #ccc;
    border-radius: 9px;
    cursor: pointer;
    transition: background 0.2s;
    border: none;
    padding: 0;
}
.web-search-switch.active {
    background: #4ECDC4;
}
.web-search-switch::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 14px;
    height: 14px;
    background: white;
    border-radius: 50%;
    transition: transform 0.2s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
.web-search-switch.active::after {
    transform: translateX(14px);
}
.search-citations {
    margin-top: 10px;
    padding-top: 8px;
    border-top: 1px solid rgba(0,0,0,0.08);
    font-size: 10px;
}
.search-citations-title {
    font-weight: 700;
    color: #888;
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.search-citation-item {
    padding: 3px 0;
    display: flex;
    gap: 4px;
    align-items: flex-start;
}
.search-citation-item a {
    color: #2563EB;
    text-decoration: none;
    word-break: break-all;
}
.search-citation-item a:hover {
    text-decoration: underline;
}
.search-indicator {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    color: #666;
    font-size: 11px;
    font-style: italic;
}

/* ============================================ */
/* Phase 3: Export & Sharing                     */
/* ============================================ */
.day-export-bar {
    display: flex;
    gap: 6px;
    padding: 10px 0 2px 0;
    margin-top: 8px;
    border-top: 1px dashed #ddd;
}
.day-export-btn {
    flex: 1;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    padding: 6px 8px;
    background: #f5f5f5;
    border: 1px solid #ddd;
    border-radius: 6px;
    cursor: pointer;
    font-size: 11px;
    font-weight: 600;
    color: #555;
    transition: all 0.15s;
}
.day-export-btn:hover {
    background: #e8f4f8;
    border-color: #4ECDC4;
    color: #0D9488;
}
.day-export-btn.export-text:hover {
    background: #e8f0ff;
    border-color: #2563EB;
    color: #2563EB;
}
.day-export-btn.export-gmaps:hover {
    background: #e8ffe8;
    border-color: #34A853;
    color: #34A853;
}
.day-export-btn.export-qr:hover {
    background: #f3e8ff;
    border-color: #7C3AED;
    color: #7C3AED;
}
.qr-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1100;
    align-items: center;
    justify-content: center;
}
.qr-overlay.active {
    display: flex;
}
.qr-modal {
    background: white;
    border-radius: 16px;
    padding: 24px;
    max-width: 320px;
    width: 90%;
    text-align: center;
    box-shadow: 0 10px 50px rgba(0,0,0,0.3);
}
.qr-modal-title {
    font-size: 14px;
    font-weight: 700;
    margin-bottom: 4px;
    color: #333;
}
.qr-modal-subtitle {
    font-size: 11px;
    color: #666;
    margin-bottom: 16px;
}
.qr-modal img {
    width: 200px;
    height: 200px;
    border-radius: 8px;
    border: 1px solid #eee;
}
.qr-modal-actions {
    display: flex;
    gap: 8px;
    justify-content: center;
    margin-top: 16px;
}
.qr-modal-close {
    padding: 8px 24px;
    background: #333;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    transition: background 0.15s;
}
.qr-modal-close:hover {
    background: #555;
}
.qr-modal-link {
    display: block;
    margin-top: 10px;
    font-size: 10px;
    color: #2563EB;
    word-break: break-all;
    text-decoration: none;
}
.qr-modal-link:hover {
    text-decoration: underline;
}
.copy-toast {
    position: fixed;
    bottom: 40px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: #333;
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    opacity: 0;
    transition: all 0.3s;
    z-index: 1200;
    pointer-events: none;
}
.copy-toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
}
@media (max-width: 768px) {
    .day-export-btn {
        font-size: 10px;
        padding: 5px 4px;
        gap: 2px;
    }
    .qr-modal {
        max-width: 280px;
    }
}

/* ============================================ */
/* Phase 4: Multi-Destination Framework          */
/* ============================================ */
.dest-selector {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
    padding-bottom: 12px;
    border-bottom: 1px solid #eee;
}
.dest-select {
    flex: 1;
    padding: 7px 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    background: white;
    cursor: pointer;
    color: #333;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
    padding-right: 24px;
}
.dest-select:focus {
    outline: none;
    border-color: #4ECDC4;
}
.dest-add-btn {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: #f0f0f0;
    border: 1px solid #ddd;
    cursor: pointer;
    font-size: 16px;
    color: #666;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
    flex-shrink: 0;
}
.dest-add-btn:hover {
    background: #4ECDC4;
    color: white;
    border-color: #4ECDC4;
}
.dest-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1100;
    align-items: center;
    justify-content: center;
}
.dest-overlay.active {
    display: flex;
}
.dest-modal {
    background: white;
    border-radius: 16px;
    padding: 24px;
    max-width: 440px;
    width: 90%;
    box-shadow: 0 10px 50px rgba(0,0,0,0.3);
}
.dest-modal-title {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 6px;
    color: #333;
}
.dest-modal-desc {
    font-size: 12px;
    color: #666;
    line-height: 1.5;
    margin-bottom: 16px;
}
.dest-modal-input {
    width: 100%;
    padding: 10px 14px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 12px;
    font-family: monospace;
    margin-bottom: 8px;
    box-sizing: border-box;
}
.dest-modal-input:focus {
    outline: none;
    border-color: #4ECDC4;
}
.dest-modal-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    margin-top: 16px;
}
.dest-modal-btn {
    padding: 8px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    transition: all 0.15s;
}
.dest-modal-btn.primary {
    background: #4ECDC4;
    color: white;
}
.dest-modal-btn.primary:hover {
    background: #3db8b0;
}
.dest-modal-btn.secondary {
    background: #f0f0f0;
    color: #333;
}
.dest-modal-btn.secondary:hover {
    background: #ddd;
}
.dest-modal-schema {
    margin-top: 12px;
    padding: 10px;
    background: #f8f8f8;
    border-radius: 8px;
    font-size: 10px;
    font-family: monospace;
    max-height: 150px;
    overflow-y: auto;
    white-space: pre-wrap;
    word-break: break-all;
    line-height: 1.4;
    color: #555;
    border: 1px solid #eee;
}
.dest-modal-or {
    text-align: center;
    font-size: 11px;
    color: #999;
    margin: 12px 0;
    font-weight: 600;
}
.dest-modal-file {
    display: flex;
    gap: 8px;
    align-items: center;
}
.dest-modal-file input[type="file"] {
    flex: 1;
    font-size: 11px;
}
@media (max-width: 768px) {
    .dest-selector {
        gap: 6px;
        margin-bottom: 10px;
        padding-bottom: 10px;
    }
    .dest-select {
        font-size: 11px;
    }
    .dest-modal {
        max-width: 95%;
        padding: 16px;
    }
}

/* Annotation badges on markers */
.annotation-badge {
    position: absolute;
    top: -4px;
    right: -4px;
    width: 14px;
    height: 14px;
    background: #f59e0b;
    border: 1.5px solid white;
    border-radius: 50%;
    font-size: 8px;
    line-height: 14px;
    text-align: center;
    z-index: 10;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

/* Annotation card in popups */
.annotation-card {
    background: #fffbeb;
    border: 1px solid #fde68a;
    border-radius: 6px;
    padding: 6px 8px;
    margin-top: 4px;
    font-size: 11px;
}
.annotation-card-header {
    display: flex;
    align-items: center;
    gap: 4px;
    font-weight: 600;
    color: #92400e;
    margin-bottom: 2px;
}
.annotation-card-details {
    color: #78350f;
    line-height: 1.3;
}
.annotation-status {
    display: inline-block;
    padding: 1px 5px;
    border-radius: 3px;
    font-size: 9px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}
.annotation-status.confirmed { background: #d1fae5; color: #065f46; }
.annotation-status.pending { background: #fef3c7; color: #92400e; }
.annotation-status.cancelled { background: #fee2e2; color: #991b1b; text-decoration: line-through; }

/* Annotation form in popups */
.annotation-form {
    margin-top: 6px;
    padding: 8px;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
}
.annotation-form select,
.annotation-form input {
    width: 100%;
    padding: 4px 6px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-size: 11px;
    margin-top: 4px;
    font-family: inherit;
    box-sizing: border-box;
}
.annotation-form label {
    font-size: 10px;
    font-weight: 600;
    color: #6b7280;
    display: block;
    margin-top: 6px;
}
.annotation-form label:first-child { margin-top: 0; }

/* Bookings panel */
.bookings-count-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 16px;
    height: 16px;
    background: #f59e0b;
    color: white;
    border-radius: 8px;
    font-size: 9px;
    font-weight: 700;
    padding: 0 4px;
    margin-left: 4px;
}
.booking-item {
    padding: 10px;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.15s;
}
.booking-item:hover {
    background: #f0f9ff;
    border-color: #93c5fd;
}
.booking-item-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 4px;
}
.booking-item-name {
    font-weight: 600;
    font-size: 13px;
    color: #333;
}
.booking-item-date {
    font-size: 11px;
    color: #6b7280;
}
.booking-item-details {
    font-size: 12px;
    color: #6b7280;
    line-height: 1.4;
}
.booking-filter-tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 12px;
}
.booking-filter-tab {
    padding: 4px 10px;
    font-size: 11px;
    font-weight: 500;
    border: 1px solid #d1d5db;
    border-radius: 12px;
    background: white;
    cursor: pointer;
    transition: all 0.15s;
    color: #6b7280;
}
.booking-filter-tab.active {
    background: #2563EB;
    color: white;
    border-color: #2563EB;
}

/* User indicator */
.user-indicator {
    font-size: 10px;
    color: #9ca3af;
    padding: 2px 8px;
    text-align: center;
}

    </style>
</head>
<body>
    <div class="container">
        <div id="map-container"></div>
        
        <div class="sidebar" id="sidebar">
            <div class="sidebar-drag-handle" id="dragHandle" style="display: none;"></div>
            <div class="mobile-expand-hint" id="mobileExpandHint">Swipe up for details</div>
            
            <div class="sidebar-header">
                <!-- Destination Selector (Phase 4) -->
                <div class="dest-selector" id="destSelector">
                    <select class="dest-select" id="destSelect" onchange="onDestSelectChange(this.value)"></select>
                    <button class="dest-add-btn" onclick="showAddDestModal()" title="Add a new destination">+</button>
                </div>
                <div id="destTitle" style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: #000;">
                    Travel Map
                </div>
                <div id="destSubtitle" style="font-size: 11px; color: #666; margin-bottom: 15px;">
                    Interactive Trip Map
                </div>
                
                <div class="view-toggle">
                    <button class="toggle-btn active" id="categoriesViewBtn" onclick="switchView('categories')">
                        <i class="fas fa-layer-group"></i> Categories
                    </button>
                    <button class="toggle-btn" id="itinerariesViewBtn" onclick="switchView('itineraries')">
                        <i class="fas fa-map-location-dot"></i> Itineraries
                    </button>
                    <button class="toggle-btn" onclick="showNotesPanel()" title="View all notes" style="flex: 0 0 auto; padding: 8px 12px;">
                        ðŸ“ Notes
                    </button>
                    <button class="toggle-btn" onclick="showBookingsPanel()" title="View bookings" style="flex: 0 0 auto; padding: 8px 12px;" id="bookingsBtn">
                        ðŸ”– Bookings
                    </button>
                </div>

                <!-- Quick Filter Chips (Phase 1c) -->
                <div class="filter-chips-row" id="filterChipsRow">
                    <!-- Filter chips built dynamically by buildFilterChips() -->
                </div>
                <div id="regionFilterRow" style="display:none; margin-top: 8px;">
                    <select id="regionSelect" onchange="filterByRegion(this.value)" style="width:100%; padding:7px 10px; border:1.5px solid #ddd; border-radius:8px; font-size:11px; font-weight:500; color:#555; background:white; cursor:pointer; appearance:auto;">
                        <option value="">All Regions</option>
                    </select>
                </div>
                <div class="filter-chips-count" id="filterChipsCount"></div>

                <!-- Itinerary Tabs (hidden in categories view) -->
                <div id="itineraryTabs" style="display: none; margin-top: 15px;">
                    <div style="display:flex; align-items:center; justify-content:space-between;">
                        <div class="sidebar-title" style="margin:0;">Select Itinerary</div>
                        <button onclick="openGeneratorModal()" style="padding:4px 10px; font-size:10px; font-weight:600; border:1.5px dashed #7C3AED; background:white; color:#7C3AED; border-radius:16px; cursor:pointer; white-space:nowrap; transition: all 0.15s;" onmouseover="this.style.background='#7C3AED';this.style.color='white'" onmouseout="this.style.background='white';this.style.color='#7C3AED'">+ Generate</button>
                    </div>
                    <div class="itin-tabs" id="tabsContainer"></div>
                </div>

                <!-- Categories Checkboxes (hidden in itineraries view) -->
                <div id="categoriesCheckboxes" style="margin-top: 15px;">
                    <div class="sidebar-title">Toggle Categories</div>
                    <div id="categoriesContainer"></div>
                </div>
            </div>
            
            <div class="sidebar-content" id="sidebarContent">
                <div id="categoriesView" style="display: block;">
                    <p style="color: #999; font-size: 12px; text-align: center; padding: 20px 0;">
                        Select a category above to explore
                    </p>
                </div>
                <div id="itinerariesView" style="display: none;">
                    <button class="show-all-days-btn active" id="showAllDaysBtn" onclick="showAllDays()">
                        Show All Days
                    </button>
                    <div id="daysContainer"></div>
                </div>
            </div>
        </div>
    </div>

        <!-- Swap Panel Overlay -->
    <div class="swap-overlay" id="swapOverlay" onclick="closeSwapPanel()"></div>
    <div class="swap-panel" id="swapPanel">
        <div class="swap-panel-header">
            <h3 id="swapPanelTitle">Swap Activity</h3>
            <button class="swap-panel-close" onclick="closeSwapPanel()">&times;</button>
        </div>
        <div class="swap-panel-body" id="swapPanelBody"></div>
    </div>

    <!-- Notes Panel -->
    <div class="swap-overlay" id="notesPanelOverlay" onclick="closeNotesPanel()" style="display:none;"></div>
    <div class="swap-panel" id="notesPanel" style="display:none;">
        <div class="swap-panel-header">
            <h3>ðŸ“ My Notes</h3>
            <button class="swap-panel-close" onclick="closeNotesPanel()">&times;</button>
        </div>
        <div class="swap-panel-body" id="notesPanelBody"></div>
    </div>

    <!-- Bookings Panel -->
    <div class="swap-overlay" id="bookingsPanelOverlay" onclick="closeBookingsPanel()" style="display:none;"></div>
    <div class="swap-panel" id="bookingsPanel" style="display:none;">
        <div class="swap-panel-header">
            <h3>ðŸ”– Bookings</h3>
            <button class="swap-panel-close" onclick="closeBookingsPanel()">&times;</button>
        </div>
        <div class="swap-panel-body" id="bookingsPanelBody"></div>
    </div>

    <!-- City Activity Browser (Phase 1b) -->
    <div class="browser-overlay" id="browserOverlay" onclick="closeCityBrowser()"></div>
    <div class="city-browser" id="cityBrowser">
        <div class="browser-header">
            <div class="browser-header-top">
                <div>
                    <div class="browser-header-title" id="browserTitle">Browse City</div>
                    <div class="browser-header-subtitle" id="browserSubtitle">All activities near this city</div>
                </div>
                <button class="browser-close" onclick="closeCityBrowser()">&times;</button>
            </div>
            <input type="text" class="browser-search" id="browserSearch" placeholder="Search activities..." oninput="filterBrowserActivities()">
        </div>
        <div class="browser-chips" id="browserChips">
            <button class="browser-chip active" data-filter="all" onclick="setBrowserFilter('all')">All</button>
            <button class="browser-chip" data-filter="hotels" onclick="setBrowserFilter('hotels')">&#x1F3E8; Hotels</button>
            <button class="browser-chip" data-filter="restaurants" onclick="setBrowserFilter('restaurants')">&#x1F374; Restaurants</button>
            <button class="browser-chip" data-filter="experiences" onclick="setBrowserFilter('experiences')">&#x1F5FA; Experiences</button>
            <button class="browser-chip" data-filter="kidFriendly" onclick="setBrowserFilter('kidFriendly')">&#x1F476; Kid-Friendly</button>
            <button class="browser-chip" data-filter="markets" onclick="setBrowserFilter('markets')">&#x1F6CD; Markets</button>
        </div>
        <div class="browser-body" id="browserBody"></div>
    </div>

    <!-- Geolocation - Where Am I? (Phase 1d) -->
    <button class="geo-fab" id="geoFab" onclick="geoLocate()" title="Where am I?">
        <i class="fas fa-location-crosshairs"></i>
    </button>
    <div class="nearby-panel" id="nearbyPanel">
        <div class="nearby-header">
            <div class="nearby-header-left">
                <div class="nearby-title" id="nearbyTitle">Nearby Activities</div>
                <div class="nearby-subtitle" id="nearbySubtitle">Within 2km of your location</div>
            </div>
            <button class="nearby-close" onclick="closeNearbyPanel()">&times;</button>
        </div>
        <div class="nearby-body" id="nearbyBody"></div>
    </div>

    <!-- AI Chat -->
    <button class="chat-fab" id="chatFab" onclick="toggleChatPanel()" title="AI Trip Planner">
        <i class="fas fa-robot"></i>
    </button>
    <div class="chat-panel" id="chatPanel">
        <div class="chat-header">
            <div>
                <div class="chat-header-title">AI Day Planner</div>
                <div class="chat-header-context" id="chatContext">Select an itinerary &amp; day first</div>
            </div>
            <button class="chat-header-close" onclick="toggleChatPanel()">&times;</button>
        </div>
        <div id="chatSetup" class="chat-setup" style="display:none;">
            <h3>Connect to Claude</h3>
            <p>Enter your Anthropic API key to enable AI-powered day planning. Your key is stored locally in your browser and never sent anywhere except Anthropic's API.</p>
            <input type="password" id="apiKeyInput" placeholder="sk-ant-api03-..." />
            <button onclick="saveApiKey()">Save Key</button>
            <a href="https://console.anthropic.com/settings/keys" target="_blank">Get an API key &rarr;</a>
        </div>
        <div class="chat-messages" id="chatMessages" style="display:none;"></div>
        <div class="chat-input-area" id="chatInputArea" style="display:none;">
            <textarea class="chat-input" id="chatInput" placeholder="e.g. I want knife shopping + great tempura today..." rows="1" onkeydown="chatKeyHandler(event)"></textarea>
            <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
        <div class="chat-settings" id="chatSettings" style="display:none;">
            <div class="chat-model-toggle">
                <button class="chat-model-btn active" id="modelHaiku" onclick="setChatModel('haiku')">Haiku</button>
                <button class="chat-model-btn" id="modelSonnet" onclick="setChatModel('sonnet')">Sonnet</button>
            </div>
            <div class="web-search-toggle">
                <span class="web-search-label">Web</span>
                <button class="web-search-switch active" id="webSearchToggle" onclick="toggleWebSearch()" title="Enable web search for up-to-date info"></button>
            </div>
            <span class="chat-settings-key" onclick="showApiKeySetup()">Change API key</span>
        </div>
    </div>

    <!-- QR Code Modal (Phase 3) -->
    <div class="qr-overlay" id="qrOverlay" onclick="if(event.target===this)closeQrModal()">
        <div class="qr-modal">
            <div class="qr-modal-title" id="qrTitle"></div>
            <div class="qr-modal-subtitle" id="qrSubtitle"></div>
            <img id="qrImage" src="" alt="QR Code" />
            <a class="qr-modal-link" id="qrLink" href="" target="_blank"></a>
            <div class="qr-modal-actions">
                <button class="qr-modal-close" onclick="closeQrModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Copy Toast (Phase 3) -->
    <div class="copy-toast" id="copyToast">Copied!</div>

    <!-- AI Itinerary Generator Modal -->
    <div class="gen-overlay" id="genOverlay" onclick="if(event.target===this)closeGeneratorModal()">
        <div class="gen-modal">
            <div class="gen-modal-title">Generate Custom Itinerary</div>
            <div class="gen-modal-subtitle" id="genDestLabel">for this destination</div>
            <div class="gen-profile-bar">
                <select class="gen-profile-select" id="genProfileSelect" onchange="loadTravelProfile()">
                    <option value="">â€” Select a saved profile â€”</option>
                </select>
                <button class="gen-profile-btn" onclick="showSaveProfileRow()">Save</button>
                <button class="gen-profile-btn danger" id="genProfileDeleteBtn" onclick="deleteTravelProfile()" style="display:none;">Del</button>
            </div>
            <div class="gen-profile-save-row" id="genProfileSaveRow">
                <input class="gen-profile-save-input" id="genProfileNameInput" placeholder="Profile name, e.g. 'Family with toddler'" />
                <button class="gen-profile-btn" onclick="saveTravelProfile()">Save</button>
                <button class="gen-profile-btn" onclick="hideSaveProfileRow()">Cancel</button>
            </div>
            <div class="gen-field">
                <label>Trip Duration (days)</label>
                <input type="number" id="genDays" min="2" max="21" value="7" />
            </div>
            <div class="gen-field">
                <label>Travel Party</label>
                <select id="genParty">
                    <option value="couple">Couple</option>
                    <option value="family-toddler">Family with toddler (under 4)</option>
                    <option value="family-kids">Family with kids (4-12)</option>
                    <option value="family-teens">Family with teens</option>
                    <option value="solo">Solo traveler</option>
                    <option value="friends">Group of friends</option>
                </select>
            </div>
            <div class="gen-field">
                <label>Interests (click to select)</label>
                <div class="gen-interests" id="genInterests">
                    <span class="gen-interest-chip selected" data-interest="food">Food &amp; Dining</span>
                    <span class="gen-interest-chip" data-interest="culture">Culture &amp; History</span>
                    <span class="gen-interest-chip" data-interest="adventure">Adventure</span>
                    <span class="gen-interest-chip" data-interest="shopping">Shopping</span>
                    <span class="gen-interest-chip" data-interest="relaxation">Relaxation</span>
                    <span class="gen-interest-chip" data-interest="nightlife">Nightlife</span>
                    <span class="gen-interest-chip" data-interest="nature">Nature &amp; Outdoors</span>
                    <span class="gen-interest-chip" data-interest="photography">Photography</span>
                    <span class="gen-interest-chip" data-interest="art">Art &amp; Design</span>
                    <span class="gen-interest-chip" data-interest="kid-friendly">Kid-Friendly</span>
                </div>
            </div>
            <div class="gen-field">
                <label>Pace</label>
                <select id="genPace">
                    <option value="slow">Slow &amp; relaxed (lots of downtime)</option>
                    <option value="moderate" selected>Moderate (balanced)</option>
                    <option value="fast">Fast-paced (pack it all in)</option>
                </select>
            </div>
            <div class="gen-field">
                <label>Budget</label>
                <select id="genBudget">
                    <option value="budget">Budget-friendly</option>
                    <option value="moderate" selected>Moderate</option>
                    <option value="luxury">Luxury</option>
                </select>
            </div>
            <div class="gen-field">
                <label>Special requests or constraints (optional)</label>
                <textarea id="genConstraints" placeholder="e.g., 'We need nap time 1-3pm', 'vegetarian', 'mobility issues', 'want a day trip to...', 'arriving late on day 1'"></textarea>
            </div>
            <div class="gen-field" style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                <span style="font-size:11px; font-weight:600; color:#555;">Web search for current info</span>
                <div class="web-search-toggle">
                    <button class="web-search-switch" id="genWebSearchToggle" onclick="toggleGenWebSearch()" title="Enable web search for opening hours, seasonal events, etc."></button>
                </div>
            </div>
            <div id="genPreviewArea" style="display:none;"></div>
            <div id="genError" style="display:none; color:#DC2626; font-size:12px; margin-top:8px; padding:8px; background:#FEF2F2; border-radius:8px;"></div>
            <button class="gen-btn primary gen-generate-btn" id="genSubmitBtn" onclick="submitGeneratorForm()">Generate Itinerary</button>
            <div class="gen-actions">
                <button class="gen-btn secondary" onclick="closeGeneratorModal()">Cancel</button>
                <button class="gen-btn primary" id="genSaveBtn" onclick="saveGeneratedItinerary()" style="display:none;">Save &amp; Load Itinerary</button>
            </div>
        </div>
    </div>

    <!-- Add Destination Modal (Phase 4) -->
    <div class="dest-overlay" id="destOverlay" onclick="if(event.target===this)closeAddDestModal()">
        <div class="dest-modal">
            <div class="dest-modal-title">Add a New Destination</div>
            <div class="dest-modal-desc">Load a destination data file (JSON) to add a new trip to your map. The file should contain category arrays, itinerary data, and city centers.</div>
            <div class="dest-modal-desc" style="font-weight:600;">Load from URL:</div>
            <input class="dest-modal-input" id="destUrlInput" type="text" placeholder="https://example.com/italy-trip-data.json" />
            <div class="dest-modal-or">&mdash; or &mdash;</div>
            <div class="dest-modal-desc" style="font-weight:600;">Load from file:</div>
            <div class="dest-modal-file">
                <input type="file" id="destFileInput" accept=".json" />
            </div>
            <div class="dest-modal-or">&mdash; or &mdash;</div>
            <button class="dest-modal-btn secondary" onclick="copyDestSchema()" style="width:100%;">Copy JSON Schema Template</button>
            <div class="dest-modal-schema" id="destSchema" style="display:none;"></div>
            <div class="dest-modal-actions">
                <button class="dest-modal-btn secondary" onclick="closeAddDestModal()">Cancel</button>
                <button class="dest-modal-btn primary" onclick="processDestInput()">Load Destination</button>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

    <script>
        // ============================================
        // ============================================
        // DATA â€” Loaded dynamically from JSON files
        // ============================================

        // Global arrays (populated by loadDestination)
        const hotels = [];
        const restaurants = [];
        const experiences = [];
        const kidFriendly = [];
        const markets = [];
        const itineraryData = {};
        let originalItineraryData = {};
        const cityCenters = {};
        let poiLookup = {};  // Maps POI name â†’ {desc, longDesc} for itinerary popup cross-reference

        // Multi-destination framework
        const destinations = {};
        let activeDestination = null;
        let manifestData = null;  // Stores the destinations.json manifest

        // ============================================
        // DESTINATION LOADING FROM JSON
        // ============================================

        async function loadManifest() {
            try {
                const response = await fetch('destinations.json');
                if (!response.ok) throw new Error('Could not load destinations.json');
                manifestData = await response.json();

                // Populate dropdown from manifest (before any data is loaded)
                const sel = document.getElementById('destSelect');
                sel.innerHTML = '';
                manifestData.destinations.forEach(function(dest) {
                    const opt = document.createElement('option');
                    opt.value = dest.key;
                    opt.textContent = dest.flag + ' ' + dest.name;
                    sel.appendChild(opt);
                });

                // Load the default destination
                await fetchAndLoadDestination(manifestData.default);

            } catch(e) {
                console.error('Failed to load manifest:', e);
                showCopyToast('Could not load destinations. Make sure you are serving via HTTP (see serve.sh).');
            }
        }

        async function fetchAndLoadDestination(key) {
            // If already loaded, just switch
            if (destinations[key]) {
                loadDestination(key);
                return;
            }

            // Find the file path from manifest
            let filePath = 'destinations/' + key + '.json';
            if (manifestData) {
                const entry = manifestData.destinations.find(d => d.key === key);
                if (entry && entry.file) filePath = entry.file;
            }

            // Show loading indicator
            showCopyToast('Loading ' + key + '...');

            try {
                const response = await fetch(filePath);
                if (!response.ok) throw new Error('HTTP ' + response.status);
                const data = await response.json();

                // Use existing registerExternalDest to validate and register
                registerExternalDest(data);

            } catch(e) {
                console.error('Failed to load destination ' + key + ':', e);
                showCopyToast('Could not load ' + key + '. Check that ' + filePath + ' exists.');
            }
        }

        // Override the destination selector to use async loading
        function onDestSelectChange(key) {
            if (key === activeDestination) return;
            fetchAndLoadDestination(key);
        }

        

        function replaceArrayContents(target, source) {
            target.length = 0;
            source.forEach(function(item) { target.push(item); });
        }

        function replaceObjectContents(target, source) {
            Object.keys(target).forEach(function(k) { delete target[k]; });
            Object.assign(target, source);
        }

        async function loadDestination(key) {
            if (key === activeDestination) return;
            var dest = destinations[key];
            if (!dest) { showCopyToast('Destination not found'); return; }

            activeDestination = key;

            // Save current destination mods before switching
            if (activeDestination) {
                try {
                    localStorage.setItem('tripMap_mods_' + activeDestination, JSON.stringify(modifiedState));
                } catch(e) {}
            }

            // Clear current map layers
            clearItineraryMarkers();
            Object.keys(categoryGroups).forEach(function(k) {
                if (categoryGroups[k]) {
                    map.removeLayer(categoryGroups[k]);
                    categoryGroups[k] = null;
                }
            });

            // Swap data arrays (mutate in place to preserve references)
            replaceArrayContents(hotels, dest.hotels);
            replaceArrayContents(restaurants, dest.restaurants);
            replaceArrayContents(experiences, dest.experiences);
            replaceArrayContents(kidFriendly, dest.kidFriendly);
            replaceArrayContents(markets, dest.markets);
            replaceObjectContents(itineraryData, dest.itineraryData);
            replaceObjectContents(cityCenters, dest.cityCenters);
            originalItineraryData = JSON.parse(JSON.stringify(dest.itineraryData));

            // Build POI lookup map for itinerary popup cross-reference
            poiLookup = {};
            [dest.hotels, dest.restaurants, dest.experiences, dest.kidFriendly, dest.markets].forEach(arr => {
                (arr || []).forEach(poi => {
                    if (poi.name) {
                        poiLookup[poi.name] = { desc: poi.desc || '', longDesc: poi.longDesc || '', gmapsUrl: poi.gmapsUrl || '' };
                    }
                });
            });

            // Load destination-specific modifications
            modifiedState = {};
            try {
                var saved = localStorage.getItem('tripMap_mods_' + key);
                if (saved) {
                    modifiedState = JSON.parse(saved);
                    applyModifications();
                }
            } catch(e) {}

            // Update UI
            document.getElementById('destTitle').textContent = dest.name;
            document.getElementById('destSubtitle').textContent = dest.subtitle || '';
            document.querySelector('title').textContent = dest.name + ' \u2014 Interactive Trip Map';

            // Reset map view
            map.setView(dest.defaultCenter, dest.defaultZoom);
            currentItinerary = null;
            currentDay = null;

            // Load annotations (personal.json + browser localStorage)
            await loadPersonalAnnotations(key);
            loadBrowserAnnotations(key);

            // Rebuild categories and switch to default view
            categoryGroups.hotels = L.featureGroup();
            categoryGroups.restaurants = L.featureGroup();
            categoryGroups.experiences = L.featureGroup();
            categoryGroups.kidFriendly = L.featureGroup();
            categoryGroups.markets = L.featureGroup();
            loadCategories();
            switchView('categories');
            loadSavedGeneratedItineraries();
            buildTabsUI();
            buildFilterChips();
            buildRegionFilter();
            updateBookingsBadge();
        }

        function addDestination(key, config) {
            destinations[key] = config;
            updateDestSelector();
        }

        function updateDestSelector() {
            var sel = document.getElementById('destSelect');
            sel.innerHTML = '';

            // Combine manifest entries (unloaded) with loaded destinations
            var allKeys = new Set();

            // First add manifest entries (preserves order)
            if (manifestData) {
                manifestData.destinations.forEach(function(entry) {
                    allKeys.add(entry.key);
                    var opt = document.createElement('option');
                    opt.value = entry.key;
                    var dest = destinations[entry.key];
                    opt.textContent = (dest ? dest.flag : entry.flag) + ' ' + (dest ? dest.name : entry.name);
                    if (entry.key === activeDestination) opt.selected = true;
                    sel.appendChild(opt);
                });
            }

            // Then add any dynamically loaded destinations not in manifest
            Object.keys(destinations).forEach(function(key) {
                if (allKeys.has(key)) return;  // Already added from manifest
                var opt = document.createElement('option');
                opt.value = key;
                opt.textContent = (destinations[key].flag || '\u{1F30D}') + ' ' + destinations[key].name;
                if (key === activeDestination) opt.selected = true;
                sel.appendChild(opt);
            });
        }

        function showAddDestModal() {
            document.getElementById('destOverlay').classList.add('active');
            document.getElementById('destUrlInput').value = '';
            document.getElementById('destFileInput').value = '';
            document.getElementById('destSchema').style.display = 'none';
        }

        function closeAddDestModal() {
            document.getElementById('destOverlay').classList.remove('active');
        }

        function processDestInput() {
            var url = document.getElementById('destUrlInput').value.trim();
            var fileInput = document.getElementById('destFileInput');

            if (url) {
                loadDestFromUrl(url);
            } else if (fileInput.files && fileInput.files.length > 0) {
                loadDestFromFile(fileInput.files[0]);
            } else {
                showCopyToast('Enter a URL or select a file');
            }
        }

        function loadDestFromUrl(url) {
            showCopyToast('Loading destination...');
            fetch(url)
                .then(function(r) { return r.json(); })
                .then(function(data) { registerExternalDest(data); })
                .catch(function(e) { showCopyToast('Error loading: ' + e.message); });
        }

        function loadDestFromFile(file) {
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var data = JSON.parse(e.target.result);
                    registerExternalDest(data);
                } catch(err) {
                    showCopyToast('Invalid JSON file');
                }
            };
            reader.readAsText(file);
        }

        function registerExternalDest(data) {
            if (!data.key || !data.name || !data.itineraryData || !data.cityCenters) {
                showCopyToast('Invalid schema: needs key, name, itineraryData, cityCenters');
                return;
            }
            var config = {
                name: data.name,
                subtitle: data.subtitle || '',
                flag: data.flag || '\u{1F30D}',
                defaultCenter: data.defaultCenter || [0, 0],
                defaultZoom: data.defaultZoom || 5,
                hotels: data.hotels || [],
                restaurants: data.restaurants || [],
                experiences: data.experiences || [],
                kidFriendly: data.kidFriendly || [],
                markets: data.markets || [],
                itineraryData: data.itineraryData,
                cityCenters: data.cityCenters,
                regions: data.regions || [],
                originalItineraryData: JSON.parse(JSON.stringify(data.itineraryData))
            };
            addDestination(data.key, config);
            closeAddDestModal();
            showCopyToast(data.name + ' added!');
            loadDestination(data.key);
        }

        function copyDestSchema() {
            var schema = JSON.stringify({
                "key": "italy",
                "name": "Italy Family Adventure",
                "subtitle": "14-Day Trip",
                "flag": "\u{1F1EE}\u{1F1F9}",
                "defaultCenter": [42.5, 12.5],
                "defaultZoom": 6,
                "hotels": [{"name": "Hotel Example", "coord": [41.9, 12.5], "desc": "Description"}],
                "restaurants": [{"name": "Restaurant Example", "coord": [41.9, 12.5], "desc": "Description"}],
                "experiences": [{"name": "Experience Example", "coord": [41.9, 12.5], "desc": "Description"}],
                "kidFriendly": [],
                "markets": [],
                "cityCenters": {"Rome": [41.9, 12.5, 0.12], "Florence": [43.77, 11.25, 0.10]},
                "itineraryData": {
                    "a": {
                        "name": "Classic Italy",
                        "color": "#2563EB",
                        "days": [{
                            "day": 1,
                            "title": "Rome (Arrival)",
                            "items": [
                                {"type": "hotel", "name": "Hotel Example", "coord": [41.9, 12.5]},
                                {"type": "breakfast", "name": "Morning meal", "coord": null},
                                {"type": "sightseeing", "name": "Colosseum", "coord": [41.89, 12.49]},
                                {"type": "nap", "name": "Nap Time", "coord": null},
                                {"type": "dinner", "name": "Trattoria Example", "coord": [41.9, 12.5]}
                            ]
                        }]
                    }
                }
            }, null, 2);

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(schema).then(function() {
                    showCopyToast('Schema copied to clipboard!');
                    document.getElementById('destSchema').textContent = schema;
                    document.getElementById('destSchema').style.display = 'block';
                });
            } else {
                copyFallback(schema);
                document.getElementById('destSchema').textContent = schema;
                document.getElementById('destSchema').style.display = 'block';
            }
        }

        // ============================================
        // GLOBAL STATE
        // ============================================

        let map;
        let currentView = 'categories';
        let currentItinerary = null;
        let currentDay = null;
        let allDaysActive = false;

        // Category feature groups
        let categoryGroups = {
            hotels: null,
            restaurants: null,
            experiences: null,
            kidFriendly: null,
            markets: null
        };

        // Itinerary markers and polylines
        let itineraryMarkers = [];
        let itineraryPolylines = [];

        // Category colors
        const categoryColors = {
            hotels: '#E63946',
            restaurants: '#F8A500',
            experiences: '#4ECDC4',
            kidFriendly: '#95E1D3',
            markets: '#9D4EDD'
        };

        // Item type colors
        const typeColors = {
            hotel: '#E63946',
            breakfast: '#EA580C',
            lunch: '#0D9488',
            dinner: '#BE123C',
            sightseeing: '#2563EB',
            optional: '#9D4EDD',
            nap: '#999'
        };

        // ============================================

        // ============================================
        // PERSISTENCE & MODIFICATION STATE
        // ============================================

        let modifiedState = {};

        function saveModifiedState() {
            try {
                localStorage.setItem('japanTrip_mods', JSON.stringify(modifiedState));
            } catch (e) {
                console.warn('localStorage save failed:', e);
            }
        }

        function loadModifiedState() {
            try {
                const saved = localStorage.getItem('japanTrip_mods');
                if (saved) {
                    modifiedState = JSON.parse(saved);
                    applyModifications();
                }
            } catch (e) {
                console.warn('localStorage load failed:', e);
            }
        }

        function applyModifications() {
            Object.entries(modifiedState).forEach(([stateKey, mod]) => {
                const parts = stateKey.split('_');
                const key = parts[0];
                const dayNum = parseInt(parts[1]);
                const itemIdx = parseInt(parts[2]);
                const itin = itineraryData[key];
                if (!itin) return;
                const dayData = itin.days.find(d => d.day === dayNum);
                if (!dayData || !dayData.items[itemIdx]) return;
                const origType = dayData.items[itemIdx].type;
                dayData.items[itemIdx] = { type: origType, name: mod.newName, coord: mod.newCoord, desc: mod.newDesc || '' };
            });
        }

        function resetDay(itinKey, dayNum) {
            event.stopPropagation();
            const origItin = originalItineraryData[itinKey];
            if (!origItin) return;
            const origDay = origItin.days.find(d => d.day === dayNum);
            const currItin = itineraryData[itinKey];
            const currDay = currItin.days.find(d => d.day === dayNum);
            if (!origDay || !currDay) return;
            currDay.items = JSON.parse(JSON.stringify(origDay.items));
            const prefix = itinKey + '_' + dayNum + '_';
            Object.keys(modifiedState).forEach(k => {
                if (k.startsWith(prefix)) delete modifiedState[k];
            });
            saveModifiedState();
            if (currentItinerary === itinKey) {
                showItinerary(itinKey);
            }
        }

        function dayHasModifications(itinKey, dayNum) {
            const prefix = itinKey + '_' + dayNum + '_';
            return Object.keys(modifiedState).some(k => k.startsWith(prefix));
        }

        // ============================================
        // CITY LOOKUP & ALTERNATIVES
        // ============================================


        function extractCity(title) {
            if (!title) return '';
            let city = title.split('(')[0].split('â†’')[0].split('&')[0].split('/')[0].trim();
            return city;
        }

        function findCityCenter(title) {
            const city = extractCity(title);
            for (const [name, center] of Object.entries(cityCenters)) {
                if (city.toLowerCase().includes(name.toLowerCase()) || name.toLowerCase().includes(city.toLowerCase())) {
                    return { name: name, lat: center[0], lng: center[1], radius: center[2] };
                }
            }
            return null;
        }

        function findAlternatives(dayTitle, itemType, excludeName) {
            const center = findCityCenter(dayTitle);
            if (!center) return [];

            let sources = [];
            if (itemType === 'hotel') {
                sources = hotels.map(h => ({...h, srcType: 'hotel'}));
            } else if (itemType === 'breakfast' || itemType === 'lunch' || itemType === 'dinner') {
                sources = restaurants.map(r => ({...r, srcType: 'restaurant'}));
            } else if (itemType === 'sightseeing' || itemType === 'optional') {
                sources = [
                    ...experiences.map(e => ({...e, srcType: 'experience'})),
                    ...kidFriendly.map(k => ({...k, srcType: 'kid-friendly'})),
                    ...markets.map(m => ({...m, srcType: 'market'}))
                ];
            } else {
                return [];
            }

            return sources.filter(item => {
                if (!item.coord) return false;
                if (item.name === excludeName) return false;
                const latDiff = Math.abs(item.coord[0] - center.lat);
                const lngDiff = Math.abs(item.coord[1] - center.lng);
                return latDiff < center.radius && lngDiff < center.radius;
            });
        }

        // ============================================
        // SWAP PANEL
        // ============================================

        let swapContext = null;

        function openSwapPanel(itinKey, dayNum, itemIdx) {
            const itin = itineraryData[itinKey];
            const dayData = itin.days.find(d => d.day === dayNum);
            if (!dayData) return;
            const item = dayData.items[itemIdx];
            if (!item || item.type === 'nap') return;

            swapContext = { itinKey, dayNum, itemIdx, item };

            const alts = findAlternatives(dayData.title, item.type, item.name);

            let html = '';
            html += '<div class="swap-current">';
            html += '<div class="swap-current-label">Current Activity</div>';
            html += '<div class="swap-current-name">' + escapeHtml(item.name) + '</div>';
            if (item.desc) html += '<div class="swap-current-desc">' + escapeHtml(item.desc) + '</div>';
            html += '</div>';

            html += '<div class="swap-alts-label">Alternatives in ' + escapeHtml(extractCity(dayData.title)) + '</div>';

            if (alts.length === 0) {
                html += '<div class="swap-no-alts">No alternatives found nearby for this type of activity</div>';
            } else {
                alts.forEach((alt, idx) => {
                    html += '<div class="swap-alt-card" onclick="performSwap(' + idx + ')" data-idx="' + idx + '">';
                    html += '<div class="swap-alt-name">' + escapeHtml(alt.name) + '</div>';
                    if (alt.desc) html += '<div class="swap-alt-desc">' + escapeHtml(alt.desc) + '</div>';
                    html += '</div>';
                });
            }

            document.getElementById('swapPanelBody').innerHTML = html;
            document.getElementById('swapPanelTitle').textContent = 'Swap ' + formatType(item.type);
            document.getElementById('swapOverlay').classList.add('active');
            document.getElementById('swapPanel').classList.add('active');

            // Store alternatives for performSwap
            swapContext.alts = alts;
        }

        function closeSwapPanel() {
            document.getElementById('swapOverlay').classList.remove('active');
            document.getElementById('swapPanel').classList.remove('active');
            swapContext = null;
        }

        function performSwap(altIdx) {
            if (!swapContext) return;
            const { itinKey, dayNum, itemIdx, alts } = swapContext;
            const alt = alts[altIdx];
            if (!alt) return;

            const itin = itineraryData[itinKey];
            const dayData = itin.days.find(d => d.day === dayNum);
            const origType = dayData.items[itemIdx].type;

            dayData.items[itemIdx] = {
                type: origType,
                name: alt.name,
                coord: alt.coord,
                desc: alt.desc || ''
            };

            const stateKey = itinKey + '_' + dayNum + '_' + itemIdx;
            modifiedState[stateKey] = {
                newName: alt.name,
                newCoord: alt.coord,
                newDesc: alt.desc || '',
                origName: swapContext.item.name,
                origCoord: swapContext.item.coord,
                timestamp: Date.now()
            };
            saveModifiedState();

            closeSwapPanel();

            if (currentItinerary === itinKey) {
                showItinerary(itinKey);
            }
        }

        // MAP INITIALIZATION
        // ============================================

        function initMap() {
            map = L.map('map-container').setView([36.2, 137.5], 6.5);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; CartoDB contributors',
                maxZoom: 19,
                minZoom: 4
            }).addTo(map);

            // Initialize category feature groups (empty â€” loadDestination fills them)
            categoryGroups.hotels = L.featureGroup();
            categoryGroups.restaurants = L.featureGroup();
            categoryGroups.experiences = L.featureGroup();
            categoryGroups.kidFriendly = L.featureGroup();
            categoryGroups.markets = L.featureGroup();

            // Build static UI elements
            buildCategoriesUI();

            // Initialize destination selector (Phase 4)
            updateDestSelector();

            // NOTE: loadCategories() and buildTabsUI() are called by loadDestination()
            // which is invoked right after initMap() in DOMContentLoaded
        }

        // ============================================
        // CATEGORY LOADING & RENDERING
        // ============================================

        // Build popup HTML for any category POI (shared helper)
        function buildPoiPopupHtml(poi, categoryLabel) {
            const destKey = activeDestination || 'default';
            const safeName = poi.name.replace(/'/g, "\\'");
            const noteTextareaId = 'note-' + poi.name.replace(/[^a-zA-Z0-9]/g, '_');
            const existingNote = getNote(destKey, poi.name);
            const poiAnnotations = getAnnotationsForPoi(destKey, poi.name);

            let html = `<div class="popup-title">${escapeHtml(poi.name)}</div><div class="popup-type">${categoryLabel}</div><div style="font-size:11px;color:#666;margin-top:4px;">${escapeHtml(poi.desc || '')}</div>`;
            if (poi.longDesc) html += `<div style="font-size:12px;color:#444;margin-top:6px;line-height:1.4;">${escapeHtml(poi.longDesc)}</div>`;
            if (poi.gmapsUrl) html += `<div style="margin-top:6px;"><a href="${poi.gmapsUrl}" target="_blank" rel="noopener" style="font-size:11px;color:#1a73e8;text-decoration:none;display:inline-flex;align-items:center;gap:3px;"><span style="font-size:13px;">ðŸ“</span> View on Google Maps</a></div>`;
            // Annotations
            html += buildAnnotationHtml(poiAnnotations);
            html += buildAnnotationFormHtml(destKey, poi.name);
            // Notes
            html += '<div style="margin-top:8px;border-top:1px solid #e5e7eb;padding-top:8px">';
            html += '<div style="font-size:11px;font-weight:600;color:#6b7280;margin-bottom:4px">ðŸ“ My Notes</div>';
            html += '<textarea id="' + noteTextareaId + '" style="width:100%;min-height:50px;border:1px solid #d1d5db;border-radius:4px;padding:4px;font-size:12px;resize:vertical;font-family:inherit" placeholder="Add a note...">' + escapeHtml(existingNote) + '</textarea>';
            html += '<button onclick="setNote(\'' + destKey + '\',\'' + safeName + '\',document.getElementById(\'' + noteTextareaId + '\').value);this.textContent=\'Saved âœ“\';setTimeout(()=>this.textContent=\'Save Note\',1500)" style="margin-top:4px;padding:2px 8px;font-size:11px;background:#2563EB;color:white;border:none;border-radius:3px;cursor:pointer;width:100%">Save Note</button>';
            html += '</div>';
            return html;
        }

        function loadCategories() {
            const destKey = activeDestination || 'default';

            // Helper to create a category marker with annotation badge
            function addCategoryMarker(poi, categoryKey, categoryLabel, radius) {
                if (!poi.coord) return;
                const hasAnnotation = getAnnotationsForPoi(destKey, poi.name).length > 0;
                const marker = L.circleMarker(poi.coord, {
                    radius: radius,
                    fillColor: categoryColors[categoryKey],
                    color: hasAnnotation ? '#f59e0b' : '#fff',
                    weight: hasAnnotation ? 3 : 2,
                    opacity: 1,
                    fillOpacity: 0.8
                });
                marker.bindPopup(buildPoiPopupHtml(poi, categoryLabel));
                categoryGroups[categoryKey].addLayer(marker);
            }

            // Hotels
            hotels.forEach(h => addCategoryMarker(h, 'hotels', 'Hotel', 6));
            // Restaurants
            restaurants.forEach(r => addCategoryMarker(r, 'restaurants', 'Restaurant', 5));
            // Experiences
            experiences.forEach(e => addCategoryMarker(e, 'experiences', 'Experience', 5));
            // Kid Friendly
            kidFriendly.forEach(k => addCategoryMarker(k, 'kidFriendly', 'Kid Friendly', 5));
            // Markets
            markets.forEach(m => addCategoryMarker(m, 'markets', 'Market', 5));

            // Add all to map initially (categories view)
            categoryGroups.hotels.addTo(map);
            categoryGroups.restaurants.addTo(map);
            categoryGroups.experiences.addTo(map);
            categoryGroups.kidFriendly.addTo(map);
            categoryGroups.markets.addTo(map);

            // Add legend
            addLegend();

            // Fit bounds
            let allLayers = L.featureGroup([
                categoryGroups.hotels,
                categoryGroups.restaurants,
                categoryGroups.experiences,
                categoryGroups.kidFriendly,
                categoryGroups.markets
            ]);
            if (allLayers.getLayers().length > 0) {
                map.fitBounds(allLayers.getBounds().pad(0.1));
            }
        }

        function addLegend() {
            const legend = L.control({ position: 'bottomright' });
            legend.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'legend');
                const items = [
                    { label: 'Hotels', color: categoryColors.hotels },
                    { label: 'Restaurants', color: categoryColors.restaurants },
                    { label: 'Experiences', color: categoryColors.experiences },
                    { label: 'Kid Friendly', color: categoryColors.kidFriendly },
                    { label: 'Markets', color: categoryColors.markets }
                ];
                
                items.forEach(item => {
                    const legendItem = document.createElement('div');
                    legendItem.className = 'legend-item';
                    legendItem.innerHTML = `<div class="legend-color" style="background-color:${item.color}"></div> <span>${item.label}</span>`;
                    div.appendChild(legendItem);
                });
                
                return div;
            };
            legend.addTo(map);
        }

        // ============================================
        // UI BUILDING
        // ============================================

        function buildTabsUI() {
            const container = document.getElementById('tabsContainer');
            container.innerHTML = '';  // Clear existing tabs before rebuilding

            Object.keys(itineraryData).forEach(key => {
                const itin = itineraryData[key];
                const itinName = itin.name || itin.title || key.toUpperCase();
                const btn = document.createElement('button');
                btn.className = `itin-tab itin-tab-${key}`;
                if (itin.isGenerated) {
                    btn.classList.add('itin-tab-generated');
                    btn.style.borderColor = itin.color || '#7C3AED';
                    btn.innerHTML = '\u2728 ' + escapeHtml(itinName);
                    const delSpan = document.createElement('span');
                    delSpan.className = 'itin-tab-delete';
                    delSpan.innerHTML = '\u00d7';
                    delSpan.onclick = function(e) { e.stopPropagation(); deleteGeneratedItinerary(key); };
                    btn.appendChild(delSpan);
                } else {
                    btn.textContent = itinName;
                }
                btn.onclick = () => selectItinerary(key);
                btn.id = `tab-${key}`;
                container.appendChild(btn);
            });
        }

        function buildCategoriesUI() {
            const container = document.getElementById('categoriesContainer');
            
            const categories = [
                { key: 'hotels', label: 'Hotels' },
                { key: 'restaurants', label: 'Restaurants' },
                { key: 'experiences', label: 'Experiences' },
                { key: 'kidFriendly', label: 'Kid Friendly' },
                { key: 'markets', label: 'Markets' }
            ];
            
            categories.forEach(cat => {
                const label = document.createElement('label');
                label.className = 'category-checkbox';
                label.innerHTML = `
                    <input type="checkbox" checked data-category="${cat.key}" onchange="toggleCategory('${cat.key}')">
                    <span class="category-color" style="background-color:${categoryColors[cat.key]}"></span>
                    <span class="category-label">${cat.label}</span>
                `;
                container.appendChild(label);
            });
        }

        // ============================================
        // VIEW SWITCHING
        // ============================================

        function switchView(view) {
            currentView = view;
            
            if (view === 'categories') {
                document.getElementById('categoriesViewBtn').classList.add('active');
                document.getElementById('itinerariesViewBtn').classList.remove('active');
                document.getElementById('itineraryTabs').style.display = 'none';
                document.getElementById('categoriesCheckboxes').style.display = 'block';
                document.getElementById('categoriesView').style.display = 'block';
                document.getElementById('itinerariesView').style.display = 'none';
                
                // Clear itinerary markers
                clearItineraryMarkers();
                
                // Show category markers
                categoryGroups.hotels.addTo(map);
                categoryGroups.restaurants.addTo(map);
                categoryGroups.experiences.addTo(map);
                categoryGroups.kidFriendly.addTo(map);
                categoryGroups.markets.addTo(map);
                
                // Fit bounds
                let allLayers = L.featureGroup([
                    categoryGroups.hotels,
                    categoryGroups.restaurants,
                    categoryGroups.experiences,
                    categoryGroups.kidFriendly,
                    categoryGroups.markets
                ]);
                if (allLayers.getLayers().length > 0) {
                    map.fitBounds(allLayers.getBounds().pad(0.1));
                }
            } else {
                document.getElementById('categoriesViewBtn').classList.remove('active');
                document.getElementById('itinerariesViewBtn').classList.add('active');
                document.getElementById('itineraryTabs').style.display = 'block';
                document.getElementById('categoriesCheckboxes').style.display = 'none';
                document.getElementById('categoriesView').style.display = 'none';
                document.getElementById('itinerariesView').style.display = 'block';
                
                // Hide category markers
                categoryGroups.hotels.removeFrom(map);
                categoryGroups.restaurants.removeFrom(map);
                categoryGroups.experiences.removeFrom(map);
                categoryGroups.kidFriendly.removeFrom(map);
                categoryGroups.markets.removeFrom(map);
                
                // Load first itinerary
                if (!currentItinerary) {
                    selectItinerary('a');
                }
            }

            // Reapply filter chips to new view
            if (activeFilterChips.size > 0) {
                applyFilterChips();
            }
        }

        function toggleCategory(categoryKey) {
            if (map.hasLayer(categoryGroups[categoryKey])) {
                categoryGroups[categoryKey].removeFrom(map);
            } else {
                categoryGroups[categoryKey].addTo(map);
            }
        }

        // ============================================
        // ITINERARY SELECTION & RENDERING
        // ============================================

        function selectItinerary(key) {
            currentItinerary = key;
            currentDay = null;
            allDaysActive = false;
            updateChatContext();
            
            // Update active tab
            document.querySelectorAll('.itin-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`tab-${key}`).classList.add('active');
            
            showItinerary(key);
        }

        function showItinerary(key) {
            const itin = itineraryData[key];
            
            // Clear existing markers
            clearItineraryMarkers();
            
            // Create markers for all days with coordinates
            const markers = [];
            
            itin.days.forEach(dayData => {
                dayData.items.forEach(item => {
                    if (item.coord) {
                        const marker = L.circleMarker(item.coord, {
                            radius: 7,
                            fillColor: typeColors[item.type] || '#666',
                            color: '#fff',
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 0.85
                        });
                        
                        const itemIdx = dayData.items.indexOf(item);
                        const swapBtn = (item.type !== 'nap') ? '<button class="popup-swap-btn" onclick="openSwapPanel(\x27' + key + '\x27,' + dayData.day + ',' + itemIdx + ')">&#x1f504; Swap</button>' : '';
                        const destKey = activeDestination || 'default';
                        const poiInfo = poiLookup[item.name] || {};
                        const poiAnnotations = getAnnotationsForPoi(destKey, item.name);
                        const safeName = item.name.replace(/'/g, "\\'");
                        const itinNoteId = 'note-' + item.name.replace(/[^a-zA-Z0-9]/g, '_') + '_itin';
                        const itinExistingNote = getNote(destKey, item.name);

                        let popupContent = '<div class="popup-title">' + escapeHtml(item.name) + '</div><div class="popup-type">' + formatType(item.type) + '</div><div style="font-size:11px;color:#666;margin-top:4px;">Day ' + dayData.day + '</div>';
                        if (poiInfo.desc) popupContent += '<div style="font-size:11px;color:#666;margin-top:4px;">' + escapeHtml(poiInfo.desc) + '</div>';
                        if (poiInfo.longDesc) popupContent += '<div style="font-size:12px;color:#444;margin-top:6px;line-height:1.4;">' + escapeHtml(poiInfo.longDesc) + '</div>';
                        if (poiInfo.gmapsUrl) popupContent += '<div style="margin-top:6px;"><a href="' + poiInfo.gmapsUrl + '" target="_blank" rel="noopener" style="font-size:11px;color:#1a73e8;text-decoration:none;display:inline-flex;align-items:center;gap:3px;"><span style="font-size:13px;">ðŸ“</span> View on Google Maps</a></div>';
                        popupContent += swapBtn;
                        // Annotations
                        popupContent += buildAnnotationHtml(poiAnnotations);
                        popupContent += buildAnnotationFormHtml(destKey, item.name);
                        // Notes
                        popupContent += '<div style="margin-top:8px;border-top:1px solid #e5e7eb;padding-top:8px">';
                        popupContent += '<div style="font-size:11px;font-weight:600;color:#6b7280;margin-bottom:4px">ðŸ“ My Notes</div>';
                        popupContent += '<textarea id="' + itinNoteId + '" style="width:100%;min-height:50px;border:1px solid #d1d5db;border-radius:4px;padding:4px;font-size:12px;resize:vertical;font-family:inherit" placeholder="Add a note...">' + escapeHtml(itinExistingNote) + '</textarea>';
                        popupContent += '<button onclick="setNote(\'' + destKey + '\',\'' + safeName + '\',document.getElementById(\'' + itinNoteId + '\').value);this.textContent=\'Saved âœ“\';setTimeout(()=>this.textContent=\'Save Note\',1500)" style="margin-top:4px;padding:2px 8px;font-size:11px;background:#2563EB;color:white;border:none;border-radius:3px;cursor:pointer;width:100%">Save Note</button>';
                        popupContent += '</div>';
                        marker.bindPopup(popupContent);
                        marker.addTo(map);
                        itineraryMarkers.push({marker: marker, coord: item.coord, day: dayData.day, type: item.type, name: item.name});
                        markers.push({lat: item.coord[0], lng: item.coord[1]});
                    }
                });
            });

            // Create polylines for each day
            itin.days.forEach(dayData => {
                const dayCoords = [];
                dayData.items.forEach(item => {
                    if (item.coord && item.type !== 'nap') {
                        dayCoords.push(item.coord);
                    }
                });
                
                if (dayCoords.length > 1) {
                    const polyline = L.polyline(dayCoords, {
                        color: itin.color || '#666',
                        weight: 2,
                        opacity: 0.5,
                        dashArray: '5,3'
                    }).addTo(map);
                    itineraryPolylines.push({polyline: polyline, day: dayData.day});
                }
            });

            // Render days in sidebar
            renderDays(key);
            
            // Fit bounds to all markers
            if (markers.length > 0) {
                const bounds = L.latLngBounds(markers);
                map.fitBounds(bounds.pad(0.1));
            }

            // Set show all days button to active
            document.getElementById('showAllDaysBtn').classList.add('active');
            allDaysActive = true;

            // Reapply filter chips if active
            if (activeFilterChips.size > 0) {
                applyFilterChips();
            }
        }

        function showDay(key, dayNum) {
            currentDay = dayNum;
            currentDay = dayNum;
            allDaysActive = false;
            document.getElementById('showAllDaysBtn').classList.remove('active');
            
            // Hide all markers, show only this day's
            itineraryMarkers.forEach(m => {
                if (m.day === dayNum) {
                    m.marker.setStyle({opacity: 1, fillOpacity: 0.85});
                } else {
                    m.marker.setStyle({opacity: 0.2, fillOpacity: 0.2});
                }
            });

            // Hide all polylines, show only this day's
            itineraryPolylines.forEach(p => {
                if (p.day === dayNum) {
                    p.polyline.setStyle({opacity: 0.5});
                } else {
                    p.polyline.setStyle({opacity: 0.1});
                }
            });

            // Highlight active day card
            document.querySelectorAll('.day-card-header').forEach(header => {
                header.classList.remove('active');
            });
            document.getElementById(`day-header-${key}-${dayNum}`).classList.add('active');

            // Fit bounds to this day's markers
            const dayMarkers = itineraryMarkers.filter(m => m.day === dayNum);
            if (dayMarkers.length > 0) {
                const coords = dayMarkers.map(m => m.coord);
                const bounds = L.latLngBounds(coords);
                map.fitBounds(bounds.pad(0.2));
            }

            // Reapply filter chips if active
            if (activeFilterChips.size > 0) {
                applyFilterChips();
            }
        }

        function showAllDays() {
            currentDay = null;
            allDaysActive = true;
            currentDay = null; updateChatContext();
            document.getElementById('showAllDaysBtn').classList.add('active');
            
            // Show all markers
            itineraryMarkers.forEach(m => {
                m.marker.setStyle({opacity: 1, fillOpacity: 0.85});
            });

            // Show all polylines
            itineraryPolylines.forEach(p => {
                p.polyline.setStyle({opacity: 0.5});
            });

            // Unhighlight day cards
            document.querySelectorAll('.day-card-header').forEach(header => {
                header.classList.remove('active');
            });

            // Fit bounds to all markers
            const allCoords = itineraryMarkers.map(m => m.coord);
            if (allCoords.length > 0) {
                const bounds = L.latLngBounds(allCoords);
                map.fitBounds(bounds.pad(0.1));
            }

            // Reapply filter chips if active
            if (activeFilterChips.size > 0) {
                applyFilterChips();
            }
        }

        function clearItineraryMarkers() {
            itineraryMarkers.forEach(m => {
                map.removeLayer(m.marker);
            });
            itineraryMarkers = [];

            itineraryPolylines.forEach(p => {
                map.removeLayer(p.polyline);
            });
            itineraryPolylines = [];
        }

        // ============================================
        // DAY RENDERING
        // ============================================

        function renderDays(key) {
            const itin = itineraryData[key];
            const container = document.getElementById('daysContainer');
            container.innerHTML = '';

            itin.days.forEach(dayData => {
                const dayCard = document.createElement('div');
                dayCard.className = 'day-card';

                const header = document.createElement('div');
                header.className = 'day-card-header';
                header.id = `day-header-${key}-${dayData.day}`;
                header.onclick = () => toggleDayCard(header, dayData.day, key);
                const hasMods = dayHasModifications(key, dayData.day);
                const resetBtn = hasMods ? '<button class="day-reset-btn" onclick="event.stopPropagation(); resetDay(\x27' + key + '\x27,' + dayData.day + ')">&#8635; Reset</button>' : '';
                if (hasMods) header.classList.add('modified');
                const cityName = extractCity(dayData.title);
                const browseBtn = '<button class="day-browse-btn" onclick="event.stopPropagation(); openCityBrowser(\x27' + key + '\x27,' + dayData.day + ')" title="Browse all activities in ' + escapeHtml(cityName) + '">&#x1F50D; Browse ' + escapeHtml(cityName) + '</button>';
                header.innerHTML = '<span>Day ' + dayData.day + ' â€” ' + escapeHtml(dayData.title) + '</span><div style="display:flex;gap:6px;align-items:center;">' + browseBtn + resetBtn + '<span class="day-card-toggle">â–¼</span></div>';

                const content = document.createElement('div');
                content.className = 'day-card-content';

                dayData.items.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = `day-item ${item.type}`;
                    if (item.coord) {
                        itemEl.classList.add('has-coord');
                        itemEl.onclick = () => panToMarker(item.coord[0], item.coord[1], item.name);
                    }
                    const swapIcon = (item.type !== 'nap' && item.coord) ? '<button class="day-item-swap" onclick="event.stopPropagation(); openSwapPanel(\x27' + key + '\x27,' + dayData.day + ',' + dayData.items.indexOf(item) + ')" title="Swap activity">&#x21c4;</button>' : '';
                    itemEl.innerHTML = '<span class="day-item-type">' + formatType(item.type) + '</span><span class="day-item-name">' + escapeHtml(item.name) + '</span>' + swapIcon;
                    content.appendChild(itemEl);
                });

                // Export bar (Phase 3)
                const exportBar = document.createElement('div');
                exportBar.className = 'day-export-bar';
                exportBar.innerHTML = '<button class="day-export-btn export-text" onclick="event.stopPropagation(); exportDayText(\x27' + key + '\x27,' + dayData.day + ')" title="Copy day schedule as text">\u{1F4CB} Copy</button>' +
                    '<button class="day-export-btn export-gmaps" onclick="event.stopPropagation(); exportDayGoogleMaps(\x27' + key + '\x27,' + dayData.day + ')" title="Open route in Google Maps">\u{1F5FA} Maps</button>' +
                    '<button class="day-export-btn export-qr" onclick="event.stopPropagation(); exportDayQR(\x27' + key + '\x27,' + dayData.day + ')" title="QR code for Google Maps route">\u{1F4F1} QR</button>';
                content.appendChild(exportBar);

                dayCard.appendChild(header);
                dayCard.appendChild(content);
                container.appendChild(dayCard);
            });
        }

        // ============================================
        // Phase 3: Export & Sharing Functions
        // ============================================
        function exportDayText(key, dayNum) {
            var itin = itineraryData[key];
            var dayData = itin.days.find(function(d) { return d.day === dayNum; });
            if (!dayData) return;

            var typeEmoji = {
                hotel: '\u{1F3E8}', breakfast: '\u{1F373}', lunch: '\u{1F35C}', dinner: '\u{1F357}',
                sightseeing: '\u{1F5FA}', optional: '\u2728', nap: '\u{1F634}'
            };

            var dest = destinations[activeDestination] || {};
            var text = (dest.flag || '\u{1F30D}') + ' ' + (dest.name || 'Trip') + '\n';
            text += itin.name + ' \u2014 Day ' + dayData.day + '\n';
            text += '\u{1F4CD} ' + dayData.title + '\n';
            text += '\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n';

            dayData.items.forEach(function(item) {
                var emoji = typeEmoji[item.type] || '\u{1F4CB}';
                text += emoji + ' ' + item.name + '\n';
            });

            text += '\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n';
            text += 'Generated from Japan Trip Map';

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(function() {
                    showCopyToast('Copied to clipboard!');
                }).catch(function() {
                    copyFallback(text);
                });
            } else {
                copyFallback(text);
            }
        }

        function copyFallback(text) {
            var ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.opacity = '0';
            document.body.appendChild(ta);
            ta.select();
            try { document.execCommand('copy'); } catch(e) {}
            document.body.removeChild(ta);
            showCopyToast('Copied to clipboard!');
        }

        function exportDayGoogleMaps(key, dayNum) {
            var itin = itineraryData[key];
            var dayData = itin.days.find(function(d) { return d.day === dayNum; });
            if (!dayData) return;

            var coords = dayData.items
                .filter(function(item) { return item.coord && item.type !== 'nap'; })
                .map(function(item) { return item.coord[0] + ',' + item.coord[1]; });

            if (coords.length === 0) {
                showCopyToast('No locations with coordinates');
                return;
            }

            var url;
            if (coords.length === 1) {
                url = 'https://www.google.com/maps/search/?api=1&query=' + coords[0];
            } else {
                url = 'https://www.google.com/maps/dir/' + coords.join('/');
            }

            window.open(url, '_blank');
        }

        function exportDayQR(key, dayNum) {
            var itin = itineraryData[key];
            var dayData = itin.days.find(function(d) { return d.day === dayNum; });
            if (!dayData) return;

            var coords = dayData.items
                .filter(function(item) { return item.coord && item.type !== 'nap'; })
                .map(function(item) { return item.coord[0] + ',' + item.coord[1]; });

            if (coords.length === 0) {
                showCopyToast('No locations with coordinates');
                return;
            }

            var mapsUrl;
            if (coords.length === 1) {
                mapsUrl = 'https://www.google.com/maps/search/?api=1&query=' + coords[0];
            } else {
                mapsUrl = 'https://www.google.com/maps/dir/' + coords.join('/');
            }

            var qrUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + encodeURIComponent(mapsUrl);

            document.getElementById('qrTitle').textContent = itin.name + ' \u2014 Day ' + dayData.day;
            document.getElementById('qrSubtitle').textContent = dayData.title;
            document.getElementById('qrImage').src = qrUrl;
            document.getElementById('qrLink').href = mapsUrl;
            document.getElementById('qrLink').textContent = 'Open in Google Maps \u2192';
            document.getElementById('qrOverlay').classList.add('active');
        }

        function closeQrModal() {
            document.getElementById('qrOverlay').classList.remove('active');
        }

        function showCopyToast(message) {
            var toast = document.getElementById('copyToast');
            toast.textContent = message || 'Copied!';
            toast.classList.add('show');
            setTimeout(function() { toast.classList.remove('show'); }, 2000);
        }

        function toggleDayCard(header, dayNum, key) {
            const content = header.nextElementSibling;
            content.classList.toggle('open');
            header.classList.toggle('active');
            header.querySelector('.day-card-toggle').classList.toggle('open');

            if (content.classList.contains('open')) {
                showDay(key, dayNum);
                updateChatContext();
            } else if (allDaysActive) {
                showAllDays();
            }
        }

        // ============================================
        // HOW TO ADD A NEW DESTINATION
        // ============================================
        //
        // 1. Create POI arrays (copy this template, replace COUNTRY with your destination key):
        //
        //    const hotels_COUNTRY = [
        //        {"name": "Hotel Name", "coord": [LAT, LNG], "desc": "Short description"},
        //    ];
        //    const restaurants_COUNTRY = [ /* same format */ ];
        //    const experiences_COUNTRY = [ /* same format */ ];
        //    const kidFriendly_COUNTRY = [ /* same format */ ];
        //    const markets_COUNTRY = [ /* same format */ ];
        //
        // 2. Create city centers (for the City Activity Browser):
        //
        //    const cityCenters_COUNTRY = {
        //        'City Name': [LAT, LNG, RADIUS],  // radius ~0.15 for large cities
        //    };
        //
        // 3. Create itineraries (use keys "a", "b", "c" etc.):
        //    Supported types: hotel, breakfast, lunch, dinner, sightseeing, optional, nap
        //
        //    const itineraryData_COUNTRY = {
        //        "a": {
        //            "name": "Itinerary Display Name",
        //            "color": "#2563EB",
        //            "days": [
        //                {"day": 1, "title": "Day Title", "items": [
        //                    {"type": "hotel", "name": "Hotel", "coord": [LAT, LNG]},
        //                    {"type": "sightseeing", "name": "Activity", "coord": [LAT, LNG]},
        //                    {"type": "lunch", "name": "Restaurant", "coord": [LAT, LNG]},
        //                    {"type": "dinner", "name": "Restaurant", "coord": [LAT, LNG]}
        //                ]}
        //            ]
        //        }
        //    };
        //    let originalItineraryData_COUNTRY = JSON.parse(JSON.stringify(itineraryData_COUNTRY));
        //
        // 4. Register the destination:
        //
        //    destinations['country'] = {
        //        name: 'Country Family Adventure',
        //        subtitle: 'Interactive Trip Map',
        //        flag: '\u{1F1XX}\u{1F1XX}',
        //        defaultCenter: [LAT, LNG],
        //        defaultZoom: 6,
        //        hotels: hotels_COUNTRY,
        //        restaurants: restaurants_COUNTRY,
        //        experiences: experiences_COUNTRY,
        //        kidFriendly: kidFriendly_COUNTRY,
        //        markets: markets_COUNTRY,
        //        itineraryData: itineraryData_COUNTRY,
        //        cityCenters: cityCenters_COUNTRY,
        //        originalItineraryData: originalItineraryData_COUNTRY
        //    };
        //
        // That's it! The dropdown, map, and all features work automatically.
        // ============================================

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        function panToMarker(lat, lng, name) {
            map.flyTo([lat, lng], 14, { duration: 1 });
            
            // Find and open popup
            itineraryMarkers.forEach(m => {
                if (Math.abs(m.marker.getLatLng().lat - lat) < 0.0001 && Math.abs(m.marker.getLatLng().lng - lng) < 0.0001) {
                    setTimeout(() => m.marker.openPopup(), 500);
                }
            });
        }

        function formatType(type) {
            const typeMap = {
                'breakfast': 'Breakfast',
                'lunch': 'Lunch',
                'dinner': 'Dinner',
                'sightseeing': 'Sightseeing',
                'hotel': 'Hotel',
                'nap': 'Nap',
                'optional': 'Optional'
            };
            return typeMap[type] || type;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // ============================================
        // NOTES STORAGE FUNCTIONS
        // ============================================

        // ============================================
        // MULTI-USER & NOTES SYSTEM
        // ============================================

        let currentUser = 'default';
        (function() {
            try {
                const params = new URLSearchParams(window.location.search);
                currentUser = params.get('user') || 'default';
            } catch(e) {}
        })();

        function getNoteKey(destKey, poiName) {
            return 'tripMap_notes_' + currentUser + '_' + destKey + '_' + poiName.replace(/[^a-zA-Z0-9]/g, '_');
        }

        function getNote(destKey, poiName) {
            // Check new namespaced key first, fall back to legacy key
            const val = localStorage.getItem(getNoteKey(destKey, poiName));
            if (val) return val;
            // Legacy migration: check old key format (no user prefix)
            const legacyKey = 'tripMap_notes_' + destKey + '_' + poiName.replace(/[^a-zA-Z0-9]/g, '_');
            const legacyVal = localStorage.getItem(legacyKey);
            if (legacyVal && currentUser === 'default') {
                // Migrate to new key
                localStorage.setItem(getNoteKey(destKey, poiName), legacyVal);
                localStorage.removeItem(legacyKey);
                return legacyVal;
            }
            return '';
        }

        function setNote(destKey, poiName, text) {
            const key = getNoteKey(destKey, poiName);
            if (text.trim()) {
                localStorage.setItem(key, text.trim());
            } else {
                localStorage.removeItem(key);
            }
            updateNoteIndicators();
        }

        function getAllNotes(destKey) {
            const notes = [];
            const prefix = 'tripMap_notes_' + currentUser + '_' + destKey + '_';
            const legacyPrefix = 'tripMap_notes_' + destKey + '_';
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(prefix)) {
                    const poiName = key.replace(prefix, '').replace(/_/g, ' ');
                    notes.push({ poiName, text: localStorage.getItem(key) });
                } else if (currentUser === 'default' && key.startsWith(legacyPrefix) && !key.startsWith('tripMap_notes_default_')) {
                    // Legacy notes (no user prefix) â€” only show for default user
                    const poiPart = key.replace(legacyPrefix, '');
                    // Ensure this isn't actually a user-prefixed key
                    if (!poiPart.includes('tripMap_')) {
                        const poiName = poiPart.replace(/_/g, ' ');
                        notes.push({ poiName, text: localStorage.getItem(key) });
                    }
                }
            }
            return notes;
        }

        function updateNoteIndicators() {
            if (activeDestination) {
                const sidebar = document.getElementById('sidebarContent');
                if (sidebar) {
                    const items = sidebar.querySelectorAll('[data-poi-name]');
                    items.forEach(item => {
                        const poiName = item.getAttribute('data-poi-name');
                        const hasNote = getNote(activeDestination, poiName);
                        const hasAnnotation = getAnnotationsForPoi(activeDestination, poiName).length > 0;
                        const noteIcon = item.querySelector('.note-indicator');
                        if (hasNote || hasAnnotation) {
                            if (!noteIcon) {
                                const icon = document.createElement('span');
                                icon.className = 'note-indicator';
                                icon.textContent = hasAnnotation ? ' ðŸ”–' : ' ðŸ“';
                                icon.title = hasAnnotation ? 'Has booking' : 'Has notes';
                                item.appendChild(icon);
                            } else {
                                noteIcon.textContent = hasAnnotation ? ' ðŸ”–' : ' ðŸ“';
                            }
                        } else {
                            if (noteIcon) noteIcon.remove();
                        }
                    });
                }
            }
        }

        function showNotesPanel() {
            const notes = getAllNotes(activeDestination);
            let html = '<div style="padding:16px"><h3 style="margin:0 0 12px;font-size:16px;">ðŸ“ My Notes';
            const destInfo = destinations[activeDestination];
            if (destInfo) html += ' â€” ' + escapeHtml(destInfo.name || activeDestination);
            html += '</h3>';
            if (currentUser !== 'default') html += '<div class="user-indicator">Viewing as: ' + escapeHtml(currentUser) + '</div>';
            if (notes.length === 0) {
                html += '<p style="color:#9ca3af;font-size:14px;margin:0;">No notes yet. Click on any place to add a note.</p>';
            } else {
                notes.forEach(n => {
                    html += '<div style="margin-bottom:12px;padding:8px;background:#f9fafb;border-radius:6px;border:1px solid #e5e7eb">';
                    html += '<div style="font-weight:600;font-size:13px;color:#333;margin-bottom:4px;">' + escapeHtml(n.poiName) + '</div>';
                    html += '<div style="font-size:12px;color:#6b7280;margin:4px 0;white-space:pre-wrap;line-height:1.4;">' + escapeHtml(n.text) + '</div>';
                    html += '</div>';
                });
            }
            // Import/export buttons
            html += '<div style="margin-top:16px;border-top:1px solid #e5e7eb;padding-top:12px;display:flex;gap:8px;">';
            html += '<button onclick="exportNotesAndAnnotations()" style="flex:1;padding:6px 10px;font-size:11px;font-weight:600;background:#2563EB;color:white;border:none;border-radius:6px;cursor:pointer;">Export All</button>';
            html += '<button onclick="document.getElementById(\'importFileInput\').click()" style="flex:1;padding:6px 10px;font-size:11px;font-weight:600;background:white;color:#2563EB;border:1.5px solid #2563EB;border-radius:6px;cursor:pointer;">Import</button>';
            html += '<input type="file" id="importFileInput" accept=".json" style="display:none" onchange="importNotesAndAnnotations(this.files[0])">';
            html += '</div>';
            html += '</div>';
            const panel = document.getElementById('notesPanel');
            const overlay = document.getElementById('notesPanelOverlay');
            if (panel) { panel.innerHTML = html; panel.style.display = 'flex'; }
            if (overlay) { overlay.style.display = 'block'; }
        }

        function closeNotesPanel() {
            const panel = document.getElementById('notesPanel');
            const overlay = document.getElementById('notesPanelOverlay');
            if (panel) panel.style.display = 'none';
            if (overlay) overlay.style.display = 'none';
        }

        // ============================================
        // PERSONAL ANNOTATIONS SYSTEM
        // ============================================

        let personalAnnotations = {};  // destKey â†’ array (from personal.json)
        let browserAnnotations = {};   // destKey â†’ array (from localStorage)

        async function loadPersonalAnnotations(destKey) {
            try {
                const resp = await fetch('personal/' + destKey + '.json');
                if (resp.ok) {
                    const data = await resp.json();
                    personalAnnotations[destKey] = data.annotations || [];
                    return personalAnnotations[destKey];
                }
            } catch(e) {}
            personalAnnotations[destKey] = [];
            return [];
        }

        function loadBrowserAnnotations(destKey) {
            try {
                const raw = localStorage.getItem('tripMap_annotations_' + currentUser + '_' + destKey);
                if (raw) {
                    browserAnnotations[destKey] = JSON.parse(raw);
                    return browserAnnotations[destKey];
                }
            } catch(e) {}
            browserAnnotations[destKey] = [];
            return [];
        }

        function saveBrowserAnnotations(destKey) {
            try {
                const arr = browserAnnotations[destKey] || [];
                if (arr.length > 0) {
                    localStorage.setItem('tripMap_annotations_' + currentUser + '_' + destKey, JSON.stringify(arr));
                } else {
                    localStorage.removeItem('tripMap_annotations_' + currentUser + '_' + destKey);
                }
            } catch(e) {}
        }

        function getAllAnnotations(destKey) {
            const staticAnns = personalAnnotations[destKey] || [];
            const browserAnns = browserAnnotations[destKey] || [];
            return staticAnns.concat(browserAnns).sort((a, b) => {
                if (!a.date) return 1;
                if (!b.date) return -1;
                return a.date.localeCompare(b.date);
            });
        }

        function getAnnotationsForPoi(destKey, poiName) {
            return getAllAnnotations(destKey).filter(a => a.poiName === poiName);
        }

        function formatAnnotationDate(dateStr) {
            if (!dateStr) return '';
            try {
                const d = new Date(dateStr + (dateStr.includes('T') ? '' : 'T00:00:00'));
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            } catch(e) { return dateStr; }
        }

        function getAnnotationTypeIcon(type, subtype) {
            if (type === 'reservation') {
                if (subtype === 'hotel') return 'ðŸ¨';
                if (subtype === 'restaurant') return 'ðŸ½ï¸';
                if (subtype === 'activity') return 'ðŸŽŸï¸';
                return 'ðŸ“‹';
            }
            if (type === 'ticket') return 'ðŸŽ«';
            return 'ðŸ“Œ';
        }

        function buildAnnotationHtml(annotations) {
            if (!annotations || annotations.length === 0) return '';
            let html = '<div style="margin-top:8px;border-top:1px solid #e5e7eb;padding-top:8px">';
            html += '<div style="font-size:11px;font-weight:600;color:#92400e;margin-bottom:4px">ðŸ”– Bookings</div>';
            annotations.forEach(ann => {
                const icon = getAnnotationTypeIcon(ann.type, ann.subtype);
                const dateStr = formatAnnotationDate(ann.date);
                const endDateStr = ann.endDate ? ' â†’ ' + formatAnnotationDate(ann.endDate) : '';
                const statusClass = (ann.status || 'confirmed').toLowerCase();
                html += '<div class="annotation-card">';
                html += '<div class="annotation-card-header">';
                html += '<span>' + icon + ' ' + escapeHtml(ann.subtype || ann.type || '') + '</span>';
                html += '<span class="annotation-status ' + statusClass + '">' + escapeHtml(ann.status || 'confirmed') + '</span>';
                html += '</div>';
                if (dateStr) html += '<div style="font-size:10px;color:#b45309;margin-bottom:2px">' + dateStr + endDateStr + '</div>';
                if (ann.details) html += '<div class="annotation-card-details">' + escapeHtml(ann.details) + '</div>';
                if (ann.source === 'browser') {
                    html += '<button onclick="deleteBrowserAnnotation(\'' + (activeDestination || 'default') + '\',\'' + (ann.id || '').replace(/'/g, "\\'") + '\')" style="margin-top:4px;padding:1px 6px;font-size:9px;background:none;color:#dc2626;border:1px solid #fecaca;border-radius:3px;cursor:pointer;">Remove</button>';
                }
                html += '</div>';
            });
            html += '</div>';
            return html;
        }

        function buildAnnotationFormHtml(destKey, poiName) {
            const safePoi = poiName.replace(/'/g, "\\'");
            const safeDest = (destKey || 'default').replace(/'/g, "\\'");
            let html = '<div style="margin-top:6px">';
            html += '<button onclick="this.style.display=\'none\';this.nextElementSibling.style.display=\'block\'" style="padding:3px 8px;font-size:10px;font-weight:600;background:#fffbeb;color:#92400e;border:1px solid #fde68a;border-radius:4px;cursor:pointer;width:100%">+ Add Booking</button>';
            html += '<div class="annotation-form" style="display:none">';
            html += '<label>Type</label><select id="annFormType_' + safePoi.replace(/[^a-zA-Z0-9]/g, '_') + '"><option value="reservation">Reservation</option><option value="ticket">Ticket</option><option value="note">Note</option></select>';
            html += '<label>Subtype</label><select id="annFormSubtype_' + safePoi.replace(/[^a-zA-Z0-9]/g, '_') + '"><option value="restaurant">Restaurant</option><option value="hotel">Hotel</option><option value="activity">Activity</option><option value="museum">Museum</option><option value="tour">Tour</option><option value="show">Show</option></select>';
            html += '<label>Date</label><input type="date" id="annFormDate_' + safePoi.replace(/[^a-zA-Z0-9]/g, '_') + '">';
            html += '<label>End Date (hotels)</label><input type="date" id="annFormEndDate_' + safePoi.replace(/[^a-zA-Z0-9]/g, '_') + '">';
            html += '<label>Details</label><input type="text" id="annFormDetails_' + safePoi.replace(/[^a-zA-Z0-9]/g, '_') + '" placeholder="Confirmation #, party size, notes...">';
            html += '<label>Status</label><select id="annFormStatus_' + safePoi.replace(/[^a-zA-Z0-9]/g, '_') + '"><option value="confirmed">Confirmed</option><option value="pending">Pending</option></select>';
            html += '<button onclick="saveBrowserAnnotationFromForm(\'' + safeDest + '\',\'' + safePoi + '\')" style="margin-top:8px;padding:4px 10px;font-size:11px;font-weight:600;background:#f59e0b;color:white;border:none;border-radius:4px;cursor:pointer;width:100%">Save Booking</button>';
            html += '</div></div>';
            return html;
        }

        function saveBrowserAnnotationFromForm(destKey, poiName) {
            const safeId = poiName.replace(/[^a-zA-Z0-9]/g, '_');
            const type = document.getElementById('annFormType_' + safeId).value;
            const subtype = document.getElementById('annFormSubtype_' + safeId).value;
            const date = document.getElementById('annFormDate_' + safeId).value;
            const endDate = document.getElementById('annFormEndDate_' + safeId).value;
            const details = document.getElementById('annFormDetails_' + safeId).value;
            const status = document.getElementById('annFormStatus_' + safeId).value;
            if (!details && !date) { showCopyToast('Please add a date or details'); return; }
            const ann = {
                id: destKey + '_' + safeId + '_' + Date.now(),
                poiName: poiName,
                type: type,
                subtype: subtype,
                status: status,
                date: date || null,
                endDate: endDate || null,
                details: details,
                addedBy: currentUser,
                source: 'browser'
            };
            if (!browserAnnotations[destKey]) browserAnnotations[destKey] = [];
            browserAnnotations[destKey].push(ann);
            saveBrowserAnnotations(destKey);
            showCopyToast('Booking saved!');
            updateNoteIndicators();
            updateBookingsBadge();
        }

        function deleteBrowserAnnotation(destKey, annId) {
            if (!confirm('Remove this booking?')) return;
            if (browserAnnotations[destKey]) {
                browserAnnotations[destKey] = browserAnnotations[destKey].filter(a => a.id !== annId);
                saveBrowserAnnotations(destKey);
                updateNoteIndicators();
                updateBookingsBadge();
                showCopyToast('Booking removed');
            }
        }

        // Bookings panel
        function updateBookingsBadge() {
            const btn = document.getElementById('bookingsBtn');
            if (!btn) return;
            const count = getAllAnnotations(activeDestination).length;
            const badge = btn.querySelector('.bookings-count-badge');
            if (count > 0) {
                if (badge) { badge.textContent = count; }
                else { btn.innerHTML = 'ðŸ”– Bookings <span class="bookings-count-badge">' + count + '</span>'; }
            } else {
                if (badge) badge.remove();
            }
        }

        function showBookingsPanel() {
            const allAnns = getAllAnnotations(activeDestination);
            const now = new Date().toISOString().split('T')[0];
            let html = '<div style="padding:16px">';
            html += '<h3 style="margin:0 0 8px;font-size:16px;">ðŸ”– Bookings';
            const destInfo = destinations[activeDestination];
            if (destInfo) html += ' â€” ' + escapeHtml(destInfo.name || activeDestination);
            html += '</h3>';
            if (currentUser !== 'default') html += '<div class="user-indicator">Viewing as: ' + escapeHtml(currentUser) + '</div>';
            if (allAnns.length === 0) {
                html += '<p style="color:#9ca3af;font-size:14px;margin:0;">No bookings yet. Click on any place and use "Add Booking" to add one, or ask Claude to build a personal.json file from your confirmations.</p>';
            } else {
                // Split into upcoming and past
                const upcoming = allAnns.filter(a => !a.date || a.date >= now);
                const past = allAnns.filter(a => a.date && a.date < now);
                if (upcoming.length > 0) {
                    html += '<div style="font-size:12px;font-weight:600;color:#6b7280;margin:12px 0 6px;text-transform:uppercase;letter-spacing:0.5px;">Upcoming</div>';
                    upcoming.forEach(ann => { html += buildBookingItemHtml(ann); });
                }
                if (past.length > 0) {
                    html += '<div style="font-size:12px;font-weight:600;color:#6b7280;margin:12px 0 6px;text-transform:uppercase;letter-spacing:0.5px;">Past</div>';
                    past.forEach(ann => { html += buildBookingItemHtml(ann); });
                }
            }
            html += '</div>';
            const panel = document.getElementById('bookingsPanel');
            const overlay = document.getElementById('bookingsPanelOverlay');
            if (panel) { panel.innerHTML = html; panel.style.display = 'flex'; }
            if (overlay) { overlay.style.display = 'block'; }
        }

        function buildBookingItemHtml(ann) {
            const icon = getAnnotationTypeIcon(ann.type, ann.subtype);
            const dateStr = formatAnnotationDate(ann.date);
            const endDateStr = ann.endDate ? ' â†’ ' + formatAnnotationDate(ann.endDate) : '';
            const statusClass = (ann.status || 'confirmed').toLowerCase();
            // Find POI coords for map centering
            const poiInfo = poiLookup[ann.poiName];
            let clickAction = '';
            if (ann.poiName && poiInfo) {
                clickAction = 'closeBookingsPanel()';
            }
            let html = '<div class="booking-item" onclick="' + clickAction + '">';
            html += '<div class="booking-item-header">';
            html += '<span class="booking-item-name">' + icon + ' ' + escapeHtml(ann.poiName || 'Unknown') + '</span>';
            html += '<span class="annotation-status ' + statusClass + '">' + escapeHtml(ann.status || '') + '</span>';
            html += '</div>';
            if (dateStr) html += '<div class="booking-item-date">' + dateStr + endDateStr + '</div>';
            if (ann.details) html += '<div class="booking-item-details">' + escapeHtml(ann.details) + '</div>';
            if (ann.source === 'browser') {
                html += '<div style="margin-top:4px"><button onclick="event.stopPropagation();deleteBrowserAnnotation(\'' + (activeDestination || 'default').replace(/'/g, "\\'") + '\',\'' + (ann.id || '').replace(/'/g, "\\'") + '\');showBookingsPanel()" style="padding:2px 6px;font-size:9px;background:none;color:#dc2626;border:1px solid #fecaca;border-radius:3px;cursor:pointer;">Remove</button></div>';
            }
            html += '</div>';
            return html;
        }

        function closeBookingsPanel() {
            const panel = document.getElementById('bookingsPanel');
            const overlay = document.getElementById('bookingsPanelOverlay');
            if (panel) panel.style.display = 'none';
            if (overlay) overlay.style.display = 'none';
        }

        // Import/Export
        function exportNotesAndAnnotations() {
            const notes = getAllNotes(activeDestination);
            const anns = browserAnnotations[activeDestination] || [];
            const data = {
                destination: activeDestination,
                user: currentUser,
                exportDate: new Date().toISOString().split('T')[0],
                notes: notes,
                browserAnnotations: anns
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'travel-notes-' + activeDestination + '-' + data.exportDate + '.json';
            link.click();
            URL.revokeObjectURL(url);
            showCopyToast('Exported ' + notes.length + ' notes + ' + anns.length + ' bookings');
        }

        function importNotesAndAnnotations(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    let noteCount = 0, annCount = 0;
                    // Import notes
                    if (data.notes && Array.isArray(data.notes)) {
                        data.notes.forEach(n => {
                            if (n.poiName && n.text) {
                                setNote(activeDestination, n.poiName, n.text);
                                noteCount++;
                            }
                        });
                    }
                    // Import browser annotations
                    if (data.browserAnnotations && Array.isArray(data.browserAnnotations)) {
                        if (!browserAnnotations[activeDestination]) browserAnnotations[activeDestination] = [];
                        const existingIds = new Set(browserAnnotations[activeDestination].map(a => a.id));
                        data.browserAnnotations.forEach(ann => {
                            if (!existingIds.has(ann.id)) {
                                ann.source = 'browser';
                                browserAnnotations[activeDestination].push(ann);
                                annCount++;
                            }
                        });
                        saveBrowserAnnotations(activeDestination);
                    }
                    showCopyToast('Imported ' + noteCount + ' notes + ' + annCount + ' bookings');
                    updateNoteIndicators();
                    updateBookingsBadge();
                    showNotesPanel(); // Refresh the panel
                } catch(err) {
                    showCopyToast('Import failed: invalid file');
                }
            };
            reader.readAsText(file);
        }

        // ============================================
        // QUICK FILTER CHIPS (Phase 1c)
        // ============================================

        let activeFilterChips = new Set();

        // Base filter chip config (universal for all destinations)
        const baseFilterChipConfig = {
            hotels:     { categoryKey: 'hotels',     types: ['hotel'],                      namePattern: null },
            dining:     { categoryKey: 'restaurants', types: ['breakfast', 'lunch', 'dinner'], namePattern: null },
            sightseeing:{ categoryKey: 'experiences', types: ['sightseeing'],                  namePattern: null },
            kids:       { categoryKey: 'kidFriendly', types: ['optional', 'sightseeing'],      namePattern: /kid|child|play|zoo|aquarium|toy|family|playground/iu },
            markets:    { categoryKey: 'markets',     types: ['optional', 'sightseeing'],      namePattern: /market|bazaar|souk|mercado|markt/iu }
        };

        // Destination-specific extra filter chips
        const destFilterChips = {
            japan: {
                cameras:  { emoji: '\u{1F4F7}', label: 'Cameras',  categoryKey: null, types: ['optional'], namePattern: /\u{1F4F7}|camera|photo|film|lemon-sha|leica/iu },
                skincare: { emoji: '\u{1F9F4}', label: 'Skincare', categoryKey: null, types: ['optional'], namePattern: /\u{1F9F4}|skincare|beauty|shiseido|sk-ii|cosme|yojiya|aesop|makanai|isetan beauty/iu }
            }
        };

        // Active config (rebuilt per destination)
        let filterChipConfig = Object.assign({}, baseFilterChipConfig);

        // Chip definitions for building UI
        const baseChipDefs = [
            { key: 'hotels',      emoji: '\u{1F3E8}', label: 'Hotels' },
            { key: 'dining',      emoji: '\u{1F374}', label: 'Dining' },
            { key: 'sightseeing', emoji: '\u{1F5FA}', label: 'Sights' },
            { key: 'kids',        emoji: '\u{1F476}', label: 'Kids' },
            { key: 'markets',     emoji: '\u{1F6CD}', label: 'Markets' }
        ];

        function buildFilterChips() {
            const row = document.getElementById('filterChipsRow');
            row.innerHTML = '';
            activeFilterChips.clear();

            // Rebuild filterChipConfig for this destination
            filterChipConfig = Object.assign({}, baseFilterChipConfig);
            const extraChips = destFilterChips[activeDestination] || {};
            Object.assign(filterChipConfig, extraChips);

            // Build chip elements: first 3 base, then extras, then remaining base
            const chipOrder = [];
            chipOrder.push(baseChipDefs[0]); // Hotels
            chipOrder.push(baseChipDefs[1]); // Dining
            chipOrder.push(baseChipDefs[2]); // Sights

            // Insert destination-specific chips here
            Object.keys(extraChips).forEach(key => {
                chipOrder.push({ key: key, emoji: extraChips[key].emoji, label: extraChips[key].label });
            });

            chipOrder.push(baseChipDefs[3]); // Kids
            chipOrder.push(baseChipDefs[4]); // Markets

            chipOrder.forEach(chip => {
                const span = document.createElement('span');
                span.className = 'filter-chip';
                span.setAttribute('data-filter', chip.key);
                span.onclick = function() { toggleFilterChip(chip.key); };
                span.textContent = chip.emoji + ' ' + chip.label;
                row.appendChild(span);
            });

            // Add clear button
            const clearBtn = document.createElement('button');
            clearBtn.className = 'filter-chips-clear';
            clearBtn.id = 'filterChipsClear';
            clearBtn.onclick = clearFilterChips;
            clearBtn.style.display = 'none';
            clearBtn.textContent = 'Clear';
            row.appendChild(clearBtn);

            // Reset count display
            const countEl = document.getElementById('filterChipsCount');
            if (countEl) {
                countEl.classList.remove('active');
                countEl.textContent = '';
            }
        }

        function toggleFilterChip(filter) {
            if (activeFilterChips.has(filter)) {
                activeFilterChips.delete(filter);
            } else {
                activeFilterChips.add(filter);
            }

            // Update chip UI
            const chip = document.querySelector('.filter-chip[data-filter="' + filter + '"]');
            if (chip) chip.classList.toggle('active');

            // Show/hide clear button
            const clearBtn = document.getElementById('filterChipsClear');
            clearBtn.style.display = activeFilterChips.size > 0 ? 'inline-block' : 'none';

            applyFilterChips();
        }

        function clearFilterChips() {
            activeFilterChips.clear();
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            document.getElementById('filterChipsClear').style.display = 'none';
            document.getElementById('filterChipsCount').classList.remove('active');
            applyFilterChips();
        }

        function markerMatchesFilter(markerData) {
            // Check if a marker matches ANY of the active filters (OR logic)
            for (const filter of activeFilterChips) {
                const config = filterChipConfig[filter];
                if (!config) continue;

                // Check type match
                const typeMatch = config.types.includes(markerData.type);

                // For filters with namePattern, require BOTH type match and name match
                if (config.namePattern) {
                    if (typeMatch && config.namePattern.test(markerData.name || '')) return true;
                    // Also match by name alone for sightseeing-typed items
                    if (config.namePattern.test(markerData.name || '')) return true;
                } else {
                    // For simple type-based filters, just type match
                    if (typeMatch) return true;
                }
            }
            return false;
        }

        function applyFilterChips() {
            if (currentView === 'categories') {
                applyFilterChipsCategories();
            } else {
                applyFilterChipsItineraries();
            }
        }

        function applyFilterChipsCategories() {
            const countEl = document.getElementById('filterChipsCount');

            if (activeFilterChips.size === 0) {
                // No filters active â€” restore to checkbox state
                Object.keys(categoryGroups).forEach(key => {
                    const checkbox = document.querySelector('input[data-category="' + key + '"]');
                    if (checkbox && checkbox.checked) {
                        if (!map.hasLayer(categoryGroups[key])) categoryGroups[key].addTo(map);
                    } else {
                        if (map.hasLayer(categoryGroups[key])) categoryGroups[key].removeFrom(map);
                    }
                });
                countEl.classList.remove('active');
                return;
            }

            // Show only category layers that match active filter chips
            const showCategories = new Set();
            activeFilterChips.forEach(filter => {
                const config = filterChipConfig[filter];
                if (config && config.categoryKey) {
                    showCategories.add(config.categoryKey);
                }
                // For filters without a categoryKey (e.g. cameras, skincare), show experiences
                if (config && !config.categoryKey) {
                    showCategories.add('experiences');
                }
            });

            Object.keys(categoryGroups).forEach(key => {
                if (showCategories.has(key)) {
                    if (!map.hasLayer(categoryGroups[key])) categoryGroups[key].addTo(map);
                } else {
                    if (map.hasLayer(categoryGroups[key])) categoryGroups[key].removeFrom(map);
                }
            });

            countEl.classList.add('active');
            countEl.textContent = showCategories.size + ' categor' + (showCategories.size === 1 ? 'y' : 'ies') + ' shown';
        }

        function applyFilterChipsItineraries() {
            const countEl = document.getElementById('filterChipsCount');

            if (activeFilterChips.size === 0) {
                // No filters â€” restore normal visibility based on current day selection
                if (allDaysActive || !currentDay) {
                    itineraryMarkers.forEach(m => {
                        m.marker.setStyle({opacity: 1, fillOpacity: 0.85});
                    });
                    itineraryPolylines.forEach(p => {
                        p.polyline.setStyle({opacity: 0.5});
                    });
                } else {
                    itineraryMarkers.forEach(m => {
                        if (m.day === currentDay) {
                            m.marker.setStyle({opacity: 1, fillOpacity: 0.85});
                        } else {
                            m.marker.setStyle({opacity: 0.2, fillOpacity: 0.2});
                        }
                    });
                    itineraryPolylines.forEach(p => {
                        if (p.day === currentDay) {
                            p.polyline.setStyle({opacity: 0.5});
                        } else {
                            p.polyline.setStyle({opacity: 0.1});
                        }
                    });
                }
                countEl.classList.remove('active');
                return;
            }

            // Filters active â€” highlight matching, dim non-matching
            let matchCount = 0;
            itineraryMarkers.forEach(m => {
                const dayVisible = allDaysActive || !currentDay || m.day === currentDay;
                const matches = markerMatchesFilter(m);

                if (matches && dayVisible) {
                    m.marker.setStyle({opacity: 1, fillOpacity: 0.95, weight: 3});
                    m.marker.setRadius(9);
                    matchCount++;
                } else if (dayVisible) {
                    m.marker.setStyle({opacity: 0.15, fillOpacity: 0.15, weight: 2});
                    m.marker.setRadius(7);
                } else {
                    m.marker.setStyle({opacity: 0.08, fillOpacity: 0.08, weight: 2});
                    m.marker.setRadius(7);
                }
            });

            // Dim polylines when filtering
            itineraryPolylines.forEach(p => {
                const dayVisible = allDaysActive || !currentDay || p.day === currentDay;
                p.polyline.setStyle({opacity: dayVisible ? 0.15 : 0.05});
            });

            countEl.classList.add('active');
            countEl.textContent = matchCount + ' matching marker' + (matchCount !== 1 ? 's' : '') + ' highlighted';
        }


        // ============================================
        // REGION FILTERING
        // ============================================

        let activeRegion = null; // {name, bounds: [[minLat, minLng], [maxLat, maxLng]]}

        function buildRegionFilter() {
            const row = document.getElementById('regionFilterRow');
            const sel = document.getElementById('regionSelect');
            activeRegion = null;

            // Check if current destination has regions defined
            const dest = destinations[activeDestination];
            if (!dest || !dest.regions || dest.regions.length === 0) {
                row.style.display = 'none';
                return;
            }

            row.style.display = 'block';
            sel.innerHTML = '<option value="">All Regions</option>';
            dest.regions.forEach(function(region, idx) {
                const opt = document.createElement('option');
                opt.value = idx;
                opt.textContent = region.name;
                sel.appendChild(opt);
            });
        }

        function filterByRegion(value) {
            const dest = destinations[activeDestination];
            if (!dest || !dest.regions) return;

            if (value === '' || value === null) {
                activeRegion = null;
            } else {
                activeRegion = dest.regions[parseInt(value)];
            }

            // Re-apply to current view
            if (currentView === 'categories') {
                applyRegionFilterCategories();
            }
        }

        function isInRegion(coord, region) {
            if (!region || !region.bounds) return true;
            var lat = coord[0], lng = coord[1];
            var b = region.bounds;
            return lat >= b[0][0] && lat <= b[1][0] && lng >= b[0][1] && lng <= b[1][1];
        }

        function applyRegionFilterCategories() {
            if (!activeRegion) {
                // No region filter â€” reload all categories
                loadCategories();
                return;
            }

            // Filter each category group to only show markers in region
            var dest = destinations[activeDestination];
            var catArrays = {
                hotels: dest.hotels,
                restaurants: dest.restaurants,
                experiences: dest.experiences,
                kidFriendly: dest.kidFriendly,
                markets: dest.markets
            };

            Object.keys(categoryGroups).forEach(function(key) {
                if (map.hasLayer(categoryGroups[key])) categoryGroups[key].removeFrom(map);
                categoryGroups[key] = L.featureGroup();
            });

            var totalShown = 0;
            Object.keys(catArrays).forEach(function(key) {
                var items = catArrays[key] || [];
                items.forEach(function(item) {
                    if (!isInRegion(item.coord, activeRegion)) return;
                    totalShown++;
                    var marker = L.circleMarker(item.coord, {
                        radius: 7,
                        fillColor: categoryColors[key],
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.85
                    });
                    marker.bindPopup('<strong>' + escapeHtml(item.name) + '</strong><br>' + escapeHtml(item.desc || ''));
                    categoryGroups[key].addLayer(marker);
                });

                var checkbox = document.querySelector('input[data-category="' + key + '"]');
                if (checkbox && checkbox.checked) {
                    categoryGroups[key].addTo(map);
                }
            });

            var countEl = document.getElementById('filterChipsCount');
            countEl.classList.add('active');
            countEl.textContent = activeRegion.name + ': ' + totalShown + ' places';
        }


        // ============================================
        // GEOLOCATION - WHERE AM I? (Phase 1d)
        // ============================================

        let geoMarker = null;
        let geoAccuracyCircle = null;
        let geoWatchId = null;
        let nearbyIsOpen = false;

        function haversineDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function geoLocate() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser.');
                return;
            }

            const fab = document.getElementById('geoFab');
            fab.classList.add('loading');

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    fab.classList.remove('loading');
                    fab.classList.add('active');
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy; // meters

                    showUserLocation(lat, lng, accuracy);
                    findAndShowNearby(lat, lng);

                    // Start watching position for updates
                    if (geoWatchId) navigator.geolocation.clearWatch(geoWatchId);
                    geoWatchId = navigator.geolocation.watchPosition(
                        function(pos) {
                            updateUserLocation(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy);
                        },
                        function() {},
                        { enableHighAccuracy: true, maximumAge: 30000, timeout: 15000 }
                    );
                },
                function(error) {
                    fab.classList.remove('loading');
                    let msg = 'Could not determine your location.';
                    if (error.code === 1) msg = 'Location access denied. Please enable location permissions for this page.';
                    else if (error.code === 2) msg = 'Location unavailable. Please check your device settings.';
                    else if (error.code === 3) msg = 'Location request timed out. Please try again.';
                    alert(msg);
                },
                { enableHighAccuracy: true, maximumAge: 60000, timeout: 10000 }
            );
        }

        function showUserLocation(lat, lng, accuracy) {
            // Remove existing markers
            if (geoMarker) map.removeLayer(geoMarker);
            if (geoAccuracyCircle) map.removeLayer(geoAccuracyCircle);

            // Accuracy circle
            geoAccuracyCircle = L.circle([lat, lng], {
                radius: accuracy,
                className: 'geo-accuracy',
                interactive: false
            }).addTo(map);

            // Pulsing blue dot
            const dotIcon = L.divIcon({
                className: 'geo-dot-wrapper',
                html: '<div class="geo-dot"></div>',
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });
            geoMarker = L.marker([lat, lng], { icon: dotIcon, zIndexOffset: 1000 }).addTo(map);
            geoMarker.bindPopup('<div style="text-align:center;font-size:12px;font-weight:600;">You are here</div><div style="text-align:center;font-size:11px;color:#666;">\u00b1' + Math.round(accuracy) + 'm accuracy</div>');

            // Fly to location
            map.flyTo([lat, lng], 15, { duration: 1.5 });
        }

        function updateUserLocation(lat, lng, accuracy) {
            if (geoMarker) {
                geoMarker.setLatLng([lat, lng]);
            }
            if (geoAccuracyCircle) {
                geoAccuracyCircle.setLatLng([lat, lng]);
                geoAccuracyCircle.setRadius(accuracy);
            }
        }

        function findAndShowNearby(lat, lng) {
            const radiusKm = 2;
            const allItems = [];

            // Search all category arrays
            const addItems = (items, category, color) => {
                items.forEach(item => {
                    if (!item.coord) return;
                    const dist = haversineDistance(lat, lng, item.coord[0], item.coord[1]);
                    if (dist <= radiusKm) {
                        allItems.push({
                            name: item.name,
                            desc: item.desc || '',
                            coord: item.coord,
                            category: category,
                            color: color,
                            distance: dist
                        });
                    }
                });
            };

            addItems(hotels, 'Hotel', categoryColors.hotels);
            addItems(restaurants, 'Restaurant', categoryColors.restaurants);
            addItems(experiences, 'Experience', categoryColors.experiences);
            addItems(kidFriendly, 'Kid-Friendly', categoryColors.kidFriendly);
            addItems(markets, 'Market', categoryColors.markets);

            // Also search current itinerary items if in itinerary view
            if (currentView === 'itineraries' && currentItinerary) {
                const itin = itineraryData[currentItinerary];
                itin.days.forEach(dayData => {
                    dayData.items.forEach(item => {
                        if (!item.coord) return;
                        const dist = haversineDistance(lat, lng, item.coord[0], item.coord[1]);
                        if (dist <= radiusKm) {
                            // Check if already in list (by name)
                            if (!allItems.some(a => a.name === item.name)) {
                                allItems.push({
                                    name: item.name,
                                    desc: 'Day ' + dayData.day + ' \u2014 ' + formatType(item.type),
                                    coord: item.coord,
                                    category: formatType(item.type),
                                    color: typeColors[item.type] || '#666',
                                    distance: dist
                                });
                            }
                        }
                    });
                });
            }

            // Sort by distance
            allItems.sort((a, b) => a.distance - b.distance);

            showNearbyPanel(allItems, lat, lng);
        }

        function showNearbyPanel(items, lat, lng) {
            const panel = document.getElementById('nearbyPanel');
            const body = document.getElementById('nearbyBody');
            const subtitle = document.getElementById('nearbySubtitle');

            if (items.length === 0) {
                subtitle.textContent = 'No activities found within 2km';
                body.innerHTML = '<div class="nearby-empty">No nearby activities found.<br><span style="font-size:11px;color:#bbb;margin-top:4px;display:block;">Try zooming out or checking a different area.</span></div>';
            } else {
                subtitle.textContent = items.length + ' activit' + (items.length === 1 ? 'y' : 'ies') + ' within 2km';

                let html = '';
                items.forEach(item => {
                    const distText = item.distance < 0.1
                        ? Math.round(item.distance * 1000) + 'm'
                        : item.distance.toFixed(1) + 'km';
                    html += '<div class="nearby-item" onclick="panToNearby(' + item.coord[0] + ',' + item.coord[1] + ',\x27' + escapeHtml(item.name).replace(/'/g, '\x27') + '\x27)">';
                    html += '<div class="nearby-item-dot" style="background:' + item.color + '"></div>';
                    html += '<div class="nearby-item-info">';
                    html += '<div class="nearby-item-name">' + escapeHtml(item.name) + '</div>';
                    if (item.desc) html += '<div class="nearby-item-desc">' + escapeHtml(item.desc) + '</div>';
                    html += '</div>';
                    html += '<div class="nearby-item-dist">' + distText + '</div>';
                    html += '</div>';
                });
                body.innerHTML = html;
            }

            panel.classList.add('active');
            nearbyIsOpen = true;
        }

        function closeNearbyPanel() {
            document.getElementById('nearbyPanel').classList.remove('active');
            nearbyIsOpen = false;
        }

        function panToNearby(lat, lng, name) {
            map.flyTo([lat, lng], 16, { duration: 0.8 });

            // Try to open the marker popup
            const allMarkers = [...itineraryMarkers];
            // Also check category group markers
            Object.values(categoryGroups).forEach(group => {
                if (map.hasLayer(group)) {
                    group.eachLayer(m => {
                        const ll = m.getLatLng();
                        if (Math.abs(ll.lat - lat) < 0.0001 && Math.abs(ll.lng - lng) < 0.0001) {
                            setTimeout(() => m.openPopup(), 600);
                        }
                    });
                }
            });
            itineraryMarkers.forEach(m => {
                if (Math.abs(m.marker.getLatLng().lat - lat) < 0.0001 && Math.abs(m.marker.getLatLng().lng - lng) < 0.0001) {
                    setTimeout(() => m.marker.openPopup(), 600);
                }
            });
        }

        function stopGeoWatch() {
            if (geoWatchId) {
                navigator.geolocation.clearWatch(geoWatchId);
                geoWatchId = null;
            }
            if (geoMarker) {
                map.removeLayer(geoMarker);
                geoMarker = null;
            }
            if (geoAccuracyCircle) {
                map.removeLayer(geoAccuracyCircle);
                geoAccuracyCircle = null;
            }
            document.getElementById('geoFab').classList.remove('active');
            closeNearbyPanel();
        }


        // ============================================
        // CITY ACTIVITY BROWSER (Phase 1b)
        // ============================================

        let browserIsOpen = false;
        let browserContext = null;
        let browserFilter = 'all';
        let browserSelectedActivity = null;

        function openCityBrowser(itinKey, dayNum) {
            const itin = itineraryData[itinKey];
            const dayData = itin.days.find(d => d.day === dayNum);
            if (!dayData) return;

            const cityCenter = findCityCenter(dayData.title);
            const cityName = cityCenter ? cityCenter.name : extractCity(dayData.title);

            if (!cityCenter) {
                alert('Could not determine city for this day.');
                return;
            }

            // Gather all activities near this city
            const allActivities = [];

            const filterByCity = (items, category) => {
                return items.filter(item =>
                    item.coord &&
                    Math.abs(item.coord[0] - cityCenter.lat) < cityCenter.radius &&
                    Math.abs(item.coord[1] - cityCenter.lng) < cityCenter.radius
                ).map(item => ({...item, category}));
            };

            allActivities.push(...filterByCity(hotels, 'hotels'));
            allActivities.push(...filterByCity(restaurants, 'restaurants'));
            allActivities.push(...filterByCity(experiences, 'experiences'));
            allActivities.push(...filterByCity(kidFriendly, 'kidFriendly'));
            allActivities.push(...filterByCity(markets, 'markets'));

            browserContext = {
                itinKey,
                dayNum,
                city: cityName,
                activities: allActivities,
                dayData
            };

            // Update UI
            document.getElementById('browserTitle').textContent = 'Browse ' + cityName;
            document.getElementById('browserSubtitle').textContent = allActivities.length + ' activities near ' + cityName;
            document.getElementById('browserSearch').value = '';
            browserFilter = 'all';

            // Reset chips
            document.querySelectorAll('.browser-chip').forEach(c => c.classList.remove('active'));
            document.querySelector('.browser-chip[data-filter="all"]').classList.add('active');

            renderBrowserActivities();

            document.getElementById('browserOverlay').classList.add('active');
            document.getElementById('cityBrowser').classList.add('active');
            browserIsOpen = true;
        }

        function closeCityBrowser() {
            document.getElementById('browserOverlay').classList.remove('active');
            document.getElementById('cityBrowser').classList.remove('active');
            browserIsOpen = false;
            browserContext = null;
            browserSelectedActivity = null;
        }

        function setBrowserFilter(filter) {
            browserFilter = filter;
            document.querySelectorAll('.browser-chip').forEach(c => c.classList.remove('active'));
            document.querySelector('.browser-chip[data-filter="' + filter + '"]').classList.add('active');
            renderBrowserActivities();
        }

        function filterBrowserActivities() {
            renderBrowserActivities();
        }

        function renderBrowserActivities() {
            if (!browserContext) return;

            const body = document.getElementById('browserBody');
            const searchTerm = document.getElementById('browserSearch').value.toLowerCase().trim();

            let activities = browserContext.activities;

            // Apply category filter
            if (browserFilter !== 'all') {
                activities = activities.filter(a => a.category === browserFilter);
            }

            // Apply search filter
            if (searchTerm) {
                activities = activities.filter(a =>
                    a.name.toLowerCase().includes(searchTerm) ||
                    (a.desc && a.desc.toLowerCase().includes(searchTerm))
                );
            }

            if (activities.length === 0) {
                body.innerHTML = '<div class="browser-no-results">No activities found matching your search.</div>';
                return;
            }

            // Group by category
            const groups = {};
            const groupOrder = ['hotels', 'restaurants', 'experiences', 'kidFriendly', 'markets'];
            const groupLabels = {
                hotels: '\u{1F3E8} Hotels & Ryokans',
                restaurants: '\u{1F374} Restaurants & Bars',
                experiences: '\u{1F5FA} Experiences & Activities',
                kidFriendly: '\u{1F476} Kid-Friendly',
                markets: '\u{1F6CD} Markets'
            };
            const typeClass = {
                hotels: 'hotel',
                restaurants: 'restaurant',
                experiences: 'experience',
                kidFriendly: 'kid',
                markets: 'market'
            };

            activities.forEach(a => {
                if (!groups[a.category]) groups[a.category] = [];
                groups[a.category].push(a);
            });

            // Build a stable index map so we can reference the correct activity when clicked
            const activityIndexMap = [];
            activities.forEach((a, i) => activityIndexMap.push(a));

            let html = '';
            let runningIdx = 0;
            groupOrder.forEach(cat => {
                if (!groups[cat] || groups[cat].length === 0) return;
                html += '<div class="browser-group">';
                html += '<div class="browser-group-title">' + groupLabels[cat] + ' (' + groups[cat].length + ')</div>';
                groups[cat].forEach((act) => {
                    const idx = activities.indexOf(act);
                    html += '<div class="browser-activity" id="browser-act-' + idx + '" onclick="selectBrowserActivity(' + idx + ')">';
                    html += '<div class="browser-activity-name">' + escapeHtml(act.name) + '</div>';
                    if (act.desc) html += '<div class="browser-activity-desc">' + escapeHtml(act.desc) + '</div>';
                    html += '<span class="browser-activity-type ' + typeClass[act.category] + '">' + (cat === 'kidFriendly' ? 'Kid-Friendly' : cat.charAt(0).toUpperCase() + cat.slice(1)) + '</span>';
                    html += '<div class="browser-slot-picker" id="browser-slots-' + idx + '"></div>';
                    html += '</div>';
                });
                html += '</div>';
            });

            body.innerHTML = html;
        }

        function selectBrowserActivity(actIdx) {
            if (!browserContext) return;

            const activities = getFilteredBrowserActivities();
            const act = activities[actIdx];
            if (!act) return;

            // Close any previously open slot pickers
            document.querySelectorAll('.browser-slot-picker.active').forEach(el => {
                el.classList.remove('active');
                el.innerHTML = '';
            });
            document.querySelectorAll('.browser-activity.selected').forEach(el => {
                el.classList.remove('selected');
            });

            // Highlight selected activity
            const actEl = document.getElementById('browser-act-' + actIdx);
            if (actEl) actEl.classList.add('selected');

            // Show slot picker for this activity
            const slotPicker = document.getElementById('browser-slots-' + actIdx);
            if (!slotPicker) return;

            const dayData = browserContext.dayData;
            let slotsHtml = '<div class="browser-slot-title">Replace which item on Day ' + browserContext.dayNum + '?</div>';

            dayData.items.forEach((item, itemIdx) => {
                if (item.type === 'nap') return;
                slotsHtml += '<div class="browser-slot-item" onclick="event.stopPropagation(); replaceDayItem(' + actIdx + ',' + itemIdx + ')">';
                slotsHtml += '<strong>' + formatType(item.type) + ':</strong> ' + escapeHtml(item.name);
                slotsHtml += '</div>';
            });

            slotPicker.innerHTML = slotsHtml;
            slotPicker.classList.add('active');
            browserSelectedActivity = act;

            // Scroll the slot picker into view
            setTimeout(() => slotPicker.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 100);
        }

        function getFilteredBrowserActivities() {
            if (!browserContext) return [];

            let activities = browserContext.activities;
            const searchTerm = document.getElementById('browserSearch').value.toLowerCase().trim();

            if (browserFilter !== 'all') {
                activities = activities.filter(a => a.category === browserFilter);
            }
            if (searchTerm) {
                activities = activities.filter(a =>
                    a.name.toLowerCase().includes(searchTerm) ||
                    (a.desc && a.desc.toLowerCase().includes(searchTerm))
                );
            }
            return activities;
        }

        function replaceDayItem(actIdx, itemIdx) {
            if (!browserContext) return;

            const activities = getFilteredBrowserActivities();
            const act = activities[actIdx];
            if (!act) return;

            const { itinKey, dayNum } = browserContext;
            const dayData = itineraryData[itinKey].days.find(d => d.day === dayNum);
            if (!dayData || !dayData.items[itemIdx]) return;

            const oldItem = dayData.items[itemIdx];

            // Keep the original slot type for structured items (meals, hotel)
            let newType = oldItem.type;
            if (act.category === 'experiences' || act.category === 'kidFriendly' || act.category === 'markets') {
                if (oldItem.type !== 'hotel' && oldItem.type !== 'breakfast' && oldItem.type !== 'lunch' && oldItem.type !== 'dinner') {
                    newType = 'sightseeing';
                }
            }

            // Save to modifiedState for persistence
            const modKey = itinKey + '_' + dayNum + '_' + itemIdx;
            const origDay = originalItineraryData[itinKey].days.find(d => d.day === dayNum);
            modifiedState[modKey] = {
                newName: act.name,
                newCoord: act.coord,
                newDesc: act.desc || '',
                origName: origDay.items[itemIdx].name,
                origCoord: origDay.items[itemIdx].coord,
                timestamp: new Date().toISOString()
            };
            saveModifiedState();

            // Update itinerary data
            dayData.items[itemIdx] = {
                type: newType,
                name: act.name,
                coord: act.coord,
                desc: act.desc || ''
            };

            // Refresh UI
            renderDays(itinKey);
            if (currentDay === dayNum) {
                showDay(itinKey, dayNum);
            } else if (allDaysActive) {
                showItinerary(itinKey);
            }

            // Close browser
            closeCityBrowser();
        }


        // ============================================
        // AI CHAT SYSTEM
        // ============================================

        let chatModel = 'haiku';
        let chatApiKey = null;
        let chatHistory = [];
        let lastAiDayData = null;
        let chatIsOpen = false;
        let chatWebSearch = true;
        let configLoaded = false;

        // Load config.json for pre-configured API key (family/private deployment)
        async function loadConfig() {
            try {
                const resp = await fetch('config.json');
                if (resp.ok) {
                    const config = await resp.json();
                    if (config.anthropicApiKey && config.anthropicApiKey.startsWith('sk-')) {
                        chatApiKey = config.anthropicApiKey;
                        try {
                            localStorage.setItem('japanTrip_apiKey', config.anthropicApiKey);
                            localStorage.setItem('tripMap_apiKey', config.anthropicApiKey);
                        } catch(e) {}
                        configLoaded = true;
                    }
                    if (config.defaultModel) {
                        chatModel = config.defaultModel;
                    }
                }
            } catch(e) {
                // No config.json or fetch failed â€” normal for public deployment
            }
        }

        function getModelId() {
            if (chatModel === 'haiku') return 'claude-haiku-4-5-20251001';
            return 'claude-sonnet-4-5-20250929';
        }

        function toggleChatPanel() {
            chatIsOpen = !chatIsOpen;
            const panel = document.getElementById('chatPanel');
            if (chatIsOpen) {
                panel.classList.add('active');
                loadApiKey();
                updateChatContext();
            } else {
                panel.classList.remove('active');
            }
        }

        function loadApiKey() {
            try {
                chatApiKey = chatApiKey || localStorage.getItem('japanTrip_apiKey');
            } catch(e) {}
            if (chatApiKey) {
                showChatInterface();
                if (configLoaded) {
                    addChatMessage('assistant', "Ready to help plan your day! AI is pre-configured for this family map.\n\nTry things like:\n\u2022 \"I want museum hopping and great pasta today\"\n\u2022 \"Make today more kid-friendly\"\n\u2022 \"Swap dinner for something casual\"");
                }
            } else {
                showApiKeySetup();
            }
        }

        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (!key || !key.startsWith('sk-')) {
                addChatMessage('error', 'Please enter a valid API key starting with sk-');
                return;
            }
            chatApiKey = key;
            try {
                localStorage.setItem('japanTrip_apiKey', key);
            } catch(e) {}
            showChatInterface();
            addChatMessage('assistant', "Ready to help plan your day! Tell me what you're in the mood for and I'll rearrange your schedule.\n\nTry things like:\n\u2022 \"I want knife shopping and tempura today\"\n\u2022 \"Make today more kid-friendly\"\n\u2022 \"Swap dinner for something casual\"");
        }

        function showApiKeySetup() {
            document.getElementById('chatSetup').style.display = 'flex';
            document.getElementById('chatMessages').style.display = 'none';
            document.getElementById('chatInputArea').style.display = 'none';
            document.getElementById('chatSettings').style.display = 'none';
        }

        function showChatInterface() {
            document.getElementById('chatSetup').style.display = 'none';
            document.getElementById('chatMessages').style.display = 'flex';
            document.getElementById('chatInputArea').style.display = 'flex';
            document.getElementById('chatSettings').style.display = 'flex';
            if (chatHistory.length === 0) {
                addChatMessage('assistant', "Hi! I'm your AI day planner. Select an itinerary and expand a day in the sidebar, then tell me what you'd like to do today.\n\nI'll rearrange the schedule using your curated research database of 180+ spots across Japan.");
            }
        }

        function setChatModel(model) {
            chatModel = model;
            document.getElementById('modelHaiku').classList.toggle('active', model === 'haiku');
            document.getElementById('modelSonnet').classList.toggle('active', model === 'sonnet');
        }

        function updateChatContext() {
            const ctx = document.getElementById('chatContext');
            if (currentItinerary && currentDay) {
                const itin = itineraryData[currentItinerary];
                const dayData = itin.days.find(d => d.day === currentDay);
                if (dayData) {
                    ctx.textContent = itin.name + ' \u2014 Day ' + currentDay + ': ' + dayData.title;
                    return;
                }
            }
            if (currentItinerary) {
                ctx.textContent = itineraryData[currentItinerary].name + ' \u2014 select a day';
            } else {
                ctx.textContent = 'Select an itinerary & day first';
            }
        }

        function addChatMessage(role, content) {
            const container = document.getElementById('chatMessages');
            const msg = document.createElement('div');
            msg.className = 'chat-msg ' + role;
            msg.innerHTML = content.replace(/\n/g, '<br>');
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
            chatHistory.push({ role: role, content: content });
        }

        function addTypingIndicator() {
            const container = document.getElementById('chatMessages');
            const typing = document.createElement('div');
            typing.className = 'chat-typing';
            typing.id = 'chatTyping';
            typing.innerHTML = '<span></span><span></span><span></span>';
            container.appendChild(typing);
            container.scrollTop = container.scrollHeight;
        }

        function removeTypingIndicator() {
            const el = document.getElementById('chatTyping');
            if (el) el.remove();
        }

        function chatKeyHandler(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChatMessage();
            }
        }

        function buildSystemPrompt() {
            if (!currentItinerary || !currentDay) {
                return null;
            }
            const itin = itineraryData[currentItinerary];
            const dayData = itin.days.find(d => d.day === currentDay);
            if (!dayData) return null;

            const cityName = extractCity(dayData.title);
            const center = findCityCenter(dayData.title);

            // Gather all available activities in this city
            let cityActivities = { hotels: [], restaurants: [], experiences: [], kidFriendly: [], markets: [] };
            if (center) {
                const r = center.radius;
                hotels.forEach(h => {
                    if (h.coord && Math.abs(h.coord[0] - center.lat) < r && Math.abs(h.coord[1] - center.lng) < r)
                        cityActivities.hotels.push(h.name + (h.desc ? ' (' + h.desc + ')' : ''));
                });
                restaurants.forEach(h => {
                    if (h.coord && Math.abs(h.coord[0] - center.lat) < r && Math.abs(h.coord[1] - center.lng) < r)
                        cityActivities.restaurants.push(h.name + (h.desc ? ' (' + h.desc + ')' : ''));
                });
                experiences.forEach(h => {
                    if (h.coord && Math.abs(h.coord[0] - center.lat) < r && Math.abs(h.coord[1] - center.lng) < r)
                        cityActivities.experiences.push(h.name + (h.desc ? ' (' + h.desc + ')' : ''));
                });
                kidFriendly.forEach(h => {
                    if (h.coord && Math.abs(h.coord[0] - center.lat) < r && Math.abs(h.coord[1] - center.lng) < r)
                        cityActivities.kidFriendly.push(h.name + (h.desc ? ' (' + h.desc + ')' : ''));
                });
                markets.forEach(h => {
                    if (h.coord && Math.abs(h.coord[0] - center.lat) < r && Math.abs(h.coord[1] - center.lng) < r)
                        cityActivities.markets.push(h.name + (h.desc ? ' (' + h.desc + ')' : ''));
                });
            }

            const currentItems = dayData.items.map(item =>
                item.type.toUpperCase() + ': ' + item.name
            ).join('\n');

            const destName = destinations[activeDestination] ? destinations[activeDestination].name : 'travel';
            return 'You are a ' + destName + ' travel day planner.\n\n' +
                'CURRENT DAY: ' + itin.name + ', Day ' + dayData.day + ' - ' + dayData.title + '\n\n' +
                'CURRENT SCHEDULE:\n' + currentItems + '\n\n' +
                'AVAILABLE IN ' + cityName.toUpperCase() + ':\n' +
                'Hotels: ' + (cityActivities.hotels.join(', ') || 'none listed') + '\n' +
                'Restaurants: ' + (cityActivities.restaurants.join(', ') || 'none listed') + '\n' +
                'Experiences: ' + (cityActivities.experiences.join(', ') || 'none listed') + '\n' +
                'Kid-Friendly: ' + (cityActivities.kidFriendly.join(', ') || 'none listed') + '\n' +
                'Markets: ' + (cityActivities.markets.join(', ') || 'none listed') + '\n\n' +
                'HARD CONSTRAINTS:\n' +
                '- Must include: hotel, breakfast, lunch, dinner\n' +
                '- Keep the same hotel unless user asks to change it\n' +
                '- Optional items are welcome but mark type as "optional"\n\n' +
                'RESPONSE MODES:\n' +
                '1) SCHEDULE CHANGE â€” If the user asks to change, rearrange, replace, or create a new schedule, respond with ONLY a JSON array of day items. No markdown, no explanation, just the JSON.\n' +
                '   Each item: {"type": "hotel|breakfast|lunch|dinner|sightseeing|nap|optional", "name": "Place Name", "coord": [lat, lng] or null}\n' +
                '   Use coordinates from the AVAILABLE lists above when possible. Use null for coord if unknown.\n' +
                '   Order: hotel first, then chronological (breakfast, sightseeing, lunch, nap, afternoon activities, dinner, optional).\n' +
                '2) INFORMATION REQUEST â€” If the user asks about a specific place (hours, reviews, prices, tips, directions, booking info, seasonal details), respond with helpful text. Use web search when available to find current, accurate information. Include specific details like opening hours, current prices, reservation requirements, and practical tips.\n' +
                '3) GENERAL QUESTION â€” If the user asks a general travel question or comparison, respond with helpful text.\n\n' +
                'IMPORTANT: Only use mode 1 (JSON array) when the user clearly wants to modify the schedule. For all other queries, use natural text.';
        }

        function findCoordForName(name) {
            const allItems = [...hotels, ...restaurants, ...experiences, ...kidFriendly, ...markets];
            const match = allItems.find(item => item.name.toLowerCase() === name.toLowerCase());
            return match ? match.coord : null;
        }

        function toggleWebSearch() {
            chatWebSearch = !chatWebSearch;
            document.getElementById('webSearchToggle').classList.toggle('active', chatWebSearch);
        }

        function parseApiResponse(data) {
            let text = '';
            let citations = [];
            if (!data.content) return { text: '', citations: [] };
            for (const block of data.content) {
                if (block.type === 'text') {
                    text += block.text;
                } else if (block.type === 'web_search_tool_result') {
                    if (Array.isArray(block.content)) {
                        block.content.forEach(function(result) {
                            if (result.type === 'web_search_result' && result.url) {
                                citations.push({
                                    title: result.title || result.url,
                                    url: result.url
                                });
                            }
                        });
                    }
                }
            }
            return { text: text.trim(), citations: citations };
        }

        function formatCitations(citations) {
            if (!citations || citations.length === 0) return '';
            var seen = {};
            var unique = citations.filter(function(c) {
                if (seen[c.url]) return false;
                seen[c.url] = true;
                return true;
            });
            if (unique.length === 0) return '';
            var html = '<div class="search-citations"><div class="search-citations-title">Sources</div>';
            unique.slice(0, 5).forEach(function(c) {
                var title = escapeHtml(c.title || c.url);
                var url = escapeHtml(c.url);
                html += '<div class="search-citation-item">\u2022 <a href="' + url + '" target="_blank" rel="noopener">' + title + '</a></div>';
            });
            html += '</div>';
            return html;
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (!msg) return;

            if (!currentItinerary || !currentDay) {
                addChatMessage('system', 'Please select an itinerary and expand a day first, then I can help rearrange it.');
                return;
            }

            if (!chatApiKey) {
                showApiKeySetup();
                return;
            }

            input.value = '';
            input.style.height = 'auto';
            addChatMessage('user', msg);

            const systemPrompt = buildSystemPrompt();
            if (!systemPrompt) {
                addChatMessage('error', 'Could not build context. Make sure you have a day selected.');
                return;
            }

            // Disable input while waiting
            document.getElementById('chatSendBtn').disabled = true;
            input.disabled = true;
            addTypingIndicator();

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': chatApiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: (function() {
                        var reqBody = {
                            model: getModelId(),
                            max_tokens: 4096,
                            system: systemPrompt,
                            messages: [{ role: 'user', content: msg }]
                        };
                        if (chatWebSearch) {
                            reqBody.tools = [{ type: 'web_search_20250305', name: 'web_search', max_uses: 5 }];
                        }
                        return JSON.stringify(reqBody);
                    })()
                });

                removeTypingIndicator();

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    if (response.status === 401) {
                        addChatMessage('error', 'Invalid API key. Click "Change API key" below to update it.');
                        chatApiKey = null;
                        try { localStorage.removeItem('japanTrip_apiKey'); } catch(e) {}
                    } else {
                        addChatMessage('error', 'API error: ' + (errData.error?.message || response.status));
                    }
                    return;
                }

                const data = await response.json();
                const { text, citations } = parseApiResponse(data);

                if (!text) {
                    addChatMessage('error', 'Empty response from AI.');
                    return;
                }

                // Try to parse as JSON array (schedule change mode)
                let parsed = null;
                try {
                    // Extract JSON from response (handle markdown code blocks)
                    let jsonStr = text.trim();
                    if (jsonStr.startsWith('```')) {
                        jsonStr = jsonStr.replace(/^```(?:json)?\n?/, '').replace(/\n?```$/, '').trim();
                    }
                    parsed = JSON.parse(jsonStr);
                } catch(e) {
                    // Not JSON â€” show as text response with citations
                    var responseHtml = text.replace(/\n/g, '<br>');
                    if (citations.length > 0) {
                        responseHtml += formatCitations(citations);
                    }
                    addChatMessage('assistant', responseHtml);
                    return;
                }

                if (!Array.isArray(parsed) || parsed.length === 0) {
                    addChatMessage('assistant', text);
                    return;
                }

                // Validate and fix coordinates
                parsed = parsed.map(item => {
                    if (!item.coord || !Array.isArray(item.coord)) {
                        item.coord = findCoordForName(item.name);
                    }
                    if (!item.type) item.type = 'sightseeing';
                    return item;
                });

                // Store for potential application
                lastAiDayData = parsed;

                // Build preview
                let previewHtml = '<div class="chat-msg-day-preview">';
                parsed.forEach(item => {
                    const icon = item.type === 'hotel' ? '\ud83c\udfe8' :
                                 item.type === 'breakfast' ? '\ud83c\udf73' :
                                 item.type === 'lunch' ? '\ud83c\udf5c' :
                                 item.type === 'dinner' ? '\ud83c\udf77' :
                                 item.type === 'nap' ? '\ud83d\udca4' :
                                 item.type === 'optional' ? '\u2728' : '\ud83d\udccd';
                    previewHtml += '<div class="preview-item"><span class="preview-type">' + icon + ' ' + escapeHtml(item.type) + '</span><span>' + escapeHtml(item.name) + '</span></div>';
                });
                previewHtml += '</div>';
                previewHtml += '<button class="chat-msg-apply-btn" onclick="applyAiDay()">Apply this schedule</button>';

                addChatMessage('assistant', 'Here\'s your updated day:' + previewHtml);

            } catch(e) {
                removeTypingIndicator();
                if (e.message?.includes('Failed to fetch')) {
                    addChatMessage('error', 'Network error. Check your internet connection.');
                } else {
                    addChatMessage('error', 'Error: ' + e.message);
                }
            } finally {
                document.getElementById('chatSendBtn').disabled = false;
                input.disabled = false;
                input.focus();
            }
        }

        function applyAiDay() {
            if (!lastAiDayData || !currentItinerary || !currentDay) return;

            const itin = itineraryData[currentItinerary];
            const dayData = itin.days.find(d => d.day === currentDay);
            if (!dayData) return;

            // Save each original item for reset capability
            dayData.items.forEach((origItem, idx) => {
                const stateKey = currentItinerary + '_' + currentDay + '_' + idx;
                if (!modifiedState[stateKey]) {
                    modifiedState[stateKey] = {
                        newName: origItem.name,
                        newCoord: origItem.coord,
                        newDesc: '',
                        origName: origItem.name,
                        origCoord: origItem.coord,
                        timestamp: Date.now()
                    };
                }
            });

            // Replace the entire day's items
            dayData.items = lastAiDayData.map(item => ({
                type: item.type || 'sightseeing',
                name: item.name,
                coord: item.coord || null
            }));

            // Update modifiedState for all new items
            dayData.items.forEach((newItem, idx) => {
                const stateKey = currentItinerary + '_' + currentDay + '_' + idx;
                const origDay = originalItineraryData[currentItinerary].days.find(d => d.day === currentDay);
                const origItem = origDay && origDay.items[idx] ? origDay.items[idx] : { name: '', coord: null };
                modifiedState[stateKey] = {
                    newName: newItem.name,
                    newCoord: newItem.coord,
                    newDesc: '',
                    origName: origItem.name,
                    origCoord: origItem.coord,
                    timestamp: Date.now()
                };
            });

            saveModifiedState();
            showItinerary(currentItinerary);

            // Disable the apply button
            const btns = document.querySelectorAll('.chat-msg-apply-btn');
            btns.forEach(btn => {
                btn.disabled = true;
                btn.textContent = '\u2713 Applied!';
            });

            addChatMessage('system', 'Day ' + currentDay + ' updated! You can use the \u21bb Reset button on the day card to revert.');
            lastAiDayData = null;
            updateChatContext();
        }



        // ============================================
        // AI ITINERARY GENERATOR
        // ============================================

        let lastGeneratedItinerary = null;  // Holds preview data before save
        const GEN_COLORS = ['#7C3AED', '#EC4899', '#06B6D4', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#14B8A6'];

        // Travel profile management
        function getTravelProfiles() {
            try { return JSON.parse(localStorage.getItem('tripMap_travelProfiles') || '{}'); } catch(e) { return {}; }
        }

        function populateProfileDropdown() {
            const select = document.getElementById('genProfileSelect');
            const profiles = getTravelProfiles();
            select.innerHTML = '<option value="">â€” Select a saved profile â€”</option>';
            Object.keys(profiles).sort().forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                select.appendChild(opt);
            });
            document.getElementById('genProfileDeleteBtn').style.display = 'none';
        }

        function loadTravelProfile() {
            const select = document.getElementById('genProfileSelect');
            const name = select.value;
            const deleteBtn = document.getElementById('genProfileDeleteBtn');
            if (!name) { deleteBtn.style.display = 'none'; return; }
            deleteBtn.style.display = '';
            const profiles = getTravelProfiles();
            const p = profiles[name];
            if (!p) return;
            if (p.days) document.getElementById('genDays').value = p.days;
            if (p.party) document.getElementById('genParty').value = p.party;
            if (p.pace) document.getElementById('genPace').value = p.pace;
            if (p.budget) document.getElementById('genBudget').value = p.budget;
            if (p.constraints !== undefined) document.getElementById('genConstraints').value = p.constraints;
            // Set interests
            document.querySelectorAll('.gen-interest-chip').forEach(chip => {
                if (p.interests && p.interests.includes(chip.dataset.interest)) {
                    chip.classList.add('selected');
                } else {
                    chip.classList.remove('selected');
                }
            });
            if (p.webSearch !== undefined) {
                genWebSearch = p.webSearch;
                const toggle = document.getElementById('genWebSearchToggle');
                if (toggle) toggle.classList.toggle('active', genWebSearch);
            }
        }

        function showSaveProfileRow() {
            document.getElementById('genProfileSaveRow').classList.add('active');
            document.getElementById('genProfileNameInput').focus();
        }

        function hideSaveProfileRow() {
            document.getElementById('genProfileSaveRow').classList.remove('active');
            document.getElementById('genProfileNameInput').value = '';
        }

        function saveTravelProfile() {
            const nameInput = document.getElementById('genProfileNameInput');
            const name = nameInput.value.trim();
            if (!name) { showCopyToast('Please enter a profile name'); return; }
            const profiles = getTravelProfiles();
            profiles[name] = {
                days: parseInt(document.getElementById('genDays').value) || 7,
                party: document.getElementById('genParty').value,
                interests: getSelectedInterests(),
                pace: document.getElementById('genPace').value,
                budget: document.getElementById('genBudget').value,
                constraints: document.getElementById('genConstraints').value.trim(),
                webSearch: genWebSearch || false
            };
            try { localStorage.setItem('tripMap_travelProfiles', JSON.stringify(profiles)); } catch(e) {}
            populateProfileDropdown();
            document.getElementById('genProfileSelect').value = name;
            document.getElementById('genProfileDeleteBtn').style.display = '';
            hideSaveProfileRow();
            showCopyToast('Profile "' + name + '" saved!');
        }

        function deleteTravelProfile() {
            const select = document.getElementById('genProfileSelect');
            const name = select.value;
            if (!name) return;
            if (!confirm('Delete profile "' + name + '"?')) return;
            const profiles = getTravelProfiles();
            delete profiles[name];
            try { localStorage.setItem('tripMap_travelProfiles', JSON.stringify(profiles)); } catch(e) {}
            populateProfileDropdown();
            showCopyToast('Profile deleted');
        }

        let genWebSearch = false;

        function toggleGenWebSearch() {
            genWebSearch = !genWebSearch;
            document.getElementById('genWebSearchToggle').classList.toggle('active', genWebSearch);
        }

        let refineConversation = []; // Tracks multi-turn refinement messages

        function openGeneratorModal() {
            if (!activeDestination) {
                showCopyToast('Please select a destination first');
                return;
            }
            if (!chatApiKey) {
                chatApiKey = localStorage.getItem('tripMap_apiKey') || localStorage.getItem('japanTrip_apiKey');
            }
            if (!chatApiKey) {
                showCopyToast('API key required â€” open the chat panel first to set it up');
                return;
            }
            const dest = destinations[activeDestination];
            document.getElementById('genDestLabel').textContent = 'for ' + (dest ? dest.name : activeDestination);
            document.getElementById('genPreviewArea').style.display = 'none';
            document.getElementById('genPreviewArea').innerHTML = '';
            document.getElementById('genError').style.display = 'none';
            document.getElementById('genSaveBtn').style.display = 'none';
            document.getElementById('genSubmitBtn').style.display = '';
            document.getElementById('genSubmitBtn').disabled = false;
            document.getElementById('genSubmitBtn').innerHTML = 'Generate Itinerary';
            lastGeneratedItinerary = null;
            populateProfileDropdown();
            hideSaveProfileRow();
            genWebSearch = false;
            document.getElementById('genWebSearchToggle').classList.remove('active');
            document.getElementById('genOverlay').classList.add('active');
        }

        function closeGeneratorModal() {
            document.getElementById('genOverlay').classList.remove('active');
        }

        // Interest chip toggle
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('gen-interest-chip')) {
                e.target.classList.toggle('selected');
            }
        });

        function getSelectedInterests() {
            return Array.from(document.querySelectorAll('.gen-interest-chip.selected')).map(el => el.dataset.interest);
        }

        function buildGeneratorSystemPrompt() {
            const dest = destinations[activeDestination];
            const destName = dest ? dest.name : activeDestination;
            const days = parseInt(document.getElementById('genDays').value) || 7;
            const party = document.getElementById('genParty').value;
            const interests = getSelectedInterests();
            const pace = document.getElementById('genPace').value;
            const budget = document.getElementById('genBudget').value;
            const constraints = document.getElementById('genConstraints').value.trim();

            // Build compact POI list grouped by city
            const cityPois = {};
            const allPois = [
                ...hotels.map(h => ({...h, cat: 'hotel'})),
                ...restaurants.map(r => ({...r, cat: 'restaurant'})),
                ...experiences.map(e => ({...e, cat: 'experience'})),
                ...kidFriendly.map(k => ({...k, cat: 'kid-friendly'})),
                ...markets.map(m => ({...m, cat: 'market'}))
            ];

            // Group POIs by nearest city center
            Object.entries(cityCenters).forEach(([city, coords]) => {
                cityPois[city] = { hotels: [], restaurants: [], experiences: [], kidFriendly: [], markets: [] };
                const r = coords[2] || 0.15;
                allPois.forEach(poi => {
                    if (!poi.coord) return;
                    if (Math.abs(poi.coord[0] - coords[0]) < r && Math.abs(poi.coord[1] - coords[1]) < r) {
                        const catKey = poi.cat === 'hotel' ? 'hotels' : poi.cat === 'restaurant' ? 'restaurants' : poi.cat === 'experience' ? 'experiences' : poi.cat === 'kid-friendly' ? 'kidFriendly' : 'markets';
                        const entry = poi.name + (poi.desc ? ' (' + poi.desc + ')' : '');
                        if (cityPois[city][catKey].length < 15) {
                            cityPois[city][catKey].push(entry);
                        }
                    }
                });
            });

            // Build POI section
            let poiSection = '';
            Object.entries(cityPois).forEach(([city, cats]) => {
                const total = cats.hotels.length + cats.restaurants.length + cats.experiences.length + cats.kidFriendly.length + cats.markets.length;
                if (total === 0) return;
                poiSection += '\n## ' + city + '\n';
                if (cats.hotels.length) poiSection += 'Hotels: ' + cats.hotels.join(' | ') + '\n';
                if (cats.restaurants.length) poiSection += 'Restaurants: ' + cats.restaurants.join(' | ') + '\n';
                if (cats.experiences.length) poiSection += 'Experiences: ' + cats.experiences.join(' | ') + '\n';
                if (cats.kidFriendly.length) poiSection += 'Kid-Friendly: ' + cats.kidFriendly.join(' | ') + '\n';
                if (cats.markets.length) poiSection += 'Markets: ' + cats.markets.join(' | ') + '\n';
            });

            // City centers for reference
            let cityCentersList = Object.entries(cityCenters).map(([city, coords]) => city + ': [' + coords[0] + ', ' + coords[1] + ']').join(', ');

            // Party description
            const partyDesc = {
                'couple': 'a couple',
                'family-toddler': 'a family with a toddler (under 4 years old) â€” nap time 1:00-3:00 PM is essential',
                'family-kids': 'a family with kids aged 4-12',
                'family-teens': 'a family with teenagers',
                'solo': 'a solo traveler',
                'friends': 'a group of friends'
            }[party] || party;

            const paceDesc = {
                'slow': 'Slow and relaxed â€” no more than 2-3 activities per day, plenty of downtime',
                'moderate': 'Moderate â€” 3-4 activities per day with breaks',
                'fast': 'Fast-paced â€” maximize activities and experiences each day'
            }[pace] || pace;

            let prompt = 'You are a travel itinerary planner. Generate a ' + days + '-day itinerary for ' + destName + '.\n\n';
            prompt += 'TRAVELERS: ' + partyDesc + '\n';
            prompt += 'INTERESTS: ' + (interests.length ? interests.join(', ') : 'general sightseeing') + '\n';
            prompt += 'PACE: ' + paceDesc + '\n';
            prompt += 'BUDGET: ' + budget + '\n';
            if (constraints) prompt += 'SPECIAL REQUESTS: ' + constraints + '\n';

            prompt += '\nAVAILABLE PLACES (use these by name where possible):\n' + poiSection;
            prompt += '\nCITY CENTERS: ' + cityCentersList + '\n';

            prompt += '\nRULES:\n';
            prompt += '- Use places from the AVAILABLE PLACES list above whenever possible. You may add well-known places not in the list if needed.\n';
            prompt += '- Each day should have a logical geographic flow (group nearby activities).\n';
            prompt += '- Include hotel, breakfast, lunch, dinner each day. Add sightseeing, optional, and nap items as appropriate.\n';
            if (party === 'family-toddler') {
                prompt += '- MANDATORY: Include a "nap" item from 1:00-3:00 PM every day. Keep distances between stops short and walkable.\n';
            }
            prompt += '- For multi-city trips, group days by city and minimize transit days.\n';
            prompt += '- The first day should account for arrival, the last day for departure.\n';

            prompt += '\nRESPONSE FORMAT: Respond with ONLY valid JSON (no markdown, no explanation, no code fences). The JSON must be an object:\n';
            prompt += '{\n';
            prompt += '  "name": "Itinerary Name (short, descriptive, e.g. \'Foodie Family Adventure\')",\n';
            prompt += '  "days": [\n';
            prompt += '    {\n';
            prompt += '      "day": 1,\n';
            prompt += '      "title": "City Name (Theme)",\n';
            prompt += '      "items": [\n';
            prompt += '        {"type": "hotel", "name": "Hotel Name"},\n';
            prompt += '        {"type": "breakfast", "name": "Restaurant Name"},\n';
            prompt += '        {"type": "sightseeing", "name": "Place Name"},\n';
            prompt += '        {"type": "lunch", "name": "Restaurant Name"},\n';
            prompt += '        {"type": "nap", "name": "Nap / Rest Time"},\n';
            prompt += '        {"type": "sightseeing", "name": "Place Name"},\n';
            prompt += '        {"type": "dinner", "name": "Restaurant Name"},\n';
            prompt += '        {"type": "optional", "name": "Optional Activity"}\n';
            prompt += '      ]\n';
            prompt += '    }\n';
            prompt += '  ]\n';
            prompt += '}\n';
            prompt += 'Valid types: hotel, breakfast, lunch, dinner, sightseeing, optional, nap.\n';
            prompt += 'Do NOT include coordinates â€” they will be looked up automatically.\n';
            prompt += 'IMPORTANT: Output raw JSON only. No markdown code blocks, no backticks, no explanation text.';

            return prompt;
        }

        async function submitGeneratorForm() {
            const submitBtn = document.getElementById('genSubmitBtn');
            const errorDiv = document.getElementById('genError');
            const previewArea = document.getElementById('genPreviewArea');
            const saveBtn = document.getElementById('genSaveBtn');

            errorDiv.style.display = 'none';
            previewArea.style.display = 'none';
            saveBtn.style.display = 'none';
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="gen-spinner"></span>Generating...';

            refineConversation = []; // Reset refinement conversation
            const systemPrompt = buildGeneratorSystemPrompt();
            const days = parseInt(document.getElementById('genDays').value) || 7;

            try {
                const modelId = (typeof getModelId === 'function') ? getModelId() : 'claude-sonnet-4-5-20250929';
                const maxTokens = modelId.includes('haiku') ? 4096 : 8192;

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': chatApiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: (function() {
                        var reqBody = {
                            model: modelId,
                            max_tokens: maxTokens,
                            system: systemPrompt,
                            messages: [{ role: 'user', content: 'Generate the ' + days + '-day itinerary now. Output raw JSON only.' }]
                        };
                        if (genWebSearch) {
                            reqBody.tools = [{ type: 'web_search_20250305', name: 'web_search', max_uses: 5 }];
                        }
                        return JSON.stringify(reqBody);
                    })()
                });

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(errData.error?.message || 'API error ' + response.status);
                }

                const data = await response.json();

                // Extract text from response
                let text = '';
                if (data.content) {
                    data.content.forEach(block => {
                        if (block.type === 'text') text += block.text;
                    });
                }

                if (!text) throw new Error('Empty response from AI');

                // Parse JSON (handle code fences if present)
                let jsonStr = text.trim();
                if (jsonStr.startsWith('```')) {
                    jsonStr = jsonStr.replace(/^```(?:json)?\n?/, '').replace(/\n?```$/, '').trim();
                }

                let parsed;
                try {
                    parsed = JSON.parse(jsonStr);
                } catch(e) {
                    throw new Error('AI response was not valid JSON. Try again or use a different model.');
                }

                // Validate structure
                if (!parsed.days || !Array.isArray(parsed.days) || parsed.days.length === 0) {
                    throw new Error('Invalid itinerary structure â€” no days found');
                }

                // Look up coordinates for all items
                parsed.days.forEach(day => {
                    if (!day.items) day.items = [];
                    day.items.forEach(item => {
                        if (!item.coord) {
                            item.coord = findCoordForName(item.name);
                        }
                        if (!item.type) item.type = 'sightseeing';
                    });
                });

                // Store for saving
                lastGeneratedItinerary = parsed;

                // Render preview using shared function
                renderGeneratorPreview(parsed);

                saveBtn.style.display = '';
                submitBtn.innerHTML = 'Regenerate';
                submitBtn.disabled = false;

            } catch(e) {
                errorDiv.textContent = e.message;
                errorDiv.style.display = 'block';
                submitBtn.innerHTML = 'Try Again';
                submitBtn.disabled = false;
            }
        }

        function saveGeneratedItinerary() {
            if (!lastGeneratedItinerary) return;

            // Generate unique key
            const genCount = Object.keys(itineraryData).filter(k => k.startsWith('gen_')).length;
            const genKey = 'gen_' + (genCount + 1);

            // Pick a color
            const colorIdx = genCount % GEN_COLORS.length;

            const itinObj = {
                name: lastGeneratedItinerary.name || 'Custom Itinerary',
                color: GEN_COLORS[colorIdx],
                days: lastGeneratedItinerary.days,
                isGenerated: true
            };

            // Add to itineraryData
            itineraryData[genKey] = itinObj;
            originalItineraryData[genKey] = JSON.parse(JSON.stringify(itinObj));

            // Persist to localStorage
            try {
                const storageKey = 'tripMap_genItin_' + activeDestination;
                const existing = JSON.parse(localStorage.getItem(storageKey) || '{}');
                existing[genKey] = itinObj;
                localStorage.setItem(storageKey, JSON.stringify(existing));
            } catch(e) {
                console.warn('Could not save generated itinerary to localStorage:', e);
            }

            // Rebuild tabs and select the new one
            buildTabsUI();
            selectItinerary(genKey);
            if (currentView !== 'itineraries') switchView('itineraries');

            closeGeneratorModal();
            showCopyToast('Itinerary created! Check the new tab.');
            lastGeneratedItinerary = null;
        }

        function loadSavedGeneratedItineraries() {
            // Called after destination loads to restore any generated itineraries from localStorage
            try {
                const storageKey = 'tripMap_genItin_' + activeDestination;
                const saved = JSON.parse(localStorage.getItem(storageKey) || '{}');
                Object.entries(saved).forEach(([key, itinObj]) => {
                    if (!itineraryData[key]) {
                        itinObj.isGenerated = true;
                        itineraryData[key] = itinObj;
                        originalItineraryData[key] = JSON.parse(JSON.stringify(itinObj));
                    }
                });
            } catch(e) {}
        }

        function deleteGeneratedItinerary(key) {
            if (!confirm('Delete this generated itinerary?')) return;

            delete itineraryData[key];
            delete originalItineraryData[key];

            // Remove from localStorage
            try {
                const storageKey = 'tripMap_genItin_' + activeDestination;
                const saved = JSON.parse(localStorage.getItem(storageKey) || '{}');
                delete saved[key];
                localStorage.setItem(storageKey, JSON.stringify(saved));
            } catch(e) {}

            // Rebuild tabs, switch to first available
            buildTabsUI();
            const firstKey = Object.keys(itineraryData)[0];
            if (firstKey && currentView === 'itineraries') {
                selectItinerary(firstKey);
            }

            showCopyToast('Itinerary deleted');
        }

        async function refineGeneratedItinerary() {
            const input = document.getElementById('genRefineInput');
            const msg = input.value.trim();
            if (!msg) return;
            if (!lastGeneratedItinerary) { showCopyToast('No itinerary to refine'); return; }

            const refineBtn = document.getElementById('genRefineBtn');
            refineBtn.disabled = true;
            refineBtn.innerHTML = '<span class="gen-spinner"></span>Refining...';
            input.disabled = true;
            const errorDiv = document.getElementById('genError');
            errorDiv.style.display = 'none';

            try {
                const dest = destinations[activeDestination];
                const destName = dest ? dest.name : activeDestination;

                // Build a compact system prompt for refinement
                let systemPrompt = 'You are a travel itinerary planner helping refine an existing itinerary for ' + destName + '.\n\n';
                systemPrompt += 'CURRENT ITINERARY:\n' + JSON.stringify(lastGeneratedItinerary, null, 0) + '\n\n';

                // Include available POIs for reference
                const allPois = [...hotels, ...restaurants, ...experiences, ...kidFriendly, ...markets];
                const poiNames = allPois.slice(0, 200).map(p => p.name + (p.desc ? ' (' + p.desc + ')' : '')).join(' | ');
                systemPrompt += 'AVAILABLE PLACES (use these when adding new activities): ' + poiNames + '\n\n';

                systemPrompt += 'RULES:\n';
                systemPrompt += '- Modify only the parts the user asks about. Keep everything else exactly the same.\n';
                systemPrompt += '- If user asks to change a specific day, only change that day.\n';
                systemPrompt += '- If user asks to add/remove activities, adjust accordingly while keeping the itinerary balanced.\n';
                systemPrompt += '- Maintain hotel, breakfast, lunch, dinner structure each day.\n';
                systemPrompt += '- Use places from the AVAILABLE PLACES list when possible.\n';
                systemPrompt += '\nRESPONSE FORMAT: Respond with ONLY the complete updated itinerary as valid JSON (same format as the current itinerary). Include ALL days, not just modified ones. No markdown, no explanation, no code fences.\n';
                systemPrompt += 'IMPORTANT: Output raw JSON only.';

                // Build conversation messages for multi-turn
                refineConversation.push({ role: 'user', content: msg });

                const modelId = (typeof getModelId === 'function') ? getModelId() : 'claude-sonnet-4-5-20250929';
                const maxTokens = modelId.includes('haiku') ? 4096 : 8192;

                const reqBody = {
                    model: modelId,
                    max_tokens: maxTokens,
                    system: systemPrompt,
                    messages: refineConversation.slice(-6) // Keep last 6 messages for context window management
                };

                if (genWebSearch) {
                    reqBody.tools = [{ type: 'web_search_20250305', name: 'web_search', max_uses: 3 }];
                }

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': chatApiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify(reqBody)
                });

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(errData.error?.message || 'API error ' + response.status);
                }

                const data = await response.json();
                let text = '';
                if (data.content) {
                    data.content.forEach(block => {
                        if (block.type === 'text') text += block.text;
                    });
                }
                if (!text) throw new Error('Empty response from AI');

                let jsonStr = text.trim();
                if (jsonStr.startsWith('```')) {
                    jsonStr = jsonStr.replace(/^```(?:json)?\n?/, '').replace(/\n?```$/, '').trim();
                }

                let parsed;
                try {
                    parsed = JSON.parse(jsonStr);
                } catch(e) {
                    throw new Error('AI response was not valid JSON. Try rephrasing your request.');
                }

                if (!parsed.days || !Array.isArray(parsed.days) || parsed.days.length === 0) {
                    throw new Error('Invalid itinerary structure â€” no days found');
                }

                // Look up coordinates
                parsed.days.forEach(day => {
                    if (!day.items) day.items = [];
                    day.items.forEach(item => {
                        if (!item.coord) item.coord = findCoordForName(item.name);
                        if (!item.type) item.type = 'sightseeing';
                    });
                });

                // Track assistant response for multi-turn
                refineConversation.push({ role: 'assistant', content: text });

                // Update the stored itinerary
                lastGeneratedItinerary = parsed;

                // Re-render preview
                renderGeneratorPreview(parsed);
                input.value = '';
                showCopyToast('Itinerary refined!');

            } catch(e) {
                errorDiv.textContent = e.message;
                errorDiv.style.display = 'block';
                // Remove the failed user message from conversation
                refineConversation.pop();
            } finally {
                refineBtn.disabled = false;
                refineBtn.innerHTML = 'Refine';
                input.disabled = false;
                input.focus();
            }
        }

        function renderGeneratorPreview(parsed) {
            const previewArea = document.getElementById('genPreviewArea');
            let previewHtml = '<div class="gen-preview">';
            previewHtml += '<div style="font-size:13px;font-weight:700;color:#333;margin-bottom:8px;">' + escapeHtml(parsed.name || 'Generated Itinerary') + '</div>';
            parsed.days.forEach(day => {
                previewHtml += '<div class="gen-preview-day">';
                previewHtml += '<div class="gen-preview-day-title">Day ' + day.day + ' \u2014 ' + escapeHtml(day.title || '') + '</div>';
                (day.items || []).forEach(item => {
                    const icon = item.type === 'hotel' ? '\uD83C\uDFE8' : item.type === 'breakfast' ? '\uD83C\uDF73' : item.type === 'lunch' ? '\uD83C\uDF5C' : item.type === 'dinner' ? '\uD83C\uDF77' : item.type === 'nap' ? '\uD83D\uDCA4' : item.type === 'optional' ? '\u2728' : '\uD83D\uDCCD';
                    const coordStatus = item.coord ? '' : ' <span style="color:#F59E0B;font-size:10px;">(no coords)</span>';
                    previewHtml += '<div class="gen-preview-item"><span class="type-badge">' + icon + ' ' + escapeHtml(item.type) + '</span> ' + escapeHtml(item.name) + coordStatus + '</div>';
                });
                previewHtml += '</div>';
            });
            previewHtml += '</div>';
            // Add refinement input
            previewHtml += '<div class="gen-refine-bar">';
            previewHtml += '<input class="gen-refine-input" id="genRefineInput" placeholder="e.g. Make day 3 more adventurous, add a beach day..." onkeydown="if(event.key===\'Enter\' && !event.shiftKey){event.preventDefault();refineGeneratedItinerary();}" />';
            previewHtml += '<button class="gen-refine-btn" id="genRefineBtn" onclick="refineGeneratedItinerary()">Refine</button>';
            previewHtml += '</div>';
            previewHtml += '<div class="gen-refine-hint">Ask to modify specific days, swap activities, change pace, add rest days, etc.</div>';
            previewArea.innerHTML = previewHtml;
            previewArea.style.display = 'block';
        }

        // ============================================
        // INITIALIZATION
        // ============================================

        document.addEventListener('DOMContentLoaded', async function() {
            await loadConfig();  // Load config.json for family deployment (pre-configured API key)
            initMap();
            loadManifest();  // Load destinations from JSON files

            // Mobile bottom-sheet behavior
            const sidebar = document.getElementById('sidebar');
            const dragHandle = document.getElementById('dragHandle');

            if (window.innerWidth <= 768) {
                dragHandle.style.display = 'block';

                // States: collapsed, half, expanded
                let mobileState = 'collapsed';
                const COLLAPSED_PX = 145;
                const HALF_VH = 50;
                const EXPANDED_VH = 85;

                function setMobileState(state, animate) {
                    mobileState = state;
                    sidebar.classList.remove('mobile-collapsed', 'mobile-half', 'mobile-expanded');
                    if (!animate) sidebar.style.transition = 'none';
                    else sidebar.style.transition = '';

                    if (state === 'collapsed') {
                        sidebar.classList.add('mobile-collapsed');
                        sidebar.style.maxHeight = COLLAPSED_PX + 'px';
                    } else if (state === 'half') {
                        sidebar.classList.add('mobile-half');
                        sidebar.style.maxHeight = HALF_VH + 'vh';
                    } else {
                        sidebar.classList.add('mobile-expanded');
                        sidebar.style.maxHeight = EXPANDED_VH + 'vh';
                    }
                    // Restore transition after frame
                    if (!animate) requestAnimationFrame(() => { sidebar.style.transition = ''; });
                }

                // Start collapsed
                setMobileState('collapsed', false);

                // Drag logic
                let startY = 0, startH = 0, dragging = false, lastVelocity = 0, lastTime = 0, lastY = 0;

                dragHandle.addEventListener('touchstart', (e) => {
                    startY = e.touches[0].clientY;
                    startH = sidebar.offsetHeight;
                    dragging = true;
                    lastY = startY;
                    lastTime = Date.now();
                    lastVelocity = 0;
                    sidebar.style.transition = 'none';
                }, { passive: true });

                dragHandle.addEventListener('touchmove', (e) => {
                    if (!dragging) return;
                    const currentY = e.touches[0].clientY;
                    const diff = startY - currentY;
                    const now = Date.now();
                    const dt = now - lastTime;
                    if (dt > 0) lastVelocity = (lastY - currentY) / dt;
                    lastY = currentY;
                    lastTime = now;
                    const newH = Math.min(Math.max(COLLAPSED_PX, startH + diff), window.innerHeight * (EXPANDED_VH / 100));
                    sidebar.style.maxHeight = newH + 'px';
                    // Toggle hidden content visibility at threshold
                    if (newH > COLLAPSED_PX + 20) {
                        sidebar.classList.remove('mobile-collapsed');
                    } else {
                        sidebar.classList.add('mobile-collapsed');
                    }
                    e.preventDefault();
                }, { passive: false });

                function snapToNearest() {
                    if (!dragging) return;
                    dragging = false;
                    sidebar.style.transition = '';
                    const h = sidebar.offsetHeight;
                    const vh = window.innerHeight;
                    const halfPx = vh * HALF_VH / 100;
                    const expandedPx = vh * EXPANDED_VH / 100;
                    // Use velocity for flick gestures
                    if (lastVelocity > 0.5) {
                        // Swiping up fast
                        if (mobileState === 'collapsed') setMobileState('half', true);
                        else setMobileState('expanded', true);
                    } else if (lastVelocity < -0.5) {
                        // Swiping down fast
                        if (mobileState === 'expanded') setMobileState('half', true);
                        else setMobileState('collapsed', true);
                    } else {
                        // Snap to closest
                        const distCollapsed = Math.abs(h - COLLAPSED_PX);
                        const distHalf = Math.abs(h - halfPx);
                        const distExpanded = Math.abs(h - expandedPx);
                        const minDist = Math.min(distCollapsed, distHalf, distExpanded);
                        if (minDist === distCollapsed) setMobileState('collapsed', true);
                        else if (minDist === distHalf) setMobileState('half', true);
                        else setMobileState('expanded', true);
                    }
                }

                dragHandle.addEventListener('touchend', snapToNearest, { passive: true });
                dragHandle.addEventListener('touchcancel', snapToNearest, { passive: true });

                // Tap handle to toggle collapsed <-> half
                let tapStartY = 0, tapMoved = false;
                dragHandle.addEventListener('pointerdown', (e) => { tapStartY = e.clientY; tapMoved = false; });
                dragHandle.addEventListener('pointermove', (e) => {
                    if (Math.abs(e.clientY - tapStartY) > 8) tapMoved = true;
                });
                dragHandle.addEventListener('pointerup', (e) => {
                    if (tapMoved) return;
                    if (mobileState === 'collapsed') setMobileState('half', true);
                    else setMobileState('collapsed', true);
                });
            }
        });
    </script>
</body>
</html>
