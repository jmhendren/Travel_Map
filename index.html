<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Map — Interactive Trip Planner</title>

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563EB">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Travel Map">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    
    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
        }

        .container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        #map-container {
            flex: 1;
            position: relative;
            z-index: 1;
        }

        .leaflet-container {
            width: 100%;
            height: 100%;
            background: #f0f0f0;
        }

        /* Sidebar */
        .sidebar {
            width: 380px;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            z-index: 10;
            transition: transform 0.3s ease;
        }

        .sidebar.hidden {
            transform: translateX(100%);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 2px solid #e5e5e5;
            background: white;
            z-index: 11;
        }

        .sidebar-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Tabs for Itineraries */
        .itin-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .itin-tab {
            flex: 1 1 100%;
            padding: 10px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: #f9fafb;
            cursor: pointer;
            font-weight: 500;
            font-size: 12px;
            text-align: left;
            transition: all 0.2s;
            color: #6b7280;
        }

        .itin-tab:hover {
            border-color: #999;
            background: #f0f0f0;
        }

        .itin-tab.active {
            background: white;
            border-color: #333;
            color: #111827;
            font-weight: 600;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        /* Tab colors */
        .itin-tab-a.active { color: #2563EB; border-color: #2563EB; }
        .itin-tab-b.active { color: #059669; border-color: #059669; }
        .itin-tab-c.active { color: #D97706; border-color: #D97706; }
        .itin-tab-d.active { color: #DC2626; border-color: #DC2626; }
        .itin-tab-e.active { color: #7C3AED; border-color: #7C3AED; }

        /* Generated itinerary tabs */
        .itin-tab-generated { border-style: dashed !important; }
        .itin-tab-generated.active { border-style: solid !important; }
        .itin-tab-delete { cursor: pointer; margin-left: 6px; opacity: 0.5; font-size: 13px; font-weight: 700; }
        .itin-tab-delete:hover { opacity: 1; color: #DC2626; }

        /* Generator modal */
        .gen-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center; }
        .gen-overlay.active { display: flex; }
        .gen-modal { background: white; border-radius: 16px; padding: 24px; max-width: 480px; width: 92%; box-shadow: 0 10px 50px rgba(0,0,0,0.3); max-height: 85vh; overflow-y: auto; }
        .gen-modal-title { font-size: 16px; font-weight: 700; margin-bottom: 4px; color: #333; }
        .gen-modal-subtitle { font-size: 12px; color: #888; margin-bottom: 16px; }
        .gen-field { margin-bottom: 14px; }
        .gen-field label { display: block; font-size: 11px; font-weight: 600; color: #555; margin-bottom: 5px; }
        .gen-field input, .gen-field select, .gen-field textarea { width: 100%; padding: 9px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 12px; font-family: inherit; box-sizing: border-box; }
        .gen-field input:focus, .gen-field select:focus, .gen-field textarea:focus { outline: none; border-color: #7C3AED; }
        .gen-field textarea { resize: vertical; min-height: 56px; }
        .gen-interests { display: flex; flex-wrap: wrap; gap: 6px; }
        .gen-interest-chip { padding: 5px 12px; border: 1.5px solid #ddd; border-radius: 20px; font-size: 11px; font-weight: 500; cursor: pointer; background: white; color: #555; transition: all 0.15s; user-select: none; }
        .gen-interest-chip.selected { background: #7C3AED; color: white; border-color: #7C3AED; }
        .gen-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 18px; }
        .gen-btn { padding: 9px 22px; border: none; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.15s; }
        .gen-btn.primary { background: #7C3AED; color: white; }
        .gen-btn.primary:hover { background: #6D28D9; }
        .gen-btn.primary:disabled { background: #C4B5FD; cursor: not-allowed; }
        .gen-btn.secondary { background: #f0f0f0; color: #333; }
        .gen-btn.secondary:hover { background: #ddd; }
        .gen-spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: genSpin 0.6s linear infinite; margin-right: 6px; vertical-align: middle; }
        @keyframes genSpin { to { transform: rotate(360deg); } }
        .gen-generate-btn { width: 100%; padding: 12px; font-size: 13px; margin-top: 8px; }
        .gen-preview { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px; margin-top: 12px; max-height: 300px; overflow-y: auto; }
        .gen-preview-day { margin-bottom: 10px; }
        .gen-preview-day-title { font-size: 11px; font-weight: 700; color: #7C3AED; margin-bottom: 4px; }
        .gen-preview-item { font-size: 11px; color: #555; padding: 2px 0; }
        .gen-preview-item .type-badge { display: inline-block; font-size: 10px; font-weight: 600; color: #888; width: 70px; }
        .gen-profile-bar { display: flex; gap: 6px; margin-bottom: 14px; align-items: center; }
        .gen-profile-select { flex: 1; padding: 7px 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 11px; font-family: inherit; background: white; }
        .gen-profile-select:focus { outline: none; border-color: #7C3AED; }
        .gen-profile-btn { padding: 6px 10px; border: 1.5px solid #7C3AED; background: white; color: #7C3AED; border-radius: 8px; cursor: pointer; font-size: 10px; font-weight: 600; white-space: nowrap; transition: all 0.15s; }
        .gen-profile-btn:hover { background: #7C3AED; color: white; }
        .gen-profile-btn.danger { border-color: #DC2626; color: #DC2626; }
        .gen-profile-btn.danger:hover { background: #DC2626; color: white; }
        .gen-profile-save-row { display: none; gap: 6px; margin-bottom: 14px; align-items: center; }
        .gen-profile-save-row.active { display: flex; }
        .gen-profile-save-input { flex: 1; padding: 7px 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 11px; font-family: inherit; }
        .gen-profile-save-input:focus { outline: none; border-color: #7C3AED; }
        .gen-refine-bar { display: flex; gap: 6px; margin-top: 10px; align-items: center; }
        .gen-refine-input { flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 12px; font-family: inherit; }
        .gen-refine-input:focus { outline: none; border-color: #7C3AED; }
        .gen-refine-btn { padding: 8px 14px; border: none; background: #7C3AED; color: white; border-radius: 8px; cursor: pointer; font-size: 11px; font-weight: 600; transition: all 0.15s; white-space: nowrap; }
        .gen-refine-btn:hover { background: #6D28D9; }
        .gen-refine-btn:disabled { background: #C4B5FD; cursor: not-allowed; }
        .gen-refine-hint { font-size: 10px; color: #888; margin-top: 6px; }
        @media (max-width: 768px) {
            .gen-modal { max-width: 95%; padding: 16px; max-height: 80vh; }
        }

        /* ====== 3-Option Itinerary Mode Selector ====== */
        .itin-mode-selector { display: flex; flex-direction: column; gap: 10px; padding: 4px 0; }
        .itin-mode-card {
            display: flex; align-items: center; gap: 14px;
            padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 12px;
            background: #f9fafb; cursor: pointer; transition: all 0.2s;
            user-select: none;
        }
        .itin-mode-card:hover { border-color: #7C3AED; background: #faf5ff; transform: translateY(-1px); box-shadow: 0 2px 8px rgba(124,58,237,0.1); }
        .itin-mode-card:active { transform: translateY(0); }
        .itin-mode-card .card-icon { font-size: 28px; flex-shrink: 0; width: 40px; text-align: center; }
        .itin-mode-card .card-text { flex: 1; min-width: 0; }
        .itin-mode-card .card-title { font-size: 13px; font-weight: 700; color: #111827; margin-bottom: 2px; }
        .itin-mode-card .card-desc { font-size: 11px; color: #6b7280; line-height: 1.3; }
        .itin-mode-card .card-arrow { color: #9ca3af; font-size: 14px; flex-shrink: 0; }
        .itin-mode-card:hover .card-arrow { color: #7C3AED; }
        .itin-mode-back {
            display: inline-flex; align-items: center; gap: 4px;
            background: none; border: none; color: #6b7280; font-size: 11px;
            font-weight: 600; cursor: pointer; padding: 6px 0; margin-bottom: 8px;
            transition: color 0.15s;
        }
        .itin-mode-back:hover { color: #7C3AED; }
        .itin-mode-back .back-arrow { font-size: 14px; }

        /* ====== Inline Generator (Option 2) ====== */
        .itin-inline-gen { padding: 4px 0; }
        .itin-inline-gen .gen-modal-title { font-size: 15px; margin-bottom: 2px; }
        .itin-inline-gen .gen-modal-subtitle { margin-bottom: 12px; }
        .itin-inline-gen .gen-generate-btn { margin-top: 6px; }
        .itin-inline-gen .gen-preview { max-height: 250px; }

        /* ====== Step-by-Step Builder ====== */
        .step-builder { padding: 4px 0; }
        .step-builder-progress {
            display: flex; align-items: center; gap: 0; margin-bottom: 16px;
            padding: 8px 0; overflow-x: auto; scrollbar-width: none;
        }
        .step-builder-progress::-webkit-scrollbar { display: none; }
        .step-dot {
            width: 24px; height: 24px; border-radius: 50%;
            border: 2px solid #d1d5db; background: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 700; color: #9ca3af;
            flex-shrink: 0; transition: all 0.2s; cursor: pointer;
        }
        .step-dot.active { border-color: #7C3AED; background: #7C3AED; color: white; }
        .step-dot.completed { border-color: #10B981; background: #10B981; color: white; }
        .step-dot.completed::after { content: '✓'; }
        .step-line { flex: 1; height: 2px; background: #d1d5db; min-width: 8px; }
        .step-line.completed { background: #10B981; }
        .step-builder-title { font-size: 14px; font-weight: 700; color: #111827; margin-bottom: 4px; }
        .step-builder-subtitle { font-size: 11px; color: #6b7280; margin-bottom: 14px; }
        .step-builder-field { margin-bottom: 12px; }
        .step-builder-field label { display: block; font-size: 11px; font-weight: 600; color: #555; margin-bottom: 4px; }
        .step-builder-field input, .step-builder-field select {
            width: 100%; padding: 9px 12px; border: 1px solid #ddd; border-radius: 8px;
            font-size: 12px; font-family: inherit; box-sizing: border-box;
        }
        .step-builder-field input:focus, .step-builder-field select:focus { outline: none; border-color: #7C3AED; }
        .step-builder-nav { display: flex; gap: 8px; margin-top: 16px; }
        .step-builder-nav button {
            flex: 1; padding: 10px; border: none; border-radius: 8px;
            font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.15s;
        }
        .step-nav-prev { background: #f0f0f0; color: #333; }
        .step-nav-prev:hover { background: #e0e0e0; }
        .step-nav-next { background: #7C3AED; color: white; }
        .step-nav-next:hover { background: #6D28D9; }
        .step-nav-next:disabled { background: #C4B5FD; cursor: not-allowed; }

        /* POI Picker */
        .step-poi-search {
            width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px;
            font-size: 12px; font-family: inherit; box-sizing: border-box; margin-bottom: 8px;
        }
        .step-poi-search:focus { outline: none; border-color: #7C3AED; }
        .step-poi-list { max-height: 220px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; -webkit-overflow-scrolling: touch; touch-action: pan-y; overscroll-behavior: contain; }
        .step-poi-item {
            padding: 10px 12px; border-bottom: 1px solid #f3f4f6; cursor: pointer;
            transition: background 0.15s;
        }
        .step-poi-item:last-child { border-bottom: none; }
        .step-poi-item:hover { background: #f9fafb; }
        .step-poi-item.selected { background: #faf5ff; border-left: 3px solid #7C3AED; }
        .step-poi-name { font-size: 12px; font-weight: 600; color: #111827; }
        .step-poi-desc { font-size: 10px; color: #6b7280; margin-top: 2px; line-height: 1.3; }
        .step-poi-tags { display: flex; flex-wrap: wrap; gap: 3px; margin-top: 4px; }
        .step-poi-tag { font-size: 9px; padding: 1px 6px; border-radius: 10px; background: #f3f4f6; color: #6b7280; }

        /* Hotel entry with nights */
        .step-hotel-entry {
            display: flex; align-items: center; gap: 8px;
            padding: 8px 12px; background: #fef2f2; border-radius: 8px;
            margin-bottom: 8px; border: 1px solid #fecaca;
        }
        .step-hotel-entry .hotel-name { flex: 1; font-size: 12px; font-weight: 600; color: #111; }
        .step-hotel-entry .hotel-nights { font-size: 11px; color: #6b7280; }
        .step-hotel-entry .hotel-remove { background: none; border: none; cursor: pointer; color: #9ca3af; font-size: 16px; padding: 0 4px; }
        .step-hotel-entry .hotel-remove:hover { color: #DC2626; }
        .step-nights-input { width: 60px !important; text-align: center; }

        /* Day Planning Slots */
        .step-day-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 0; border-bottom: 1px solid #e5e7eb; margin-bottom: 10px;
        }
        .step-day-header .day-label { font-size: 14px; font-weight: 700; color: #111; }
        .step-day-header .day-hotel { font-size: 11px; color: #6b7280; }
        .step-day-slots { display: flex; flex-direction: column; gap: 8px; }
        .step-day-slot {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 12px; border: 1.5px solid #e5e7eb; border-radius: 8px;
            background: white; transition: all 0.15s;
        }
        .step-day-slot:hover { border-color: #d1d5db; }
        .step-day-slot .slot-icon { font-size: 18px; flex-shrink: 0; }
        .step-day-slot .slot-info { flex: 1; min-width: 0; }
        .step-day-slot .slot-label { font-size: 10px; font-weight: 600; text-transform: uppercase; color: #9ca3af; }
        .step-day-slot .slot-content { font-size: 12px; color: #111; margin-top: 1px; }
        .step-day-slot .slot-content.empty { color: #9ca3af; font-style: italic; }
        .step-day-slot .slot-actions { display: flex; gap: 4px; flex-shrink: 0; }
        .step-day-slot .slot-choose-btn {
            padding: 4px 10px; border: 1.5px solid #7C3AED; background: white;
            color: #7C3AED; border-radius: 14px; font-size: 10px; font-weight: 600;
            cursor: pointer; transition: all 0.15s; white-space: nowrap;
        }
        .step-day-slot .slot-choose-btn:hover { background: #7C3AED; color: white; }
        .step-day-slot .slot-clear-btn {
            padding: 4px 8px; border: none; background: none;
            color: #9ca3af; cursor: pointer; font-size: 14px;
        }
        .step-day-slot .slot-clear-btn:hover { color: #DC2626; }
        .step-day-slot.filled { border-color: #7C3AED; background: #faf5ff; }

        /* AI Recommend Button */
        .step-ai-recommend-btn {
            width: 100%; padding: 10px; margin-top: 10px;
            border: 2px dashed #7C3AED; border-radius: 8px;
            background: linear-gradient(135deg, #faf5ff 0%, #ede9fe 100%);
            color: #7C3AED; font-size: 12px; font-weight: 600;
            cursor: pointer; transition: all 0.2s; display: flex;
            align-items: center; justify-content: center; gap: 6px;
        }
        .step-ai-recommend-btn:hover { background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%); border-style: solid; }
        .step-ai-recommend-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Review step */
        .step-review-card {
            border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 10px;
            overflow: hidden; background: white;
        }
        .step-review-card-header {
            padding: 10px 14px; background: #f9fafb; font-size: 13px;
            font-weight: 600; color: #111; border-bottom: 1px solid #e5e7eb;
        }
        .step-review-card-body { padding: 8px 14px; }
        .step-review-item {
            padding: 4px 0; font-size: 12px; color: #374151;
            border-bottom: 1px solid #f3f4f6;
        }
        .step-review-item:last-child { border-bottom: none; }
        .step-review-item .review-type { font-size: 10px; font-weight: 600; text-transform: uppercase; color: #9ca3af; margin-right: 6px; }
        .step-save-btn {
            width: 100%; padding: 12px; background: #10B981; color: white;
            border: none; border-radius: 8px; font-size: 14px; font-weight: 700;
            cursor: pointer; margin-top: 12px; transition: all 0.15s;
        }
        .step-save-btn:hover { background: #059669; }

        /* Draft resume prompt */
        .step-draft-prompt {
            padding: 14px; border: 2px solid #F59E0B; border-radius: 10px;
            background: #FFFBEB; margin-bottom: 14px;
        }
        .step-draft-prompt p { font-size: 12px; color: #92400E; margin: 0 0 10px 0; }
        .step-draft-prompt-actions { display: flex; gap: 8px; }
        .step-draft-prompt-actions button { flex: 1; padding: 8px; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; border: none; }
        .step-draft-resume { background: #F59E0B; color: white; }
        .step-draft-resume:hover { background: #D97706; }
        .step-draft-new { background: #f0f0f0; color: #333; }
        .step-draft-new:hover { background: #e0e0e0; }

        /* Mobile-specific mode selector tweaks */
        @media (max-width: 768px) {
            .itin-mode-card { padding: 12px 14px; gap: 12px; }
            .itin-mode-card .card-icon { font-size: 24px; width: 34px; }
            .itin-mode-card .card-title { font-size: 13px; }
            .step-poi-list { max-height: 180px; }

            /* Mobile sub-views must flex-fill so sheet-scroll works */
            #mobileCuratedView,
            #mobileGenerateView,
            #mobileBuilderView {
                display: none;
                flex-direction: column;
                flex: 1;
                min-height: 0;
                overflow: hidden;
            }
            /* When visible via JS (display set to flex) */
            #mobileCuratedView[style*="display:flex"],
            #mobileCuratedView[style*="display: flex"],
            #mobileGenerateView[style*="display:flex"],
            #mobileGenerateView[style*="display: flex"],
            #mobileBuilderView[style*="display:flex"],
            #mobileBuilderView[style*="display: flex"] {
                display: flex !important;
            }
        }

        /* View toggle */
        .view-toggle {
            display: flex;
            gap: 6px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .toggle-btn {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            color: #666;
        }

        .toggle-btn:hover {
            border-color: #999;
        }

        .toggle-btn.active {
            background: #333;
            color: white;
            border-color: #333;
        }

        /* Sidebar content */
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            scroll-behavior: smooth;
        }

        /* Scrollbar styling */
        .sidebar-content::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-content::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .sidebar-content::-webkit-scrollbar-thumb {
            background: #bbb;
            border-radius: 3px;
        }

        .sidebar-content::-webkit-scrollbar-thumb:hover {
            background: #888;
        }

        /* Day Card */
        .day-card {
            margin-bottom: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            overflow: hidden;
            background: white;
            transition: box-shadow 0.2s;
        }

        .day-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .day-card-header {
            padding: 12px 15px;
            background: #f9f9f9;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .day-card-header:hover {
            background: #f0f0f0;
        }

        .day-card-header.active {
            background: #e8f4f8;
            border-bottom-color: #4ECDC4;
        }

        .day-card-toggle {
            color: #999;
            font-size: 12px;
            transition: transform 0.2s;
        }

        .day-card-toggle.open {
            transform: rotate(180deg);
        }

        .day-card-content {
            display: none;
            padding: 12px 15px;
            background: #fafafa;
            max-height: 500px;
            overflow-y: auto;
        }

        .day-card-content.open {
            display: block;
        }

        .day-item {
            padding: 8px 12px;
            margin-bottom: 6px;
            border-radius: 4px;
            font-size: 12px;
            border-left: 3px solid #ddd;
            background: #f0f0f0;
            word-break: break-word;
        }

        .day-item.has-coord {
            cursor: pointer;
            transition: all 0.2s;
        }

        .day-item.has-coord:hover {
            background-color: #e8e8e8;
            transform: translateX(2px);
        }

        /* Day item types */
        .day-item.hotel {
            border-left-color: #E63946;
            background-color: #ffe8eb;
        }

        .day-item.hotel.has-coord:hover {
            background-color: #ffd5df;
        }

        .day-item.breakfast,
        .day-item.lunch,
        .day-item.dinner {
            border-left-color: #F8A500;
            background-color: #fff4e6;
        }

        .day-item.breakfast.has-coord:hover,
        .day-item.lunch.has-coord:hover,
        .day-item.dinner.has-coord:hover {
            background-color: #ffebd2;
        }

        .day-item.nap {
            border-left-color: #999;
            background-color: #f0f0f0;
            font-style: italic;
            color: #666;
        }

        .day-item.sightseeing {
            border-left-color: #4ECDC4;
            background-color: #e8f9f7;
        }

        .day-item.sightseeing.has-coord:hover {
            background-color: #d1f3f0;
        }

        .day-item.optional {
            border-left-color: #9D4EDD;
            background-color: #f3e8ff;
        }

        .day-item.optional.has-coord:hover {
            background-color: #e8d5ff;
        }

        .day-item-type {
            display: inline-block;
            font-weight: 600;
            font-size: 10px;
            text-transform: uppercase;
            margin-right: 6px;
            opacity: 0.7;
        }

        .day-item-name {
            display: inline;
        }

        /* Show All Days button */
        .show-all-days-btn {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            background: #333;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.2s;
        }

        .show-all-days-btn:hover {
            background: #555;
        }

        .show-all-days-btn.active {
            background: #2563EB;
        }

        /* Categories View */
        .categories-content {
            padding: 20px;
        }

        .category-checkbox {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            cursor: pointer;
            background: #f9f9f9;
            border: 1px solid #eee;
            transition: all 0.2s;
        }

        .category-checkbox:hover {
            background: #f0f0f0;
        }

        .category-checkbox input[type="checkbox"] {
            margin-right: 10px;
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        .category-label {
            flex: 1;
            cursor: pointer;
            font-weight: 500;
            font-size: 13px;
            color: #333;
        }

        .category-color {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 6px;
            vertical-align: middle;
        }

        /* Legend */
        .legend {
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .legend-item:last-child {
            margin-bottom: 0;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
        }

        /* Mobile responsive - old sidebar styles removed, handled by new tab-based UI */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            #map-container {
                flex: 1;
                z-index: 1;
            }
        }

        /* Leaflet popup styling */
        .leaflet-popup-content {
            font-size: 13px;
            padding: 8px;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .popup-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .popup-type {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            font-weight: 500;
        }
    
/* ============================================ */
/* SWAP PANEL & PERSISTENCE UI */
/* ============================================ */

.swap-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    display: none;
}
.swap-overlay.active { display: block; }

.swap-panel {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    width: 420px;
    max-width: 92vw;
    max-height: 80vh;
    display: none;
    flex-direction: column;
    z-index: 1001;
    overflow: hidden;
}
.swap-panel.active {
    display: flex;
}
.swap-panel-header {
    padding: 16px 20px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
}
.swap-panel-header h3 {
    margin: 0;
    font-size: 15px;
    font-weight: 700;
    color: #333;
}
.swap-panel-close {
    background: none;
    border: none;
    font-size: 22px;
    cursor: pointer;
    color: #999;
    padding: 0;
    width: 32px; height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    transition: all 0.15s;
}
.swap-panel-close:hover {
    background: #f0f0f0;
    color: #333;
}
.swap-panel-body {
    padding: 16px 20px;
    overflow-y: auto;
    flex: 1;
}
.swap-current {
    padding: 12px 14px;
    background: #e8f4f8;
    border: 1px solid #b2e0db;
    border-radius: 8px;
    margin-bottom: 16px;
}
.swap-current-label {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #0D9488;
    margin-bottom: 6px;
}
.swap-current-name {
    font-weight: 600;
    color: #333;
    font-size: 14px;
}
.swap-current-desc {
    font-size: 11px;
    color: #666;
    margin-top: 4px;
}
.swap-alts-label {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #999;
    margin-bottom: 10px;
}
.swap-alt-card {
    padding: 12px 14px;
    background: #f9f9f9;
    border: 1px solid #eee;
    border-radius: 8px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.15s;
}
.swap-alt-card:hover {
    background: #f0f0f0;
    border-color: #ccc;
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.06);
}
.swap-alt-name {
    font-weight: 600;
    color: #333;
    font-size: 13px;
}
.swap-alt-desc {
    font-size: 11px;
    color: #888;
    margin-top: 3px;
}
.swap-no-alts {
    padding: 24px;
    text-align: center;
    color: #999;
    font-size: 13px;
    background: #f9f9f9;
    border-radius: 8px;
}

/* Swap button in popups */
.popup-swap-btn {
    display: block;
    width: 100%;
    margin-top: 8px;
    padding: 6px 10px;
    background: #4ECDC4;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 11px;
    font-weight: 600;
    transition: background 0.15s;
}
.popup-swap-btn:hover {
    background: #3db8b0;
}

/* Swap icon in sidebar day items */
.day-item-swap {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 22px; height: 22px;
    background: none;
    border: 1px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
    color: #999;
    margin-left: 6px;
    flex-shrink: 0;
    transition: all 0.15s;
    padding: 0;
}
.day-item-swap:hover {
    background: #4ECDC4;
    color: white;
    border-color: #4ECDC4;
}

/* Day item layout adjustment for swap button */
.day-item {
    display: flex;
    align-items: center;
}
.day-item-name {
    flex: 1;
}

/* Reset button on day cards */
.day-reset-btn {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 8px;
    background: #fff3cd;
    border: 1px solid #F8A500;
    border-radius: 4px;
    cursor: pointer;
    font-size: 10px;
    font-weight: 600;
    color: #9a6700;
    transition: all 0.15s;
    white-space: nowrap;
}
.day-reset-btn:hover {
    background: #F8A500;
    color: white;
}

/* Modified indicator on day header */
.day-card-header.modified {
    border-left: 3px solid #F8A500;
}

@media (max-width: 768px) {
    .swap-panel {
        width: auto;
        max-width: 95vw;
        max-height: 70vh;
        top: auto;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
    }
}


/* ============================================ */
/* AI CHAT PANEL                                */
/* ============================================ */

.chat-fab {
    position: fixed;
    bottom: 24px;
    right: 24px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4ECDC4, #2563EB);
    color: white;
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 16px rgba(37, 99, 235, 0.4);
    z-index: 900;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    transition: all 0.2s;
}
.chat-fab:hover {
    transform: scale(1.08);
    box-shadow: 0 6px 24px rgba(37, 99, 235, 0.5);
}
.chat-fab.hidden { display: none; }

.chat-panel {
    position: fixed;
    bottom: 90px;
    right: 24px;
    width: 400px;
    max-width: calc(100vw - 48px);
    height: 520px;
    max-height: calc(100vh - 120px);
    background: white;
    border-radius: 16px;
    box-shadow: 0 10px 50px rgba(0,0,0,0.25);
    z-index: 901;
    display: none;
    flex-direction: column;
    overflow: hidden;
}
.chat-panel.active { display: flex; }

.chat-header {
    padding: 14px 16px;
    background: linear-gradient(135deg, #4ECDC4, #2563EB);
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
}
.chat-header-title {
    font-size: 14px;
    font-weight: 700;
}
.chat-header-context {
    font-size: 10px;
    opacity: 0.85;
    margin-top: 2px;
}
.chat-header-close {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.15s;
}
.chat-header-close:hover { background: rgba(255,255,255,0.35); }

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 12px 14px;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.chat-msg {
    max-width: 88%;
    padding: 10px 14px;
    border-radius: 12px;
    font-size: 13px;
    line-height: 1.5;
    word-wrap: break-word;
}
.chat-msg.assistant {
    align-self: flex-start;
    background: #f0f4f8;
    color: #333;
    border-bottom-left-radius: 4px;
}
.chat-msg.user {
    align-self: flex-end;
    background: #2563EB;
    color: white;
    border-bottom-right-radius: 4px;
}
.chat-msg.system {
    align-self: center;
    background: #fff3cd;
    color: #856404;
    font-size: 11px;
    padding: 6px 12px;
    border-radius: 8px;
    text-align: center;
    max-width: 95%;
}
.chat-msg.error {
    align-self: center;
    background: #f8d7da;
    color: #721c24;
    font-size: 11px;
    padding: 6px 12px;
    border-radius: 8px;
    text-align: center;
}

.chat-msg-day-preview {
    margin-top: 8px;
    padding: 8px 10px;
    background: rgba(0,0,0,0.04);
    border-radius: 8px;
    font-size: 11px;
}
.chat-msg-day-preview .preview-item {
    padding: 3px 0;
    display: flex;
    gap: 6px;
    align-items: center;
}
.chat-msg-day-preview .preview-type {
    font-weight: 600;
    font-size: 10px;
    text-transform: uppercase;
    min-width: 65px;
    color: #666;
}
.chat-msg-apply-btn {
    display: block;
    width: 100%;
    margin-top: 10px;
    padding: 8px;
    background: #4ECDC4;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 700;
    transition: background 0.15s;
}
.chat-msg-apply-btn:hover { background: #3db8b0; }
.chat-msg-apply-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
}

.chat-input-area {
    padding: 10px 14px;
    border-top: 1px solid #eee;
    display: flex;
    gap: 8px;
    flex-shrink: 0;
    align-items: flex-end;
}
.chat-input {
    flex: 1;
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 10px 14px;
    font-size: 13px;
    font-family: inherit;
    resize: none;
    max-height: 80px;
    min-height: 40px;
    line-height: 1.4;
    outline: none;
    transition: border-color 0.15s;
}
.chat-input:focus { border-color: #2563EB; }
.chat-send-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #2563EB;
    color: white;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
    transition: background 0.15s;
}
.chat-send-btn:hover { background: #1d4ed8; }
.chat-send-btn:disabled { background: #ccc; cursor: not-allowed; }

.chat-settings {
    padding: 10px 14px;
    border-top: 1px solid #eee;
    flex-shrink: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.chat-model-toggle {
    display: flex;
    gap: 4px;
}
.chat-model-btn {
    padding: 4px 10px;
    border: 1px solid #ddd;
    border-radius: 12px;
    background: white;
    cursor: pointer;
    font-size: 10px;
    font-weight: 600;
    color: #666;
    transition: all 0.15s;
}
.chat-model-btn.active {
    background: #333;
    color: white;
    border-color: #333;
}
.chat-settings-key {
    font-size: 10px;
    color: #999;
    cursor: pointer;
    text-decoration: underline;
}
.chat-settings-key:hover { color: #666; }

.chat-typing {
    display: flex;
    gap: 4px;
    padding: 8px 14px;
    align-self: flex-start;
}
.chat-typing span {
    width: 6px;
    height: 6px;
    background: #999;
    border-radius: 50%;
    animation: chatTyping 1.2s infinite;
}
.chat-typing span:nth-child(2) { animation-delay: 0.2s; }
.chat-typing span:nth-child(3) { animation-delay: 0.4s; }
@keyframes chatTyping {
    0%, 60%, 100% { opacity: 0.3; transform: translateY(0); }
    30% { opacity: 1; transform: translateY(-4px); }
}

/* API Key Setup Screen */
.chat-setup {
    flex: 1;
    padding: 24px 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
}
.chat-setup h3 {
    margin: 0 0 8px 0;
    font-size: 16px;
    color: #333;
}
.chat-setup p {
    margin: 0 0 16px 0;
    font-size: 12px;
    color: #666;
    line-height: 1.5;
}
.chat-setup input {
    width: 100%;
    padding: 10px 14px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 13px;
    font-family: monospace;
    margin-bottom: 12px;
}
.chat-setup button {
    padding: 10px 24px;
    background: #2563EB;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: background 0.15s;
}
.chat-setup button:hover { background: #1d4ed8; }
.chat-setup a {
    display: block;
    margin-top: 12px;
    font-size: 11px;
    color: #2563EB;
}

/* Chat FAB/panel hidden on mobile - handled by new tab-based UI */
@media (max-width: 768px) {
    .chat-fab {
        display: none !important;
    }
    .chat-panel {
        display: none !important;
    }
}

/* ============================================ */
/* CITY ACTIVITY BROWSER (Phase 1b)            */
/* ============================================ */

.browser-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.4);
    z-index: 900;
}
.browser-overlay.active { display: block; }

.city-browser {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 400px;
    height: 100vh;
    background: white;
    box-shadow: 2px 0 20px rgba(0,0,0,0.15);
    z-index: 901;
    flex-direction: column;
    transform: translateX(-100%);
    transition: transform 0.3s ease;
}
.city-browser.active {
    display: flex;
    transform: translateX(0);
}

.browser-header {
    padding: 16px;
    border-bottom: 1px solid #e5e5e5;
    background: linear-gradient(135deg, #4ECDC4, #2563EB);
    color: white;
}
.browser-header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}
.browser-header-title {
    font-size: 16px;
    font-weight: 700;
}
.browser-header-subtitle {
    font-size: 11px;
    opacity: 0.85;
    margin-top: 2px;
}
.browser-close {
    width: 32px; height: 32px;
    background: rgba(255,255,255,0.2);
    border: none;
    border-radius: 50%;
    color: white;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.15s;
}
.browser-close:hover { background: rgba(255,255,255,0.35); }

.browser-search {
    width: 100%;
    padding: 8px 12px;
    border: none;
    border-radius: 8px;
    font-size: 13px;
    background: rgba(255,255,255,0.9);
    outline: none;
    transition: background 0.15s;
}
.browser-search::placeholder { color: #999; }
.browser-search:focus { background: white; }

.browser-chips {
    display: flex;
    gap: 6px;
    padding: 10px 16px;
    overflow-x: auto;
    border-bottom: 1px solid #eee;
    background: #fafafa;
}
.browser-chips::-webkit-scrollbar { height: 0; }
.browser-chip {
    padding: 5px 12px;
    border: 1px solid #ddd;
    border-radius: 20px;
    font-size: 11px;
    cursor: pointer;
    white-space: nowrap;
    background: white;
    transition: all 0.2s;
}
.browser-chip:hover { border-color: #999; background: #f0f0f0; }
.browser-chip.active {
    background: #333;
    color: white;
    border-color: #333;
}

.browser-body {
    flex: 1;
    overflow-y: auto;
    padding: 12px 16px;
}
.browser-body::-webkit-scrollbar { width: 6px; }
.browser-body::-webkit-scrollbar-track { background: #f1f1f1; }
.browser-body::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
.browser-body::-webkit-scrollbar-thumb:hover { background: #999; }

.browser-group {
    margin-bottom: 20px;
}
.browser-group-title {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #666;
    margin-bottom: 8px;
    padding-bottom: 6px;
    border-bottom: 1px solid #eee;
}
.browser-activity {
    padding: 10px 12px;
    margin-bottom: 6px;
    border-radius: 8px;
    background: #f9f9f9;
    border: 1px solid #eee;
    cursor: pointer;
    transition: all 0.2s;
}
.browser-activity:hover {
    background: #e8f4f8;
    border-color: #4ECDC4;
    transform: translateX(2px);
}
.browser-activity.selected {
    background: #e8f4f8;
    border-color: #4ECDC4;
    box-shadow: 0 2px 8px rgba(78, 205, 196, 0.2);
}
.browser-activity-name {
    font-size: 13px;
    font-weight: 600;
    color: #333;
}
.browser-activity-desc {
    font-size: 11px;
    color: #666;
    margin-top: 2px;
}
.browser-activity-type {
    display: inline-block;
    font-size: 9px;
    font-weight: 600;
    text-transform: uppercase;
    padding: 2px 6px;
    border-radius: 3px;
    margin-top: 4px;
}
.browser-activity-type.hotel { background: #ffe8eb; color: #E63946; }
.browser-activity-type.restaurant { background: #fff4e6; color: #F8A500; }
.browser-activity-type.experience { background: #e8f9f7; color: #0D9488; }
.browser-activity-type.kid { background: #e8faf5; color: #059669; }
.browser-activity-type.market { background: #f3e8ff; color: #9D4EDD; }

.browser-slot-picker {
    display: none;
    margin-top: 8px;
    padding: 8px;
    background: white;
    border: 1px solid #4ECDC4;
    border-radius: 6px;
    animation: slotPickerFadeIn 0.2s ease;
}
@keyframes slotPickerFadeIn {
    from { opacity: 0; transform: translateY(-4px); }
    to { opacity: 1; transform: translateY(0); }
}
.browser-slot-picker.active { display: block; }
.browser-slot-title {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    color: #0D9488;
    margin-bottom: 6px;
}
.browser-slot-item {
    padding: 6px 10px;
    margin-bottom: 4px;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    background: #f0f0f0;
    border: 1px solid transparent;
    transition: all 0.15s;
}
.browser-slot-item:hover {
    background: #4ECDC4;
    color: white;
}
.browser-no-results {
    padding: 32px 16px;
    text-align: center;
    color: #999;
    font-size: 13px;
}

.day-browse-btn {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    padding: 3px 8px;
    background: #e8f4f8;
    border: 1px solid #4ECDC4;
    border-radius: 4px;
    cursor: pointer;
    font-size: 10px;
    font-weight: 600;
    color: #0D9488;
    transition: all 0.2s;
}
.day-browse-btn:hover {
    background: #4ECDC4;
    color: white;
}

@media (max-width: 768px) {
    .city-browser {
        top: auto;
        bottom: 0;
        left: 0;
        width: 100vw;
        height: 75vh;
        max-height: 75vh;
        border-radius: 16px 16px 0 0;
        transform: translateY(100%);
    }
    .city-browser.active {
        transform: translateY(0);
    }
    .browser-chips {
        padding: 8px 12px;
    }
    .browser-header {
        padding: 12px;
    }
    .day-browse-btn {
        font-size: 9px;
        padding: 2px 6px;
    }
}

/* ============================================ */
/* QUICK FILTER CHIPS (Phase 1c)               */
/* ============================================ */

.filter-chips-row {
    display: flex;
    gap: 5px;
    margin-top: 12px;
    flex-wrap: wrap;
}
.filter-chip {
    padding: 4px 10px;
    border: 1.5px solid #ddd;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 500;
    cursor: pointer;
    background: white;
    color: #555;
    transition: all 0.2s;
    white-space: nowrap;
    user-select: none;
}
.filter-chip:hover {
    border-color: #999;
    background: #f5f5f5;
}
.filter-chip.active {
    color: white;
    border-color: transparent;
}
.filter-chip[data-filter="hotels"].active {
    background: #E63946;
}
.filter-chip[data-filter="dining"].active {
    background: #F8A500;
}
.filter-chip[data-filter="sightseeing"].active {
    background: #2563EB;
}
.filter-chip[data-filter="cameras"].active {
    background: #6B7280;
}
.filter-chip[data-filter="skincare"].active {
    background: #EC4899;
}
.filter-chip[data-filter="kids"].active {
    background: #059669;
}
.filter-chip[data-filter="markets"].active {
    background: #9D4EDD;
}
.filter-chips-clear {
    padding: 4px 8px;
    border: none;
    border-radius: 20px;
    font-size: 10px;
    font-weight: 600;
    cursor: pointer;
    background: #f0f0f0;
    color: #999;
    transition: all 0.2s;
    white-space: nowrap;
}
.filter-chips-clear:hover {
    background: #ddd;
    color: #666;
}
.filter-chips-count {
    font-size: 10px;
    color: #999;
    margin-top: 4px;
    display: none;
}
.filter-chips-count.active {
    display: block;
}

@media (max-width: 768px) {
    .filter-chips-row {
        gap: 4px;
        margin-top: 8px;
    }
    .filter-chip {
        font-size: 10px;
        padding: 3px 8px;
    }
}

/* ============================================ */
/* TAG FILTER PANEL                             */
/* ============================================ */

.tag-filter-toggle {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-top: 8px;
    padding: 5px 12px;
    border: 1.5px solid #e5e7eb;
    border-radius: 8px;
    background: #f9fafb;
    cursor: pointer;
    font-size: 11px;
    font-weight: 500;
    color: #6b7280;
    transition: all 0.2s;
    width: 100%;
    justify-content: space-between;
}
.tag-filter-toggle:hover {
    border-color: #9ca3af;
    background: #f3f4f6;
}
.tag-filter-toggle.has-active {
    border-color: #2563EB;
    color: #2563EB;
    background: #eff6ff;
}
.tag-filter-toggle .chevron {
    transition: transform 0.2s;
    font-size: 10px;
}
.tag-filter-toggle.open .chevron {
    transform: rotate(180deg);
}

.tag-filter-panel {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
    margin-top: 0;
}
.tag-filter-panel.open {
    max-height: 400px;
    overflow-y: auto;
    margin-top: 8px;
}
.tag-filter-panel::-webkit-scrollbar {
    width: 4px;
}
.tag-filter-panel::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 4px;
}

.tag-group {
    margin-bottom: 8px;
}
.tag-group-label {
    font-size: 10px;
    font-weight: 600;
    color: #9ca3af;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
    padding-left: 2px;
}
.tag-group-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
}

.tag-chip {
    padding: 3px 9px;
    border: 1.5px solid #e5e7eb;
    border-radius: 14px;
    font-size: 10px;
    font-weight: 500;
    cursor: pointer;
    background: white;
    color: #6b7280;
    transition: all 0.15s;
    white-space: nowrap;
    user-select: none;
    line-height: 1.3;
}
.tag-chip:hover {
    border-color: #9ca3af;
    background: #f9fafb;
}
.tag-chip.active {
    color: white;
    border-color: transparent;
}

.tag-filter-actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin-top: 6px;
    padding-top: 6px;
    border-top: 1px solid #f3f4f6;
}
.tag-filter-clear-btn {
    padding: 3px 10px;
    border: none;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
    cursor: pointer;
    background: #f3f4f6;
    color: #9ca3af;
    transition: all 0.15s;
}
.tag-filter-clear-btn:hover {
    background: #e5e7eb;
    color: #6b7280;
}
.tag-filter-count {
    font-size: 10px;
    color: #6b7280;
    line-height: 22px;
}

/* Mobile tag filter modal */

.mobile-tag-modal {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 1050;
    background: white;
    border-radius: 16px 16px 0 0;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
    max-height: 60vh;
    overflow-y: auto;
    padding: 16px 16px 24px;
    animation: slideUp 0.25s ease;
}
.mobile-tag-modal.visible {
    display: block;
}
@keyframes slideUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
}
.mobile-tag-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid #e5e7eb;
}
.mobile-tag-modal-title {
    font-size: 14px;
    font-weight: 600;
    color: #1f2937;
}
.mobile-tag-modal-close {
    width: 28px;
    height: 28px;
    border: none;
    background: #f3f4f6;
    border-radius: 50%;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6b7280;
}
.mobile-tag-modal-backdrop {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.3);
    z-index: 1049;
}
.mobile-tag-modal-backdrop.visible {
    display: block;
}

/* ============================================ */
/* Phase 1e: Web Search Toggle + Citations      */
/* ============================================ */
.web-search-toggle {
    display: flex;
    align-items: center;
    gap: 6px;
}
.web-search-label {
    font-size: 10px;
    color: #666;
    font-weight: 600;
}
.web-search-switch {
    position: relative;
    width: 32px;
    height: 18px;
    background: #ccc;
    border-radius: 9px;
    cursor: pointer;
    transition: background 0.2s;
    border: none;
    padding: 0;
}
.web-search-switch.active {
    background: #4ECDC4;
}
.web-search-switch::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 14px;
    height: 14px;
    background: white;
    border-radius: 50%;
    transition: transform 0.2s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
.web-search-switch.active::after {
    transform: translateX(14px);
}
.search-citations {
    margin-top: 10px;
    padding-top: 8px;
    border-top: 1px solid rgba(0,0,0,0.08);
    font-size: 10px;
}
.search-citations-title {
    font-weight: 700;
    color: #888;
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.search-citation-item {
    padding: 3px 0;
    display: flex;
    gap: 4px;
    align-items: flex-start;
}
.search-citation-item a {
    color: #2563EB;
    text-decoration: none;
    word-break: break-all;
}
.search-citation-item a:hover {
    text-decoration: underline;
}
.search-indicator {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    color: #666;
    font-size: 11px;
    font-style: italic;
}

/* ============================================ */
/* Phase 3: Export & Sharing                     */
/* ============================================ */
.day-export-bar {
    display: flex;
    gap: 6px;
    padding: 10px 0 2px 0;
    margin-top: 8px;
    border-top: 1px dashed #ddd;
}
.day-export-btn {
    flex: 1;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    padding: 6px 8px;
    background: #f5f5f5;
    border: 1px solid #ddd;
    border-radius: 6px;
    cursor: pointer;
    font-size: 11px;
    font-weight: 600;
    color: #555;
    transition: all 0.15s;
}
.day-export-btn:hover {
    background: #e8f4f8;
    border-color: #4ECDC4;
    color: #0D9488;
}
.day-export-btn.export-text:hover {
    background: #e8f0ff;
    border-color: #2563EB;
    color: #2563EB;
}
.day-export-btn.export-gmaps:hover {
    background: #e8ffe8;
    border-color: #34A853;
    color: #34A853;
}
.day-export-btn.export-qr:hover {
    background: #f3e8ff;
    border-color: #7C3AED;
    color: #7C3AED;
}
.qr-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1100;
    align-items: center;
    justify-content: center;
}
.qr-overlay.active {
    display: flex;
}
.qr-modal {
    background: white;
    border-radius: 16px;
    padding: 24px;
    max-width: 320px;
    width: 90%;
    text-align: center;
    box-shadow: 0 10px 50px rgba(0,0,0,0.3);
}
.qr-modal-title {
    font-size: 14px;
    font-weight: 700;
    margin-bottom: 4px;
    color: #333;
}
.qr-modal-subtitle {
    font-size: 11px;
    color: #666;
    margin-bottom: 16px;
}
.qr-modal img {
    width: 200px;
    height: 200px;
    border-radius: 8px;
    border: 1px solid #eee;
}
.qr-modal-actions {
    display: flex;
    gap: 8px;
    justify-content: center;
    margin-top: 16px;
}
.qr-modal-close {
    padding: 8px 24px;
    background: #333;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    transition: background 0.15s;
}
.qr-modal-close:hover {
    background: #555;
}
.qr-modal-link {
    display: block;
    margin-top: 10px;
    font-size: 10px;
    color: #2563EB;
    word-break: break-all;
    text-decoration: none;
}
.qr-modal-link:hover {
    text-decoration: underline;
}
/* ============ Geolocation ============ */
.locate-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 1000;
    width: 36px;
    height: 36px;
    background: white;
    border: 2px solid rgba(0,0,0,0.2);
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    box-shadow: 0 1px 5px rgba(0,0,0,0.15);
    transition: all 0.2s;
}
.locate-btn:hover { background: #f0f0f0; }
.locate-btn.active { color: #2563EB; border-color: #2563EB; }
.locate-btn.tracking { animation: locate-pulse 2s infinite; }
@keyframes locate-pulse {
    0%, 100% { box-shadow: 0 1px 5px rgba(0,0,0,0.15); }
    50% { box-shadow: 0 0 12px rgba(37,99,235,0.4); }
}
.user-location-dot {
    width: 14px;
    height: 14px;
    background: #2563EB;
    border: 3px solid white;
    border-radius: 50%;
    box-shadow: 0 0 8px rgba(37,99,235,0.5);
}
.user-location-ring {
    width: 40px;
    height: 40px;
    background: rgba(37,99,235,0.12);
    border: 1px solid rgba(37,99,235,0.25);
    border-radius: 50%;
}

/* ============ Share Modal ============ */
.share-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1100;
    align-items: center;
    justify-content: center;
}
.share-overlay.active { display: flex; }
.share-modal {
    background: white;
    border-radius: 16px;
    padding: 28px;
    max-width: 420px;
    width: 92%;
    box-shadow: 0 10px 50px rgba(0,0,0,0.3);
}
.share-modal-title {
    font-size: 16px;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 2px;
}
.share-modal-subtitle {
    font-size: 12px;
    color: #64748b;
    margin-bottom: 16px;
}
.share-link-box {
    background: #f1f5f9;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 10px 12px;
    font-size: 11px;
    color: #475569;
    word-break: break-all;
    margin-bottom: 8px;
    max-height: 60px;
    overflow-y: auto;
    font-family: monospace;
}
.share-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    width: 100%;
    padding: 10px;
    font-size: 13px;
    font-weight: 600;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.15s;
}
.share-btn-primary {
    background: #2563EB;
    color: white;
}
.share-btn-primary:hover { background: #1d4ed8; }
.share-btn-secondary {
    background: #f1f5f9;
    color: #334155;
    margin-top: 8px;
}
.share-btn-secondary:hover { background: #e2e8f0; }
.share-btn-close {
    background: none;
    color: #94a3b8;
    margin-top: 12px;
    font-size: 12px;
}
.share-btn-close:hover { color: #64748b; }
.share-divider {
    border: none;
    border-top: 1px solid #e2e8f0;
    margin: 14px 0;
}
.shared-banner {
    display: none;
    background: linear-gradient(135deg, #dbeafe, #ede9fe);
    border: 1px solid #bfdbfe;
    border-radius: 10px;
    padding: 10px 14px;
    margin-bottom: 12px;
    font-size: 12px;
    color: #1e40af;
    align-items: center;
    justify-content: space-between;
}
.shared-banner.active { display: flex; }
.shared-banner-dismiss {
    background: none;
    border: none;
    color: #1e40af;
    cursor: pointer;
    font-size: 16px;
    padding: 0 4px;
    opacity: 0.6;
}
.shared-banner-dismiss:hover { opacity: 1; }

/* ============ Print Styles ============ */
@media print {
    body * { visibility: hidden; }
    #printFrame, #printFrame * { visibility: visible; }
    #printFrame {
        position: absolute;
        left: 0; top: 0;
        width: 100%;
    }
}

.copy-toast {
    position: fixed;
    bottom: 40px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: #333;
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    opacity: 0;
    transition: all 0.3s;
    z-index: 1200;
    pointer-events: none;
}
.copy-toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
}
@media (max-width: 768px) {
    .day-export-btn {
        font-size: 10px;
        padding: 5px 4px;
        gap: 2px;
    }
    .qr-modal {
        max-width: 280px;
    }
}

/* ============================================ */
/* Phase 4: Multi-Destination Framework          */
/* ============================================ */
.dest-selector {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 12px;
    padding-bottom: 12px;
    border-bottom: 1px solid #eee;
}
.dest-region-row {
    display: flex;
    align-items: center;
    gap: 8px;
}
.dest-select {
    flex: 1;
    padding: 7px 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    background: white;
    cursor: pointer;
    color: #333;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
    padding-right: 24px;
}
.dest-select:focus {
    outline: none;
    border-color: #4ECDC4;
}
.dest-country-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    max-height: 120px;
    overflow-y: auto;
}
.dest-country-chip {
    padding: 4px 8px;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    font-size: 11px;
    cursor: pointer;
    background: white;
    color: #374151;
    transition: all 0.15s;
    white-space: nowrap;
}
.dest-country-chip:hover {
    background: #f0fffe;
    border-color: #4ECDC4;
}
.dest-country-chip.active {
    background: #4ECDC4;
    color: white;
    border-color: #4ECDC4;
    font-weight: 600;
}
.dest-country-chip.loaded {
    border-color: #93e6df;
    background: #f0fffe;
}
.dest-country-chip.region-active {
    background: #d1faf5;
    border-color: #4ECDC4;
    color: #0d7a72;
    font-weight: 500;
}
.dest-load-region-btn {
    padding: 4px 10px;
    border: 1px solid #4ECDC4;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
    cursor: pointer;
    background: #f0fffe;
    color: #4ECDC4;
    transition: all 0.15s;
    white-space: nowrap;
}
.dest-load-region-btn:hover {
    background: #4ECDC4;
    color: white;
}
.dest-load-region-btn.active {
    background: #4ECDC4;
    color: white;
    border-color: #3bada6;
}
.dest-region-badge {
    font-size: 10px;
    color: #9ca3af;
    padding: 2px 0;
    display: flex;
    align-items: center;
    gap: 8px;
}
.dest-region-pois-toggle {
    font-size: 10px;
    padding: 2px 8px;
    border: 1px solid #d1d5db;
    border-radius: 10px;
    background: white;
    color: #6b7280;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
}
.dest-region-pois-toggle:hover {
    border-color: #4ECDC4;
    color: #0d9488;
}
.dest-region-pois-toggle.active {
    background: #4ECDC4;
    color: white;
    border-color: #4ECDC4;
}
.dest-add-btn {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: #f0f0f0;
    border: 1px solid #ddd;
    cursor: pointer;
    font-size: 16px;
    color: #666;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
    flex-shrink: 0;
}
.dest-add-btn:hover {
    background: #4ECDC4;
    color: white;
    border-color: #4ECDC4;
}
.dest-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1100;
    align-items: center;
    justify-content: center;
}
.dest-overlay.active {
    display: flex;
}
.dest-modal {
    background: white;
    border-radius: 16px;
    padding: 24px;
    max-width: 440px;
    width: 90%;
    box-shadow: 0 10px 50px rgba(0,0,0,0.3);
}
.dest-modal-title {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 6px;
    color: #333;
}
.dest-modal-desc {
    font-size: 12px;
    color: #666;
    line-height: 1.5;
    margin-bottom: 16px;
}
.dest-modal-input {
    width: 100%;
    padding: 10px 14px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 12px;
    font-family: monospace;
    margin-bottom: 8px;
    box-sizing: border-box;
}
.dest-modal-input:focus {
    outline: none;
    border-color: #4ECDC4;
}
.dest-modal-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    margin-top: 16px;
}
.dest-modal-btn {
    padding: 8px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    transition: all 0.15s;
}
.dest-modal-btn.primary {
    background: #4ECDC4;
    color: white;
}
.dest-modal-btn.primary:hover {
    background: #3db8b0;
}
.dest-modal-btn.secondary {
    background: #f0f0f0;
    color: #333;
}
.dest-modal-btn.secondary:hover {
    background: #ddd;
}
.dest-modal-schema {
    margin-top: 12px;
    padding: 10px;
    background: #f8f8f8;
    border-radius: 8px;
    font-size: 10px;
    font-family: monospace;
    max-height: 150px;
    overflow-y: auto;
    white-space: pre-wrap;
    word-break: break-all;
    line-height: 1.4;
    color: #555;
    border: 1px solid #eee;
}
.dest-modal-or {
    text-align: center;
    font-size: 11px;
    color: #999;
    margin: 12px 0;
    font-weight: 600;
}
.dest-modal-file {
    display: flex;
    gap: 8px;
    align-items: center;
}
.dest-modal-file input[type="file"] {
    flex: 1;
    font-size: 11px;
}
@media (max-width: 768px) {
    .dest-selector {
        gap: 6px;
        margin-bottom: 10px;
        padding-bottom: 10px;
    }
    .dest-select {
        font-size: 11px;
    }
    .dest-modal {
        max-width: 95%;
        padding: 16px;
    }
}

/* Annotation badges on markers */
.annotation-badge {
    position: absolute;
    top: -4px;
    right: -4px;
    width: 14px;
    height: 14px;
    background: #f59e0b;
    border: 1.5px solid white;
    border-radius: 50%;
    font-size: 8px;
    line-height: 14px;
    text-align: center;
    z-index: 10;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

/* Annotation card in popups */
.annotation-card {
    background: #fffbeb;
    border: 1px solid #fde68a;
    border-radius: 6px;
    padding: 6px 8px;
    margin-top: 4px;
    font-size: 11px;
}
.annotation-card-header {
    display: flex;
    align-items: center;
    gap: 4px;
    font-weight: 600;
    color: #92400e;
    margin-bottom: 2px;
}
.annotation-card-details {
    color: #78350f;
    line-height: 1.3;
}
.annotation-status {
    display: inline-block;
    padding: 1px 5px;
    border-radius: 3px;
    font-size: 9px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}
.annotation-status.confirmed { background: #d1fae5; color: #065f46; }
.annotation-status.pending { background: #fef3c7; color: #92400e; }
.annotation-status.cancelled { background: #fee2e2; color: #991b1b; text-decoration: line-through; }

/* Annotation form in popups */
.annotation-form {
    margin-top: 6px;
    padding: 8px;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
}
.annotation-form select,
.annotation-form input {
    width: 100%;
    padding: 4px 6px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-size: 11px;
    margin-top: 4px;
    font-family: inherit;
    box-sizing: border-box;
}
.annotation-form label {
    font-size: 10px;
    font-weight: 600;
    color: #6b7280;
    display: block;
    margin-top: 6px;
}
.annotation-form label:first-child { margin-top: 0; }

/* Bookings panel */
.bookings-count-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 16px;
    height: 16px;
    background: #f59e0b;
    color: white;
    border-radius: 8px;
    font-size: 9px;
    font-weight: 700;
    padding: 0 4px;
    margin-left: 4px;
}
.booking-item {
    padding: 10px;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.15s;
}
.booking-item:hover {
    background: #f0f9ff;
    border-color: #93c5fd;
}
.booking-item-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 4px;
}
.booking-item-name {
    font-weight: 600;
    font-size: 13px;
    color: #333;
}
.booking-item-date {
    font-size: 11px;
    color: #6b7280;
}
.booking-item-details {
    font-size: 12px;
    color: #6b7280;
    line-height: 1.4;
}
.booking-filter-tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 12px;
}
.booking-filter-tab {
    padding: 4px 10px;
    font-size: 11px;
    font-weight: 500;
    border: 1px solid #d1d5db;
    border-radius: 12px;
    background: white;
    cursor: pointer;
    transition: all 0.15s;
    color: #6b7280;
}
.booking-filter-tab.active {
    background: #2563EB;
    color: white;
    border-color: #2563EB;
}

/* User indicator */
.user-indicator {
    font-size: 10px;
    color: #9ca3af;
    padding: 2px 8px;
    text-align: center;
}

/* ============================================
   MOBILE TAB-BASED NAVIGATION
   ============================================ */

/* Hide all mobile elements on desktop */
@media (min-width: 769px) {
    .mobile-dest-bar,
    .mobile-tab-bar,
    .mobile-tab-panel,
    .mobile-poi-sheet,
    .mobile-poi-sheet-overlay,
    .mobile-map-controls {
        display: none !important;
    }
}

/* Mobile layout overrides */
@media (max-width: 768px) {
    /* Hide desktop sidebar and chat FAB on mobile */
    .sidebar {
        display: none !important;
    }
    .chat-fab {
        display: none !important;
    }
    .chat-panel {
        display: none !important;
    }

    /* Make container fill viewport accounting for top bar and bottom tab bar + safe area */
    .container {
        flex-direction: column;
        padding-top: 44px;  /* dest bar height */
        padding-bottom: calc(56px + env(safe-area-inset-bottom, 0px)); /* tab bar + iOS home indicator */
    }

    #map-container {
        flex: 1;
        z-index: 1;
        position: relative;
    }

    /* ---- Destination Top Bar ---- */
    .mobile-dest-bar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 44px;
        background: white;
        border-bottom: 1px solid #e5e7eb;
        z-index: 500;
        display: flex;
        align-items: center;
    }

    .mobile-dest-bar-inner {
        width: 100%;
        padding: 0 12px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .mobile-dest-btn {
        display: flex;
        align-items: center;
        gap: 6px;
        background: none;
        border: none;
        font-size: 15px;
        font-weight: 600;
        color: #1a1a1a;
        cursor: pointer;
        padding: 6px 12px;
        border-radius: 8px;
        transition: background 0.15s;
    }

    .mobile-dest-btn:active {
        background: #f3f4f6;
    }

    /* ---- Bottom Tab Bar ---- */
    .mobile-tab-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: calc(56px + env(safe-area-inset-bottom, 0px));
        background: white;
        border-top: 1px solid #e5e7eb;
        display: flex;
        align-items: flex-start;
        justify-content: space-around;
        z-index: 500;
        padding-top: 4px;
        padding-bottom: env(safe-area-inset-bottom, 0px);
    }

    .mobile-tab {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 2px;
        background: none;
        border: none;
        color: #9ca3af;
        font-size: 10px;
        font-weight: 500;
        padding: 6px 0;
        cursor: pointer;
        transition: color 0.15s;
        -webkit-tap-highlight-color: transparent;
    }

    .mobile-tab i {
        font-size: 18px;
    }

    .mobile-tab.active {
        color: #2563EB;
    }

    .mobile-tab:active {
        color: #1d4ed8;
    }

    /* ---- Tab Panels (Bottom Sheet Style) ---- */
    .mobile-tab-panel {
        position: fixed;
        left: 0;
        right: 0;
        bottom: calc(56px + env(safe-area-inset-bottom, 0px));
        background: #f9fafb;
        z-index: 400;
        overflow: hidden;
        border-radius: 16px 16px 0 0;
        box-shadow: 0 -4px 24px rgba(0,0,0,0.12);
        transform: translateY(100%);
        transition: transform 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94), height 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        display: flex;
        flex-direction: column;
        will-change: transform;
    }

    .mobile-tab-panel.sheet-visible {
        transform: translateY(0);
    }

    /* Sheet height detents — half (default) and expanded */
    .mobile-tab-panel.sheet-half {
        height: 50vh;
    }

    .mobile-tab-panel.sheet-expanded {
        height: calc(100vh - 44px - 56px);
        border-radius: 0;
    }

    /* Scrollable inner content */
    .mobile-tab-panel .sheet-scroll {
        flex: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        min-height: 0;
        overscroll-behavior: contain;
    }

    /* Drag handle for sheet panels */
    .sheet-drag-handle {
        width: 100%;
        padding: 8px 0 4px 0;
        text-align: center;
        flex-shrink: 0;
        cursor: grab;
        -webkit-tap-highlight-color: transparent;
    }

    .sheet-drag-handle::before {
        content: '';
        display: inline-block;
        width: 36px;
        height: 4px;
        background: #d1d5db;
        border-radius: 2px;
    }

    /* Close button for sheet panels */
    .sheet-close-btn {
        position: absolute;
        top: 6px;
        right: 10px;
        background: #f3f4f6;
        border: none;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        font-size: 16px;
        color: #6b7280;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        -webkit-tap-highlight-color: transparent;
    }

    .sheet-close-btn:active {
        background: #e5e7eb;
    }

    /* Subtle backdrop behind the sheet so map feels layered */
    .mobile-sheet-backdrop {
        display: none;
        position: fixed;
        top: 44px;
        left: 0;
        right: 0;
        bottom: 56px;
        background: rgba(0,0,0,0.08);
        z-index: 399;
        transition: opacity 0.3s;
        opacity: 0;
    }

    .mobile-sheet-backdrop.visible {
        display: block;
        opacity: 1;
    }

    /* ---- Map Tab (default - map shows through container) ---- */

    /* ---- Floating Category Controls on Map ---- */
    .mobile-map-controls {
        position: absolute;
        bottom: 12px;
        left: 0;
        right: 0;
        z-index: 50;
        display: flex;
        align-items: flex-end;
        gap: 6px;
        padding: 0 6px;
        pointer-events: none;
    }

    .mobile-cat-chips {
        display: flex;
        gap: 6px;
        padding: 6px 4px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        pointer-events: auto;
        flex: 1;
        min-width: 0;
        scrollbar-width: none;
    }

    .mobile-cat-chips::-webkit-scrollbar {
        display: none;
    }

    .mobile-tag-filter-fab {
        flex-shrink: 0;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 1.5px solid #d1d5db;
        background: white;
        font-size: 16px;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        pointer-events: auto;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
        -webkit-tap-highlight-color: transparent;
        position: relative;
    }
    .mobile-tag-filter-fab.has-active {
        background: #7C3AED;
        border-color: #7C3AED;
        box-shadow: 0 2px 10px rgba(124,58,237,0.4);
    }
    .mobile-tag-filter-fab .tag-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        min-width: 16px;
        height: 16px;
        border-radius: 8px;
        background: #EF4444;
        color: white;
        font-size: 9px;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 3px;
    }
    .mobile-tag-filter-fab:active {
        transform: scale(0.9);
    }

    .mobile-cat-chip {
        flex-shrink: 0;
        padding: 6px 12px;
        border-radius: 20px;
        border: 1.5px solid #d1d5db;
        background: white;
        font-size: 12px;
        font-weight: 500;
        color: #6b7280;
        cursor: pointer;
        white-space: nowrap;
        box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        transition: all 0.15s;
        -webkit-tap-highlight-color: transparent;
    }

    .mobile-cat-chip.active {
        background: #2563EB;
        color: white;
        border-color: #2563EB;
    }

    .mobile-cat-chip:active {
        transform: scale(0.95);
    }

    /* ---- POI Detail Bottom Sheet ---- */
    .mobile-poi-sheet-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.3);
        z-index: 550;
    }

    .mobile-poi-sheet-overlay.active {
        display: block;
    }

    .mobile-poi-sheet {
        position: fixed;
        bottom: calc(56px + env(safe-area-inset-bottom, 0px)); /* above tab bar + safe area */
        left: 0;
        right: 0;
        max-height: 55vh;
        background: white;
        border-radius: 16px 16px 0 0;
        box-shadow: 0 -4px 24px rgba(0,0,0,0.15);
        z-index: 560;
        transform: translateY(calc(100% + 60px)); /* push fully below tab bar when hidden */
        transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        will-change: transform;
        pointer-events: none; /* don't block taps on tab bar when hidden */
    }

    .mobile-poi-sheet.active {
        transform: translateY(0);
        pointer-events: auto;
    }

    .mobile-poi-drag-handle {
        width: 100%;
        padding: 10px 0 6px 0;
        text-align: center;
        flex-shrink: 0;
    }

    .mobile-poi-drag-handle::before {
        content: '';
        display: inline-block;
        width: 36px;
        height: 4px;
        background: #d1d5db;
        border-radius: 2px;
    }

    .mobile-poi-close {
        position: absolute;
        top: 8px;
        right: 12px;
        background: #f3f4f6;
        border: none;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        font-size: 16px;
        color: #6b7280;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1;
    }

    .mobile-poi-content {
        padding: 0 16px 16px 16px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        flex: 1;
    }

    .mobile-poi-content .popup-title {
        font-size: 16px;
        font-weight: 700;
        color: #111;
        margin-bottom: 4px;
    }

    .mobile-poi-content .popup-type {
        font-size: 11px;
        font-weight: 600;
        color: #2563EB;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }

    /* ---- Search Panel ---- */
    .mobile-search-bar {
        padding: 8px 12px 8px 12px;
        background: white;
        border-bottom: 1px solid #e5e7eb;
        flex-shrink: 0;
        z-index: 10;
    }

    .mobile-search-input-wrap {
        display: flex;
        align-items: center;
        gap: 8px;
        background: #f3f4f6;
        border-radius: 10px;
        padding: 8px 12px;
    }

    .mobile-search-input {
        flex: 1;
        border: none;
        background: none;
        font-size: 15px;
        color: #1a1a1a;
        outline: none;
        font-family: inherit;
    }

    .mobile-search-input::placeholder {
        color: #9ca3af;
    }

    .mobile-search-clear {
        background: #d1d5db;
        border: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        font-size: 12px;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .mobile-search-chips {
        display: flex;
        gap: 6px;
        padding: 8px 12px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        background: white;
        border-bottom: 1px solid #f3f4f6;
        scrollbar-width: none;
        flex-shrink: 0;
    }

    .mobile-search-chips::-webkit-scrollbar {
        display: none;
    }

    .mobile-search-chip {
        flex-shrink: 0;
        padding: 5px 12px;
        border-radius: 16px;
        border: 1.5px solid #e5e7eb;
        background: white;
        font-size: 12px;
        font-weight: 500;
        color: #6b7280;
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.15s;
    }

    .mobile-search-chip.active {
        background: #2563EB;
        color: white;
        border-color: #2563EB;
    }

    .mobile-search-results {
        padding: 8px 12px;
    }

    .mobile-search-empty {
        text-align: center;
        color: #9ca3af;
        padding: 40px 20px;
        font-size: 14px;
    }

    .mobile-search-card {
        background: white;
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        cursor: pointer;
        transition: box-shadow 0.15s;
        display: flex;
        gap: 10px;
        align-items: flex-start;
    }

    .mobile-search-card:active {
        box-shadow: 0 1px 6px rgba(0,0,0,0.12);
    }

    .mobile-search-card-body {
        flex: 1;
        min-width: 0;
    }

    .mobile-search-card-name {
        font-size: 14px;
        font-weight: 600;
        color: #111;
        margin-bottom: 2px;
    }

    .mobile-search-card-desc {
        font-size: 12px;
        color: #6b7280;
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .mobile-search-card-meta {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-top: 4px;
    }

    .mobile-search-card-badge {
        font-size: 10px;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 4px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .mobile-search-card-rating {
        font-size: 11px;
        color: #f59e0b;
    }

    /* Category badge colors */
    .mobile-search-card-badge.cat-hotels { background: #dbeafe; color: #2563EB; }
    .mobile-search-card-badge.cat-restaurants { background: #fce7f3; color: #db2777; }
    .mobile-search-card-badge.cat-experiences { background: #d1fae5; color: #059669; }
    .mobile-search-card-badge.cat-kidFriendly { background: #fef3c7; color: #d97706; }
    .mobile-search-card-badge.cat-markets { background: #f3e8ff; color: #7c3aed; }

    /* ---- Trips Panel ---- */
    .mobile-trips-header {
        padding: 8px 12px;
        background: white;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
        z-index: 10;
    }

    .mobile-trips-title {
        font-size: 16px;
        font-weight: 700;
        color: #111;
    }

    .mobile-trips-actions {
        display: flex;
        gap: 6px;
        align-items: center;
    }

    .mobile-trips-action-btn {
        padding: 5px 8px;
        background: none;
        border: 1.5px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: background 0.15s;
    }

    .mobile-trips-action-btn:active {
        background: #f3f4f6;
    }

    .mobile-trips-generate {
        font-size: 11px;
        font-weight: 600;
        color: #7C3AED;
        border-color: #7C3AED;
        border-style: dashed;
        padding: 5px 10px;
    }

    .mobile-trips-tabs {
        padding: 8px 12px;
        background: white;
        border-bottom: 1px solid #f3f4f6;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        display: flex;
        gap: 6px;
        scrollbar-width: none;
        flex-shrink: 0;
    }

    .mobile-trips-tabs::-webkit-scrollbar {
        display: none;
    }

    .mobile-trips-tab {
        flex-shrink: 0;
        padding: 6px 14px;
        border-radius: 16px;
        border: 1.5px solid #d1d5db;
        background: white;
        font-size: 12px;
        font-weight: 500;
        color: #374151;
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.15s;
    }

    .mobile-trips-tab.active {
        color: white;
        border-color: transparent;
    }

    .mobile-trips-tab.gen-tab {
        border-style: dashed;
    }

    .mobile-trips-content {
        padding: 8px 12px 16px 12px;
    }

    .mobile-trips-back {
        display: flex;
        align-items: center;
        gap: 6px;
        background: none;
        border: none;
        color: #2563EB;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        padding: 8px 0;
        margin-bottom: 8px;
    }

    /* ---- Mobile Chat Panel ---- */
    .mobile-chat-header {
        padding: 12px 16px;
        background: white;
        border-bottom: 1px solid #e5e7eb;
        flex-shrink: 0;
    }

    .mobile-chat-title {
        font-size: 16px;
        font-weight: 700;
        color: #111;
    }

    .mobile-chat-context {
        font-size: 11px;
        color: #9ca3af;
        margin-top: 2px;
    }

    .mobile-chat-messages {
        flex: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding: 12px 16px;
    }

    .mobile-chat-input-area {
        display: flex;
        gap: 8px;
        padding: 10px 12px;
        background: white;
        border-top: 1px solid #e5e7eb;
    }

    .mobile-chat-settings {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 6px 12px;
        background: #f9fafb;
        border-top: 1px solid #f3f4f6;
    }

    #mobileChatPanel {
        /* Chat stays full height since it's an immersive interaction */
        height: calc(100vh - 44px - 56px) !important;
        border-radius: 0 !important;
    }

    /* Make mobile chat messages fill available space */
    #mobileChatPanel .mobile-chat-messages {
        flex: 1;
        min-height: 0;
    }

    /* ---- Leaflet popup mobile override ---- */
    .leaflet-popup-content-wrapper {
        max-width: 280px;
    }
}

    </style>
</head>
<body>
    <!-- Mobile destination bar -->
    <div class="mobile-dest-bar" id="mobileDestBar">
        <div class="mobile-dest-bar-inner">
            <button class="mobile-dest-btn" id="mobileDestBtn" onclick="toggleMobileDestPicker()">
                <span id="mobileDestFlag">🗺️</span>
                <span id="mobileDestName">Travel Map</span>
                <i class="fas fa-chevron-down" style="font-size:10px;margin-left:4px;opacity:0.5;"></i>
            </button>
        </div>
    </div>

    <div class="container">
        <div id="map-container">
            <button class="locate-btn" id="locateBtn" onclick="toggleGeolocation()" title="Show my location">
                <i class="fas fa-location-crosshairs"></i>
            </button>

            <!-- Mobile floating category controls -->
            <div class="mobile-map-controls" id="mobileMapControls">
                <div class="mobile-cat-chips" id="mobileCatChips">
                    <button class="mobile-cat-chip active" data-cat="hotels" onclick="toggleMobileCat('hotels',this)">🏨 Hotels</button>
                    <button class="mobile-cat-chip active" data-cat="restaurants" onclick="toggleMobileCat('restaurants',this)">🍽 Restaurants</button>
                    <button class="mobile-cat-chip active" data-cat="experiences" onclick="toggleMobileCat('experiences',this)">🎭 Experiences</button>
                    <button class="mobile-cat-chip active" data-cat="kidFriendly" onclick="toggleMobileCat('kidFriendly',this)">👶 Kids</button>
                    <button class="mobile-cat-chip active" data-cat="markets" onclick="toggleMobileCat('markets',this)">🛒 Markets</button>
                </div>
                <button class="mobile-tag-filter-fab" id="mobileTagFilterBtn" onclick="openMobileTagModal()">🏷</button>
            </div>

            <!-- Mobile Tag Filter Modal -->
            <div class="mobile-tag-modal-backdrop" id="mobileTagBackdrop" onclick="closeMobileTagModal()"></div>
            <div class="mobile-tag-modal" id="mobileTagModal">
                <div class="mobile-tag-modal-header">
                    <span class="mobile-tag-modal-title">Filter by Tags</span>
                    <button class="mobile-tag-modal-close" onclick="closeMobileTagModal()">✕</button>
                </div>
                <div id="mobileTagModalContent">
                    <!-- Built dynamically -->
                </div>
            </div>
        </div>
        
        <div class="sidebar" id="sidebar">
            <div class="sidebar-drag-handle" id="dragHandle" style="display: none;"></div>
            <div class="mobile-expand-hint" id="mobileExpandHint">Swipe up for details</div>
            
            <div class="sidebar-header">
                <!-- Destination Selector — Region → Country two-level picker -->
                <div class="dest-selector" id="destSelector">
                    <div class="dest-region-row">
                        <select class="dest-select" id="regionSelect" onchange="onRegionSelectChange(this.value)">
                            <option value="">All Destinations</option>
                        </select>
                        <select class="dest-select" id="destSelect" onchange="onDestSelectChange(this.value)" style="display:none;"></select>
                        <button class="dest-add-btn" onclick="showAddDestModal()" title="Add a new destination">+</button>
                    </div>
                    <div class="dest-country-chips" id="destCountryChips"></div>
                    <div class="dest-region-badge" id="destRegionBadge"></div>
                </div>
                <div id="destTitle" style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: #000;">
                    Travel Map
                </div>
                <div id="destSubtitle" style="font-size: 11px; color: #666; margin-bottom: 15px;">
                    Interactive Trip Map
                </div>
                
                <div class="view-toggle">
                    <button class="toggle-btn active" id="categoriesViewBtn" onclick="switchView('categories')">
                        <i class="fas fa-layer-group"></i> Categories
                    </button>
                    <button class="toggle-btn" id="itinerariesViewBtn" onclick="switchView('itineraries')">
                        <i class="fas fa-map-location-dot"></i> Itineraries
                    </button>
                    <button class="toggle-btn" onclick="showNotesPanel()" title="View all notes" style="flex: 0 0 auto; padding: 8px 10px; font-size: 11px;">
                        📝 Notes
                    </button>
                    <button class="toggle-btn" onclick="showBookingsPanel()" title="View bookings" style="flex: 0 0 auto; padding: 8px 10px; font-size: 11px;" id="bookingsBtn">
                        🔖 Bookings
                    </button>
                </div>

                <!-- Quick Filter Chips (Phase 1c) -->
                <div class="filter-chips-row" id="filterChipsRow">
                    <!-- Filter chips built dynamically by buildFilterChips() -->
                </div>
                <div id="regionFilterRow" style="display:none; margin-top: 8px;">
                    <select id="regionSelect" onchange="filterByRegion(this.value)" style="width:100%; padding:7px 10px; border:1.5px solid #ddd; border-radius:8px; font-size:11px; font-weight:500; color:#555; background:white; cursor:pointer; appearance:auto;">
                        <option value="">All Regions</option>
                    </select>
                </div>
                <div class="filter-chips-count" id="filterChipsCount"></div>

                <!-- Tag Filter Panel -->
                <button class="tag-filter-toggle" id="tagFilterToggle" onclick="toggleTagPanel()">
                    <span id="tagFilterToggleLabel">🏷 Filter by Tags</span>
                    <span class="chevron">▼</span>
                </button>
                <div class="tag-filter-panel" id="tagFilterPanel">
                    <!-- Built dynamically by buildTagFilterPanel() -->
                </div>

                <!-- Shared Itinerary Banner -->
                <div class="shared-banner" id="sharedBanner">
                    <span id="sharedBannerText">Viewing shared itinerary</span>
                    <button class="shared-banner-dismiss" onclick="dismissSharedBanner()">&#x2715;</button>
                </div>

                <!-- Itinerary Tabs (hidden in categories view) -->
                <div id="itineraryTabs" style="display: none; margin-top: 15px;">
                    <!-- 3-Option Mode Selector -->
                    <div id="itinModeSelector" class="itin-mode-selector">
                        <div class="itin-mode-card" onclick="selectItinMode('curated')">
                            <div class="card-icon">📋</div>
                            <div class="card-text">
                                <div class="card-title">Curated Itineraries</div>
                                <div class="card-desc">Browse pre-made trip plans and generated itineraries</div>
                            </div>
                            <div class="card-arrow">›</div>
                        </div>
                        <div class="itin-mode-card" onclick="selectItinMode('generate')">
                            <div class="card-icon">✨</div>
                            <div class="card-text">
                                <div class="card-title">Generate Custom Itinerary</div>
                                <div class="card-desc">AI-powered itinerary built from your preferences</div>
                            </div>
                            <div class="card-arrow">›</div>
                        </div>
                        <div class="itin-mode-card" onclick="selectItinMode('builder')">
                            <div class="card-icon">🗺️</div>
                            <div class="card-text">
                                <div class="card-title">Step-by-Step Builder</div>
                                <div class="card-desc">Plan your trip day by day with flights, hotels &amp; activities</div>
                            </div>
                            <div class="card-arrow">›</div>
                        </div>
                    </div>

                    <!-- Curated sub-view (existing tabs) -->
                    <div id="itinCuratedView" style="display:none;">
                        <button class="itin-mode-back" onclick="selectItinMode('menu')"><span class="back-arrow">‹</span> Back to options</button>
                        <div style="display:flex; align-items:center; justify-content:space-between;">
                            <div class="sidebar-title" style="margin:0;">Select Itinerary</div>
                            <div style="display:flex; gap:6px; align-items:center;">
                                <button onclick="openShareModal()" style="padding:4px 10px; font-size:10px; font-weight:600; border:1.5px solid #2563EB; background:white; color:#2563EB; border-radius:16px; cursor:pointer; white-space:nowrap; transition: all 0.15s;" onmouseover="this.style.background='#2563EB';this.style.color='white'" onmouseout="this.style.background='white';this.style.color='#2563EB'">&#x1F517; Share</button>
                                <button onclick="openGeneratorModal()" style="padding:4px 10px; font-size:10px; font-weight:600; border:1.5px dashed #7C3AED; background:white; color:#7C3AED; border-radius:16px; cursor:pointer; white-space:nowrap; transition: all 0.15s;" onmouseover="this.style.background='#7C3AED';this.style.color='white'" onmouseout="this.style.background='white';this.style.color='#7C3AED'">+ Generate</button>
                            </div>
                        </div>
                        <div class="itin-tabs" id="tabsContainer"></div>
                    </div>

                </div>

                <!-- Categories Checkboxes (hidden in itineraries view) -->
                <div id="categoriesCheckboxes" style="margin-top: 15px;">
                    <div class="sidebar-title">Toggle Categories</div>
                    <div id="categoriesContainer"></div>
                </div>
            </div>
            
            <div class="sidebar-content" id="sidebarContent">
                <div id="categoriesView" style="display: block;">
                    <p style="color: #999; font-size: 12px; text-align: center; padding: 20px 0;">
                        Select a category above to explore
                    </p>
                </div>
                <div id="itinerariesView" style="display: none;">
                    <button class="show-all-days-btn active" id="showAllDaysBtn" onclick="showAllDays()">
                        Show All Days
                    </button>
                    <div id="daysContainer"></div>
                </div>
                <!-- Inline Generator (in scrollable area) -->
                <div id="itinGenerateView" style="display:none;">
                    <button class="itin-mode-back" onclick="selectItinMode('menu')"><span class="back-arrow">‹</span> Back to options</button>
                    <div id="inlineGenContainer" class="itin-inline-gen"></div>
                </div>
                <!-- Step-by-Step Builder (in scrollable area) -->
                <div id="itinBuilderView" style="display:none;">
                    <button class="itin-mode-back" onclick="confirmExitBuilder('desktop')"><span class="back-arrow">‹</span> Back to options</button>
                    <div id="stepBuilderContainer" class="step-builder"></div>
                </div>
            </div>
        </div>
    </div>

        <!-- Swap Panel Overlay -->
    <div class="swap-overlay" id="swapOverlay" onclick="closeSwapPanel()"></div>
    <div class="swap-panel" id="swapPanel">
        <div class="swap-panel-header">
            <h3 id="swapPanelTitle">Swap Activity</h3>
            <button class="swap-panel-close" onclick="closeSwapPanel()">&times;</button>
        </div>
        <div class="swap-panel-body" id="swapPanelBody"></div>
    </div>

    <!-- Notes Panel -->
    <div class="swap-overlay" id="notesPanelOverlay" onclick="closeNotesPanel()" style="display:none;"></div>
    <div class="swap-panel" id="notesPanel" style="display:none;">
        <div class="swap-panel-header">
            <h3>📝 My Notes</h3>
            <button class="swap-panel-close" onclick="closeNotesPanel()">&times;</button>
        </div>
        <div class="swap-panel-body" id="notesPanelBody"></div>
    </div>

    <!-- Bookings Panel -->
    <div class="swap-overlay" id="bookingsPanelOverlay" onclick="closeBookingsPanel()" style="display:none;"></div>
    <div class="swap-panel" id="bookingsPanel" style="display:none;">
        <div class="swap-panel-header">
            <h3>🔖 Bookings</h3>
            <button class="swap-panel-close" onclick="closeBookingsPanel()">&times;</button>
        </div>
        <div class="swap-panel-body" id="bookingsPanelBody"></div>
    </div>

    <!-- City Activity Browser (Phase 1b) -->
    <div class="browser-overlay" id="browserOverlay" onclick="closeCityBrowser()"></div>
    <div class="city-browser" id="cityBrowser">
        <div class="browser-header">
            <div class="browser-header-top">
                <div>
                    <div class="browser-header-title" id="browserTitle">Browse City</div>
                    <div class="browser-header-subtitle" id="browserSubtitle">All activities near this city</div>
                </div>
                <button class="browser-close" onclick="closeCityBrowser()">&times;</button>
            </div>
            <input type="text" class="browser-search" id="browserSearch" placeholder="Search activities..." oninput="filterBrowserActivities()">
        </div>
        <div class="browser-chips" id="browserChips">
            <button class="browser-chip active" data-filter="all" onclick="setBrowserFilter('all')">All</button>
            <button class="browser-chip" data-filter="hotels" onclick="setBrowserFilter('hotels')">&#x1F3E8; Hotels</button>
            <button class="browser-chip" data-filter="restaurants" onclick="setBrowserFilter('restaurants')">&#x1F374; Restaurants</button>
            <button class="browser-chip" data-filter="experiences" onclick="setBrowserFilter('experiences')">&#x1F5FA; Experiences</button>
            <button class="browser-chip" data-filter="kidFriendly" onclick="setBrowserFilter('kidFriendly')">&#x1F476; Kid-Friendly</button>
            <button class="browser-chip" data-filter="markets" onclick="setBrowserFilter('markets')">&#x1F6CD; Markets</button>
        </div>
        <div class="browser-body" id="browserBody"></div>
    </div>

    <!-- AI Chat -->
    <button class="chat-fab" id="chatFab" onclick="toggleChatPanel()" title="AI Trip Planner">
        <i class="fas fa-robot"></i>
    </button>
    <div class="chat-panel" id="chatPanel">
        <div class="chat-header">
            <div>
                <div class="chat-header-title">AI Day Planner</div>
                <div class="chat-header-context" id="chatContext">Select an itinerary &amp; day first</div>
            </div>
            <button class="chat-header-close" onclick="toggleChatPanel()">&times;</button>
        </div>
        <div id="chatSetup" class="chat-setup" style="display:none;">
            <h3>Connect to Claude</h3>
            <p>Enter your Anthropic API key to enable AI-powered day planning. Your key is stored locally in your browser and never sent anywhere except Anthropic's API.</p>
            <input type="password" id="apiKeyInput" placeholder="sk-ant-api03-..." />
            <button onclick="saveApiKey()">Save Key</button>
            <a href="https://console.anthropic.com/settings/keys" target="_blank">Get an API key &rarr;</a>
        </div>
        <div class="chat-messages" id="chatMessages" style="display:none;"></div>
        <div class="chat-input-area" id="chatInputArea" style="display:none;">
            <textarea class="chat-input" id="chatInput" placeholder="e.g. I want knife shopping + great tempura today..." rows="1" onkeydown="chatKeyHandler(event)"></textarea>
            <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
        <div class="chat-settings" id="chatSettings" style="display:none;">
            <div class="chat-model-toggle">
                <button class="chat-model-btn active" id="modelHaiku" onclick="setChatModel('haiku')">Haiku</button>
                <button class="chat-model-btn" id="modelSonnet" onclick="setChatModel('sonnet')">Sonnet</button>
            </div>
            <div class="web-search-toggle">
                <span class="web-search-label">Web</span>
                <button class="web-search-switch active" id="webSearchToggle" onclick="toggleWebSearch()" title="Enable web search for up-to-date info"></button>
            </div>
            <span class="chat-settings-key" onclick="showApiKeySetup()">Change API key</span>
        </div>
    </div>

    <!-- QR Code Modal (Phase 3) -->
    <div class="qr-overlay" id="qrOverlay" onclick="if(event.target===this)closeQrModal()">
        <div class="qr-modal">
            <div class="qr-modal-title" id="qrTitle"></div>
            <div class="qr-modal-subtitle" id="qrSubtitle"></div>
            <img id="qrImage" src="" alt="QR Code" />
            <a class="qr-modal-link" id="qrLink" href="" target="_blank"></a>
            <div class="qr-modal-actions">
                <button class="qr-modal-close" onclick="closeQrModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="share-overlay" id="shareOverlay" onclick="if(event.target===this)closeShareModal()">
        <div class="share-modal">
            <div class="share-modal-title" id="shareTitle">Share Itinerary</div>
            <div class="share-modal-subtitle" id="shareSubtitle"></div>
            <div class="share-link-box" id="shareLinkBox"></div>
            <button class="share-btn share-btn-primary" onclick="copyShareLink()">&#x1F4CB; Copy Link</button>
            <hr class="share-divider">
            <button class="share-btn share-btn-secondary" onclick="copyFullItineraryText()">&#x1F4DD; Copy as Text</button>
            <button class="share-btn share-btn-secondary" onclick="printItinerary()">&#x1F5A8; Print / Save as PDF</button>
            <button class="share-btn share-btn-close" onclick="closeShareModal()">Close</button>
        </div>
    </div>

    <!-- Copy Toast (Phase 3) -->
    <div class="copy-toast" id="copyToast">Copied!</div>

    <!-- AI Itinerary Generator Modal -->
    <div class="gen-overlay" id="genOverlay" onclick="if(event.target===this)closeGeneratorModal()">
        <div class="gen-modal">
            <div class="gen-modal-title">Generate Custom Itinerary</div>
            <div class="gen-modal-subtitle" id="genDestLabel">for this destination</div>
            <div class="gen-profile-bar">
                <select class="gen-profile-select" id="genProfileSelect" onchange="loadTravelProfile()">
                    <option value="">— Select a saved profile —</option>
                </select>
                <button class="gen-profile-btn" onclick="showSaveProfileRow()">Save</button>
                <button class="gen-profile-btn danger" id="genProfileDeleteBtn" onclick="deleteTravelProfile()" style="display:none;">Del</button>
            </div>
            <div class="gen-profile-save-row" id="genProfileSaveRow">
                <input class="gen-profile-save-input" id="genProfileNameInput" placeholder="Profile name, e.g. 'Family with toddler'" />
                <button class="gen-profile-btn" onclick="saveTravelProfile()">Save</button>
                <button class="gen-profile-btn" onclick="hideSaveProfileRow()">Cancel</button>
            </div>
            <div class="gen-field">
                <label>Trip Type</label>
                <div style="display:flex;gap:6px;margin-bottom:8px;">
                    <button class="toggle-btn active" id="genTypeSingle" onclick="setGenTripType('single')" style="flex:1;padding:6px;font-size:11px;">Single Destination</button>
                    <button class="toggle-btn" id="genTypeMulti" onclick="setGenTripType('multi')" style="flex:1;padding:6px;font-size:11px;">Multi-Destination</button>
                </div>
            </div>
            <div class="gen-field" id="genSingleDaysField">
                <label>Trip Duration (days)</label>
                <input type="number" id="genDays" min="2" max="21" value="7" />
            </div>
            <div class="gen-field" id="genMultiDestField" style="display:none;">
                <label>Destinations & Days</label>
                <div id="genSegmentsList"></div>
                <button onclick="addGenSegment()" style="width:100%;padding:6px;font-size:11px;border:1px dashed #d1d5db;border-radius:6px;background:white;cursor:pointer;color:#6b7280;margin-top:6px;">+ Add Destination</button>
                <div id="genMultiTotalDays" style="font-size:11px;color:#6b7280;margin-top:4px;"></div>
            </div>
            <div class="gen-field">
                <label>Travel Party</label>
                <select id="genParty">
                    <option value="couple">Couple</option>
                    <option value="family-toddler">Family with toddler (under 4)</option>
                    <option value="family-kids">Family with kids (4-12)</option>
                    <option value="family-teens">Family with teens</option>
                    <option value="solo">Solo traveler</option>
                    <option value="friends">Group of friends</option>
                </select>
            </div>
            <div class="gen-field">
                <label>Interests (click to select)</label>
                <div class="gen-interests" id="genInterests">
                    <span class="gen-interest-chip selected" data-interest="food">Food &amp; Dining</span>
                    <span class="gen-interest-chip" data-interest="culture">Culture &amp; History</span>
                    <span class="gen-interest-chip" data-interest="adventure">Adventure</span>
                    <span class="gen-interest-chip" data-interest="shopping">Shopping</span>
                    <span class="gen-interest-chip" data-interest="relaxation">Relaxation</span>
                    <span class="gen-interest-chip" data-interest="nightlife">Nightlife</span>
                    <span class="gen-interest-chip" data-interest="nature">Nature &amp; Outdoors</span>
                    <span class="gen-interest-chip" data-interest="photography">Photography</span>
                    <span class="gen-interest-chip" data-interest="art">Art &amp; Design</span>
                    <span class="gen-interest-chip" data-interest="kid-friendly">Kid-Friendly</span>
                </div>
            </div>
            <div class="gen-field">
                <label>Pace</label>
                <select id="genPace">
                    <option value="slow">Slow &amp; relaxed (lots of downtime)</option>
                    <option value="moderate" selected>Moderate (balanced)</option>
                    <option value="fast">Fast-paced (pack it all in)</option>
                </select>
            </div>
            <div class="gen-field">
                <label>Budget</label>
                <select id="genBudget">
                    <option value="budget">Budget-friendly</option>
                    <option value="moderate" selected>Moderate</option>
                    <option value="luxury">Luxury</option>
                </select>
            </div>
            <div class="gen-field">
                <label>Special requests or constraints (optional)</label>
                <textarea id="genConstraints" placeholder="e.g., 'We need nap time 1-3pm', 'vegetarian', 'mobility issues', 'want a day trip to...', 'arriving late on day 1'"></textarea>
            </div>
            <div class="gen-field" style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                <span style="font-size:11px; font-weight:600; color:#555;">Web search for current info</span>
                <div class="web-search-toggle">
                    <button class="web-search-switch" id="genWebSearchToggle" onclick="toggleGenWebSearch()" title="Enable web search for opening hours, seasonal events, etc."></button>
                </div>
            </div>
            <div id="genPreviewArea" style="display:none;"></div>
            <div id="genError" style="display:none; color:#DC2626; font-size:12px; margin-top:8px; padding:8px; background:#FEF2F2; border-radius:8px;"></div>
            <button class="gen-btn primary gen-generate-btn" id="genSubmitBtn" onclick="submitGeneratorForm()">Generate Itinerary</button>
            <div class="gen-actions">
                <button class="gen-btn secondary" onclick="closeGeneratorModal()">Cancel</button>
                <button class="gen-btn primary" id="genSaveBtn" onclick="saveGeneratedItinerary()" style="display:none;">Save &amp; Load Itinerary</button>
            </div>
        </div>
    </div>

    <!-- Add Destination Modal (Phase 4) -->
    <div class="dest-overlay" id="destOverlay" onclick="if(event.target===this)closeAddDestModal()">
        <div class="dest-modal">
            <div class="dest-modal-title">Add a New Destination</div>
            <div class="dest-modal-desc">Load a destination data file (JSON) to add a new trip to your map. The file should contain category arrays, itinerary data, and city centers.</div>
            <div class="dest-modal-desc" style="font-weight:600;">Load from URL:</div>
            <input class="dest-modal-input" id="destUrlInput" type="text" placeholder="https://example.com/italy-trip-data.json" />
            <div class="dest-modal-or">&mdash; or &mdash;</div>
            <div class="dest-modal-desc" style="font-weight:600;">Load from file:</div>
            <div class="dest-modal-file">
                <input type="file" id="destFileInput" accept=".json" />
            </div>
            <div class="dest-modal-or">&mdash; or &mdash;</div>
            <button class="dest-modal-btn secondary" onclick="copyDestSchema()" style="width:100%;">Copy JSON Schema Template</button>
            <div class="dest-modal-schema" id="destSchema" style="display:none;"></div>
            <div class="dest-modal-actions">
                <button class="dest-modal-btn secondary" onclick="closeAddDestModal()">Cancel</button>
                <button class="dest-modal-btn primary" onclick="processDestInput()">Load Destination</button>
            </div>
        </div>
    </div>

    <!-- Mobile Chat Panel -->
    <div class="mobile-tab-panel" id="mobileChatPanel">
        <button class="sheet-close-btn" onclick="closeMobileSheet()" aria-label="Close" style="top:12px;">&times;</button>
        <div class="mobile-chat-header">
            <div class="mobile-chat-title">AI Trip Planner</div>
            <div class="mobile-chat-context" id="mobileChatContext">Select an itinerary &amp; day first</div>
        </div>
        <div id="mobileChatSetup" class="chat-setup" style="display:none;">
            <h3>Connect to Claude</h3>
            <p>Enter your Anthropic API key to enable AI-powered day planning.</p>
            <input type="password" id="mobileApiKeyInput" placeholder="sk-ant-api03-..." />
            <button onclick="saveMobileApiKey()">Save Key</button>
            <a href="https://console.anthropic.com/settings/keys" target="_blank">Get an API key &rarr;</a>
        </div>
        <div class="mobile-chat-messages" id="mobileChatMessages" style="display:none;"></div>
        <div class="mobile-chat-input-area" id="mobileChatInputArea" style="display:none;">
            <textarea class="chat-input" id="mobileChatInput" placeholder="e.g. I want knife shopping + great tempura today..." rows="1" onkeydown="mobileChatKeyHandler(event)"></textarea>
            <button class="chat-send-btn" id="mobileChatSendBtn" onclick="sendMobileChatMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
        <div class="mobile-chat-settings" id="mobileChatSettings" style="display:none;">
            <div class="chat-model-toggle">
                <button class="chat-model-btn active" id="mobileModelHaiku" onclick="setChatModel('haiku')">Haiku</button>
                <button class="chat-model-btn" id="mobileModelSonnet" onclick="setChatModel('sonnet')">Sonnet</button>
            </div>
            <div class="web-search-toggle">
                <span class="web-search-label">Web</span>
                <button class="web-search-switch active" id="mobileWebSearchToggle" onclick="toggleWebSearch()" title="Enable web search"></button>
            </div>
            <span class="chat-settings-key" onclick="showApiKeySetup()">Change API key</span>
        </div>
    </div>

    <!-- Mobile Sheet Backdrop -->
    <div class="mobile-sheet-backdrop" id="mobileSheetBackdrop" onclick="collapseMobileSheet()"></div>

    <!-- Mobile Search Panel -->
    <div class="mobile-tab-panel sheet-half" id="mobileSearchPanel">
        <div class="sheet-drag-handle" id="searchDragHandle"></div>
        <button class="sheet-close-btn" onclick="closeMobileSheet()" aria-label="Close">&times;</button>
        <div class="mobile-search-bar">
            <div class="mobile-search-input-wrap">
                <i class="fas fa-search" style="color:#9ca3af;"></i>
                <input type="text" class="mobile-search-input" id="mobileSearchInput" placeholder="Search places..." oninput="onMobileSearch()">
                <button class="mobile-search-clear" id="mobileSearchClear" onclick="clearMobileSearch()" style="display:none;">&times;</button>
            </div>
        </div>
        <div class="mobile-search-chips" id="mobileSearchChips">
            <button class="mobile-search-chip active" data-filter="all" onclick="setMobileSearchFilter('all',this)">All</button>
            <button class="mobile-search-chip" data-filter="hotels" onclick="setMobileSearchFilter('hotels',this)">🏨 Hotels</button>
            <button class="mobile-search-chip" data-filter="restaurants" onclick="setMobileSearchFilter('restaurants',this)">🍽 Restaurants</button>
            <button class="mobile-search-chip" data-filter="experiences" onclick="setMobileSearchFilter('experiences',this)">🎭 Experiences</button>
            <button class="mobile-search-chip" data-filter="kidFriendly" onclick="setMobileSearchFilter('kidFriendly',this)">👶 Kids</button>
            <button class="mobile-search-chip" data-filter="markets" onclick="setMobileSearchFilter('markets',this)">🛒 Markets</button>
            <button class="mobile-search-chip mobile-search-tag-btn" id="mobileSearchTagBtn" onclick="openMobileTagModal()" style="border-color:#7C3AED;color:#7C3AED;">🏷 Tags</button>
        </div>
        <div class="sheet-scroll">
            <div class="mobile-search-results" id="mobileSearchResults">
                <div class="mobile-search-empty">Select a destination and search for places</div>
            </div>
        </div>
    </div>

    <!-- Mobile Trips Panel -->
    <div class="mobile-tab-panel sheet-half" id="mobileTripsPanel">
        <div class="sheet-drag-handle" id="tripsDragHandle"></div>
        <button class="sheet-close-btn" onclick="closeMobileSheet()" aria-label="Close">&times;</button>
        <div class="mobile-trips-header" id="mobileTripsHeader">
            <div class="mobile-trips-title">Itineraries</div>
            <div class="mobile-trips-actions" id="mobileTripsActions">
                <button class="mobile-trips-action-btn" onclick="showMobileTripsSubView('notes')" title="Notes">📝</button>
                <button class="mobile-trips-action-btn" onclick="showMobileTripsSubView('bookings')" title="Bookings" id="mobileBookingsBtn">🔖</button>
                <button class="mobile-trips-action-btn" onclick="openShareModal()" title="Share">🔗</button>
                <button class="mobile-trips-action-btn mobile-trips-generate" onclick="openGeneratorModal()" title="Generate">+ Generate</button>
            </div>
        </div>

        <!-- Mobile 3-Option Mode Selector -->
        <div id="mobileItinModeSelector" class="itin-mode-selector" style="padding: 8px 12px;">
            <div class="itin-mode-card" onclick="selectMobileItinMode('curated')">
                <div class="card-icon">📋</div>
                <div class="card-text">
                    <div class="card-title">Curated Itineraries</div>
                    <div class="card-desc">Browse pre-made trip plans and generated itineraries</div>
                </div>
                <div class="card-arrow">›</div>
            </div>
            <div class="itin-mode-card" onclick="selectMobileItinMode('generate')">
                <div class="card-icon">✨</div>
                <div class="card-text">
                    <div class="card-title">Generate Custom Itinerary</div>
                    <div class="card-desc">AI-powered itinerary built from your preferences</div>
                </div>
                <div class="card-arrow">›</div>
            </div>
            <div class="itin-mode-card" onclick="selectMobileItinMode('builder')">
                <div class="card-icon">🗺️</div>
                <div class="card-text">
                    <div class="card-title">Step-by-Step Builder</div>
                    <div class="card-desc">Plan your trip day by day with flights, hotels &amp; activities</div>
                </div>
                <div class="card-arrow">›</div>
            </div>
        </div>

        <!-- Mobile Curated sub-view -->
        <div id="mobileCuratedView" style="display:none;">
            <div style="padding: 4px 12px;">
                <button class="itin-mode-back" onclick="selectMobileItinMode('menu')"><span class="back-arrow">‹</span> Back to options</button>
            </div>
            <div class="mobile-trips-tabs" id="mobileTripsTabsContainer"></div>
            <div class="sheet-scroll">
                <div class="mobile-trips-content" id="mobileTripsContent">
                    <div id="mobileTripsItinView">
                        <button class="show-all-days-btn active" id="mobileShowAllDaysBtn" onclick="showAllDays()">Show All Days</button>
                        <div id="mobileDaysContainer"></div>
                    </div>
                    <div id="mobileTripsSubView" style="display:none;">
                        <button class="mobile-trips-back" onclick="hideMobileTripsSubView()"><i class="fas fa-arrow-left"></i> Back to Itineraries</button>
                        <div id="mobileTripsSubContent"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Inline Generator sub-view -->
        <div id="mobileGenerateView" style="display:none;">
            <div style="padding: 4px 12px;">
                <button class="itin-mode-back" onclick="selectMobileItinMode('menu')"><span class="back-arrow">‹</span> Back to options</button>
            </div>
            <div class="sheet-scroll">
                <div style="padding: 0 12px 16px 12px;">
                    <div id="mobileInlineGenContainer" class="itin-inline-gen"></div>
                </div>
            </div>
        </div>

        <!-- Mobile Step-by-Step Builder sub-view -->
        <div id="mobileBuilderView" style="display:none;">
            <div style="padding: 4px 12px;">
                <button class="itin-mode-back" onclick="confirmExitBuilder('mobile')"><span class="back-arrow">‹</span> Back to options</button>
            </div>
            <div class="sheet-scroll">
                <div style="padding: 0 12px 16px 12px;">
                    <div id="mobileStepBuilderContainer" class="step-builder"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile POI Detail Sheet -->
    <div class="mobile-poi-sheet-overlay" id="mobilePoiOverlay" onclick="hideMobilePOIDetail()"></div>
    <div class="mobile-poi-sheet" id="mobilePoiSheet">
        <div class="mobile-poi-drag-handle"></div>
        <button class="mobile-poi-close" onclick="hideMobilePOIDetail()">&times;</button>
        <div class="mobile-poi-content" id="mobilePoiContent"></div>
    </div>

    <!-- Mobile Tab Bar -->
    <nav class="mobile-tab-bar" id="mobileTabBar">
        <button class="mobile-tab active" data-tab="map" onclick="switchMobileTab('map')">
            <i class="fas fa-map"></i>
            <span>Map</span>
        </button>
        <button class="mobile-tab" data-tab="trips" onclick="switchMobileTab('trips')">
            <i class="fas fa-route"></i>
            <span>Trips</span>
        </button>
        <button class="mobile-tab" data-tab="search" onclick="switchMobileTab('search')">
            <i class="fas fa-search"></i>
            <span>Search</span>
        </button>
        <button class="mobile-tab" data-tab="chat" onclick="switchMobileTab('chat')">
            <i class="fas fa-comments"></i>
            <span>Chat</span>
        </button>
    </nav>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

    <script>
        // ============================================
        // ============================================
        // DATA — Loaded dynamically from JSON files
        // ============================================

        // Global arrays (populated by loadDestination)
        const hotels = [];
        const restaurants = [];
        const experiences = [];
        const kidFriendly = [];
        const markets = [];
        const itineraryData = {};
        let originalItineraryData = {};
        const cityCenters = {};
        let poiLookup = {};  // Maps POI name → {desc, longDesc} for itinerary popup cross-reference
        let poiNamesList = []; // Sorted POI names (longest first) for fuzzy matching

        // Fuzzy POI lookup: exact match first, then check if a known POI name is contained in the itinerary item name
        function lookupPoi(name) {
            if (poiLookup[name]) return poiLookup[name];
            const lower = name.toLowerCase();
            for (let i = 0; i < poiNamesList.length; i++) {
                if (lower.includes(poiNamesList[i].toLowerCase())) {
                    return poiLookup[poiNamesList[i]];
                }
            }
            return {};
        }

        // Cross-destination POI lookup: check a specific destination's cache
        function lookupPoiInDest(name, destKey) {
            const destLookup = multiDestPoiLookup[destKey];
            if (!destLookup) return lookupPoi(name);  // fallback to active dest
            if (destLookup[name]) {
                const poi = destLookup[name];
                return { desc: poi.desc || '', longDesc: poi.longDesc || '', gmapsUrl: poi.gmapsUrl || '', rating: poi.rating, ratingCount: poi.ratingCount, priceLevel: poi.priceLevel, website: poi.website, hours: poi.hours, photoRef: poi.photoRef, photoAttribution: poi.photoAttribution, tags: poi.tags };
            }
            // Fuzzy match within that destination
            const lower = name.toLowerCase();
            const keys = Object.keys(destLookup).sort((a, b) => b.length - a.length);
            for (let i = 0; i < keys.length; i++) {
                if (lower.includes(keys[i].toLowerCase())) {
                    const poi = destLookup[keys[i]];
                    return { desc: poi.desc || '', longDesc: poi.longDesc || '', gmapsUrl: poi.gmapsUrl || '', rating: poi.rating, ratingCount: poi.ratingCount, priceLevel: poi.priceLevel, website: poi.website, hours: poi.hours, photoRef: poi.photoRef, photoAttribution: poi.photoAttribution, tags: poi.tags };
                }
            }
            return lookupPoi(name);  // final fallback
        }

        // Multi-destination framework
        const destinations = {};
        let activeDestination = null;
        let manifestData = null;  // Stores the destinations.json manifest
        let destLoadGeneration = 0;  // Incremented on each loadDestination call to cancel stale async loads

        // Region & multi-destination state
        let activeRegion = null;           // Currently selected region key
        let loadedRegionDests = new Set(); // Destination keys loaded as part of a region
        let destinationCache = {};         // key → full destination config (persists across switches)
        let multiDestPoiLookup = {};       // key → { poiName → poi } for cross-destination coord lookup
        let regionPoisActive = false;      // Whether region-wide POI markers are showing
        let regionPoiLayers = [];          // Extra layers added by "Show Region POIs"
        let regionViewAll = false;         // True when "Show All" region view is active

        // ============================================
        // DESTINATION LOADING FROM JSON
        // ============================================

        async function loadManifest() {
            try {
                const response = await fetch('destinations.json');
                if (!response.ok) throw new Error('Could not load destinations.json');
                manifestData = await response.json();

                // Build region dropdown
                const regionSel = document.getElementById('regionSelect');
                regionSel.innerHTML = '<option value="">All Destinations</option>';
                if (manifestData.regions) {
                    manifestData.regions.forEach(function(region) {
                        const opt = document.createElement('option');
                        opt.value = region.key;
                        opt.textContent = region.flag + ' ' + region.name + ' (' + region.destinations.length + ')';
                        regionSel.appendChild(opt);
                    });
                }

                // Populate flat dest dropdown (hidden by default, used as fallback)
                const sel = document.getElementById('destSelect');
                sel.innerHTML = '';
                manifestData.destinations.forEach(function(dest) {
                    const opt = document.createElement('option');
                    opt.value = dest.key;
                    opt.textContent = dest.flag + ' ' + dest.name;
                    sel.appendChild(opt);
                });

                // Check for shared trip link first, otherwise load default
                const sharedLoaded = await loadSharedTrip();
                if (!sharedLoaded) {
                    // Find which region the default destination is in and select it
                    const defaultKey = manifestData.default;
                    const defaultRegion = findRegionForDest(defaultKey);
                    if (defaultRegion) {
                        onRegionSelectChange(defaultRegion.key, defaultKey);
                    } else {
                        await fetchAndLoadDestination(defaultKey);
                    }
                }

            } catch(e) {
                console.error('Failed to load manifest:', e);
                showCopyToast('Could not load destinations. Make sure you are serving via HTTP (see serve.sh).');
            }
        }

        // Find which region a destination belongs to
        function findRegionForDest(destKey) {
            if (!manifestData || !manifestData.regions) return null;
            return manifestData.regions.find(r => r.destinations.includes(destKey)) || null;
        }

        // Region selector change handler
        function onRegionSelectChange(regionKey, autoSelectDest) {
            activeRegion = regionKey || null;
            regionViewAll = false;
            const regionSel = document.getElementById('regionSelect');
            regionSel.value = regionKey || '';

            if (!regionKey) {
                // "All Destinations" — show flat dropdown instead
                document.getElementById('destSelect').style.display = '';
                document.getElementById('destCountryChips').innerHTML = '';
                document.getElementById('destRegionBadge').textContent = '';
                return;
            }

            // Hide flat dropdown, show country chips
            document.getElementById('destSelect').style.display = 'none';

            const region = manifestData.regions.find(r => r.key === regionKey);
            if (!region) return;

            // Build chips immediately (shows loading state), then auto-load all
            buildCountryChips(region, autoSelectDest);

            // If not auto-selecting a specific destination, load the whole region
            if (!autoSelectDest) {
                loadRegion(regionKey);
            }
        }

        // Build country chips for a region
        function buildCountryChips(region, autoSelectDest) {
            const container = document.getElementById('destCountryChips');
            container.innerHTML = '';

            // "Show All" toggle button
            const allLoaded = region.destinations.every(k => destinations[k]);
            const showAllBtn = document.createElement('span');
            showAllBtn.className = 'dest-load-region-btn';
            showAllBtn.id = 'regionShowAllBtn';
            if (regionViewAll) {
                showAllBtn.classList.add('active');
                showAllBtn.textContent = '\u2713 All ' + region.destinations.length;
            } else if (allLoaded) {
                showAllBtn.textContent = 'Show All ' + region.destinations.length;
            } else {
                showAllBtn.textContent = 'Load All ' + region.destinations.length;
            }
            showAllBtn.onclick = function() { onShowAllClick(region.key); };
            container.appendChild(showAllBtn);

            // Country chips
            region.destinations.forEach(function(destKey) {
                const entry = manifestData.destinations.find(d => d.key === destKey);
                if (!entry) return;
                const chip = document.createElement('span');
                chip.className = 'dest-country-chip';
                chip.dataset.dest = destKey;
                chip.textContent = entry.flag + ' ' + entry.name;
                if (destinations[destKey]) chip.classList.add('loaded');
                // In "view all" mode, all loaded chips appear semi-active; otherwise only the active dest
                if (regionViewAll) {
                    if (destinations[destKey]) chip.classList.add('region-active');
                } else if (destKey === activeDestination) {
                    chip.classList.add('active');
                }
                chip.onclick = function() { onCountryChipClick(destKey); };
                container.appendChild(chip);
            });

            // Badge
            const loaded = region.destinations.filter(k => destinations[k]).length;
            const badge = document.getElementById('destRegionBadge');
            let badgeHtml = '<span>' + (loaded > 0 ? loaded + '/' + region.destinations.length + ' loaded' : 'Loading destinations...') + '</span>';
            badge.innerHTML = badgeHtml;

            // Auto-select a destination if specified
            if (autoSelectDest) {
                fetchAndLoadDestination(autoSelectDest);
            }
        }

        // Country chip click — load that single destination, exit "view all" mode
        function onCountryChipClick(destKey) {
            const wasViewAll = regionViewAll;
            regionViewAll = false;
            clearRegionPois();

            if (destKey === activeDestination && wasViewAll) {
                // Already on this dest but was in "view all" mode — just re-center on this country
                var dest = destinations[destKey];
                if (dest) {
                    map.setView(dest.defaultCenter, dest.defaultZoom);
                }
                updateCountryChipStates();
                return;
            }

            fetchAndLoadDestination(destKey);
        }

        // "Show All" button click — toggle region-wide view
        async function onShowAllClick(regionKey) {
            const region = manifestData.regions.find(r => r.key === regionKey);
            if (!region) return;

            // If not all loaded yet, load them first
            const allLoaded = region.destinations.every(k => destinations[k]);
            if (!allLoaded) {
                await loadRegion(regionKey);
                return; // loadRegion already sets regionViewAll = true
            }

            // Toggle into "view all" mode
            regionViewAll = true;

            // Turn on region POIs if not already active
            if (!regionPoisActive) {
                toggleRegionPois();
            }

            // Compute bounds across all loaded destinations in this region and zoom to fit
            zoomToRegionBounds(region);

            // Refresh chip states
            buildCountryChips(region);
        }

        // Zoom map to fit all loaded destinations in a region
        function zoomToRegionBounds(region) {
            var allCoords = [];
            region.destinations.forEach(function(destKey) {
                var dest = destinations[destKey] || destinationCache[destKey];
                if (!dest) return;
                if (dest.defaultCenter) allCoords.push(dest.defaultCenter);
            });
            if (allCoords.length > 0) {
                map.fitBounds(L.latLngBounds(allCoords).pad(0.15));
            }
        }

        // Update chip states after a destination loads
        function updateCountryChipStates() {
            document.querySelectorAll('.dest-country-chip').forEach(function(chip) {
                const key = chip.dataset.dest;
                chip.classList.remove('active', 'region-active');
                chip.classList.toggle('loaded', !!destinations[key]);
                if (regionViewAll) {
                    if (destinations[key]) chip.classList.add('region-active');
                } else {
                    chip.classList.toggle('active', key === activeDestination);
                }
            });

            // Update "Show All" button state
            const showAllBtn = document.getElementById('regionShowAllBtn');
            if (showAllBtn && activeRegion && manifestData) {
                const region = manifestData.regions.find(r => r.key === activeRegion);
                if (region) {
                    const allLoaded = region.destinations.every(k => destinations[k]);
                    showAllBtn.classList.toggle('active', regionViewAll);
                    if (regionViewAll) {
                        showAllBtn.textContent = '\u2713 All ' + region.destinations.length;
                    } else if (allLoaded) {
                        showAllBtn.textContent = 'Show All ' + region.destinations.length;
                    } else {
                        showAllBtn.textContent = 'Load All ' + region.destinations.length;
                    }
                }
            }

            // Update badge
            if (activeRegion && manifestData) {
                const region = manifestData.regions.find(r => r.key === activeRegion);
                if (region) {
                    const loaded = region.destinations.filter(k => destinations[k]).length;
                    const badge = document.getElementById('destRegionBadge');
                    let badgeHtml = '<span>' + loaded + '/' + region.destinations.length + ' loaded</span>';
                    badge.innerHTML = badgeHtml;
                }
            }
        }

        // Toggle region-wide POI markers on/off
        function toggleRegionPois() {
            if (regionPoisActive) {
                // Remove extra region POI layers
                regionPoiLayers.forEach(function(layer) {
                    try { map.removeLayer(layer); } catch(e) {}
                });
                regionPoiLayers = [];
                regionPoisActive = false;
            } else {
                // Add POIs from all loaded region destinations (except active one — already showing)
                if (!activeRegion || !manifestData) return;
                const region = manifestData.regions.find(r => r.key === activeRegion);
                if (!region) return;

                const catColors = categoryColors;
                const catRadii = { hotels: 6, restaurants: 5, experiences: 5, kidFriendly: 5, markets: 5 };
                const catLabels = { hotels: 'Hotel', restaurants: 'Restaurant', experiences: 'Experience', kidFriendly: 'Kid Friendly', markets: 'Market' };

                region.destinations.forEach(function(destKey) {
                    if (destKey === activeDestination) return; // Already showing
                    const dest = destinations[destKey] || destinationCache[destKey];
                    if (!dest) return;

                    ['hotels', 'restaurants', 'experiences', 'kidFriendly', 'markets'].forEach(function(cat) {
                        const pois = dest[cat] || [];
                        pois.forEach(function(poi) {
                            if (!poi.coord) return;
                            // Check if this category group is currently visible
                            if (!categoryGroups[cat] || !map.hasLayer(categoryGroups[cat])) return;

                            var radius = catRadii[cat];
                            var marker = L.circleMarker(poi.coord, {
                                radius: radius,
                                fillColor: catColors[cat],
                                color: '#fff',
                                weight: 1.5,
                                opacity: 0.7,
                                fillOpacity: 0.5,
                                interactive: true
                            });
                            marker._baseRadius = radius;
                            marker.bindPopup('<div class="popup-title">' + escapeHtml(poi.name) + '</div><div class="popup-type">' + catLabels[cat] + ' · ' + escapeHtml(dest.name || destKey) + '</div>' + (poi.desc ? '<div style="font-size:11px;color:#666;margin-top:4px;">' + escapeHtml(poi.desc) + '</div>' : ''));
                            marker.addTo(map);
                            regionPoiLayers.push(marker);
                        });
                    });
                });
                regionPoisActive = true;
            }
            // Update badge button state
            updateCountryChipStates();
        }

        // Clear region POIs when switching destinations
        function clearRegionPois() {
            regionPoiLayers.forEach(function(layer) {
                try { map.removeLayer(layer); } catch(e) {}
            });
            regionPoiLayers = [];
            regionPoisActive = false;
        }

        // Load ALL destinations in a region (parallel fetch)
        async function loadRegion(regionKey) {
            const region = manifestData.regions.find(r => r.key === regionKey);
            if (!region) return;

            activeRegion = regionKey;
            const regionSel = document.getElementById('regionSelect');
            regionSel.value = regionKey;

            showCopyToast('Loading ' + region.name + ' (' + region.destinations.length + ' destinations)...');

            // Fetch all destinations in parallel (skip already loaded)
            const toLoad = region.destinations.filter(k => !destinations[k]);
            const promises = toLoad.map(async function(destKey) {
                let filePath = 'destinations/' + destKey + '.json';
                const entry = manifestData.destinations.find(d => d.key === destKey);
                if (entry && entry.file) filePath = entry.file;

                try {
                    const response = await fetch(filePath);
                    if (!response.ok) throw new Error('HTTP ' + response.status + ' for ' + destKey);
                    const data = await response.json();
                    return data;
                } catch(e) {
                    console.error('Failed to load ' + destKey + ':', e);
                    return null;
                }
            });

            const results = await Promise.all(promises);

            // Register all loaded destinations (without switching to each one)
            let loadedCount = 0;
            results.forEach(function(data) {
                if (!data || !data.key) return;
                if (destinations[data.key]) return; // Already registered

                const config = {
                    name: data.name,
                    subtitle: data.subtitle || '',
                    flag: data.flag || '\u{1F30D}',
                    defaultCenter: data.defaultCenter || [0, 0],
                    defaultZoom: data.defaultZoom || 5,
                    hotels: data.hotels || [],
                    restaurants: data.restaurants || [],
                    experiences: data.experiences || [],
                    kidFriendly: data.kidFriendly || [],
                    markets: data.markets || [],
                    itineraryData: data.itineraryData || {},
                    cityCenters: data.cityCenters || {},
                    regions: data.regions || [],
                    originalItineraryData: JSON.parse(JSON.stringify(data.itineraryData || {}))
                };
                normalizeItineraryDays(config.itineraryData);
                normalizeItineraryDays(config.originalItineraryData);
                destinations[data.key] = config;
                loadedRegionDests.add(data.key);

                // Build per-destination POI lookup for cross-destination coord resolution
                buildDestPoiLookup(data.key, config);
                loadedCount++;
            });

            showCopyToast(region.name + ': ' + (loadedCount + region.destinations.length - toLoad.length) + '/' + region.destinations.length + ' loaded');

            // If no destination is active yet, load the first one in the region
            // (this sets up the base map layer so region POIs can overlay on top)
            if (!activeDestination || !region.destinations.includes(activeDestination)) {
                await loadDestination(region.destinations[0]);
            }

            // Now enter "view all" mode — show region POIs and zoom to fit
            regionViewAll = true;
            if (!regionPoisActive) {
                toggleRegionPois();
            }
            zoomToRegionBounds(region);

            // Refresh chips to show the "view all" state
            updateCountryChipStates();
            buildCountryChips(region);
        }

        // Build per-destination POI lookup (for cross-destination coordinate resolution)
        function buildDestPoiLookup(destKey, config) {
            const lookup = {};
            ['hotels', 'restaurants', 'experiences', 'kidFriendly', 'markets'].forEach(function(cat) {
                (config[cat] || []).forEach(function(poi) {
                    if (poi.name && poi.coord) {
                        lookup[poi.name] = poi;
                    }
                });
            });
            multiDestPoiLookup[destKey] = lookup;
        }

        // Find coordinate for a POI name within a specific destination
        function findCoordInDest(name, destKey) {
            const lookup = multiDestPoiLookup[destKey];
            if (!lookup) return null;
            const poi = lookup[name] || lookup[Object.keys(lookup).find(k => k.toLowerCase() === name.toLowerCase())];
            return poi ? poi.coord : null;
        }

        async function fetchAndLoadDestination(key) {
            // If already loaded, just switch
            if (destinations[key]) {
                await loadDestination(key);
                return;
            }

            // Find the file path from manifest
            let filePath = 'destinations/' + key + '.json';
            if (manifestData) {
                const entry = manifestData.destinations.find(d => d.key === key);
                if (entry && entry.file) filePath = entry.file;
            }

            // Show loading indicator
            showCopyToast('Loading ' + key + '...');

            try {
                const response = await fetch(filePath);
                if (!response.ok) throw new Error('HTTP ' + response.status);
                const data = await response.json();

                // Use existing registerExternalDest to validate and register
                await registerExternalDest(data);

            } catch(e) {
                console.error('Failed to load destination ' + key + ':', e);
                showCopyToast('Could not load ' + key + '. Check that ' + filePath + ' exists.');
            }
        }

        // Override the destination selector to use async loading
        function onDestSelectChange(key) {
            if (key === activeDestination) return;
            fetchAndLoadDestination(key);
        }

        

        function replaceArrayContents(target, source) {
            target.length = 0;
            source.forEach(function(item) { target.push(item); });
        }

        function replaceObjectContents(target, source) {
            Object.keys(target).forEach(function(k) { delete target[k]; });
            Object.assign(target, source);
        }

        async function loadDestination(key) {
            if (key === activeDestination) return;
            var dest = destinations[key];
            if (!dest) { showCopyToast('Destination not found'); return; }

            // Increment load generation — if another load starts while we're awaiting,
            // this load is stale and should abort to prevent corrupting state
            const thisGeneration = ++destLoadGeneration;

            // Save previous destination's mods before switching (use OLD key, not new)
            var previousDest = activeDestination;
            activeDestination = key;
            if (previousDest) {
                try {
                    localStorage.setItem('tripMap_mods_' + previousDest, JSON.stringify(modifiedState));
                } catch(e) {}
            }

            // Clear current map layers safely
            try {
                clearItineraryMarkers();
                clearRegionPois();
            } catch(e) { console.error('[loadDestination] clearItineraryMarkers error:', e); }
            Object.keys(categoryGroups).forEach(function(k) {
                try {
                    if (categoryGroups[k]) {
                        map.removeLayer(categoryGroups[k]);
                        categoryGroups[k] = null;
                    }
                } catch(e) { console.error('[loadDestination] removeLayer error for', k, ':', e); }
            });

            // Swap data arrays (mutate in place to preserve references)
            replaceArrayContents(hotels, dest.hotels);
            replaceArrayContents(restaurants, dest.restaurants);
            replaceArrayContents(experiences, dest.experiences);
            replaceArrayContents(kidFriendly, dest.kidFriendly);
            replaceArrayContents(markets, dest.markets);
            replaceObjectContents(itineraryData, dest.itineraryData);
            replaceObjectContents(cityCenters, dest.cityCenters);
            originalItineraryData = JSON.parse(JSON.stringify(dest.itineraryData));

            // Build POI lookup map for itinerary popup cross-reference
            poiLookup = {};
            [dest.hotels, dest.restaurants, dest.experiences, dest.kidFriendly, dest.markets].forEach(arr => {
                (arr || []).forEach(poi => {
                    if (poi.name) {
                        poiLookup[poi.name] = { desc: poi.desc || '', longDesc: poi.longDesc || '', gmapsUrl: poi.gmapsUrl || '', rating: poi.rating, ratingCount: poi.ratingCount, priceLevel: poi.priceLevel, website: poi.website, hours: poi.hours, photoRef: poi.photoRef, photoAttribution: poi.photoAttribution, tags: poi.tags };
                    }
                });
            });
            // Build sorted list of POI names (longest first) for fuzzy matching
            poiNamesList = Object.keys(poiLookup).sort((a, b) => b.length - a.length);

            // Load destination-specific modifications
            modifiedState = {};
            try {
                var saved = localStorage.getItem('tripMap_mods_' + key);
                if (saved) {
                    modifiedState = JSON.parse(saved);
                    applyModifications();
                }
            } catch(e) {}

            // Update UI
            document.getElementById('destTitle').textContent = dest.name;
            document.getElementById('destSubtitle').textContent = dest.subtitle || '';
            document.querySelector('title').textContent = dest.name + ' \u2014 Interactive Trip Map';
            // Sync the dropdown selector to the active destination
            var destSel = document.getElementById('destSelect');
            if (destSel) destSel.value = key;

            // Reset map view
            map.setView(dest.defaultCenter, dest.defaultZoom);
            currentItinerary = null;
            currentDay = null;

            // Reset chat conversation state for new destination
            chatConversation = [];
            chatGeneratedItinerary = null;
            chatHistory = [];

            // Load annotations (personal.json + browser localStorage)
            await loadPersonalAnnotations(key);
            loadBrowserAnnotations(key);

            // Abort if a newer destination load started while we were awaiting annotations
            if (thisGeneration !== destLoadGeneration) return;

            // Rebuild categories and switch to default view — wrapped in try/catch
            // so individual failures don't prevent the rest from executing
            try {
                categoryGroups.hotels = L.featureGroup();
                categoryGroups.restaurants = L.featureGroup();
                categoryGroups.experiences = L.featureGroup();
                categoryGroups.kidFriendly = L.featureGroup();
                categoryGroups.markets = L.featureGroup();
                loadCategories();
                activeFilterChips.clear();  // Reset filter state so old destination's filters don't hide new POIs
                activeTagFilters.clear();  // Reset tag filters on destination switch
                currentItinMode = 'menu'; // Reset itinerary mode selector
                resetBuilderState();      // Reset step builder
                switchView('categories');
            } catch(e) {
                console.error('[loadDestination] Error rebuilding categories/view:', e);
            }

            try {
                loadSavedGeneratedItineraries();
                buildTabsUI();
                buildFilterChips();
                buildTagFilterPanel();
                // Close tag filter panel on destination switch
                var _tagPanel = document.getElementById('tagFilterPanel');
                var _tagToggle = document.getElementById('tagFilterToggle');
                if (_tagPanel) _tagPanel.classList.remove('open');
                if (_tagToggle) _tagToggle.classList.remove('open');
                buildRegionFilter();
                updateBookingsBadge();
            } catch(e) {
                console.error('[loadDestination] Error rebuilding UI components:', e);
            }

            // Update mobile UI
            try {
                updateMobileAfterDestLoad();
            } catch(e) {
                console.error('[loadDestination] Error updating mobile UI:', e);
            }

            // Update region picker chip states
            try {
                updateCountryChipStates();
                // Also build cross-dest POI lookup for this destination
                buildDestPoiLookup(key, dest);
                // Update generator label to show destination name
                const genLabel = document.getElementById('genDestLabel');
                if (genLabel) genLabel.textContent = 'for ' + dest.name;
            } catch(e) {
                console.error('[loadDestination] Error updating region UI:', e);
            }
        }

        function addDestination(key, config) {
            destinations[key] = config;
            updateDestSelector();
        }

        function updateDestSelector() {
            var sel = document.getElementById('destSelect');
            sel.innerHTML = '';

            // Combine manifest entries (unloaded) with loaded destinations
            var allKeys = new Set();

            // First add manifest entries (preserves order)
            if (manifestData) {
                manifestData.destinations.forEach(function(entry) {
                    allKeys.add(entry.key);
                    var opt = document.createElement('option');
                    opt.value = entry.key;
                    var dest = destinations[entry.key];
                    opt.textContent = (dest ? dest.flag : entry.flag) + ' ' + (dest ? dest.name : entry.name);
                    if (entry.key === activeDestination) opt.selected = true;
                    sel.appendChild(opt);
                });
            }

            // Then add any dynamically loaded destinations not in manifest
            Object.keys(destinations).forEach(function(key) {
                if (allKeys.has(key)) return;  // Already added from manifest
                var opt = document.createElement('option');
                opt.value = key;
                opt.textContent = (destinations[key].flag || '\u{1F30D}') + ' ' + destinations[key].name;
                if (key === activeDestination) opt.selected = true;
                sel.appendChild(opt);
            });
        }

        function showAddDestModal() {
            document.getElementById('destOverlay').classList.add('active');
            document.getElementById('destUrlInput').value = '';
            document.getElementById('destFileInput').value = '';
            document.getElementById('destSchema').style.display = 'none';
        }

        function closeAddDestModal() {
            document.getElementById('destOverlay').classList.remove('active');
        }

        function processDestInput() {
            var url = document.getElementById('destUrlInput').value.trim();
            var fileInput = document.getElementById('destFileInput');

            if (url) {
                loadDestFromUrl(url);
            } else if (fileInput.files && fileInput.files.length > 0) {
                loadDestFromFile(fileInput.files[0]);
            } else {
                showCopyToast('Enter a URL or select a file');
            }
        }

        function loadDestFromUrl(url) {
            showCopyToast('Loading destination...');
            fetch(url)
                .then(function(r) { return r.json(); })
                .then(function(data) { return registerExternalDest(data); })
                .catch(function(e) { showCopyToast('Error loading: ' + e.message); });
        }

        function loadDestFromFile(file) {
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var data = JSON.parse(e.target.result);
                    registerExternalDest(data).catch(function(err) {
                        console.error('Error loading destination from file:', err);
                    });
                } catch(err) {
                    showCopyToast('Invalid JSON file');
                }
            };
            reader.readAsText(file);
        }

        // Normalize itinerary days: parse "label" format into "day" + "title" fields
        // JSON uses: { label: "Day 1 — Tokyo Arrival" }
        // Code expects: { day: 1, title: "Tokyo Arrival", label: "Day 1 — Tokyo Arrival" }
        function normalizeItineraryDays(itinData) {
            if (!itinData) return;
            Object.values(itinData).forEach(itin => {
                if (!itin || !itin.days) return;
                itin.days.forEach((dayData, idx) => {
                    // If already has day+title (old format or already normalized), skip
                    if (dayData.day !== undefined && dayData.title !== undefined) return;
                    // Parse from label: "Day 1 — Tokyo Arrival & Icons"
                    if (dayData.label) {
                        const match = dayData.label.match(/^Day\s+(\d+)\s*[—–\-]\s*(.+)$/i);
                        if (match) {
                            dayData.day = parseInt(match[1]);
                            dayData.title = match[2].trim();
                        } else {
                            // Fallback: use index+1 as day, full label as title
                            dayData.day = idx + 1;
                            dayData.title = dayData.label;
                        }
                    } else {
                        // No label either — use index as fallback
                        dayData.day = idx + 1;
                        dayData.title = 'Day ' + (idx + 1);
                    }
                });
            });
        }

        async function registerExternalDest(data) {
            if (!data.key || !data.name || !data.itineraryData || !data.cityCenters) {
                showCopyToast('Invalid schema: needs key, name, itineraryData, cityCenters');
                return;
            }
            var config = {
                name: data.name,
                subtitle: data.subtitle || '',
                flag: data.flag || '\u{1F30D}',
                defaultCenter: data.defaultCenter || [0, 0],
                defaultZoom: data.defaultZoom || 5,
                hotels: data.hotels || [],
                restaurants: data.restaurants || [],
                experiences: data.experiences || [],
                kidFriendly: data.kidFriendly || [],
                markets: data.markets || [],
                itineraryData: data.itineraryData,
                cityCenters: data.cityCenters,
                regions: data.regions || [],
                originalItineraryData: JSON.parse(JSON.stringify(data.itineraryData))
            };
            // Normalize day format (label → day + title) for both copies
            normalizeItineraryDays(config.itineraryData);
            normalizeItineraryDays(config.originalItineraryData);
            addDestination(data.key, config);
            buildDestPoiLookup(data.key, config);
            closeAddDestModal();
            showCopyToast(data.name + ' added!');
            await loadDestination(data.key);
            updateCountryChipStates();
        }

        function copyDestSchema() {
            var schema = JSON.stringify({
                "key": "italy",
                "name": "Italy Family Adventure",
                "subtitle": "14-Day Trip",
                "flag": "\u{1F1EE}\u{1F1F9}",
                "defaultCenter": [42.5, 12.5],
                "defaultZoom": 6,
                "hotels": [{"name": "Hotel Example", "coord": [41.9, 12.5], "desc": "Description"}],
                "restaurants": [{"name": "Restaurant Example", "coord": [41.9, 12.5], "desc": "Description"}],
                "experiences": [{"name": "Experience Example", "coord": [41.9, 12.5], "desc": "Description"}],
                "kidFriendly": [],
                "markets": [],
                "cityCenters": {"Rome": [41.9, 12.5, 0.12], "Florence": [43.77, 11.25, 0.10]},
                "itineraryData": {
                    "a": {
                        "name": "Classic Italy",
                        "color": "#2563EB",
                        "days": [{
                            "day": 1,
                            "title": "Rome (Arrival)",
                            "items": [
                                {"type": "hotel", "name": "Hotel Example", "coord": [41.9, 12.5]},
                                {"type": "breakfast", "name": "Morning meal", "coord": null},
                                {"type": "sightseeing", "name": "Colosseum", "coord": [41.89, 12.49]},
                                {"type": "nap", "name": "Nap Time", "coord": null},
                                {"type": "dinner", "name": "Trattoria Example", "coord": [41.9, 12.5]}
                            ]
                        }]
                    }
                }
            }, null, 2);

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(schema).then(function() {
                    showCopyToast('Schema copied to clipboard!');
                    document.getElementById('destSchema').textContent = schema;
                    document.getElementById('destSchema').style.display = 'block';
                });
            } else {
                copyFallback(schema);
                document.getElementById('destSchema').textContent = schema;
                document.getElementById('destSchema').style.display = 'block';
            }
        }

        // ============================================
        // GLOBAL STATE
        // ============================================

        let map;
        let currentView = 'categories';
        let currentItinerary = null;
        let currentDay = null;
        let allDaysActive = false;

        // Category feature groups
        let categoryGroups = {
            hotels: null,
            restaurants: null,
            experiences: null,
            kidFriendly: null,
            markets: null
        };

        // Legend control reference
        let legendControl = null;

        // Itinerary markers and polylines
        let itineraryMarkers = [];
        let itineraryPolylines = [];

        // Category colors
        const categoryColors = {
            hotels: '#E63946',
            restaurants: '#F8A500',
            experiences: '#4ECDC4',
            kidFriendly: '#95E1D3',
            markets: '#9D4EDD'
        };

        // ============================================
        // TAG FILTER STATE & TAXONOMY
        // ============================================

        let activeTagFilters = new Set();
        let allCategoryMarkerRefs = []; // {poi, marker, hitMarker, categoryKey}

        const tagTaxonomy = {
            'Vibe': {
                color: '#6366F1',
                tags: ['Romantic', 'Photography Worthy', 'Splurge', 'Budget Friendly', 'Rainy Day', 'Hidden Gem', 'Iconic / Must-See', 'Scenic Views']
            },
            'Food & Drink': {
                color: '#F59E0B',
                tags: ['Fine Dining', 'Casual Eats', 'Good for Lunch', 'Good for Dinner', 'Local Delicacies', 'Coffee', 'Cocktails & Bars', 'Sweet Treats', 'Breakfast Spot', 'Brunch', 'Market / Street Food', 'Off-Hours Eats', 'Afternoon Wine']
            },
            'Activities': {
                color: '#2563EB',
                tags: ['Cultural & Historical', 'Art & Design', 'Outdoor & Nature', 'Adventure & Active', 'Shopping', 'Wellness & Spa', 'Nightlife', 'Half-Day Trip', 'Full-Day Activity', 'Live Music / Entertainment', 'Beach']
            },
            'Family': {
                color: '#10B981',
                tags: ['Family Friendly', 'Toddler Friendly', 'Kids Gear Rental', 'Kids Clothing', 'Playgrounds']
            },
            'Practical': {
                color: '#8B5CF6',
                tags: ['Reservations Recommended', 'Good for Groups', 'Pet Friendly']
            }
        };

        // Per-tag color map (derived from group colors with slight variation)
        const tagColorMap = {};
        (function() {
            const groupPalettes = {
                'Vibe': ['#6366F1','#818CF8','#A78BFA','#C084FC','#7C3AED','#8B5CF6','#6D28D9','#4F46E5'],
                'Food & Drink': ['#F59E0B','#D97706','#B45309','#EA580C','#F97316','#FB923C','#FBBF24','#FCD34D','#92400E','#78350F','#C2410C','#A16207','#854D0E'],
                'Activities': ['#2563EB','#3B82F6','#0EA5E9','#06B6D4','#DC2626','#14B8A6','#7C3AED','#1D4ED8','#1E40AF','#D946EF','#38BDF8'],
                'Family': ['#10B981','#34D399','#4ADE80','#86EFAC','#84CC16'],
                'Practical': ['#8B5CF6','#0EA5E9','#22D3EE']
            };
            Object.keys(tagTaxonomy).forEach(group => {
                const palette = groupPalettes[group];
                tagTaxonomy[group].tags.forEach((tag, i) => {
                    tagColorMap[tag] = palette[i % palette.length];
                });
            });
        })();

        // Item type colors
        const typeColors = {
            hotel: '#E63946',
            breakfast: '#EA580C',
            lunch: '#0D9488',
            dinner: '#BE123C',
            sightseeing: '#2563EB',
            optional: '#9D4EDD',
            nap: '#999'
        };

        // ============================================

        // ============================================
        // PERSISTENCE & MODIFICATION STATE
        // ============================================

        let modifiedState = {};

        function saveModifiedState() {
            try {
                localStorage.setItem('japanTrip_mods', JSON.stringify(modifiedState));
            } catch (e) {
                console.warn('localStorage save failed:', e);
            }
        }

        function loadModifiedState() {
            try {
                const saved = localStorage.getItem('japanTrip_mods');
                if (saved) {
                    modifiedState = JSON.parse(saved);
                    applyModifications();
                }
            } catch (e) {
                console.warn('localStorage load failed:', e);
            }
        }

        function applyModifications() {
            Object.entries(modifiedState).forEach(([stateKey, mod]) => {
                const parts = stateKey.split('_');
                const key = parts[0];
                const dayNum = parseInt(parts[1]);
                const itemIdx = parseInt(parts[2]);
                const itin = itineraryData[key];
                if (!itin) return;
                const dayData = itin.days.find(d => d.day === dayNum);
                if (!dayData || !dayData.items[itemIdx]) return;
                const origType = dayData.items[itemIdx].type;
                dayData.items[itemIdx] = { type: origType, name: mod.newName, coord: mod.newCoord, desc: mod.newDesc || '' };
            });
        }

        function resetDay(itinKey, dayNum) {
            event.stopPropagation();
            const origItin = originalItineraryData[itinKey];
            if (!origItin) return;
            const origDay = origItin.days.find(d => d.day === dayNum);
            const currItin = itineraryData[itinKey];
            const currDay = currItin.days.find(d => d.day === dayNum);
            if (!origDay || !currDay) return;
            currDay.items = JSON.parse(JSON.stringify(origDay.items));
            const prefix = itinKey + '_' + dayNum + '_';
            Object.keys(modifiedState).forEach(k => {
                if (k.startsWith(prefix)) delete modifiedState[k];
            });
            saveModifiedState();
            if (currentItinerary === itinKey) {
                showItinerary(itinKey);
            }
        }

        function dayHasModifications(itinKey, dayNum) {
            const prefix = itinKey + '_' + dayNum + '_';
            return Object.keys(modifiedState).some(k => k.startsWith(prefix));
        }

        // ============================================
        // CITY LOOKUP & ALTERNATIVES
        // ============================================


        function extractCity(title) {
            if (!title) return '';
            let city = title.split('(')[0].split('→')[0].split('&')[0].split('/')[0].trim();
            return city;
        }

        function findCityCenter(title) {
            const city = extractCity(title);
            for (const [name, center] of Object.entries(cityCenters)) {
                if (city.toLowerCase().includes(name.toLowerCase()) || name.toLowerCase().includes(city.toLowerCase())) {
                    return { name: name, lat: center[0], lng: center[1], radius: center[2] };
                }
            }
            return null;
        }

        function findAlternatives(dayTitle, itemType, excludeName) {
            const center = findCityCenter(dayTitle);
            if (!center) return [];

            let sources = [];
            if (itemType === 'hotel') {
                sources = hotels.map(h => ({...h, srcType: 'hotel'}));
            } else if (itemType === 'breakfast' || itemType === 'lunch' || itemType === 'dinner') {
                sources = restaurants.map(r => ({...r, srcType: 'restaurant'}));
            } else if (itemType === 'sightseeing' || itemType === 'optional') {
                sources = [
                    ...experiences.map(e => ({...e, srcType: 'experience'})),
                    ...kidFriendly.map(k => ({...k, srcType: 'kid-friendly'})),
                    ...markets.map(m => ({...m, srcType: 'market'}))
                ];
            } else {
                return [];
            }

            return sources.filter(item => {
                if (!item.coord) return false;
                if (item.name === excludeName) return false;
                const latDiff = Math.abs(item.coord[0] - center.lat);
                const lngDiff = Math.abs(item.coord[1] - center.lng);
                return latDiff < center.radius && lngDiff < center.radius;
            });
        }

        // ============================================
        // SWAP PANEL
        // ============================================

        let swapContext = null;

        function openSwapPanel(itinKey, dayNum, itemIdx) {
            const itin = itineraryData[itinKey];
            const dayData = itin.days.find(d => d.day === dayNum);
            if (!dayData) return;
            const item = dayData.items[itemIdx];
            if (!item || item.type === 'nap') return;

            swapContext = { itinKey, dayNum, itemIdx, item };

            const alts = findAlternatives(dayData.title, item.type, item.name);

            let html = '';
            html += '<div class="swap-current">';
            html += '<div class="swap-current-label">Current Activity</div>';
            html += '<div class="swap-current-name">' + escapeHtml(item.name) + '</div>';
            if (item.desc) html += '<div class="swap-current-desc">' + escapeHtml(item.desc) + '</div>';
            html += '</div>';

            html += '<div class="swap-alts-label">Alternatives in ' + escapeHtml(extractCity(dayData.title)) + '</div>';

            if (alts.length === 0) {
                html += '<div class="swap-no-alts">No alternatives found nearby for this type of activity</div>';
            } else {
                alts.forEach((alt, idx) => {
                    html += '<div class="swap-alt-card" onclick="performSwap(' + idx + ')" data-idx="' + idx + '">';
                    html += '<div class="swap-alt-name">' + escapeHtml(alt.name) + '</div>';
                    if (alt.desc) html += '<div class="swap-alt-desc">' + escapeHtml(alt.desc) + '</div>';
                    html += '</div>';
                });
            }

            document.getElementById('swapPanelBody').innerHTML = html;
            document.getElementById('swapPanelTitle').textContent = 'Swap ' + formatType(item.type);
            document.getElementById('swapOverlay').classList.add('active');
            document.getElementById('swapPanel').classList.add('active');

            // Store alternatives for performSwap
            swapContext.alts = alts;
        }

        function closeSwapPanel() {
            document.getElementById('swapOverlay').classList.remove('active');
            document.getElementById('swapPanel').classList.remove('active');
            swapContext = null;
        }

        function performSwap(altIdx) {
            if (!swapContext) return;
            const { itinKey, dayNum, itemIdx, alts } = swapContext;
            const alt = alts[altIdx];
            if (!alt) return;

            const itin = itineraryData[itinKey];
            const dayData = itin.days.find(d => d.day === dayNum);
            const origType = dayData.items[itemIdx].type;

            dayData.items[itemIdx] = {
                type: origType,
                name: alt.name,
                coord: alt.coord,
                desc: alt.desc || ''
            };

            const stateKey = itinKey + '_' + dayNum + '_' + itemIdx;
            modifiedState[stateKey] = {
                newName: alt.name,
                newCoord: alt.coord,
                newDesc: alt.desc || '',
                origName: swapContext.item.name,
                origCoord: swapContext.item.coord,
                timestamp: Date.now()
            };
            saveModifiedState();

            closeSwapPanel();

            if (currentItinerary === itinKey) {
                showItinerary(itinKey);
            }
        }

        // MAP INITIALIZATION
        // ============================================

        function initMap() {
            map = L.map('map-container', { zoomControl: false }).setView([36.2, 137.5], 6.5);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; CartoDB contributors',
                maxZoom: 19,
                minZoom: 4
            }).addTo(map);

            // Initialize category feature groups (empty — loadDestination fills them)
            categoryGroups.hotels = L.featureGroup();
            categoryGroups.restaurants = L.featureGroup();
            categoryGroups.experiences = L.featureGroup();
            categoryGroups.kidFriendly = L.featureGroup();
            categoryGroups.markets = L.featureGroup();

            // Zoom-responsive marker scaling — adjusts marker size with zoom level
            map.on('zoomend', function() {
                const zoom = map.getZoom();
                // Scale: 0.7x at zoom 4, 1.0x at zoom 10, 1.4x at zoom 16+
                const scale = Math.max(0.7, Math.min(1.4, 0.7 + (zoom - 4) * 0.058));
                // Scale category markers
                Object.values(categoryGroups).forEach(function(group) {
                    if (!group) return;  // Skip null groups during destination transitions
                    group.eachLayer(function(layer) {
                        if (layer._baseRadius !== undefined) {
                            layer.setRadius(Math.round(layer._baseRadius * scale));
                        } else if (layer._baseHitRadius !== undefined) {
                            layer.setRadius(Math.round(layer._baseHitRadius * scale));
                        }
                    });
                });
                // Scale itinerary markers
                itineraryMarkers.forEach(function(m) {
                    if (m.marker._baseRadius !== undefined) {
                        m.marker.setRadius(Math.round(m.marker._baseRadius * scale));
                    }
                    if (m.hitMarker && m.hitMarker._baseHitRadius !== undefined) {
                        m.hitMarker.setRadius(Math.round(m.hitMarker._baseHitRadius * scale));
                    }
                });
            });

            // Build static UI elements
            buildCategoriesUI();

            // Initialize destination selector (Phase 4)
            updateDestSelector();

            // Add geolocation control
            initGeolocation();

            // NOTE: loadCategories() and buildTabsUI() are called by loadDestination()
            // which is invoked right after initMap() in DOMContentLoaded
        }

        // ============================================
        // GEOLOCATION
        // ============================================

        let userLocationMarker = null;
        let userAccuracyCircle = null;
        let geoWatchId = null;
        let geoTracking = false;

        function initGeolocation() {
            // Check if geolocation is available
            if (!navigator.geolocation) {
                var btn = document.getElementById('locateBtn');
                if (btn) btn.style.display = 'none';
            }
        }

        function toggleGeolocation() {
            if (geoTracking) {
                stopGeolocation();
            } else {
                startGeolocation();
            }
        }

        function startGeolocation() {
            if (!navigator.geolocation) {
                showCopyToast('Geolocation not supported');
                return;
            }

            var btn = document.getElementById('locateBtn');
            btn.classList.add('tracking');
            geoTracking = true;

            // Get initial position (quick)
            navigator.geolocation.getCurrentPosition(
                function(pos) { updateUserLocation(pos); map.setView([pos.coords.latitude, pos.coords.longitude], 15); },
                function(err) { handleGeoError(err); },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );

            // Watch for continuous updates
            geoWatchId = navigator.geolocation.watchPosition(
                function(pos) { updateUserLocation(pos); },
                function(err) { /* silent on watch errors */ },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 5000 }
            );
        }

        function stopGeolocation() {
            geoTracking = false;
            var btn = document.getElementById('locateBtn');
            btn.classList.remove('tracking', 'active');

            if (geoWatchId !== null) {
                navigator.geolocation.clearWatch(geoWatchId);
                geoWatchId = null;
            }

            if (userLocationMarker) {
                map.removeLayer(userLocationMarker);
                userLocationMarker = null;
            }
            if (userAccuracyCircle) {
                map.removeLayer(userAccuracyCircle);
                userAccuracyCircle = null;
            }
        }

        function updateUserLocation(position) {
            var lat = position.coords.latitude;
            var lng = position.coords.longitude;
            var accuracy = position.coords.accuracy;

            var btn = document.getElementById('locateBtn');
            btn.classList.add('active');
            btn.classList.remove('tracking');

            // Create or update the user dot
            if (!userLocationMarker) {
                var dotIcon = L.divIcon({
                    className: '',
                    html: '<div class="user-location-dot"></div>',
                    iconSize: [14, 14],
                    iconAnchor: [7, 7]
                });
                userLocationMarker = L.marker([lat, lng], { icon: dotIcon, zIndexOffset: 9999 }).addTo(map);
                userLocationMarker.bindPopup('<div style="font-size:12px;font-weight:600;">You are here</div><div style="font-size:11px;color:#666;">Accuracy: ' + Math.round(accuracy) + 'm</div>');
            } else {
                userLocationMarker.setLatLng([lat, lng]);
                userLocationMarker.setPopupContent('<div style="font-size:12px;font-weight:600;">You are here</div><div style="font-size:11px;color:#666;">Accuracy: ' + Math.round(accuracy) + 'm</div>');
            }

            // Create or update accuracy circle
            if (!userAccuracyCircle) {
                userAccuracyCircle = L.circle([lat, lng], {
                    radius: accuracy,
                    className: 'user-location-ring',
                    fillColor: 'rgba(37,99,235,0.08)',
                    fillOpacity: 1,
                    color: 'rgba(37,99,235,0.2)',
                    weight: 1,
                    interactive: false
                }).addTo(map);
            } else {
                userAccuracyCircle.setLatLng([lat, lng]);
                userAccuracyCircle.setRadius(accuracy);
            }
        }

        function handleGeoError(error) {
            geoTracking = false;
            var btn = document.getElementById('locateBtn');
            btn.classList.remove('tracking', 'active');

            switch (error.code) {
                case error.PERMISSION_DENIED:
                    showCopyToast('Location access denied. Check browser settings.');
                    break;
                case error.POSITION_UNAVAILABLE:
                    showCopyToast('Location unavailable');
                    break;
                case error.TIMEOUT:
                    showCopyToast('Location request timed out');
                    break;
                default:
                    showCopyToast('Could not get location');
            }
        }

        // ============================================
        // CATEGORY LOADING & RENDERING
        // ============================================

        // Build enrichment data section for popup (rating, hours, website, photo)
        function buildEnrichmentHtml(data) {
            if (!data || (!data.rating && !data.website && !data.hours)) return '';
            let html = '<div style="margin-top:8px;padding:8px;background:#f8fafc;border-radius:6px;border:1px solid #e2e8f0;">';
            // Rating + price row
            if (data.rating) {
                html += '<div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:12px;">';
                html += '<span style="color:#f59e0b;">★</span> <strong>' + data.rating + '</strong>';
                if (data.ratingCount) html += ' <span style="color:#9ca3af;font-size:11px;">(' + Number(data.ratingCount).toLocaleString() + ')</span>';
                if (data.priceLevel) {
                    const priceLevels = {'FREE':'Free','INEXPENSIVE':'$','MODERATE':'$$','EXPENSIVE':'$$$','VERY_EXPENSIVE':'$$$$'};
                    const pl = priceLevels[data.priceLevel] || data.priceLevel;
                    if (pl) html += ' <span style="color:#10b981;font-size:11px;margin-left:4px;">' + pl + '</span>';
                }
                html += '</div>';
            }
            // Website
            if (data.website) {
                try {
                    const domain = new URL(data.website).hostname.replace('www.','');
                    html += '<div style="margin-top:4px;"><a href="' + escapeHtml(data.website) + '" target="_blank" rel="noopener" style="font-size:11px;color:#1a73e8;text-decoration:none;display:inline-flex;align-items:center;gap:3px;">🌐 ' + escapeHtml(domain) + '</a></div>';
                } catch(e) {}
            }
            // Hours (collapsible)
            if (data.hours && data.hours.length > 0) {
                const hoursId = 'hrs-' + Math.random().toString(36).substr(2, 8);
                html += '<div style="margin-top:4px;">';
                html += '<button onclick="var el=document.getElementById(\'' + hoursId + '\');el.style.display=el.style.display===\'none\'?\'block\':\'none\';this.textContent=el.style.display===\'none\'?\'🕐 Hours ▸\':\'🕐 Hours ▾\'" style="font-size:11px;color:#1a73e8;cursor:pointer;text-decoration:none;background:none;border:none;padding:0;font-family:inherit;-webkit-tap-highlight-color:rgba(0,0,0,0.1);">🕐 Hours ▸</button>';
                html += '<div id="' + hoursId + '" style="display:none;margin-top:4px;font-size:10px;color:#555;line-height:1.6;">';
                data.hours.forEach(function(h) { html += escapeHtml(h) + '<br>'; });
                html += '</div></div>';
            }
            // Photo (lazy-loaded via API key)
            if (data.photoRef) {
                const apiKey = localStorage.getItem('tripMap_apiKey') || localStorage.getItem('japanTrip_apiKey') || '';
                if (apiKey) {
                    const photoUrl = 'https://places.googleapis.com/v1/' + encodeURI(data.photoRef) + '/media?maxHeightPx=200&key=' + encodeURIComponent(apiKey);
                    html += '<div style="margin-top:6px;"><img src="' + photoUrl + '" style="width:100%;max-height:150px;object-fit:cover;border-radius:4px;" loading="lazy" onerror="this.parentElement.style.display=\'none\'"></div>';
                    if (data.photoAttribution) html += '<div style="font-size:9px;color:#9ca3af;margin-top:2px;">Photo: ' + escapeHtml(data.photoAttribution) + '</div>';
                }
            }
            html += '</div>';
            return html;
        }

        // Build tags HTML for POI popups
        function buildTagsHtml(data) {
            if (!data || !data.tags || !data.tags.length) return '';
            const tagColors = {
                'Fine Dining':'#7c3aed','Splurge':'#7c3aed','Romantic':'#ec4899',
                'Family Friendly':'#f59e0b','Toddler Friendly':'#f59e0b',
                'Budget Friendly':'#10b981','Casual Eats':'#10b981',
                'Good for Lunch':'#f97316','Good for Dinner':'#6366f1',
                'Coffee':'#92400e','Cocktails & Bars':'#be185d','Nightlife':'#be185d',
                'Local Delicacies':'#dc2626','Sweet Treats':'#ec4899',
                'Outdoor & Nature':'#059669','Adventure & Active':'#059669',
                'Cultural & Historical':'#1d4ed8','Art & Design':'#7c3aed',
                'Shopping':'#d97706','Wellness & Spa':'#0d9488',
                'Photography Worthy':'#6366f1','Rainy Day':'#6b7280'
            };
            let html = '<div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:4px;">';
            data.tags.forEach(function(tag) {
                const color = tagColors[tag] || '#6b7280';
                html += '<span style="display:inline-block;padding:2px 7px;border-radius:10px;font-size:10px;font-weight:500;color:' + color + ';background:' + color + '14;border:1px solid ' + color + '30;">' + escapeHtml(tag) + '</span>';
            });
            html += '</div>';
            return html;
        }

        // Build popup HTML for any category POI (shared helper)
        function buildPoiPopupHtml(poi, categoryLabel) {
            const destKey = activeDestination || 'default';
            const safeName = poi.name.replace(/'/g, "\\'");
            const noteTextareaId = 'note-' + poi.name.replace(/[^a-zA-Z0-9]/g, '_');
            const existingNote = getNote(destKey, poi.name);
            const poiAnnotations = getAnnotationsForPoi(destKey, poi.name);

            let html = `<div class="popup-title">${escapeHtml(poi.name)}</div><div class="popup-type">${categoryLabel}</div><div style="font-size:11px;color:#666;margin-top:4px;">${escapeHtml(poi.desc || '')}</div>`;
            if (poi.longDesc) html += `<div style="font-size:12px;color:#444;margin-top:6px;line-height:1.4;">${escapeHtml(poi.longDesc)}</div>`;
            html += buildEnrichmentHtml(poi);
            html += buildTagsHtml(poi);
            if (poi.gmapsUrl) html += `<div style="margin-top:6px;"><a href="${poi.gmapsUrl}" target="_blank" rel="noopener" style="font-size:11px;color:#1a73e8;text-decoration:none;display:inline-flex;align-items:center;gap:3px;"><span style="font-size:13px;">📍</span> View on Google Maps</a></div>`;
            // Annotations
            html += buildAnnotationHtml(poiAnnotations);
            html += buildAnnotationFormHtml(destKey, poi.name);
            // Notes
            html += '<div style="margin-top:8px;border-top:1px solid #e5e7eb;padding-top:8px">';
            html += '<div style="font-size:11px;font-weight:600;color:#6b7280;margin-bottom:4px">📝 My Notes</div>';
            html += '<textarea id="' + noteTextareaId + '" style="width:100%;min-height:50px;border:1px solid #d1d5db;border-radius:4px;padding:4px;font-size:12px;resize:vertical;font-family:inherit" placeholder="Add a note...">' + escapeHtml(existingNote) + '</textarea>';
            html += '<button onclick="setNote(\'' + destKey + '\',\'' + safeName + '\',document.getElementById(\'' + noteTextareaId + '\').value);this.textContent=\'Saved ✓\';setTimeout(()=>this.textContent=\'Save Note\',1500)" style="margin-top:4px;padding:2px 8px;font-size:11px;background:#2563EB;color:white;border:none;border-radius:3px;cursor:pointer;width:100%">Save Note</button>';
            html += '</div>';
            return html;
        }

        function loadCategories() {
            const destKey = activeDestination || 'default';
            allCategoryMarkerRefs = []; // Reset marker tracking for tag filtering

            // Helper to create a category marker with annotation badge
            function addCategoryMarker(poi, categoryKey, categoryLabel, radius) {
                if (!poi.coord) return;
                const hasAnnotation = getAnnotationsForPoi(destKey, poi.name).length > 0;

                // Invisible hit-area marker (large, transparent) for easier clicking/tapping
                const hitRadius = isMobile() ? 16 : 12;
                const hitMarker = L.circleMarker(poi.coord, {
                    radius: hitRadius,
                    fillColor: 'transparent',
                    color: 'transparent',
                    weight: 0,
                    fillOpacity: 0,
                    interactive: true
                });
                hitMarker.bindPopup(buildPoiPopupHtml(poi, categoryLabel));
                if (isMobile()) {
                    hitMarker.off('click');
                    hitMarker.on('click', function() {
                        showMobilePOIDetail(poi, categoryLabel);
                    });
                }
                categoryGroups[categoryKey].addLayer(hitMarker);

                // Visible marker (small, styled) — clicks pass through to hitMarker
                const marker = L.circleMarker(poi.coord, {
                    radius: radius,
                    fillColor: categoryColors[categoryKey],
                    color: hasAnnotation ? '#f59e0b' : '#fff',
                    weight: hasAnnotation ? 3 : 2,
                    opacity: 1,
                    fillOpacity: 0.8,
                    interactive: false
                });
                categoryGroups[categoryKey].addLayer(marker);

                // Desktop hover effect — grow marker on hover
                if (!isMobile()) {
                    hitMarker.on('mouseover', function() { marker.setRadius(radius + 2); });
                    hitMarker.on('mouseout', function() { marker.setRadius(radius); });
                }

                // Store base radii for zoom-responsive scaling
                marker._baseRadius = radius;
                hitMarker._baseHitRadius = hitRadius;

                // Track for tag-based filtering
                allCategoryMarkerRefs.push({ poi: poi, marker: marker, hitMarker: hitMarker, categoryKey: categoryKey, baseRadius: radius });
            }

            // Hotels
            hotels.forEach(h => addCategoryMarker(h, 'hotels', 'Hotel', 6));
            // Restaurants
            restaurants.forEach(r => addCategoryMarker(r, 'restaurants', 'Restaurant', 5));
            // Experiences
            experiences.forEach(e => addCategoryMarker(e, 'experiences', 'Experience', 5));
            // Kid Friendly
            kidFriendly.forEach(k => addCategoryMarker(k, 'kidFriendly', 'Kid Friendly', 5));
            // Markets
            markets.forEach(m => addCategoryMarker(m, 'markets', 'Market', 5));

            // Add all to map initially (categories view)
            categoryGroups.hotels.addTo(map);
            categoryGroups.restaurants.addTo(map);
            categoryGroups.experiences.addTo(map);
            categoryGroups.kidFriendly.addTo(map);
            categoryGroups.markets.addTo(map);

            // Add legend
            addLegend();

            // Fit bounds
            let allLayers = L.featureGroup([
                categoryGroups.hotels,
                categoryGroups.restaurants,
                categoryGroups.experiences,
                categoryGroups.kidFriendly,
                categoryGroups.markets
            ]);
            if (allLayers.getLayers().length > 0) {
                map.fitBounds(allLayers.getBounds().pad(0.1));
            }
        }

        function addLegend() {
            // Remove existing legend before adding a new one
            if (legendControl) {
                map.removeControl(legendControl);
                legendControl = null;
            }
            const legend = L.control({ position: 'bottomright' });
            legend.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'legend');
                const items = [
                    { label: 'Hotels', color: categoryColors.hotels },
                    { label: 'Restaurants', color: categoryColors.restaurants },
                    { label: 'Experiences', color: categoryColors.experiences },
                    { label: 'Kid Friendly', color: categoryColors.kidFriendly },
                    { label: 'Markets', color: categoryColors.markets }
                ];

                items.forEach(item => {
                    const legendItem = document.createElement('div');
                    legendItem.className = 'legend-item';
                    legendItem.innerHTML = `<div class="legend-color" style="background-color:${item.color}"></div> <span>${item.label}</span>`;
                    div.appendChild(legendItem);
                });

                return div;
            };
            legend.addTo(map);
            legendControl = legend;
        }

        // ============================================
        // UI BUILDING
        // ============================================

        function buildTabsUI() {
            const container = document.getElementById('tabsContainer');
            container.innerHTML = '';  // Clear existing tabs before rebuilding

            Object.keys(itineraryData).forEach(key => {
                const itin = itineraryData[key];
                const itinName = itin.name || itin.title || key.toUpperCase();
                const btn = document.createElement('button');
                btn.className = `itin-tab itin-tab-${key}`;
                if (itin.isGenerated) {
                    btn.classList.add('itin-tab-generated');
                    btn.style.borderColor = itin.color || '#7C3AED';
                    btn.innerHTML = '\u2728 ' + escapeHtml(itinName);
                    const delSpan = document.createElement('span');
                    delSpan.className = 'itin-tab-delete';
                    delSpan.innerHTML = '\u00d7';
                    delSpan.onclick = function(e) { e.stopPropagation(); deleteGeneratedItinerary(key); };
                    btn.appendChild(delSpan);
                } else {
                    btn.textContent = itinName;
                }
                btn.onclick = () => selectItinerary(key);
                btn.id = `tab-${key}`;
                container.appendChild(btn);
            });
        }

        function buildCategoriesUI() {
            const container = document.getElementById('categoriesContainer');
            
            const categories = [
                { key: 'hotels', label: 'Hotels' },
                { key: 'restaurants', label: 'Restaurants' },
                { key: 'experiences', label: 'Experiences' },
                { key: 'kidFriendly', label: 'Kid Friendly' },
                { key: 'markets', label: 'Markets' }
            ];
            
            categories.forEach(cat => {
                const label = document.createElement('label');
                label.className = 'category-checkbox';
                label.innerHTML = `
                    <input type="checkbox" checked data-category="${cat.key}" onchange="toggleCategory('${cat.key}')">
                    <span class="category-color" style="background-color:${categoryColors[cat.key]}"></span>
                    <span class="category-label">${cat.label}</span>
                `;
                container.appendChild(label);
            });
        }

        // ============================================
        // VIEW SWITCHING
        // ============================================

        function switchView(view) {
            currentView = view;
            
            if (view === 'categories') {
                document.getElementById('categoriesViewBtn').classList.add('active');
                document.getElementById('itinerariesViewBtn').classList.remove('active');
                document.getElementById('itineraryTabs').style.display = 'none';
                document.getElementById('categoriesCheckboxes').style.display = 'block';
                document.getElementById('categoriesView').style.display = 'block';
                document.getElementById('itinerariesView').style.display = 'none';
                
                // Clear itinerary markers
                clearItineraryMarkers();
                
                // Show category markers (with null guards for race-condition safety)
                if (categoryGroups.hotels) categoryGroups.hotels.addTo(map);
                if (categoryGroups.restaurants) categoryGroups.restaurants.addTo(map);
                if (categoryGroups.experiences) categoryGroups.experiences.addTo(map);
                if (categoryGroups.kidFriendly) categoryGroups.kidFriendly.addTo(map);
                if (categoryGroups.markets) categoryGroups.markets.addTo(map);

                // Fit bounds
                let allLayers = L.featureGroup([
                    categoryGroups.hotels,
                    categoryGroups.restaurants,
                    categoryGroups.experiences,
                    categoryGroups.kidFriendly,
                    categoryGroups.markets
                ].filter(Boolean));
                if (allLayers.getLayers().length > 0) {
                    map.fitBounds(allLayers.getBounds().pad(0.1));
                }
            } else {
                document.getElementById('categoriesViewBtn').classList.remove('active');
                document.getElementById('itinerariesViewBtn').classList.add('active');
                document.getElementById('itineraryTabs').style.display = 'block';
                document.getElementById('categoriesCheckboxes').style.display = 'none';
                document.getElementById('categoriesView').style.display = 'none';

                // Hide category markers (with null guards)
                if (categoryGroups.hotels) categoryGroups.hotels.removeFrom(map);
                if (categoryGroups.restaurants) categoryGroups.restaurants.removeFrom(map);
                if (categoryGroups.experiences) categoryGroups.experiences.removeFrom(map);
                if (categoryGroups.kidFriendly) categoryGroups.kidFriendly.removeFrom(map);
                if (categoryGroups.markets) categoryGroups.markets.removeFrom(map);

                // Show mode selector (3-option menu)
                selectItinMode('menu');
            }

            // Reapply filter chips to new view
            if (activeFilterChips.size > 0) {
                applyFilterChips();
            }
        }

        function toggleCategory(categoryKey) {
            if (map.hasLayer(categoryGroups[categoryKey])) {
                categoryGroups[categoryKey].removeFrom(map);
            } else {
                categoryGroups[categoryKey].addTo(map);
            }
            // Re-apply tag filters after category toggle
            if (activeTagFilters.size > 0) applyTagFiltersCategories();
        }

        // ============================================
        // ITINERARY SELECTION & RENDERING
        // ============================================

        function selectItinerary(key) {
            currentItinerary = key;
            currentDay = null;
            allDaysActive = false;
            updateChatContext();

            // Update active tab (desktop)
            document.querySelectorAll('.itin-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const tabEl = document.getElementById(`tab-${key}`);
            if (tabEl) tabEl.classList.add('active');

            showItinerary(key);
        }

        function showItinerary(key) {
            const itin = itineraryData[key];
            const isMultiDest = itin.isMultiDestination || false;

            // Clear existing markers
            clearItineraryMarkers();

            // Create markers for all days with coordinates
            const markers = [];

            itin.days.forEach(dayData => {
                // For multi-destination itineraries, resolve coords from the correct destination
                const dayDestKey = (isMultiDest && dayData.destination) ? dayData.destination : activeDestination;

                dayData.items.forEach(item => {
                    // For multi-dest: resolve coord from the day's destination if not already set
                    if (!item.coord && isMultiDest && dayData.destination) {
                        item.coord = findCoordInDest(item.name, dayData.destination);
                    }
                    if (item.coord) {
                        const itinBaseRadius = 7;
                        const itinHitRadius = isMobile() ? 18 : 14;

                        const itemIdx = dayData.items.indexOf(item);
                        const swapBtn = (item.type !== 'nap') ? '<button class="popup-swap-btn" onclick="openSwapPanel(\x27' + key + '\x27,' + dayData.day + ',' + itemIdx + ')">&#x1f504; Swap</button>' : '';
                        const destKey = dayDestKey || 'default';
                        const poiInfo = isMultiDest ? lookupPoiInDest(item.name, dayDestKey) : lookupPoi(item.name);
                        const poiAnnotations = getAnnotationsForPoi(destKey, item.name);
                        const safeName = item.name.replace(/'/g, "\\'");
                        const itinNoteId = 'note-' + item.name.replace(/[^a-zA-Z0-9]/g, '_') + '_itin';
                        const itinExistingNote = getNote(destKey, item.name);

                        let popupContent = '<div class="popup-title">' + escapeHtml(item.name) + '</div><div class="popup-type">' + formatType(item.type) + '</div><div style="font-size:11px;color:#666;margin-top:4px;">Day ' + dayData.day + '</div>';
                        if (poiInfo.desc) popupContent += '<div style="font-size:11px;color:#666;margin-top:4px;">' + escapeHtml(poiInfo.desc) + '</div>';
                        if (poiInfo.longDesc) popupContent += '<div style="font-size:12px;color:#444;margin-top:6px;line-height:1.4;">' + escapeHtml(poiInfo.longDesc) + '</div>';
                        popupContent += buildEnrichmentHtml(poiInfo);
                        popupContent += buildTagsHtml(poiInfo);
                        if (poiInfo.gmapsUrl) popupContent += '<div style="margin-top:6px;"><a href="' + poiInfo.gmapsUrl + '" target="_blank" rel="noopener" style="font-size:11px;color:#1a73e8;text-decoration:none;display:inline-flex;align-items:center;gap:3px;"><span style="font-size:13px;">📍</span> View on Google Maps</a></div>';
                        popupContent += swapBtn;
                        // Annotations
                        popupContent += buildAnnotationHtml(poiAnnotations);
                        popupContent += buildAnnotationFormHtml(destKey, item.name);
                        // Notes
                        popupContent += '<div style="margin-top:8px;border-top:1px solid #e5e7eb;padding-top:8px">';
                        popupContent += '<div style="font-size:11px;font-weight:600;color:#6b7280;margin-bottom:4px">📝 My Notes</div>';
                        popupContent += '<textarea id="' + itinNoteId + '" style="width:100%;min-height:50px;border:1px solid #d1d5db;border-radius:4px;padding:4px;font-size:12px;resize:vertical;font-family:inherit" placeholder="Add a note...">' + escapeHtml(itinExistingNote) + '</textarea>';
                        popupContent += '<button onclick="setNote(\'' + destKey + '\',\'' + safeName + '\',document.getElementById(\'' + itinNoteId + '\').value);this.textContent=\'Saved ✓\';setTimeout(()=>this.textContent=\'Save Note\',1500)" style="margin-top:4px;padding:2px 8px;font-size:11px;background:#2563EB;color:white;border:none;border-radius:3px;cursor:pointer;width:100%">Save Note</button>';
                        popupContent += '</div>';

                        // Invisible hit-area marker (large, transparent) for easier clicking
                        const hitMarker = L.circleMarker(item.coord, {
                            radius: itinHitRadius,
                            fillColor: 'transparent',
                            color: 'transparent',
                            weight: 0,
                            fillOpacity: 0,
                            interactive: true
                        });
                        hitMarker._baseHitRadius = itinHitRadius;
                        hitMarker.bindPopup(popupContent);
                        if (isMobile()) {
                            hitMarker.off('click');
                            hitMarker.on('click', function() {
                                const mobilePoi = { name: item.name, coord: item.coord, desc: poiInfo.desc, longDesc: poiInfo.longDesc, gmapsUrl: poiInfo.gmapsUrl, rating: poiInfo.rating, ratingCount: poiInfo.ratingCount, priceLevel: poiInfo.priceLevel, website: poiInfo.website, hours: poiInfo.hours, photoRef: poiInfo.photoRef, photoAttribution: poiInfo.photoAttribution, tags: poiInfo.tags };
                                showMobilePOIDetail(mobilePoi, formatType(item.type));
                            });
                        }
                        hitMarker.addTo(map);

                        // Visible marker (small, styled) — non-interactive, clicks pass through
                        const marker = L.circleMarker(item.coord, {
                            radius: itinBaseRadius,
                            fillColor: typeColors[item.type] || '#666',
                            color: '#fff',
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 0.85,
                            interactive: false
                        });
                        marker._baseRadius = itinBaseRadius;
                        marker.addTo(map);

                        // Desktop hover effect
                        if (!isMobile()) {
                            hitMarker.on('mouseover', function() { marker.setRadius(itinBaseRadius + 2); });
                            hitMarker.on('mouseout', function() { marker.setRadius(itinBaseRadius); });
                        }

                        itineraryMarkers.push({marker: marker, hitMarker: hitMarker, coord: item.coord, day: dayData.day, type: item.type, name: item.name});
                        markers.push({lat: item.coord[0], lng: item.coord[1]});
                    }
                });
            });

            // Create polylines for each day
            itin.days.forEach(dayData => {
                const dayCoords = [];
                dayData.items.forEach(item => {
                    if (item.coord && item.type !== 'nap') {
                        dayCoords.push(item.coord);
                    }
                });
                
                if (dayCoords.length > 1) {
                    const polyline = L.polyline(dayCoords, {
                        color: itin.color || '#666',
                        weight: 2,
                        opacity: 0.5,
                        dashArray: '5,3'
                    }).addTo(map);
                    itineraryPolylines.push({polyline: polyline, day: dayData.day});
                }
            });

            // Render days in sidebar
            renderDays(key);
            
            // Fit bounds to all markers (with padding for mobile sheet)
            if (markers.length > 0) {
                const bounds = L.latLngBounds(markers);
                map.fitBounds(bounds.pad(0.1), getMobileMapPadding());
            }

            // Set show all days button to active
            document.getElementById('showAllDaysBtn').classList.add('active');
            allDaysActive = true;

            // Reapply filter chips if active
            if (activeFilterChips.size > 0) {
                applyFilterChips();
            }
        }

        function showDay(key, dayNum) {
            currentDay = dayNum;
            currentDay = dayNum;
            allDaysActive = false;
            document.getElementById('showAllDaysBtn').classList.remove('active');
            
            // Hide all markers, show only this day's
            itineraryMarkers.forEach(m => {
                if (m.day === dayNum) {
                    m.marker.setStyle({opacity: 1, fillOpacity: 0.85});
                    if (m.hitMarker) m.hitMarker.setStyle({fillOpacity: 0, interactive: true});
                } else {
                    m.marker.setStyle({opacity: 0.2, fillOpacity: 0.2});
                    if (m.hitMarker) m.hitMarker.setStyle({fillOpacity: 0, interactive: false});
                }
            });

            // Hide all polylines, show only this day's
            itineraryPolylines.forEach(p => {
                if (p.day === dayNum) {
                    p.polyline.setStyle({opacity: 0.5});
                } else {
                    p.polyline.setStyle({opacity: 0.1});
                }
            });

            // Highlight active day card
            document.querySelectorAll('.day-card-header').forEach(header => {
                header.classList.remove('active');
            });
            document.getElementById(`day-header-${key}-${dayNum}`).classList.add('active');

            // Fit bounds to this day's markers (with padding for mobile sheet)
            const dayMarkers = itineraryMarkers.filter(m => m.day === dayNum);
            if (dayMarkers.length > 0) {
                const coords = dayMarkers.map(m => m.coord);
                const bounds = L.latLngBounds(coords);
                map.fitBounds(bounds.pad(0.2), getMobileMapPadding());
            }

            // Reapply filter chips if active
            if (activeFilterChips.size > 0) {
                applyFilterChips();
            }
        }

        function showAllDays() {
            currentDay = null;
            allDaysActive = true;
            currentDay = null; updateChatContext();
            document.getElementById('showAllDaysBtn').classList.add('active');
            
            // Show all markers
            itineraryMarkers.forEach(m => {
                m.marker.setStyle({opacity: 1, fillOpacity: 0.85});
                if (m.hitMarker) m.hitMarker.setStyle({fillOpacity: 0, interactive: true});
            });

            // Show all polylines
            itineraryPolylines.forEach(p => {
                p.polyline.setStyle({opacity: 0.5});
            });

            // Unhighlight day cards
            document.querySelectorAll('.day-card-header').forEach(header => {
                header.classList.remove('active');
            });

            // Fit bounds to all markers (with padding for mobile sheet)
            const allCoords = itineraryMarkers.map(m => m.coord);
            if (allCoords.length > 0) {
                const bounds = L.latLngBounds(allCoords);
                map.fitBounds(bounds.pad(0.1), getMobileMapPadding());
            }

            // Reapply filter chips if active
            if (activeFilterChips.size > 0) {
                applyFilterChips();
            }
        }

        function clearItineraryMarkers() {
            itineraryMarkers.forEach(m => {
                map.removeLayer(m.marker);
                if (m.hitMarker) map.removeLayer(m.hitMarker);
            });
            itineraryMarkers = [];

            itineraryPolylines.forEach(p => {
                map.removeLayer(p.polyline);
            });
            itineraryPolylines = [];
        }

        // ============================================
        // DAY RENDERING
        // ============================================

        function renderDays(key) {
            const itin = itineraryData[key];
            const container = document.getElementById('daysContainer');
            container.innerHTML = '';
            const isMultiDest = itin.isMultiDestination || false;
            let lastSegmentDest = null;

            itin.days.forEach(dayData => {
                // Multi-dest: insert segment header when destination changes
                if (isMultiDest && dayData.destination && dayData.destination !== lastSegmentDest) {
                    lastSegmentDest = dayData.destination;
                    const destEntry = manifestData ? manifestData.destinations.find(d => d.key === dayData.destination) : null;
                    const segHeader = document.createElement('div');
                    segHeader.style.cssText = 'padding:8px 12px;margin:8px 0 4px 0;background:linear-gradient(135deg,#f0fffe,#e8f8f5);border-radius:8px;font-weight:700;font-size:13px;color:#0d9488;border-left:3px solid #4ECDC4;';
                    segHeader.textContent = (destEntry ? destEntry.flag + ' ' : '') + (destEntry ? destEntry.name : dayData.destination);
                    // Add segment info if available
                    if (itin.segments) {
                        const seg = itin.segments.find(s => s.destination === dayData.destination);
                        if (seg) {
                            const info = document.createElement('span');
                            info.style.cssText = 'font-size:11px;font-weight:400;color:#6b7280;margin-left:8px;';
                            info.textContent = seg.days + ' days';
                            segHeader.appendChild(info);
                        }
                    }
                    container.appendChild(segHeader);
                }

                const dayCard = document.createElement('div');
                dayCard.className = 'day-card';

                const header = document.createElement('div');
                header.className = 'day-card-header';
                header.id = `day-header-${key}-${dayData.day}`;
                header.onclick = () => toggleDayCard(header, dayData.day, key);
                const hasMods = dayHasModifications(key, dayData.day);
                const resetBtn = hasMods ? '<button class="day-reset-btn" onclick="event.stopPropagation(); resetDay(\x27' + key + '\x27,' + dayData.day + ')">&#8635; Reset</button>' : '';
                if (hasMods) header.classList.add('modified');
                const cityName = extractCity(dayData.title);
                const browseBtn = '<button class="day-browse-btn" onclick="event.stopPropagation(); openCityBrowser(\x27' + key + '\x27,' + dayData.day + ')" title="Browse all activities in ' + escapeHtml(cityName) + '">&#x1F50D; Browse ' + escapeHtml(cityName) + '</button>';
                header.innerHTML = '<span>Day ' + dayData.day + ' — ' + escapeHtml(dayData.title) + '</span><div style="display:flex;gap:6px;align-items:center;">' + browseBtn + resetBtn + '<span class="day-card-toggle">▼</span></div>';

                const content = document.createElement('div');
                content.className = 'day-card-content';

                dayData.items.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = `day-item ${item.type}`;
                    if (item.coord) {
                        itemEl.classList.add('has-coord');
                        itemEl.onclick = () => panToMarker(item.coord[0], item.coord[1], item.name);
                    }
                    const swapIcon = (item.type !== 'nap' && item.coord) ? '<button class="day-item-swap" onclick="event.stopPropagation(); openSwapPanel(\x27' + key + '\x27,' + dayData.day + ',' + dayData.items.indexOf(item) + ')" title="Swap activity">&#x21c4;</button>' : '';
                    itemEl.innerHTML = '<span class="day-item-type">' + formatType(item.type) + '</span><span class="day-item-name">' + escapeHtml(item.name) + '</span>' + swapIcon;
                    content.appendChild(itemEl);
                });

                // Export bar (Phase 3)
                const exportBar = document.createElement('div');
                exportBar.className = 'day-export-bar';
                exportBar.innerHTML = '<button class="day-export-btn export-text" onclick="event.stopPropagation(); exportDayText(\x27' + key + '\x27,' + dayData.day + ')" title="Copy day schedule as text">\u{1F4CB} Copy</button>' +
                    '<button class="day-export-btn export-gmaps" onclick="event.stopPropagation(); exportDayGoogleMaps(\x27' + key + '\x27,' + dayData.day + ')" title="Open route in Google Maps">\u{1F5FA} Maps</button>' +
                    '<button class="day-export-btn export-qr" onclick="event.stopPropagation(); exportDayQR(\x27' + key + '\x27,' + dayData.day + ')" title="QR code for Google Maps route">\u{1F4F1} QR</button>';
                content.appendChild(exportBar);

                dayCard.appendChild(header);
                dayCard.appendChild(content);
                container.appendChild(dayCard);
            });
        }

        // ============================================
        // Phase 3: Export & Sharing Functions
        // ============================================
        function exportDayText(key, dayNum) {
            var itin = itineraryData[key];
            var dayData = itin.days.find(function(d) { return d.day === dayNum; });
            if (!dayData) return;

            var typeEmoji = {
                hotel: '\u{1F3E8}', breakfast: '\u{1F373}', lunch: '\u{1F35C}', dinner: '\u{1F357}',
                sightseeing: '\u{1F5FA}', optional: '\u2728', nap: '\u{1F634}'
            };

            var dest = destinations[activeDestination] || {};
            var text = (dest.flag || '\u{1F30D}') + ' ' + (dest.name || 'Trip') + '\n';
            text += itin.name + ' \u2014 Day ' + dayData.day + '\n';
            text += '\u{1F4CD} ' + dayData.title + '\n';
            text += '\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n';

            dayData.items.forEach(function(item) {
                var emoji = typeEmoji[item.type] || '\u{1F4CB}';
                text += emoji + ' ' + item.name + '\n';
            });

            text += '\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n';
            text += 'Generated from Japan Trip Map';

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(function() {
                    showCopyToast('Copied to clipboard!');
                }).catch(function() {
                    copyFallback(text);
                });
            } else {
                copyFallback(text);
            }
        }

        function copyFallback(text) {
            var ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.opacity = '0';
            document.body.appendChild(ta);
            ta.select();
            try { document.execCommand('copy'); } catch(e) {}
            document.body.removeChild(ta);
            showCopyToast('Copied to clipboard!');
        }

        function exportDayGoogleMaps(key, dayNum) {
            var itin = itineraryData[key];
            var dayData = itin.days.find(function(d) { return d.day === dayNum; });
            if (!dayData) return;

            var coords = dayData.items
                .filter(function(item) { return item.coord && item.type !== 'nap'; })
                .map(function(item) { return item.coord[0] + ',' + item.coord[1]; });

            if (coords.length === 0) {
                showCopyToast('No locations with coordinates');
                return;
            }

            var url;
            if (coords.length === 1) {
                url = 'https://www.google.com/maps/search/?api=1&query=' + coords[0];
            } else {
                url = 'https://www.google.com/maps/dir/' + coords.join('/');
            }

            window.open(url, '_blank');
        }

        function exportDayQR(key, dayNum) {
            var itin = itineraryData[key];
            var dayData = itin.days.find(function(d) { return d.day === dayNum; });
            if (!dayData) return;

            var coords = dayData.items
                .filter(function(item) { return item.coord && item.type !== 'nap'; })
                .map(function(item) { return item.coord[0] + ',' + item.coord[1]; });

            if (coords.length === 0) {
                showCopyToast('No locations with coordinates');
                return;
            }

            var mapsUrl;
            if (coords.length === 1) {
                mapsUrl = 'https://www.google.com/maps/search/?api=1&query=' + coords[0];
            } else {
                mapsUrl = 'https://www.google.com/maps/dir/' + coords.join('/');
            }

            var qrUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + encodeURIComponent(mapsUrl);

            document.getElementById('qrTitle').textContent = itin.name + ' \u2014 Day ' + dayData.day;
            document.getElementById('qrSubtitle').textContent = dayData.title;
            document.getElementById('qrImage').src = qrUrl;
            document.getElementById('qrLink').href = mapsUrl;
            document.getElementById('qrLink').textContent = 'Open in Google Maps \u2192';
            document.getElementById('qrOverlay').classList.add('active');
        }

        function closeQrModal() {
            document.getElementById('qrOverlay').classList.remove('active');
        }

        function showCopyToast(message) {
            var toast = document.getElementById('copyToast');
            toast.textContent = message || 'Copied!';
            toast.classList.add('show');
            setTimeout(function() { toast.classList.remove('show'); }, 2000);
        }

        // ============================================
        // TRIP SHARING
        // ============================================

        // Unicode-safe base64 helpers
        function utoa(str) { return btoa(unescape(encodeURIComponent(str))); }
        function atou(b64) { return decodeURIComponent(escape(atob(b64))); }

        function openShareModal() {
            if (!currentItinerary) {
                showCopyToast('Select an itinerary first');
                return;
            }
            const itin = itineraryData[currentItinerary];
            if (!itin) return;

            // Build share link
            const shareUrl = buildShareUrl(activeDestination, currentItinerary, itin);
            document.getElementById('shareLinkBox').textContent = shareUrl;
            document.getElementById('shareTitle').textContent = 'Share Itinerary';

            // Build subtitle — multi-dest shows all countries
            if (itin.isMultiDestination && itin.segments) {
                const countryNames = itin.segments.map(function(seg) {
                    const d = destinations[seg.destination] || {};
                    const entry = (manifestData && manifestData.destinations || []).find(dd => dd.key === seg.destination);
                    return (entry ? entry.flag + ' ' : '') + (d.name || seg.destination);
                });
                document.getElementById('shareSubtitle').textContent = '🌍 ' + countryNames.join(' → ') + ' — ' + (itin.name || 'Multi-Destination Trip');
            } else {
                const dest = destinations[activeDestination] || {};
                const destEntry = (manifestData && manifestData.destinations || []).find(d => d.key === activeDestination) || {};
                document.getElementById('shareSubtitle').textContent = (destEntry.flag || '') + ' ' + (dest.name || activeDestination) + ' — ' + (itin.name || itin.title || currentItinerary);
            }
            document.getElementById('shareOverlay').classList.add('active');
        }

        function closeShareModal() {
            document.getElementById('shareOverlay').classList.remove('active');
        }

        function buildShareUrl(destKey, itinKey, itin) {
            const base = window.location.origin + window.location.pathname;
            if (itin.isGenerated) {
                // Generated itineraries: encode the full data in hash
                const minimal = {
                    n: itin.name || 'Custom',
                    c: itin.color || '#2563EB',
                    d: itin.days.map(function(day) {
                        var dayObj = {
                            dy: day.day,
                            t: day.title,
                            i: day.items.map(function(it) {
                                var o = { n: it.name, tp: it.type };
                                if (it.coord) o.co = [Math.round(it.coord[0]*10000)/10000, Math.round(it.coord[1]*10000)/10000];
                                return o;
                            })
                        };
                        // Include destination field for multi-dest
                        if (day.destination) dayObj.ds = day.destination;
                        return dayObj;
                    })
                };
                // Include multi-dest metadata
                if (itin.isMultiDestination) {
                    minimal.md = true;
                    if (itin.segments) {
                        minimal.sg = itin.segments.map(function(s) { return { d: s.destination, n: s.days }; });
                    }
                }
                return base + '#trip=' + destKey + '/' + itinKey + '&d=' + utoa(JSON.stringify(minimal));
            } else {
                // Built-in itineraries: just the key (receiver loads from JSON)
                return base + '#trip=' + destKey + '/' + itinKey;
            }
        }

        function copyShareLink() {
            const link = document.getElementById('shareLinkBox').textContent;
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(link).then(function() {
                    showCopyToast('Link copied!');
                }).catch(function() {
                    copyFallback(link);
                });
            } else {
                copyFallback(link);
            }
        }

        function copyFullItineraryText() {
            const key = currentItinerary;
            if (!key) return;
            const itin = itineraryData[key];
            if (!itin) return;
            const isMultiDest = itin.isMultiDestination;

            var typeEmoji = {
                hotel: '\u{1F3E8}', breakfast: '\u{1F373}', lunch: '\u{1F35C}', dinner: '\u{1F357}',
                sightseeing: '\u{1F5FA}', optional: '\u2728', nap: '\u{1F634}', info: '\u{2139}\u{FE0F}'
            };

            var text = '';
            if (isMultiDest && itin.segments) {
                // Multi-destination header with route
                var routeNames = itin.segments.map(function(seg) {
                    var d = destinations[seg.destination] || {};
                    var entry = (manifestData && manifestData.destinations || []).find(dd => dd.key === seg.destination);
                    return (entry ? entry.flag + ' ' : '') + (d.name || seg.destination) + ' (' + seg.days + 'd)';
                });
                text += '\u{1F30D} ' + (itin.name || 'Multi-Destination Trip') + '\n';
                text += routeNames.join(' \u2192 ') + '\n';
            } else {
                var dest = destinations[activeDestination] || {};
                var destEntry = (manifestData && manifestData.destinations || []).find(d => d.key === activeDestination) || {};
                text += (destEntry.flag || '\u{1F30D}') + ' ' + (dest.name || activeDestination) + '\n';
                text += (itin.name || itin.title || key) + '\n';
            }
            text += '\u2550'.repeat(30) + '\n\n';

            var prevDayDest = null;
            itin.days.forEach(function(dayData) {
                // Insert destination header for multi-dest
                if (isMultiDest && dayData.destination && dayData.destination !== prevDayDest) {
                    prevDayDest = dayData.destination;
                    var dd = destinations[dayData.destination] || {};
                    var de = (manifestData && manifestData.destinations || []).find(function(d) { return d.key === dayData.destination; });
                    text += '\n' + (de ? de.flag + ' ' : '') + (dd.name || dayData.destination).toUpperCase() + '\n';
                    text += '\u2500'.repeat(30) + '\n';
                }

                text += '\u{1F4CD} Day ' + dayData.day + ' \u2014 ' + dayData.title + '\n';
                text += '\u2500'.repeat(30) + '\n';
                dayData.items.forEach(function(item) {
                    var emoji = typeEmoji[item.type] || '\u{1F4CB}';
                    var poiInfo = isMultiDest && dayData.destination ? lookupPoiInDest(item.name, dayData.destination) : lookupPoi(item.name);
                    text += emoji + ' ' + item.name;
                    if (poiInfo.desc) text += '\n   ' + poiInfo.desc;
                    text += '\n';
                });
                text += '\n';
            });

            text += '\u2550'.repeat(30) + '\n';
            if (isMultiDest) {
                text += 'Shared from Travel Map\n';
            } else {
                var dest2 = destinations[activeDestination] || {};
                text += 'Shared from ' + (dest2.name || 'Travel Map') + '\n';
            }
            text += window.location.origin + window.location.pathname;

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(function() {
                    showCopyToast('Itinerary copied as text!');
                    closeShareModal();
                }).catch(function() {
                    copyFallback(text);
                    closeShareModal();
                });
            } else {
                copyFallback(text);
                closeShareModal();
            }
        }

        function printItinerary() {
            const key = currentItinerary;
            if (!key) return;
            const itin = itineraryData[key];
            if (!itin) return;
            const dest = destinations[activeDestination] || {};
            const destEntry = (manifestData && manifestData.destinations || []).find(d => d.key === activeDestination) || {};

            var html = '<!DOCTYPE html><html><head><meta charset="utf-8">';
            html += '<title>' + (dest.name || 'Trip') + ' \u2014 ' + (itin.name || key) + '</title>';
            html += '<style>';
            html += 'body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;max-width:700px;margin:0 auto;padding:30px 20px;color:#1e293b;line-height:1.5;}';
            html += 'h1{font-size:22px;margin:0 0 2px;}';
            html += 'h2{font-size:16px;color:#475569;font-weight:500;margin:0 0 20px;}';
            html += '.day{margin-bottom:24px;page-break-inside:avoid;}';
            html += '.day-title{font-size:15px;font-weight:700;color:#1e40af;border-bottom:2px solid #dbeafe;padding-bottom:4px;margin-bottom:10px;}';
            html += '.item{display:flex;gap:10px;padding:5px 0;border-bottom:1px solid #f1f5f9;}';
            html += '.item-type{font-size:11px;color:#64748b;min-width:70px;text-transform:uppercase;font-weight:600;}';
            html += '.item-name{font-size:13px;font-weight:600;}';
            html += '.item-desc{font-size:11px;color:#64748b;margin-top:1px;}';
            html += '.item-rating{font-size:11px;color:#f59e0b;}';
            html += '.footer{margin-top:30px;padding-top:16px;border-top:2px solid #e2e8f0;font-size:11px;color:#94a3b8;text-align:center;}';
            html += '.hotels-summary{margin-top:24px;padding:16px;background:#f8fafc;border-radius:8px;border:1px solid #e2e8f0;}';
            html += '.hotels-summary h3{font-size:14px;margin:0 0 8px;}';
            html += '.hotel-item{font-size:12px;margin:4px 0;}';
            html += '.hotel-item a{color:#2563EB;text-decoration:none;}';
            html += '@media print{body{padding:10px;}}';
            html += '</style></head><body>';

            html += '<h1>' + (destEntry.flag || '') + ' ' + (dest.name || 'Trip') + '</h1>';
            html += '<h2>' + (itin.name || itin.title || key) + ' \u2014 ' + itin.days.length + ' days</h2>';

            // Collect hotels for summary
            var hotelSet = {};

            itin.days.forEach(function(dayData) {
                html += '<div class="day">';
                html += '<div class="day-title">Day ' + dayData.day + ' \u2014 ' + escapeHtml(dayData.title) + '</div>';
                dayData.items.forEach(function(item) {
                    var poiInfo = lookupPoi(item.name);
                    html += '<div class="item">';
                    html += '<div class="item-type">' + escapeHtml(formatType(item.type)) + '</div>';
                    html += '<div><div class="item-name">' + escapeHtml(item.name);
                    if (poiInfo.rating) html += ' <span class="item-rating">\u2605 ' + poiInfo.rating + '</span>';
                    html += '</div>';
                    if (poiInfo.desc) html += '<div class="item-desc">' + escapeHtml(poiInfo.desc) + '</div>';
                    html += '</div></div>';

                    if (item.type === 'hotel') {
                        hotelSet[item.name] = poiInfo;
                    }
                });
                html += '</div>';
            });

            // Hotels summary
            var hotelNames = Object.keys(hotelSet);
            if (hotelNames.length > 0) {
                html += '<div class="hotels-summary"><h3>\u{1F3E8} Accommodation Summary</h3>';
                hotelNames.forEach(function(name) {
                    var info = hotelSet[name];
                    html += '<div class="hotel-item"><strong>' + escapeHtml(name) + '</strong>';
                    if (info.website) html += ' \u2014 <a href="' + escapeHtml(info.website) + '" target="_blank">' + escapeHtml(info.website.replace(/^https?:\/\/(www\.)?/, '').split('/')[0]) + '</a>';
                    if (info.desc) html += '<br><span style="color:#64748b;">' + escapeHtml(info.desc) + '</span>';
                    html += '</div>';
                });
                html += '</div>';
            }

            html += '<div class="footer">Generated from ' + escapeHtml(dest.name || 'Travel Map') + '<br>';
            html += window.location.origin + window.location.pathname + '</div>';
            html += '</body></html>';

            var win = window.open('', '_blank');
            win.document.write(html);
            win.document.close();
            closeShareModal();
            setTimeout(function() { win.print(); }, 500);
        }

        function dismissSharedBanner() {
            document.getElementById('sharedBanner').classList.remove('active');
        }

        // Load shared itinerary from URL hash on startup
        async function loadSharedTrip() {
            var hash = window.location.hash;
            if (!hash || !hash.startsWith('#trip=')) return false;

            var tripPart = hash.substring(6); // after '#trip='
            var dataPart = null;
            var ampIdx = tripPart.indexOf('&d=');
            if (ampIdx > -1) {
                dataPart = tripPart.substring(ampIdx + 3);
                tripPart = tripPart.substring(0, ampIdx);
            }

            var parts = tripPart.split('/');
            if (parts.length < 2) return false;
            var destKey = parts[0];
            var itinKey = parts[1];

            // Load the destination
            await fetchAndLoadDestination(destKey);

            // Set dropdown
            var sel = document.getElementById('destSelect');
            if (sel) sel.value = destKey;

            // For generated itineraries with embedded data
            if (dataPart && itinKey.startsWith('gen_')) {
                try {
                    var decoded = JSON.parse(atou(dataPart));
                    var restoredItin = {
                        name: decoded.n || 'Shared Itinerary',
                        color: decoded.c || '#2563EB',
                        isGenerated: true,
                        days: decoded.d.map(function(day) {
                            var dayObj = {
                                day: day.dy,
                                title: day.t,
                                items: day.i.map(function(it) {
                                    var item = { name: it.n, type: it.tp };
                                    if (it.co) item.coord = it.co;
                                    return item;
                                })
                            };
                            // Restore destination field for multi-dest
                            if (day.ds) dayObj.destination = day.ds;
                            return dayObj;
                        })
                    };
                    // Restore multi-dest metadata
                    if (decoded.md) {
                        restoredItin.isMultiDestination = true;
                        if (decoded.sg) {
                            restoredItin.segments = decoded.sg.map(function(s) { return { destination: s.d, days: s.n }; });
                        }
                        // Load all segment destinations for proper rendering
                        if (restoredItin.segments) {
                            for (var si = 0; si < restoredItin.segments.length; si++) {
                                var segDest = restoredItin.segments[si].destination;
                                if (segDest !== destKey && !destinations[segDest]) {
                                    await fetchAndLoadDestination(segDest);
                                }
                            }
                            // Re-load the original dest so it's active
                            if (activeDestination !== destKey) {
                                await fetchAndLoadDestination(destKey);
                            }
                        }
                    }
                    // Add to itineraryData as a shared itinerary
                    var sharedKey = 'shared_1';
                    itineraryData[sharedKey] = restoredItin;
                    buildTabsUI();
                    itinKey = sharedKey;
                } catch(e) {
                    console.error('Failed to decode shared itinerary:', e);
                    return false;
                }
            }

            // Switch to itinerary view and select the itinerary
            if (itineraryData[itinKey]) {
                switchView('itineraries');
                selectItinerary(itinKey);

                // Show shared banner
                var dest = destinations[destKey] || {};
                var itin = itineraryData[itinKey] || {};
                document.getElementById('sharedBannerText').textContent = '\u{1F517} Shared: ' + (itin.name || itinKey);
                document.getElementById('sharedBanner').classList.add('active');

                return true;
            }
            return false;
        }

        function toggleDayCard(header, dayNum, key) {
            const content = header.nextElementSibling;
            content.classList.toggle('open');
            header.classList.toggle('active');
            header.querySelector('.day-card-toggle').classList.toggle('open');

            if (content.classList.contains('open')) {
                showDay(key, dayNum);
                updateChatContext();
            } else if (allDaysActive) {
                showAllDays();
            }
        }

        // ============================================
        // HOW TO ADD A NEW DESTINATION
        // ============================================
        //
        // 1. Create POI arrays (copy this template, replace COUNTRY with your destination key):
        //
        //    const hotels_COUNTRY = [
        //        {"name": "Hotel Name", "coord": [LAT, LNG], "desc": "Short description"},
        //    ];
        //    const restaurants_COUNTRY = [ /* same format */ ];
        //    const experiences_COUNTRY = [ /* same format */ ];
        //    const kidFriendly_COUNTRY = [ /* same format */ ];
        //    const markets_COUNTRY = [ /* same format */ ];
        //
        // 2. Create city centers (for the City Activity Browser):
        //
        //    const cityCenters_COUNTRY = {
        //        'City Name': [LAT, LNG, RADIUS],  // radius ~0.15 for large cities
        //    };
        //
        // 3. Create itineraries (use keys "a", "b", "c" etc.):
        //    Supported types: hotel, breakfast, lunch, dinner, sightseeing, optional, nap
        //
        //    const itineraryData_COUNTRY = {
        //        "a": {
        //            "name": "Itinerary Display Name",
        //            "color": "#2563EB",
        //            "days": [
        //                {"day": 1, "title": "Day Title", "items": [
        //                    {"type": "hotel", "name": "Hotel", "coord": [LAT, LNG]},
        //                    {"type": "sightseeing", "name": "Activity", "coord": [LAT, LNG]},
        //                    {"type": "lunch", "name": "Restaurant", "coord": [LAT, LNG]},
        //                    {"type": "dinner", "name": "Restaurant", "coord": [LAT, LNG]}
        //                ]}
        //            ]
        //        }
        //    };
        //    let originalItineraryData_COUNTRY = JSON.parse(JSON.stringify(itineraryData_COUNTRY));
        //
        // 4. Register the destination:
        //
        //    destinations['country'] = {
        //        name: 'Country Family Adventure',
        //        subtitle: 'Interactive Trip Map',
        //        flag: '\u{1F1XX}\u{1F1XX}',
        //        defaultCenter: [LAT, LNG],
        //        defaultZoom: 6,
        //        hotels: hotels_COUNTRY,
        //        restaurants: restaurants_COUNTRY,
        //        experiences: experiences_COUNTRY,
        //        kidFriendly: kidFriendly_COUNTRY,
        //        markets: markets_COUNTRY,
        //        itineraryData: itineraryData_COUNTRY,
        //        cityCenters: cityCenters_COUNTRY,
        //        originalItineraryData: originalItineraryData_COUNTRY
        //    };
        //
        // That's it! The dropdown, map, and all features work automatically.
        // ============================================

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        function panToMarker(lat, lng, name) {
            // On mobile, hide any open sheets and show POI on map
            if (isMobile()) {
                hideAllMobileSheets();
                mobileActiveTab = 'map';
                document.querySelectorAll('.mobile-tab').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tab === 'map');
                });
                const mapControls = document.getElementById('mobileMapControls');
                if (mapControls) mapControls.style.display = '';

                setTimeout(() => {
                    map.invalidateSize();
                    map.flyTo([lat, lng], 16, { duration: 0.5 });
                    // Show POI detail sheet
                    setTimeout(() => {
                        // Try to find a matching itinerary marker
                        const m = itineraryMarkers.find(m => Math.abs(m.marker.getLatLng().lat - lat) < 0.0001 && Math.abs(m.marker.getLatLng().lng - lng) < 0.0001);
                        if (m) {
                            const poiInfo = lookupPoi(m.name);
                            showMobilePOIDetail({ name: m.name, coord: [lat, lng], desc: poiInfo.desc, longDesc: poiInfo.longDesc, gmapsUrl: poiInfo.gmapsUrl, rating: poiInfo.rating, ratingCount: poiInfo.ratingCount, priceLevel: poiInfo.priceLevel, website: poiInfo.website, hours: poiInfo.hours, photoRef: poiInfo.photoRef, photoAttribution: poiInfo.photoAttribution, tags: poiInfo.tags }, formatType(m.type));
                        } else if (name) {
                            // Try to find by name in POI arrays
                            mobileItinItemTap(name);
                        }
                    }, 350);
                }, 100);
                return;
            }

            map.flyTo([lat, lng], 14, { duration: 1 });

            // Find and open popup (desktop)
            itineraryMarkers.forEach(m => {
                if (Math.abs(m.marker.getLatLng().lat - lat) < 0.0001 && Math.abs(m.marker.getLatLng().lng - lng) < 0.0001) {
                    setTimeout(() => m.marker.openPopup(), 500);
                }
            });
        }

        function formatType(type) {
            const typeMap = {
                'breakfast': 'Breakfast',
                'lunch': 'Lunch',
                'dinner': 'Dinner',
                'sightseeing': 'Sightseeing',
                'hotel': 'Hotel',
                'nap': 'Nap',
                'optional': 'Optional'
            };
            return typeMap[type] || type;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // ============================================
        // NOTES STORAGE FUNCTIONS
        // ============================================

        // ============================================
        // MULTI-USER & NOTES SYSTEM
        // ============================================

        let currentUser = 'default';
        (function() {
            try {
                const params = new URLSearchParams(window.location.search);
                currentUser = params.get('user') || 'default';
            } catch(e) {}
        })();

        function getNoteKey(destKey, poiName) {
            return 'tripMap_notes_' + currentUser + '_' + destKey + '_' + poiName.replace(/[^a-zA-Z0-9]/g, '_');
        }

        function getNote(destKey, poiName) {
            // Check new namespaced key first, fall back to legacy key
            const val = localStorage.getItem(getNoteKey(destKey, poiName));
            if (val) return val;
            // Legacy migration: check old key format (no user prefix)
            const legacyKey = 'tripMap_notes_' + destKey + '_' + poiName.replace(/[^a-zA-Z0-9]/g, '_');
            const legacyVal = localStorage.getItem(legacyKey);
            if (legacyVal && currentUser === 'default') {
                // Migrate to new key
                localStorage.setItem(getNoteKey(destKey, poiName), legacyVal);
                localStorage.removeItem(legacyKey);
                return legacyVal;
            }
            return '';
        }

        function setNote(destKey, poiName, text) {
            const key = getNoteKey(destKey, poiName);
            if (text.trim()) {
                localStorage.setItem(key, text.trim());
            } else {
                localStorage.removeItem(key);
            }
            updateNoteIndicators();
        }

        function getAllNotes(destKey) {
            const notes = [];
            const prefix = 'tripMap_notes_' + currentUser + '_' + destKey + '_';
            const legacyPrefix = 'tripMap_notes_' + destKey + '_';
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(prefix)) {
                    const poiName = key.replace(prefix, '').replace(/_/g, ' ');
                    notes.push({ poiName, text: localStorage.getItem(key) });
                } else if (currentUser === 'default' && key.startsWith(legacyPrefix) && !key.startsWith('tripMap_notes_default_')) {
                    // Legacy notes (no user prefix) — only show for default user
                    const poiPart = key.replace(legacyPrefix, '');
                    // Ensure this isn't actually a user-prefixed key
                    if (!poiPart.includes('tripMap_')) {
                        const poiName = poiPart.replace(/_/g, ' ');
                        notes.push({ poiName, text: localStorage.getItem(key) });
                    }
                }
            }
            return notes;
        }

        function updateNoteIndicators() {
            if (activeDestination) {
                const sidebar = document.getElementById('sidebarContent');
                if (sidebar) {
                    const items = sidebar.querySelectorAll('[data-poi-name]');
                    items.forEach(item => {
                        const poiName = item.getAttribute('data-poi-name');
                        const hasNote = getNote(activeDestination, poiName);
                        const hasAnnotation = getAnnotationsForPoi(activeDestination, poiName).length > 0;
                        const noteIcon = item.querySelector('.note-indicator');
                        if (hasNote || hasAnnotation) {
                            if (!noteIcon) {
                                const icon = document.createElement('span');
                                icon.className = 'note-indicator';
                                icon.textContent = hasAnnotation ? ' 🔖' : ' 📝';
                                icon.title = hasAnnotation ? 'Has booking' : 'Has notes';
                                item.appendChild(icon);
                            } else {
                                noteIcon.textContent = hasAnnotation ? ' 🔖' : ' 📝';
                            }
                        } else {
                            if (noteIcon) noteIcon.remove();
                        }
                    });
                }
            }
        }

        function showNotesPanel() {
            const notes = getAllNotes(activeDestination);
            let html = '<div style="padding:16px"><h3 style="margin:0 0 12px;font-size:16px;">📝 My Notes';
            const destInfo = destinations[activeDestination];
            if (destInfo) html += ' — ' + escapeHtml(destInfo.name || activeDestination);
            html += '</h3>';
            if (currentUser !== 'default') html += '<div class="user-indicator">Viewing as: ' + escapeHtml(currentUser) + '</div>';
            if (notes.length === 0) {
                html += '<p style="color:#9ca3af;font-size:14px;margin:0;">No notes yet. Click on any place to add a note.</p>';
            } else {
                notes.forEach(n => {
                    html += '<div style="margin-bottom:12px;padding:8px;background:#f9fafb;border-radius:6px;border:1px solid #e5e7eb">';
                    html += '<div style="font-weight:600;font-size:13px;color:#333;margin-bottom:4px;">' + escapeHtml(n.poiName) + '</div>';
                    html += '<div style="font-size:12px;color:#6b7280;margin:4px 0;white-space:pre-wrap;line-height:1.4;">' + escapeHtml(n.text) + '</div>';
                    html += '</div>';
                });
            }
            // Import/export buttons
            html += '<div style="margin-top:16px;border-top:1px solid #e5e7eb;padding-top:12px;display:flex;gap:8px;">';
            html += '<button onclick="exportNotesAndAnnotations()" style="flex:1;padding:6px 10px;font-size:11px;font-weight:600;background:#2563EB;color:white;border:none;border-radius:6px;cursor:pointer;">Export All</button>';
            html += '<button onclick="document.getElementById(\'importFileInput\').click()" style="flex:1;padding:6px 10px;font-size:11px;font-weight:600;background:white;color:#2563EB;border:1.5px solid #2563EB;border-radius:6px;cursor:pointer;">Import</button>';
            html += '<input type="file" id="importFileInput" accept=".json" style="display:none" onchange="importNotesAndAnnotations(this.files[0])">';
            html += '</div>';
            html += '</div>';
            const panel = document.getElementById('notesPanel');
            const overlay = document.getElementById('notesPanelOverlay');
            if (panel) { panel.innerHTML = html; panel.style.display = 'flex'; }
            if (overlay) { overlay.style.display = 'block'; }
        }

        function closeNotesPanel() {
            const panel = document.getElementById('notesPanel');
            const overlay = document.getElementById('notesPanelOverlay');
            if (panel) panel.style.display = 'none';
            if (overlay) overlay.style.display = 'none';
        }

        // ============================================
        // PERSONAL ANNOTATIONS SYSTEM
        // ============================================

        let personalAnnotations = {};  // destKey → array (from personal.json)
        let browserAnnotations = {};   // destKey → array (from localStorage)

        async function loadPersonalAnnotations(destKey) {
            try {
                const resp = await fetch('personal/' + destKey + '.json');
                if (resp.ok) {
                    const data = await resp.json();
                    personalAnnotations[destKey] = data.annotations || [];
                    return personalAnnotations[destKey];
                }
            } catch(e) {}
            personalAnnotations[destKey] = [];
            return [];
        }

        function loadBrowserAnnotations(destKey) {
            try {
                const raw = localStorage.getItem('tripMap_annotations_' + currentUser + '_' + destKey);
                if (raw) {
                    browserAnnotations[destKey] = JSON.parse(raw);
                    return browserAnnotations[destKey];
                }
            } catch(e) {}
            browserAnnotations[destKey] = [];
            return [];
        }

        function saveBrowserAnnotations(destKey) {
            try {
                const arr = browserAnnotations[destKey] || [];
                if (arr.length > 0) {
                    localStorage.setItem('tripMap_annotations_' + currentUser + '_' + destKey, JSON.stringify(arr));
                } else {
                    localStorage.removeItem('tripMap_annotations_' + currentUser + '_' + destKey);
                }
            } catch(e) {}
        }

        function getAllAnnotations(destKey) {
            const staticAnns = personalAnnotations[destKey] || [];
            const browserAnns = browserAnnotations[destKey] || [];
            return staticAnns.concat(browserAnns).sort((a, b) => {
                if (!a.date) return 1;
                if (!b.date) return -1;
                return a.date.localeCompare(b.date);
            });
        }

        function getAnnotationsForPoi(destKey, poiName) {
            return getAllAnnotations(destKey).filter(a => a.poiName === poiName);
        }

        function formatAnnotationDate(dateStr) {
            if (!dateStr) return '';
            try {
                const d = new Date(dateStr + (dateStr.includes('T') ? '' : 'T00:00:00'));
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            } catch(e) { return dateStr; }
        }

        function getAnnotationTypeIcon(type, subtype) {
            if (type === 'reservation') {
                if (subtype === 'hotel') return '🏨';
                if (subtype === 'restaurant') return '🍽️';
                if (subtype === 'activity') return '🎟️';
                return '📋';
            }
            if (type === 'ticket') return '🎫';
            return '📌';
        }

        function buildAnnotationHtml(annotations) {
            if (!annotations || annotations.length === 0) return '';
            let html = '<div style="margin-top:8px;border-top:1px solid #e5e7eb;padding-top:8px">';
            html += '<div style="font-size:11px;font-weight:600;color:#92400e;margin-bottom:4px">🔖 Bookings</div>';
            annotations.forEach(ann => {
                const icon = getAnnotationTypeIcon(ann.type, ann.subtype);
                const dateStr = formatAnnotationDate(ann.date);
                const endDateStr = ann.endDate ? ' → ' + formatAnnotationDate(ann.endDate) : '';
                const statusClass = (ann.status || 'confirmed').toLowerCase();
                html += '<div class="annotation-card">';
                html += '<div class="annotation-card-header">';
                html += '<span>' + icon + ' ' + escapeHtml(ann.subtype || ann.type || '') + '</span>';
                html += '<span class="annotation-status ' + statusClass + '">' + escapeHtml(ann.status || 'confirmed') + '</span>';
                html += '</div>';
                if (dateStr) html += '<div style="font-size:10px;color:#b45309;margin-bottom:2px">' + dateStr + endDateStr + '</div>';
                if (ann.details) html += '<div class="annotation-card-details">' + escapeHtml(ann.details) + '</div>';
                if (ann.source === 'browser') {
                    html += '<button onclick="deleteBrowserAnnotation(\'' + (activeDestination || 'default') + '\',\'' + (ann.id || '').replace(/'/g, "\\'") + '\')" style="margin-top:4px;padding:1px 6px;font-size:9px;background:none;color:#dc2626;border:1px solid #fecaca;border-radius:3px;cursor:pointer;">Remove</button>';
                }
                html += '</div>';
            });
            html += '</div>';
            return html;
        }

        function buildAnnotationFormHtml(destKey, poiName) {
            const safePoi = poiName.replace(/'/g, "\\'");
            const safeDest = (destKey || 'default').replace(/'/g, "\\'");
            let html = '<div style="margin-top:6px">';
            html += '<button onclick="this.style.display=\'none\';this.nextElementSibling.style.display=\'block\'" style="padding:3px 8px;font-size:10px;font-weight:600;background:#fffbeb;color:#92400e;border:1px solid #fde68a;border-radius:4px;cursor:pointer;width:100%">+ Add Booking</button>';
            html += '<div class="annotation-form" style="display:none">';
            html += '<label>Type</label><select id="annFormType_' + safePoi.replace(/[^a-zA-Z0-9]/g, '_') + '"><option value="reservation">Reservation</option><option value="ticket">Ticket</option><option value="note">Note</option></select>';
            html += '<label>Subtype</label><select id="annFormSubtype_' + safePoi.replace(/[^a-zA-Z0-9]/g, '_') + '"><option value="restaurant">Restaurant</option><option value="hotel">Hotel</option><option value="activity">Activity</option><option value="museum">Museum</option><option value="tour">Tour</option><option value="show">Show</option></select>';
            html += '<label>Date</label><input type="date" id="annFormDate_' + safePoi.replace(/[^a-zA-Z0-9]/g, '_') + '">';
            html += '<label>End Date (hotels)</label><input type="date" id="annFormEndDate_' + safePoi.replace(/[^a-zA-Z0-9]/g, '_') + '">';
            html += '<label>Details</label><input type="text" id="annFormDetails_' + safePoi.replace(/[^a-zA-Z0-9]/g, '_') + '" placeholder="Confirmation #, party size, notes...">';
            html += '<label>Status</label><select id="annFormStatus_' + safePoi.replace(/[^a-zA-Z0-9]/g, '_') + '"><option value="confirmed">Confirmed</option><option value="pending">Pending</option></select>';
            html += '<button onclick="saveBrowserAnnotationFromForm(\'' + safeDest + '\',\'' + safePoi + '\')" style="margin-top:8px;padding:4px 10px;font-size:11px;font-weight:600;background:#f59e0b;color:white;border:none;border-radius:4px;cursor:pointer;width:100%">Save Booking</button>';
            html += '</div></div>';
            return html;
        }

        function saveBrowserAnnotationFromForm(destKey, poiName) {
            const safeId = poiName.replace(/[^a-zA-Z0-9]/g, '_');
            const type = document.getElementById('annFormType_' + safeId).value;
            const subtype = document.getElementById('annFormSubtype_' + safeId).value;
            const date = document.getElementById('annFormDate_' + safeId).value;
            const endDate = document.getElementById('annFormEndDate_' + safeId).value;
            const details = document.getElementById('annFormDetails_' + safeId).value;
            const status = document.getElementById('annFormStatus_' + safeId).value;
            if (!details && !date) { showCopyToast('Please add a date or details'); return; }
            const ann = {
                id: destKey + '_' + safeId + '_' + Date.now(),
                poiName: poiName,
                type: type,
                subtype: subtype,
                status: status,
                date: date || null,
                endDate: endDate || null,
                details: details,
                addedBy: currentUser,
                source: 'browser'
            };
            if (!browserAnnotations[destKey]) browserAnnotations[destKey] = [];
            browserAnnotations[destKey].push(ann);
            saveBrowserAnnotations(destKey);
            showCopyToast('Booking saved!');
            updateNoteIndicators();
            updateBookingsBadge();
        }

        function deleteBrowserAnnotation(destKey, annId) {
            if (!confirm('Remove this booking?')) return;
            if (browserAnnotations[destKey]) {
                browserAnnotations[destKey] = browserAnnotations[destKey].filter(a => a.id !== annId);
                saveBrowserAnnotations(destKey);
                updateNoteIndicators();
                updateBookingsBadge();
                showCopyToast('Booking removed');
            }
        }

        // Bookings panel
        function updateBookingsBadge() {
            const btn = document.getElementById('bookingsBtn');
            if (!btn) return;
            const count = getAllAnnotations(activeDestination).length;
            const badge = btn.querySelector('.bookings-count-badge');
            if (count > 0) {
                if (badge) { badge.textContent = count; }
                else { btn.innerHTML = '🔖 Bookings <span class="bookings-count-badge">' + count + '</span>'; }
            } else {
                if (badge) badge.remove();
            }
        }

        function showBookingsPanel() {
            const allAnns = getAllAnnotations(activeDestination);
            const now = new Date().toISOString().split('T')[0];
            let html = '<div style="padding:16px">';
            html += '<h3 style="margin:0 0 8px;font-size:16px;">🔖 Bookings';
            const destInfo = destinations[activeDestination];
            if (destInfo) html += ' — ' + escapeHtml(destInfo.name || activeDestination);
            html += '</h3>';
            if (currentUser !== 'default') html += '<div class="user-indicator">Viewing as: ' + escapeHtml(currentUser) + '</div>';
            if (allAnns.length === 0) {
                html += '<p style="color:#9ca3af;font-size:14px;margin:0;">No bookings yet. Click on any place and use "Add Booking" to add one, or ask Claude to build a personal.json file from your confirmations.</p>';
            } else {
                // Split into upcoming and past
                const upcoming = allAnns.filter(a => !a.date || a.date >= now);
                const past = allAnns.filter(a => a.date && a.date < now);
                if (upcoming.length > 0) {
                    html += '<div style="font-size:12px;font-weight:600;color:#6b7280;margin:12px 0 6px;text-transform:uppercase;letter-spacing:0.5px;">Upcoming</div>';
                    upcoming.forEach(ann => { html += buildBookingItemHtml(ann); });
                }
                if (past.length > 0) {
                    html += '<div style="font-size:12px;font-weight:600;color:#6b7280;margin:12px 0 6px;text-transform:uppercase;letter-spacing:0.5px;">Past</div>';
                    past.forEach(ann => { html += buildBookingItemHtml(ann); });
                }
            }
            html += '</div>';
            const panel = document.getElementById('bookingsPanel');
            const overlay = document.getElementById('bookingsPanelOverlay');
            if (panel) { panel.innerHTML = html; panel.style.display = 'flex'; }
            if (overlay) { overlay.style.display = 'block'; }
        }

        function buildBookingItemHtml(ann) {
            const icon = getAnnotationTypeIcon(ann.type, ann.subtype);
            const dateStr = formatAnnotationDate(ann.date);
            const endDateStr = ann.endDate ? ' → ' + formatAnnotationDate(ann.endDate) : '';
            const statusClass = (ann.status || 'confirmed').toLowerCase();
            // Find POI coords for map centering
            const poiInfo = poiLookup[ann.poiName];
            let clickAction = '';
            if (ann.poiName && poiInfo) {
                clickAction = 'closeBookingsPanel()';
            }
            let html = '<div class="booking-item" onclick="' + clickAction + '">';
            html += '<div class="booking-item-header">';
            html += '<span class="booking-item-name">' + icon + ' ' + escapeHtml(ann.poiName || 'Unknown') + '</span>';
            html += '<span class="annotation-status ' + statusClass + '">' + escapeHtml(ann.status || '') + '</span>';
            html += '</div>';
            if (dateStr) html += '<div class="booking-item-date">' + dateStr + endDateStr + '</div>';
            if (ann.details) html += '<div class="booking-item-details">' + escapeHtml(ann.details) + '</div>';
            if (ann.source === 'browser') {
                html += '<div style="margin-top:4px"><button onclick="event.stopPropagation();deleteBrowserAnnotation(\'' + (activeDestination || 'default').replace(/'/g, "\\'") + '\',\'' + (ann.id || '').replace(/'/g, "\\'") + '\');showBookingsPanel()" style="padding:2px 6px;font-size:9px;background:none;color:#dc2626;border:1px solid #fecaca;border-radius:3px;cursor:pointer;">Remove</button></div>';
            }
            html += '</div>';
            return html;
        }

        function closeBookingsPanel() {
            const panel = document.getElementById('bookingsPanel');
            const overlay = document.getElementById('bookingsPanelOverlay');
            if (panel) panel.style.display = 'none';
            if (overlay) overlay.style.display = 'none';
        }

        // Import/Export
        function exportNotesAndAnnotations() {
            const notes = getAllNotes(activeDestination);
            const anns = browserAnnotations[activeDestination] || [];
            const data = {
                destination: activeDestination,
                user: currentUser,
                exportDate: new Date().toISOString().split('T')[0],
                notes: notes,
                browserAnnotations: anns
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'travel-notes-' + activeDestination + '-' + data.exportDate + '.json';
            link.click();
            URL.revokeObjectURL(url);
            showCopyToast('Exported ' + notes.length + ' notes + ' + anns.length + ' bookings');
        }

        function importNotesAndAnnotations(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    let noteCount = 0, annCount = 0;
                    // Import notes
                    if (data.notes && Array.isArray(data.notes)) {
                        data.notes.forEach(n => {
                            if (n.poiName && n.text) {
                                setNote(activeDestination, n.poiName, n.text);
                                noteCount++;
                            }
                        });
                    }
                    // Import browser annotations
                    if (data.browserAnnotations && Array.isArray(data.browserAnnotations)) {
                        if (!browserAnnotations[activeDestination]) browserAnnotations[activeDestination] = [];
                        const existingIds = new Set(browserAnnotations[activeDestination].map(a => a.id));
                        data.browserAnnotations.forEach(ann => {
                            if (!existingIds.has(ann.id)) {
                                ann.source = 'browser';
                                browserAnnotations[activeDestination].push(ann);
                                annCount++;
                            }
                        });
                        saveBrowserAnnotations(activeDestination);
                    }
                    showCopyToast('Imported ' + noteCount + ' notes + ' + annCount + ' bookings');
                    updateNoteIndicators();
                    updateBookingsBadge();
                    showNotesPanel(); // Refresh the panel
                } catch(err) {
                    showCopyToast('Import failed: invalid file');
                }
            };
            reader.readAsText(file);
        }

        // ============================================
        // QUICK FILTER CHIPS (Phase 1c)
        // ============================================

        let activeFilterChips = new Set();

        // Base filter chip config (universal for all destinations)
        const baseFilterChipConfig = {
            hotels:     { categoryKey: 'hotels',     types: ['hotel'],                      namePattern: null },
            dining:     { categoryKey: 'restaurants', types: ['breakfast', 'lunch', 'dinner'], namePattern: null },
            sightseeing:{ categoryKey: 'experiences', types: ['sightseeing'],                  namePattern: null },
            kids:       { categoryKey: 'kidFriendly', types: ['optional', 'sightseeing'],      namePattern: /kid|child|play|zoo|aquarium|toy|family|playground/iu },
            markets:    { categoryKey: 'markets',     types: ['optional', 'sightseeing'],      namePattern: /market|bazaar|souk|mercado|markt/iu }
        };

        // Destination-specific extra filter chips
        const destFilterChips = {
            japan: {
                cameras:  { emoji: '\u{1F4F7}', label: 'Cameras',  categoryKey: null, types: ['optional'], namePattern: /\u{1F4F7}|camera|photo|film|lemon-sha|leica/iu },
                skincare: { emoji: '\u{1F9F4}', label: 'Skincare', categoryKey: null, types: ['optional'], namePattern: /\u{1F9F4}|skincare|beauty|shiseido|sk-ii|cosme|yojiya|aesop|makanai|isetan beauty/iu }
            }
        };

        // Active config (rebuilt per destination)
        let filterChipConfig = Object.assign({}, baseFilterChipConfig);

        // Chip definitions for building UI
        const baseChipDefs = [
            { key: 'hotels',      emoji: '\u{1F3E8}', label: 'Hotels' },
            { key: 'dining',      emoji: '\u{1F374}', label: 'Dining' },
            { key: 'sightseeing', emoji: '\u{1F5FA}', label: 'Sights' },
            { key: 'kids',        emoji: '\u{1F476}', label: 'Kids' },
            { key: 'markets',     emoji: '\u{1F6CD}', label: 'Markets' }
        ];

        function buildFilterChips() {
            const row = document.getElementById('filterChipsRow');
            row.innerHTML = '';
            activeFilterChips.clear();

            // Rebuild filterChipConfig for this destination
            filterChipConfig = Object.assign({}, baseFilterChipConfig);
            const extraChips = destFilterChips[activeDestination] || {};
            Object.assign(filterChipConfig, extraChips);

            // Build chip elements: first 3 base, then extras, then remaining base
            const chipOrder = [];
            chipOrder.push(baseChipDefs[0]); // Hotels
            chipOrder.push(baseChipDefs[1]); // Dining
            chipOrder.push(baseChipDefs[2]); // Sights

            // Insert destination-specific chips here
            Object.keys(extraChips).forEach(key => {
                chipOrder.push({ key: key, emoji: extraChips[key].emoji, label: extraChips[key].label });
            });

            chipOrder.push(baseChipDefs[3]); // Kids
            chipOrder.push(baseChipDefs[4]); // Markets

            chipOrder.forEach(chip => {
                const span = document.createElement('span');
                span.className = 'filter-chip';
                span.setAttribute('data-filter', chip.key);
                span.onclick = function() { toggleFilterChip(chip.key); };
                span.textContent = chip.emoji + ' ' + chip.label;
                row.appendChild(span);
            });

            // Add clear button
            const clearBtn = document.createElement('button');
            clearBtn.className = 'filter-chips-clear';
            clearBtn.id = 'filterChipsClear';
            clearBtn.onclick = clearFilterChips;
            clearBtn.style.display = 'none';
            clearBtn.textContent = 'Clear';
            row.appendChild(clearBtn);

            // Reset count display
            const countEl = document.getElementById('filterChipsCount');
            if (countEl) {
                countEl.classList.remove('active');
                countEl.textContent = '';
            }
        }

        function toggleFilterChip(filter) {
            if (activeFilterChips.has(filter)) {
                activeFilterChips.delete(filter);
            } else {
                activeFilterChips.add(filter);
            }

            // Update chip UI
            const chip = document.querySelector('.filter-chip[data-filter="' + filter + '"]');
            if (chip) chip.classList.toggle('active');

            // Show/hide clear button
            const clearBtn = document.getElementById('filterChipsClear');
            clearBtn.style.display = activeFilterChips.size > 0 ? 'inline-block' : 'none';

            applyFilterChips();
        }

        function clearFilterChips() {
            activeFilterChips.clear();
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            document.getElementById('filterChipsClear').style.display = 'none';
            if (activeTagFilters.size === 0) {
                document.getElementById('filterChipsCount').classList.remove('active');
            }
            applyFilterChips();
        }

        function markerMatchesFilter(markerData) {
            // Check if a marker matches ANY of the active filters (OR logic)
            for (const filter of activeFilterChips) {
                const config = filterChipConfig[filter];
                if (!config) continue;

                // Check type match
                const typeMatch = config.types.includes(markerData.type);

                // For filters with namePattern, require BOTH type match and name match
                if (config.namePattern) {
                    if (typeMatch && config.namePattern.test(markerData.name || '')) return true;
                    // Also match by name alone for sightseeing-typed items
                    if (config.namePattern.test(markerData.name || '')) return true;
                } else {
                    // For simple type-based filters, just type match
                    if (typeMatch) return true;
                }
            }
            return false;
        }

        function applyFilterChips() {
            if (currentView === 'categories') {
                applyFilterChipsCategories();
            } else {
                applyFilterChipsItineraries();
            }
        }

        function applyFilterChipsCategories() {
            const countEl = document.getElementById('filterChipsCount');

            if (activeFilterChips.size === 0) {
                // No filters active — restore to checkbox state
                Object.keys(categoryGroups).forEach(key => {
                    const checkbox = document.querySelector('input[data-category="' + key + '"]');
                    if (checkbox && checkbox.checked) {
                        if (!map.hasLayer(categoryGroups[key])) categoryGroups[key].addTo(map);
                    } else {
                        if (map.hasLayer(categoryGroups[key])) categoryGroups[key].removeFrom(map);
                    }
                });
                if (activeTagFilters.size === 0) {
                    countEl.classList.remove('active');
                }
                // Re-apply tag filters on top of category visibility
                if (activeTagFilters.size > 0) applyTagFiltersCategories();
                return;
            }

            // Show only category layers that match active filter chips
            const showCategories = new Set();
            activeFilterChips.forEach(filter => {
                const config = filterChipConfig[filter];
                if (config && config.categoryKey) {
                    showCategories.add(config.categoryKey);
                }
                // For filters without a categoryKey (e.g. cameras, skincare), show experiences
                if (config && !config.categoryKey) {
                    showCategories.add('experiences');
                }
            });

            Object.keys(categoryGroups).forEach(key => {
                if (showCategories.has(key)) {
                    if (!map.hasLayer(categoryGroups[key])) categoryGroups[key].addTo(map);
                } else {
                    if (map.hasLayer(categoryGroups[key])) categoryGroups[key].removeFrom(map);
                }
            });

            if (activeTagFilters.size === 0) {
                countEl.classList.add('active');
                countEl.textContent = showCategories.size + ' categor' + (showCategories.size === 1 ? 'y' : 'ies') + ' shown';
            } else {
                // Re-apply tag filters on top of category visibility
                applyTagFiltersCategories();
            }
        }

        function applyFilterChipsItineraries() {
            const countEl = document.getElementById('filterChipsCount');

            if (activeFilterChips.size === 0) {
                // No filters — restore normal visibility based on current day selection
                if (allDaysActive || !currentDay) {
                    itineraryMarkers.forEach(m => {
                        m.marker.setStyle({opacity: 1, fillOpacity: 0.85});
                        if (m.hitMarker) m.hitMarker.setStyle({fillOpacity: 0, interactive: true});
                    });
                    itineraryPolylines.forEach(p => {
                        p.polyline.setStyle({opacity: 0.5});
                    });
                } else {
                    itineraryMarkers.forEach(m => {
                        if (m.day === currentDay) {
                            m.marker.setStyle({opacity: 1, fillOpacity: 0.85});
                            if (m.hitMarker) m.hitMarker.setStyle({fillOpacity: 0, interactive: true});
                        } else {
                            m.marker.setStyle({opacity: 0.2, fillOpacity: 0.2});
                            if (m.hitMarker) m.hitMarker.setStyle({fillOpacity: 0, interactive: false});
                        }
                    });
                    itineraryPolylines.forEach(p => {
                        if (p.day === currentDay) {
                            p.polyline.setStyle({opacity: 0.5});
                        } else {
                            p.polyline.setStyle({opacity: 0.1});
                        }
                    });
                }
                countEl.classList.remove('active');
                return;
            }

            // Filters active — highlight matching, dim non-matching
            let matchCount = 0;
            itineraryMarkers.forEach(m => {
                const dayVisible = allDaysActive || !currentDay || m.day === currentDay;
                const matches = markerMatchesFilter(m);

                if (matches && dayVisible) {
                    m.marker.setStyle({opacity: 1, fillOpacity: 0.95, weight: 3});
                    m.marker.setRadius(9);
                    if (m.hitMarker) m.hitMarker.setStyle({fillOpacity: 0, interactive: true});
                    matchCount++;
                } else if (dayVisible) {
                    m.marker.setStyle({opacity: 0.15, fillOpacity: 0.15, weight: 2});
                    m.marker.setRadius(7);
                    if (m.hitMarker) m.hitMarker.setStyle({fillOpacity: 0, interactive: true});
                } else {
                    m.marker.setStyle({opacity: 0.08, fillOpacity: 0.08, weight: 2});
                    m.marker.setRadius(7);
                    if (m.hitMarker) m.hitMarker.setStyle({fillOpacity: 0, interactive: false});
                }
            });

            // Dim polylines when filtering
            itineraryPolylines.forEach(p => {
                const dayVisible = allDaysActive || !currentDay || p.day === currentDay;
                p.polyline.setStyle({opacity: dayVisible ? 0.15 : 0.05});
            });

            countEl.classList.add('active');
            countEl.textContent = matchCount + ' matching marker' + (matchCount !== 1 ? 's' : '') + ' highlighted';
        }


        // ============================================
        // TAG FILTER PANEL
        // ============================================

        function toggleTagPanel() {
            const panel = document.getElementById('tagFilterPanel');
            const toggle = document.getElementById('tagFilterToggle');
            panel.classList.toggle('open');
            toggle.classList.toggle('open');
        }

        function buildTagFilterPanel() {
            // Determine which tags exist in the current destination's POIs
            const availableTags = new Set();
            allCategoryMarkerRefs.forEach(ref => {
                const tags = ref.poi.tags || [];
                tags.forEach(t => availableTags.add(t));
            });

            // Build desktop sidebar panel
            const panel = document.getElementById('tagFilterPanel');
            panel.innerHTML = '';

            let totalAvailable = 0;
            Object.keys(tagTaxonomy).forEach(group => {
                const groupDef = tagTaxonomy[group];
                const groupTags = groupDef.tags.filter(t => availableTags.has(t));
                if (groupTags.length === 0) return;

                totalAvailable += groupTags.length;
                const groupDiv = document.createElement('div');
                groupDiv.className = 'tag-group';

                const label = document.createElement('div');
                label.className = 'tag-group-label';
                label.textContent = group;
                groupDiv.appendChild(label);

                const chipsDiv = document.createElement('div');
                chipsDiv.className = 'tag-group-chips';

                groupTags.forEach(tag => {
                    const chip = document.createElement('span');
                    chip.className = 'tag-chip';
                    chip.setAttribute('data-tag', tag);
                    chip.textContent = tag;
                    chip.style.setProperty('--tag-color', tagColorMap[tag] || groupDef.color);
                    if (activeTagFilters.has(tag)) {
                        chip.classList.add('active');
                        chip.style.background = tagColorMap[tag] || groupDef.color;
                    }
                    chip.onclick = function() { toggleTagFilter(tag); };
                    chipsDiv.appendChild(chip);
                });

                groupDiv.appendChild(chipsDiv);
                panel.appendChild(groupDiv);
            });

            // Actions row
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'tag-filter-actions';
            actionsDiv.id = 'tagFilterActions';

            const countSpan = document.createElement('span');
            countSpan.className = 'tag-filter-count';
            countSpan.id = 'tagFilterCount';
            countSpan.textContent = activeTagFilters.size > 0 ? activeTagFilters.size + ' tag' + (activeTagFilters.size !== 1 ? 's' : '') + ' active' : '';
            actionsDiv.appendChild(countSpan);

            const clearBtn = document.createElement('button');
            clearBtn.className = 'tag-filter-clear-btn';
            clearBtn.textContent = 'Clear Tags';
            clearBtn.style.display = activeTagFilters.size > 0 ? 'inline-block' : 'none';
            clearBtn.onclick = clearTagFilters;
            actionsDiv.appendChild(clearBtn);

            panel.appendChild(actionsDiv);

            // Build mobile modal content (mirrors desktop)
            const mobileContent = document.getElementById('mobileTagModalContent');
            if (mobileContent) {
                mobileContent.innerHTML = panel.innerHTML;
                // Re-bind click events for mobile chips
                mobileContent.querySelectorAll('.tag-chip').forEach(chip => {
                    const tag = chip.getAttribute('data-tag');
                    chip.onclick = function() { toggleTagFilter(tag); };
                });
                const mobileClear = mobileContent.querySelector('.tag-filter-clear-btn');
                if (mobileClear) mobileClear.onclick = clearTagFilters;
            }

            // Update toggle button state
            updateTagToggleLabel();
        }

        function toggleTagFilter(tag) {
            if (activeTagFilters.has(tag)) {
                activeTagFilters.delete(tag);
            } else {
                activeTagFilters.add(tag);
            }

            // Update all tag chip UIs (both desktop and mobile)
            const escapedTag = (typeof CSS !== 'undefined' && CSS.escape) ? CSS.escape(tag) : tag.replace(/([!"#$%&'()*+,.\/:;<=>?@\[\\\]^`{|}~])/g, '\\$1');
            document.querySelectorAll('.tag-chip[data-tag="' + escapedTag + '"]').forEach(chip => {
                if (activeTagFilters.has(tag)) {
                    chip.classList.add('active');
                    chip.style.background = tagColorMap[tag] || '#6366F1';
                } else {
                    chip.classList.remove('active');
                    chip.style.background = '';
                }
            });

            updateTagToggleLabel();
            updateTagFilterActions();
            applyTagFilters();
        }

        function clearTagFilters() {
            activeTagFilters.clear();
            document.querySelectorAll('.tag-chip').forEach(chip => {
                chip.classList.remove('active');
                chip.style.background = '';
            });
            updateTagToggleLabel();
            updateTagFilterActions();
            applyTagFilters();
        }

        function updateTagToggleLabel() {
            const toggle = document.getElementById('tagFilterToggle');
            const label = document.getElementById('tagFilterToggleLabel');
            const mobileBtn = document.getElementById('mobileTagFilterBtn');
            const searchBtn = document.getElementById('mobileSearchTagBtn');

            if (activeTagFilters.size > 0) {
                label.textContent = '🏷 Tags (' + activeTagFilters.size + ' active)';
                toggle.classList.add('has-active');
                // Map tab FAB — add badge
                if (mobileBtn) {
                    mobileBtn.classList.add('has-active');
                    let badge = mobileBtn.querySelector('.tag-badge');
                    if (!badge) {
                        badge = document.createElement('span');
                        badge.className = 'tag-badge';
                        mobileBtn.appendChild(badge);
                    }
                    badge.textContent = activeTagFilters.size;
                }
                // Search tab chip — highlight
                if (searchBtn) {
                    searchBtn.style.background = '#7C3AED';
                    searchBtn.style.color = 'white';
                    searchBtn.style.borderColor = '#7C3AED';
                    searchBtn.textContent = '🏷 Tags (' + activeTagFilters.size + ')';
                }
            } else {
                label.textContent = '🏷 Filter by Tags';
                toggle.classList.remove('has-active');
                // Map tab FAB — remove badge
                if (mobileBtn) {
                    mobileBtn.classList.remove('has-active');
                    const badge = mobileBtn.querySelector('.tag-badge');
                    if (badge) badge.remove();
                }
                // Search tab chip — reset
                if (searchBtn) {
                    searchBtn.style.background = '';
                    searchBtn.style.color = '#7C3AED';
                    searchBtn.style.borderColor = '#7C3AED';
                    searchBtn.textContent = '🏷 Tags';
                }
            }
        }

        function updateTagFilterActions() {
            // Update desktop actions
            const countEl = document.getElementById('tagFilterCount');
            const clearBtn = document.querySelector('#tagFilterActions .tag-filter-clear-btn');
            if (countEl) countEl.textContent = activeTagFilters.size > 0 ? activeTagFilters.size + ' tag' + (activeTagFilters.size !== 1 ? 's' : '') + ' active' : '';
            if (clearBtn) clearBtn.style.display = activeTagFilters.size > 0 ? 'inline-block' : 'none';

            // Update mobile actions
            const mobileCountEl = document.querySelector('#mobileTagModalContent .tag-filter-count');
            const mobileClearBtn = document.querySelector('#mobileTagModalContent .tag-filter-clear-btn');
            if (mobileCountEl) mobileCountEl.textContent = countEl ? countEl.textContent : '';
            if (mobileClearBtn) mobileClearBtn.style.display = activeTagFilters.size > 0 ? 'inline-block' : 'none';
        }

        function poiMatchesTagFilters(poi) {
            // Returns true if the POI has ALL active tag filters (AND logic)
            if (activeTagFilters.size === 0) return true;
            const poiTags = poi.tags || [];
            for (const reqTag of activeTagFilters) {
                if (!poiTags.includes(reqTag)) return false;
            }
            return true;
        }

        function applyTagFilters() {
            if (currentView === 'categories') {
                applyTagFiltersCategories();
            } else {
                applyTagFiltersItineraries();
            }
        }

        function applyTagFiltersCategories() {
            if (activeTagFilters.size === 0) {
                // No tag filters — restore all markers to full opacity
                allCategoryMarkerRefs.forEach(ref => {
                    ref.marker.setStyle({ opacity: 1, fillOpacity: 0.8 });
                    ref.hitMarker.setStyle({ fillOpacity: 0, interactive: true });
                });
                // Update filter count
                const countEl = document.getElementById('filterChipsCount');
                if (countEl && activeFilterChips.size === 0) {
                    countEl.classList.remove('active');
                }
                return;
            }

            // Tag filters active — dim non-matching markers, highlight matching
            let matchCount = 0;
            let totalVisible = 0;
            allCategoryMarkerRefs.forEach(ref => {
                // Check if the category layer is even visible
                const catVisible = map.hasLayer(categoryGroups[ref.categoryKey]);
                if (!catVisible) return;

                totalVisible++;
                const matches = poiMatchesTagFilters(ref.poi);
                if (matches) {
                    ref.marker.setStyle({ opacity: 1, fillOpacity: 0.9 });
                    ref.hitMarker.setStyle({ fillOpacity: 0, interactive: true });
                    matchCount++;
                } else {
                    ref.marker.setStyle({ opacity: 0.12, fillOpacity: 0.12 });
                    ref.hitMarker.setStyle({ fillOpacity: 0, interactive: false });
                }
            });

            const countEl = document.getElementById('filterChipsCount');
            if (countEl) {
                countEl.classList.add('active');
                countEl.textContent = matchCount + ' of ' + totalVisible + ' POIs match tags';
            }
        }

        function applyTagFiltersItineraries() {
            if (activeTagFilters.size === 0) return;

            // For itinerary view, dim markers whose POI doesn't match tag filters
            let matchCount = 0;
            itineraryMarkers.forEach(m => {
                const dayVisible = allDaysActive || !currentDay || m.day === currentDay;
                if (!dayVisible) return;

                // Look up POI tags from poiLookup
                const poiData = poiLookup[m.name] || {};
                const poiTags = poiData.tags || [];
                let tagMatch = true;
                for (const reqTag of activeTagFilters) {
                    if (!poiTags.includes(reqTag)) { tagMatch = false; break; }
                }

                // Also apply category filter chip matching if active
                const chipMatch = activeFilterChips.size === 0 || markerMatchesFilter(m);

                if (tagMatch && chipMatch) {
                    m.marker.setStyle({opacity: 1, fillOpacity: 0.95, weight: 3});
                    m.marker.setRadius(9);
                    if (m.hitMarker) m.hitMarker.setStyle({fillOpacity: 0, interactive: true});
                    matchCount++;
                } else {
                    m.marker.setStyle({opacity: 0.12, fillOpacity: 0.12, weight: 2});
                    m.marker.setRadius(7);
                    if (m.hitMarker) m.hitMarker.setStyle({fillOpacity: 0, interactive: true});
                }
            });

            const countEl = document.getElementById('filterChipsCount');
            if (countEl) {
                countEl.classList.add('active');
                countEl.textContent = matchCount + ' matching marker' + (matchCount !== 1 ? 's' : '') + ' highlighted';
            }
        }

        // Mobile tag modal controls
        function openMobileTagModal() {
            document.getElementById('mobileTagBackdrop').classList.add('visible');
            document.getElementById('mobileTagModal').classList.add('visible');
        }

        function closeMobileTagModal() {
            document.getElementById('mobileTagBackdrop').classList.remove('visible');
            document.getElementById('mobileTagModal').classList.remove('visible');
        }

        // ============================================
        // REGION FILTERING
        // ============================================

        let activeSubRegion = null; // {name, bounds: [[minLat, minLng], [maxLat, maxLng]]}

        function buildRegionFilter() {
            const row = document.getElementById('regionFilterRow');
            const sel = document.getElementById('regionSelect');
            activeSubRegion = null;

            // Check if current destination has regions defined
            const dest = destinations[activeDestination];
            if (!dest || !dest.regions || dest.regions.length === 0) {
                row.style.display = 'none';
                return;
            }

            row.style.display = 'block';
            sel.innerHTML = '<option value="">All Regions</option>';
            dest.regions.forEach(function(region, idx) {
                const opt = document.createElement('option');
                opt.value = idx;
                opt.textContent = region.name;
                sel.appendChild(opt);
            });
        }

        function filterByRegion(value) {
            const dest = destinations[activeDestination];
            if (!dest || !dest.regions) return;

            if (value === '' || value === null) {
                activeSubRegion = null;
            } else {
                activeSubRegion = dest.regions[parseInt(value)];
            }

            // Re-apply to current view
            if (currentView === 'categories') {
                applyRegionFilterCategories();
            }
        }

        function isInRegion(coord, region) {
            if (!region || !region.bounds) return true;
            var lat = coord[0], lng = coord[1];
            var b = region.bounds;
            return lat >= b[0][0] && lat <= b[1][0] && lng >= b[0][1] && lng <= b[1][1];
        }

        function applyRegionFilterCategories() {
            if (!activeSubRegion) {
                // No region filter — reload all categories
                loadCategories();
                return;
            }

            // Filter each category group to only show markers in region
            var dest = destinations[activeDestination];
            var catArrays = {
                hotels: dest.hotels,
                restaurants: dest.restaurants,
                experiences: dest.experiences,
                kidFriendly: dest.kidFriendly,
                markets: dest.markets
            };

            Object.keys(categoryGroups).forEach(function(key) {
                if (map.hasLayer(categoryGroups[key])) categoryGroups[key].removeFrom(map);
                categoryGroups[key] = L.featureGroup();
            });

            var totalShown = 0;
            Object.keys(catArrays).forEach(function(key) {
                var items = catArrays[key] || [];
                items.forEach(function(item) {
                    if (!isInRegion(item.coord, activeSubRegion)) return;
                    totalShown++;
                    var marker = L.circleMarker(item.coord, {
                        radius: 7,
                        fillColor: categoryColors[key],
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.85
                    });
                    marker.bindPopup('<strong>' + escapeHtml(item.name) + '</strong><br>' + escapeHtml(item.desc || ''));
                    categoryGroups[key].addLayer(marker);
                });

                var checkbox = document.querySelector('input[data-category="' + key + '"]');
                if (checkbox && checkbox.checked) {
                    categoryGroups[key].addTo(map);
                }
            });

            var countEl = document.getElementById('filterChipsCount');
            countEl.classList.add('active');
            countEl.textContent = activeSubRegion.name + ': ' + totalShown + ' places';
        }


        // ============================================
        // CITY ACTIVITY BROWSER (Phase 1b)
        // ============================================

        let browserIsOpen = false;
        let browserContext = null;
        let browserFilter = 'all';
        let browserSelectedActivity = null;

        function openCityBrowser(itinKey, dayNum) {
            const itin = itineraryData[itinKey];
            const dayData = itin.days.find(d => d.day === dayNum);
            if (!dayData) return;

            const cityCenter = findCityCenter(dayData.title);
            const cityName = cityCenter ? cityCenter.name : extractCity(dayData.title);

            if (!cityCenter) {
                alert('Could not determine city for this day.');
                return;
            }

            // Gather all activities near this city
            const allActivities = [];

            const filterByCity = (items, category) => {
                return items.filter(item =>
                    item.coord &&
                    Math.abs(item.coord[0] - cityCenter.lat) < cityCenter.radius &&
                    Math.abs(item.coord[1] - cityCenter.lng) < cityCenter.radius
                ).map(item => ({...item, category}));
            };

            allActivities.push(...filterByCity(hotels, 'hotels'));
            allActivities.push(...filterByCity(restaurants, 'restaurants'));
            allActivities.push(...filterByCity(experiences, 'experiences'));
            allActivities.push(...filterByCity(kidFriendly, 'kidFriendly'));
            allActivities.push(...filterByCity(markets, 'markets'));

            browserContext = {
                itinKey,
                dayNum,
                city: cityName,
                activities: allActivities,
                dayData
            };

            // Update UI
            document.getElementById('browserTitle').textContent = 'Browse ' + cityName;
            document.getElementById('browserSubtitle').textContent = allActivities.length + ' activities near ' + cityName;
            document.getElementById('browserSearch').value = '';
            browserFilter = 'all';

            // Reset chips
            document.querySelectorAll('.browser-chip').forEach(c => c.classList.remove('active'));
            document.querySelector('.browser-chip[data-filter="all"]').classList.add('active');

            renderBrowserActivities();

            document.getElementById('browserOverlay').classList.add('active');
            document.getElementById('cityBrowser').classList.add('active');
            browserIsOpen = true;
        }

        function closeCityBrowser() {
            document.getElementById('browserOverlay').classList.remove('active');
            document.getElementById('cityBrowser').classList.remove('active');
            browserIsOpen = false;
            browserContext = null;
            browserSelectedActivity = null;
        }

        function setBrowserFilter(filter) {
            browserFilter = filter;
            document.querySelectorAll('.browser-chip').forEach(c => c.classList.remove('active'));
            document.querySelector('.browser-chip[data-filter="' + filter + '"]').classList.add('active');
            renderBrowserActivities();
        }

        function filterBrowserActivities() {
            renderBrowserActivities();
        }

        function renderBrowserActivities() {
            if (!browserContext) return;

            const body = document.getElementById('browserBody');
            const searchTerm = document.getElementById('browserSearch').value.toLowerCase().trim();

            let activities = browserContext.activities;

            // Apply category filter
            if (browserFilter !== 'all') {
                activities = activities.filter(a => a.category === browserFilter);
            }

            // Apply tag filters (AND logic — activity must have ALL selected tags)
            if (activeTagFilters.size > 0) {
                activities = activities.filter(a => {
                    const data = poiLookup[a.name] || {};
                    const poiTags = data.tags || [];
                    for (const reqTag of activeTagFilters) {
                        if (!poiTags.includes(reqTag)) return false;
                    }
                    return true;
                });
            }

            // Apply search filter
            if (searchTerm) {
                activities = activities.filter(a =>
                    a.name.toLowerCase().includes(searchTerm) ||
                    (a.desc && a.desc.toLowerCase().includes(searchTerm))
                );
            }

            if (activities.length === 0) {
                body.innerHTML = '<div class="browser-no-results">No activities found matching your search.</div>';
                return;
            }

            // Group by category
            const groups = {};
            const groupOrder = ['hotels', 'restaurants', 'experiences', 'kidFriendly', 'markets'];
            const groupLabels = {
                hotels: '\u{1F3E8} Hotels & Ryokans',
                restaurants: '\u{1F374} Restaurants & Bars',
                experiences: '\u{1F5FA} Experiences & Activities',
                kidFriendly: '\u{1F476} Kid-Friendly',
                markets: '\u{1F6CD} Markets'
            };
            const typeClass = {
                hotels: 'hotel',
                restaurants: 'restaurant',
                experiences: 'experience',
                kidFriendly: 'kid',
                markets: 'market'
            };

            activities.forEach(a => {
                if (!groups[a.category]) groups[a.category] = [];
                groups[a.category].push(a);
            });

            // Build a stable index map so we can reference the correct activity when clicked
            const activityIndexMap = [];
            activities.forEach((a, i) => activityIndexMap.push(a));

            let html = '';
            let runningIdx = 0;
            groupOrder.forEach(cat => {
                if (!groups[cat] || groups[cat].length === 0) return;
                html += '<div class="browser-group">';
                html += '<div class="browser-group-title">' + groupLabels[cat] + ' (' + groups[cat].length + ')</div>';
                groups[cat].forEach((act) => {
                    const idx = activities.indexOf(act);
                    html += '<div class="browser-activity" id="browser-act-' + idx + '" onclick="selectBrowserActivity(' + idx + ')">';
                    html += '<div class="browser-activity-name">' + escapeHtml(act.name) + '</div>';
                    if (act.desc) html += '<div class="browser-activity-desc">' + escapeHtml(act.desc) + '</div>';
                    html += '<span class="browser-activity-type ' + typeClass[act.category] + '">' + (cat === 'kidFriendly' ? 'Kid-Friendly' : cat.charAt(0).toUpperCase() + cat.slice(1)) + '</span>';
                    html += '<div class="browser-slot-picker" id="browser-slots-' + idx + '"></div>';
                    html += '</div>';
                });
                html += '</div>';
            });

            body.innerHTML = html;
        }

        function selectBrowserActivity(actIdx) {
            if (!browserContext) return;

            const activities = getFilteredBrowserActivities();
            const act = activities[actIdx];
            if (!act) return;

            // Close any previously open slot pickers
            document.querySelectorAll('.browser-slot-picker.active').forEach(el => {
                el.classList.remove('active');
                el.innerHTML = '';
            });
            document.querySelectorAll('.browser-activity.selected').forEach(el => {
                el.classList.remove('selected');
            });

            // Highlight selected activity
            const actEl = document.getElementById('browser-act-' + actIdx);
            if (actEl) actEl.classList.add('selected');

            // Show slot picker for this activity
            const slotPicker = document.getElementById('browser-slots-' + actIdx);
            if (!slotPicker) return;

            const dayData = browserContext.dayData;
            let slotsHtml = '<div class="browser-slot-title">Replace which item on Day ' + browserContext.dayNum + '?</div>';

            dayData.items.forEach((item, itemIdx) => {
                if (item.type === 'nap') return;
                slotsHtml += '<div class="browser-slot-item" onclick="event.stopPropagation(); replaceDayItem(' + actIdx + ',' + itemIdx + ')">';
                slotsHtml += '<strong>' + formatType(item.type) + ':</strong> ' + escapeHtml(item.name);
                slotsHtml += '</div>';
            });

            slotPicker.innerHTML = slotsHtml;
            slotPicker.classList.add('active');
            browserSelectedActivity = act;

            // Scroll the slot picker into view
            setTimeout(() => slotPicker.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 100);
        }

        function getFilteredBrowserActivities() {
            if (!browserContext) return [];

            let activities = browserContext.activities;
            const searchTerm = document.getElementById('browserSearch').value.toLowerCase().trim();

            if (browserFilter !== 'all') {
                activities = activities.filter(a => a.category === browserFilter);
            }
            if (searchTerm) {
                activities = activities.filter(a =>
                    a.name.toLowerCase().includes(searchTerm) ||
                    (a.desc && a.desc.toLowerCase().includes(searchTerm))
                );
            }
            return activities;
        }

        function replaceDayItem(actIdx, itemIdx) {
            if (!browserContext) return;

            const activities = getFilteredBrowserActivities();
            const act = activities[actIdx];
            if (!act) return;

            const { itinKey, dayNum } = browserContext;
            const dayData = itineraryData[itinKey].days.find(d => d.day === dayNum);
            if (!dayData || !dayData.items[itemIdx]) return;

            const oldItem = dayData.items[itemIdx];

            // Keep the original slot type for structured items (meals, hotel)
            let newType = oldItem.type;
            if (act.category === 'experiences' || act.category === 'kidFriendly' || act.category === 'markets') {
                if (oldItem.type !== 'hotel' && oldItem.type !== 'breakfast' && oldItem.type !== 'lunch' && oldItem.type !== 'dinner') {
                    newType = 'sightseeing';
                }
            }

            // Save to modifiedState for persistence
            const modKey = itinKey + '_' + dayNum + '_' + itemIdx;
            const origDay = originalItineraryData[itinKey].days.find(d => d.day === dayNum);
            modifiedState[modKey] = {
                newName: act.name,
                newCoord: act.coord,
                newDesc: act.desc || '',
                origName: origDay.items[itemIdx].name,
                origCoord: origDay.items[itemIdx].coord,
                timestamp: new Date().toISOString()
            };
            saveModifiedState();

            // Update itinerary data
            dayData.items[itemIdx] = {
                type: newType,
                name: act.name,
                coord: act.coord,
                desc: act.desc || ''
            };

            // Refresh UI
            renderDays(itinKey);
            if (currentDay === dayNum) {
                showDay(itinKey, dayNum);
            } else if (allDaysActive) {
                showItinerary(itinKey);
            }

            // Close browser
            closeCityBrowser();
        }


        // ============================================
        // AI CHAT SYSTEM
        // ============================================

        let chatModel = 'haiku';
        let chatApiKey = null;
        let chatHistory = [];
        let lastAiDayData = null;
        let chatIsOpen = false;
        let chatWebSearch = true;
        let configLoaded = false;

        // Load config.json for pre-configured API key (family/private deployment)
        async function loadConfig() {
            try {
                const resp = await fetch('config.json');
                if (resp.ok) {
                    const config = await resp.json();
                    if (config.anthropicApiKey && config.anthropicApiKey.startsWith('sk-')) {
                        chatApiKey = config.anthropicApiKey;
                        try {
                            localStorage.setItem('japanTrip_apiKey', config.anthropicApiKey);
                            localStorage.setItem('tripMap_apiKey', config.anthropicApiKey);
                        } catch(e) {}
                        configLoaded = true;
                    }
                    if (config.defaultModel) {
                        chatModel = config.defaultModel;
                    }
                }
            } catch(e) {
                // No config.json or fetch failed — normal for public deployment
            }
        }

        function getModelId() {
            if (chatModel === 'haiku') return 'claude-haiku-4-5-20251001';
            return 'claude-sonnet-4-5-20250929';
        }

        function toggleChatPanel() {
            chatIsOpen = !chatIsOpen;
            const panel = document.getElementById('chatPanel');
            if (chatIsOpen) {
                panel.classList.add('active');
                loadApiKey();
                updateChatContext();
            } else {
                panel.classList.remove('active');
            }
        }

        function loadApiKey() {
            try {
                chatApiKey = chatApiKey || localStorage.getItem('japanTrip_apiKey');
            } catch(e) {}
            if (chatApiKey) {
                showChatInterface();
                if (configLoaded) {
                    addChatMessage('assistant', "Ready to help plan your day! AI is pre-configured for this family map.\n\nTry things like:\n\u2022 \"I want museum hopping and great pasta today\"\n\u2022 \"Make today more kid-friendly\"\n\u2022 \"Swap dinner for something casual\"");
                }
            } else {
                showApiKeySetup();
            }
        }

        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (!key || !key.startsWith('sk-')) {
                addChatMessage('error', 'Please enter a valid API key starting with sk-');
                return;
            }
            chatApiKey = key;
            try {
                localStorage.setItem('japanTrip_apiKey', key);
            } catch(e) {}
            showChatInterface();
            addChatMessage('assistant', "Ready to help plan your day! Tell me what you're in the mood for and I'll rearrange your schedule.\n\nTry things like:\n\u2022 \"I want knife shopping and tempura today\"\n\u2022 \"Make today more kid-friendly\"\n\u2022 \"Swap dinner for something casual\"");
        }

        function showApiKeySetup() {
            document.getElementById('chatSetup').style.display = 'flex';
            document.getElementById('chatMessages').style.display = 'none';
            document.getElementById('chatInputArea').style.display = 'none';
            document.getElementById('chatSettings').style.display = 'none';
        }

        function showChatInterface() {
            document.getElementById('chatSetup').style.display = 'none';
            document.getElementById('chatMessages').style.display = 'flex';
            document.getElementById('chatInputArea').style.display = 'flex';
            document.getElementById('chatSettings').style.display = 'flex';
            if (chatHistory.length === 0) {
                const poiCount = hotels.length + restaurants.length + experiences.length + kidFriendly.length + markets.length;
                const destName = destinations[activeDestination] ? destinations[activeDestination].name : 'your destination';
                addChatMessage('assistant', "Hi! I'm your AI travel planner for " + destName + ", with access to " + poiCount + " curated places.\n\nI can:\n\u2022 Build a full itinerary from scratch \u2014 just tell me how long, who's going, and what you love\n\u2022 Modify a specific day \u2014 select a day in the sidebar first\n\u2022 Answer questions about places, logistics, and tips\n\nTry: \"Plan me a 7-day foodie trip for two\" or \"What's the best ramen in Tokyo?\"");
            }
        }

        function setChatModel(model) {
            chatModel = model;
            // Update desktop buttons
            document.getElementById('modelHaiku').classList.toggle('active', model === 'haiku');
            document.getElementById('modelSonnet').classList.toggle('active', model === 'sonnet');
            // Update mobile buttons
            const mh = document.getElementById('mobileModelHaiku');
            const ms = document.getElementById('mobileModelSonnet');
            if (mh) mh.classList.toggle('active', model === 'haiku');
            if (ms) ms.classList.toggle('active', model === 'sonnet');
        }

        function updateChatContext() {
            const ctx = document.getElementById('chatContext');
            const destName = destinations[activeDestination] ? destinations[activeDestination].name : '';
            if (currentItinerary && currentDay) {
                const itin = itineraryData[currentItinerary];
                const dayData = itin.days.find(d => d.day === currentDay);
                if (dayData) {
                    ctx.textContent = itin.name + ' \u2014 Day ' + currentDay + ': ' + dayData.title;
                    return;
                }
            }
            if (currentItinerary) {
                ctx.textContent = itineraryData[currentItinerary].name + ' \u2014 select a day to modify, or ask me to plan a new trip';
            } else if (destName) {
                ctx.textContent = destName + ' \u2014 ask me to plan a trip or answer questions';
            } else {
                ctx.textContent = 'Load a destination to get started';
            }
        }

        function addChatMessage(role, content) {
            const container = document.getElementById('chatMessages');
            const msg = document.createElement('div');
            msg.className = 'chat-msg ' + role;
            msg.innerHTML = content.replace(/\n/g, '<br>');
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
            chatHistory.push({ role: role, content: content });

            // Sync to mobile chat if active
            if (isMobile()) { setTimeout(syncChatMessages, 100); }
        }

        function addTypingIndicator() {
            const container = document.getElementById('chatMessages');
            const typing = document.createElement('div');
            typing.className = 'chat-typing';
            typing.id = 'chatTyping';
            typing.innerHTML = '<span></span><span></span><span></span>';
            container.appendChild(typing);
            container.scrollTop = container.scrollHeight;
        }

        function removeTypingIndicator() {
            const el = document.getElementById('chatTyping');
            if (el) el.remove();
        }

        function chatKeyHandler(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChatMessage();
            }
        }

        // Conversation history for multi-turn chat itinerary building
        let chatConversation = [];
        let chatGeneratedItinerary = null; // Holds itinerary generated via chat before save

        // Builds full-destination POI context grouped by city (for from-scratch itinerary generation)
        function buildFullDestinationContext() {
            const cityPois = {};
            const allPois = [
                ...hotels.map(h => ({...h, cat: 'hotel'})),
                ...restaurants.map(r => ({...r, cat: 'restaurant'})),
                ...experiences.map(e => ({...e, cat: 'experience'})),
                ...kidFriendly.map(k => ({...k, cat: 'kid-friendly'})),
                ...markets.map(m => ({...m, cat: 'market'}))
            ];

            // Group POIs by nearest city center
            Object.entries(cityCenters).forEach(([city, coords]) => {
                cityPois[city] = { hotels: [], restaurants: [], experiences: [], kidFriendly: [], markets: [] };
                const r = coords[2] || 0.15;
                allPois.forEach(poi => {
                    if (!poi.coord) return;
                    if (Math.abs(poi.coord[0] - coords[0]) < r && Math.abs(poi.coord[1] - coords[1]) < r) {
                        const catKey = poi.cat === 'hotel' ? 'hotels' : poi.cat === 'restaurant' ? 'restaurants' : poi.cat === 'experience' ? 'experiences' : poi.cat === 'kid-friendly' ? 'kidFriendly' : 'markets';
                        const tagStr = (poi.tags && poi.tags.length) ? ' [' + poi.tags.join(', ') + ']' : '';
                        const entry = poi.name + (poi.desc ? ' (' + poi.desc + ')' : '') + tagStr;
                        if (cityPois[city][catKey].length < 15) {
                            cityPois[city][catKey].push(entry);
                        }
                    }
                });
            });

            let poiSection = '';
            Object.entries(cityPois).forEach(([city, cats]) => {
                const total = cats.hotels.length + cats.restaurants.length + cats.experiences.length + cats.kidFriendly.length + cats.markets.length;
                if (total === 0) return;
                poiSection += '\n## ' + city + '\n';
                if (cats.hotels.length) poiSection += 'Hotels: ' + cats.hotels.join(' | ') + '\n';
                if (cats.restaurants.length) poiSection += 'Restaurants: ' + cats.restaurants.join(' | ') + '\n';
                if (cats.experiences.length) poiSection += 'Experiences: ' + cats.experiences.join(' | ') + '\n';
                if (cats.kidFriendly.length) poiSection += 'Kid-Friendly: ' + cats.kidFriendly.join(' | ') + '\n';
                if (cats.markets.length) poiSection += 'Markets: ' + cats.markets.join(' | ') + '\n';
            });

            const cityCentersList = Object.entries(cityCenters).map(([city, coords]) => city + ': [' + coords[0] + ', ' + coords[1] + ']').join(', ');

            return { poiSection: poiSection, cityCentersList: cityCentersList };
        }

        function buildSystemPrompt() {
            const destName = destinations[activeDestination] ? destinations[activeDestination].name : 'travel';
            const totalPois = hotels.length + restaurants.length + experiences.length + kidFriendly.length + markets.length;

            // If we have an active itinerary day, include day-planner context
            let dayContext = '';
            if (currentItinerary && currentDay) {
                const itin = itineraryData[currentItinerary];
                const dayData = itin ? itin.days.find(d => d.day === currentDay) : null;
                if (dayData) {
                    const cityName = extractCity(dayData.title);
                    const center = findCityCenter(dayData.title);

                    let cityActivities = { hotels: [], restaurants: [], experiences: [], kidFriendly: [], markets: [] };
                    if (center) {
                        const r = center.radius;
                        hotels.forEach(h => {
                            if (h.coord && Math.abs(h.coord[0] - center.lat) < r && Math.abs(h.coord[1] - center.lng) < r)
                                cityActivities.hotels.push(h.name + (h.desc ? ' (' + h.desc + ')' : ''));
                        });
                        restaurants.forEach(h => {
                            if (h.coord && Math.abs(h.coord[0] - center.lat) < r && Math.abs(h.coord[1] - center.lng) < r)
                                cityActivities.restaurants.push(h.name + (h.desc ? ' (' + h.desc + ')' : ''));
                        });
                        experiences.forEach(h => {
                            if (h.coord && Math.abs(h.coord[0] - center.lat) < r && Math.abs(h.coord[1] - center.lng) < r)
                                cityActivities.experiences.push(h.name + (h.desc ? ' (' + h.desc + ')' : ''));
                        });
                        kidFriendly.forEach(h => {
                            if (h.coord && Math.abs(h.coord[0] - center.lat) < r && Math.abs(h.coord[1] - center.lng) < r)
                                cityActivities.kidFriendly.push(h.name + (h.desc ? ' (' + h.desc + ')' : ''));
                        });
                        markets.forEach(h => {
                            if (h.coord && Math.abs(h.coord[0] - center.lat) < r && Math.abs(h.coord[1] - center.lng) < r)
                                cityActivities.markets.push(h.name + (h.desc ? ' (' + h.desc + ')' : ''));
                        });
                    }

                    const currentItems = dayData.items.map(item =>
                        item.type.toUpperCase() + ': ' + item.name
                    ).join('\n');

                    dayContext = '\nCURRENT DAY CONTEXT: ' + itin.name + ', Day ' + dayData.day + ' - ' + dayData.title + '\n' +
                        'CURRENT SCHEDULE:\n' + currentItems + '\n\n' +
                        'AVAILABLE IN ' + cityName.toUpperCase() + ':\n' +
                        'Hotels: ' + (cityActivities.hotels.join(', ') || 'none listed') + '\n' +
                        'Restaurants: ' + (cityActivities.restaurants.join(', ') || 'none listed') + '\n' +
                        'Experiences: ' + (cityActivities.experiences.join(', ') || 'none listed') + '\n' +
                        'Kid-Friendly: ' + (cityActivities.kidFriendly.join(', ') || 'none listed') + '\n' +
                        'Markets: ' + (cityActivities.markets.join(', ') || 'none listed') + '\n';
                }
            }

            // Build full destination context for itinerary generation
            const fullCtx = buildFullDestinationContext();

            // If a chat-generated itinerary exists (in refinement mode), include it
            let refinementContext = '';
            if (chatGeneratedItinerary) {
                refinementContext = '\nCURRENT CHAT-GENERATED ITINERARY (user may ask to refine this):\n' +
                    JSON.stringify(chatGeneratedItinerary, null, 0) + '\n';
            }

            let prompt = 'You are a ' + destName + ' travel planning assistant with access to a curated database of ' + totalPois + ' personally researched places.\n\n';

            prompt += 'DESTINATION: ' + destName + '\n';
            prompt += 'AVAILABLE PLACES (grouped by city, with tags for matching interests):\n' + fullCtx.poiSection + '\n';
            prompt += 'CITY CENTERS: ' + fullCtx.cityCentersList + '\n';

            if (dayContext) {
                prompt += dayContext;
            }

            if (refinementContext) {
                prompt += refinementContext;
            }

            prompt += '\nRESPONSE MODES:\n';
            prompt += '1) DAY SCHEDULE CHANGE — If the user has a day selected (see CURRENT DAY CONTEXT above) and asks to modify that day, respond with ONLY a JSON array of day items. No markdown, no explanation.\n';
            prompt += '   Each item: {"type": "hotel|breakfast|lunch|dinner|sightseeing|nap|optional", "name": "Place Name", "coord": [lat, lng] or null}\n';
            prompt += '   Order: hotel first, then chronological. Keep the same hotel unless asked to change it.\n\n';

            prompt += '2) NEW ITINERARY — If the user asks to build, create, or plan a full trip/itinerary from scratch (e.g., "plan me a 7-day trip", "build a foodie itinerary", "create a family vacation"), respond with a complete itinerary as a JSON object.\n';
            prompt += '   If the user hasn\'t specified enough details (duration, travel party, interests, pace), ask 2-3 brief clarifying questions in natural text first. Once you have enough info, generate the itinerary.\n';
            prompt += '   Use places from the AVAILABLE PLACES list as your primary source — they are personally curated. You may add well-known places not in the list if needed to fill gaps.\n';
            prompt += '   Match POI tags to user preferences: "romantic" → Romantic, Fine Dining, Cocktails & Bars; "family" → Family Friendly, Toddler Friendly; "foodie" → Local Delicacies, Fine Dining, Casual Eats, Sweet Treats; "budget" → Budget Friendly, Casual Eats; "adventure" → Adventure & Active, Outdoor & Nature; etc.\n';
            prompt += '   JSON format (raw JSON only, no markdown, no code fences):\n';
            prompt += '   {"name": "Short Descriptive Name", "days": [{"day": 1, "title": "City (Theme)", "items": [{"type": "hotel", "name": "..."}, {"type": "breakfast", "name": "..."}, {"type": "sightseeing", "name": "..."}, {"type": "lunch", "name": "..."}, {"type": "dinner", "name": "..."}, {"type": "optional", "name": "..."}]}]}\n';
            prompt += '   Valid types: hotel, breakfast, lunch, dinner, sightseeing, optional, nap.\n';
            prompt += '   Do NOT include coordinates — they will be looked up automatically.\n';
            prompt += '   Each day must include hotel, breakfast, lunch, dinner. Group nearby activities geographically.\n\n';

            prompt += '3) ITINERARY REFINEMENT — If a CURRENT CHAT-GENERATED ITINERARY exists above and the user asks to modify it (e.g., "make day 3 slower", "add a beach day", "swap the hotel"), output the COMPLETE updated itinerary as JSON (same format as mode 2). Include ALL days, not just modified ones.\n\n';

            prompt += '4) INFORMATION REQUEST — If the user asks about a specific place (hours, reviews, tips, directions), respond with helpful text. Use web search when available.\n\n';

            prompt += '5) GENERAL QUESTION — General travel question → respond with helpful text.\n\n';

            // Multi-destination mode — include available region destinations
            prompt += '6) MULTI-DESTINATION ITINERARY — If the user mentions multiple countries or a cross-country trip (e.g., "5 days Italy, 7 days France", "plan a trip across Spain and Portugal", "build a European tour"), respond with a multi-destination itinerary JSON.\n';
            prompt += '   JSON format: {"name": "Trip Name", "isMultiDestination": true, "segments": [{"destination": "italy", "days": 5}, {"destination": "france", "days": 7}], "days": [{"day": 1, "title": "City (Theme)", "destination": "italy", "items": [...]}]}\n';
            prompt += '   Each day MUST have a "destination" field with the country key. On transition days, include a transit info item.\n';
            prompt += '   Valid destination keys in this region: ';
            if (activeRegion && manifestData) {
                var region = manifestData.regions.find(function(r) { return r.key === activeRegion; });
                if (region) {
                    prompt += region.destinations.join(', ');
                } else {
                    prompt += activeDestination;
                }
            } else {
                prompt += activeDestination;
            }
            prompt += '\n\n';

            prompt += 'MODE SELECTION RULES:\n';
            prompt += '- Use mode 1 (day JSON array) ONLY when a CURRENT DAY CONTEXT exists AND the user wants to modify that specific day.\n';
            prompt += '- Use mode 2 (full itinerary JSON object) when the user asks to create/build/plan a new trip from scratch for ONE country.\n';
            prompt += '- Use mode 3 (full itinerary JSON object) when CURRENT CHAT-GENERATED ITINERARY exists and user wants changes to it.\n';
            prompt += '- Use mode 6 (multi-dest itinerary JSON) when the user mentions multiple countries or a cross-destination trip.\n';
            prompt += '- Use modes 4/5 (natural text) for questions and information requests.\n';
            prompt += '- When generating a full itinerary (modes 2/3/6), output ONLY raw JSON. No markdown, no backticks, no explanation.\n';
            prompt += '- When asking clarifying questions (before having enough info for mode 2/6), use natural text.';

            return prompt;
        }

        function findCoordForName(name) {
            const allItems = [...hotels, ...restaurants, ...experiences, ...kidFriendly, ...markets];
            const match = allItems.find(item => item.name.toLowerCase() === name.toLowerCase());
            return match ? match.coord : null;
        }

        function toggleWebSearch() {
            chatWebSearch = !chatWebSearch;
            document.getElementById('webSearchToggle').classList.toggle('active', chatWebSearch);
        }

        function parseApiResponse(data) {
            let text = '';
            let citations = [];
            if (!data.content) return { text: '', citations: [] };
            for (const block of data.content) {
                if (block.type === 'text') {
                    text += block.text;
                } else if (block.type === 'web_search_tool_result') {
                    if (Array.isArray(block.content)) {
                        block.content.forEach(function(result) {
                            if (result.type === 'web_search_result' && result.url) {
                                citations.push({
                                    title: result.title || result.url,
                                    url: result.url
                                });
                            }
                        });
                    }
                }
            }
            return { text: text.trim(), citations: citations };
        }

        function formatCitations(citations) {
            if (!citations || citations.length === 0) return '';
            var seen = {};
            var unique = citations.filter(function(c) {
                if (seen[c.url]) return false;
                seen[c.url] = true;
                return true;
            });
            if (unique.length === 0) return '';
            var html = '<div class="search-citations"><div class="search-citations-title">Sources</div>';
            unique.slice(0, 5).forEach(function(c) {
                var title = escapeHtml(c.title || c.url);
                var url = escapeHtml(c.url);
                html += '<div class="search-citation-item">\u2022 <a href="' + url + '" target="_blank" rel="noopener">' + title + '</a></div>';
            });
            html += '</div>';
            return html;
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (!msg) return;

            if (!chatApiKey) {
                showApiKeySetup();
                return;
            }

            input.value = '';
            input.style.height = 'auto';
            addChatMessage('user', msg);

            const systemPrompt = buildSystemPrompt();
            if (!systemPrompt) {
                addChatMessage('error', 'Could not build context. Make sure a destination is loaded.');
                return;
            }

            // Track conversation for multi-turn
            chatConversation.push({ role: 'user', content: msg });

            // Disable input while waiting
            document.getElementById('chatSendBtn').disabled = true;
            input.disabled = true;
            addTypingIndicator();

            try {
                // Use higher token limit for itinerary generation
                const modelId = getModelId();
                const maxTokens = modelId.includes('haiku') ? 4096 : 8192;

                var reqBody = {
                    model: modelId,
                    max_tokens: maxTokens,
                    system: systemPrompt,
                    messages: chatConversation.slice(-8) // Keep last 8 messages for multi-turn context
                };
                if (chatWebSearch) {
                    reqBody.tools = [{ type: 'web_search_20250305', name: 'web_search', max_uses: 5 }];
                }

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': chatApiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify(reqBody)
                });

                removeTypingIndicator();

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    if (response.status === 401) {
                        addChatMessage('error', 'Invalid API key. Click "Change API key" below to update it.');
                        chatApiKey = null;
                        try { localStorage.removeItem('japanTrip_apiKey'); } catch(e) {}
                    } else {
                        addChatMessage('error', 'API error: ' + (errData.error?.message || response.status));
                    }
                    chatConversation.pop(); // Remove failed message
                    return;
                }

                const data = await response.json();
                const { text, citations } = parseApiResponse(data);

                if (!text) {
                    addChatMessage('error', 'Empty response from AI.');
                    chatConversation.pop();
                    return;
                }

                // Track assistant response for multi-turn
                chatConversation.push({ role: 'assistant', content: text });

                // Try to parse as JSON (could be day array OR full itinerary object)
                let parsed = null;
                try {
                    let jsonStr = text.trim();
                    if (jsonStr.startsWith('```')) {
                        jsonStr = jsonStr.replace(/^```(?:json)?\n?/, '').replace(/\n?```$/, '').trim();
                    }
                    parsed = JSON.parse(jsonStr);
                } catch(e) {
                    // Not JSON — show as text response with citations
                    var responseHtml = text.replace(/\n/g, '<br>');
                    if (citations.length > 0) {
                        responseHtml += formatCitations(citations);
                    }
                    addChatMessage('assistant', responseHtml);
                    return;
                }

                // MODE 2/3/6: Full itinerary object (has "days" array with nested items)
                if (parsed && parsed.days && Array.isArray(parsed.days) && parsed.days.length > 0) {
                    // Look up coordinates for all items
                    const isMultiDest = parsed.isMultiDestination || false;
                    parsed.days.forEach(function(day) {
                        if (!day.items) day.items = [];
                        day.items.forEach(function(item) {
                            if (!item.coord && item.type !== 'info') {
                                if (isMultiDest && day.destination) {
                                    // Multi-dest: try per-destination lookup first
                                    item.coord = findCoordInDest(item.name, day.destination);
                                    if (!item.coord && parsed.segments) {
                                        // Fallback: check all segment destinations
                                        for (var si = 0; si < parsed.segments.length; si++) {
                                            item.coord = findCoordInDest(item.name, parsed.segments[si].destination);
                                            if (item.coord) break;
                                        }
                                    }
                                }
                                if (!item.coord) item.coord = findCoordForName(item.name);
                            }
                            if (!item.type) item.type = 'sightseeing';
                        });
                    });

                    // Normalize day format (label → day + title) for chat-generated itineraries
                    normalizeItineraryDays({ _chat: parsed });

                    // Store for refinement and saving
                    chatGeneratedItinerary = parsed;
                    lastGeneratedItinerary = parsed;

                    // Build inline itinerary preview in chat
                    let previewHtml = '<div class="chat-itin-preview" style="margin-top:8px;border:1px solid #e5e7eb;border-radius:8px;padding:10px;background:#f9fafb;max-height:400px;overflow-y:auto;">';
                    previewHtml += '<div style="font-size:13px;font-weight:700;color:#333;margin-bottom:8px;">' + escapeHtml(parsed.name || 'Generated Itinerary') + '</div>';
                    parsed.days.forEach(function(day) {
                        previewHtml += '<div style="margin-bottom:8px;padding:6px;background:white;border-radius:6px;border:1px solid #f0f0f0;">';
                        previewHtml += '<div style="font-size:12px;font-weight:600;color:#4B5563;margin-bottom:4px;">Day ' + day.day + ' \u2014 ' + escapeHtml(day.title || '') + '</div>';
                        (day.items || []).forEach(function(item) {
                            var icon = item.type === 'hotel' ? '\ud83c\udfe8' : item.type === 'breakfast' ? '\ud83c\udf73' : item.type === 'lunch' ? '\ud83c\udf5c' : item.type === 'dinner' ? '\ud83c\udf77' : item.type === 'nap' ? '\ud83d\udca4' : item.type === 'optional' ? '\u2728' : '\ud83d\udccd';
                            var coordStatus = item.coord ? '' : ' <span style="color:#F59E0B;font-size:10px;">(no coords)</span>';
                            previewHtml += '<div style="font-size:11px;padding:2px 0;color:#555;"><span style="display:inline-block;min-width:20px;">' + icon + '</span> ' + escapeHtml(item.name) + coordStatus + '</div>';
                        });
                        previewHtml += '</div>';
                    });
                    previewHtml += '</div>';
                    previewHtml += '<div style="margin-top:8px;display:flex;gap:8px;">';
                    previewHtml += '<button class="chat-msg-apply-btn" onclick="saveChatGeneratedItinerary()" style="flex:1;background:#7C3AED;">Save as Itinerary</button>';
                    previewHtml += '</div>';
                    previewHtml += '<div style="margin-top:4px;font-size:10px;color:#9CA3AF;text-align:center;">You can refine this \u2014 just tell me what to change.</div>';

                    addChatMessage('assistant', 'Here\'s your itinerary:' + previewHtml);
                    return;
                }

                // MODE 1: Day schedule change (JSON array of items)
                if (Array.isArray(parsed) && parsed.length > 0) {
                    // Validate and fix coordinates
                    parsed = parsed.map(function(item) {
                        if (!item.coord || !Array.isArray(item.coord)) {
                            item.coord = findCoordForName(item.name);
                        }
                        if (!item.type) item.type = 'sightseeing';
                        return item;
                    });

                    lastAiDayData = parsed;

                    let dayPreviewHtml = '<div class="chat-msg-day-preview">';
                    parsed.forEach(function(item) {
                        var icon = item.type === 'hotel' ? '\ud83c\udfe8' : item.type === 'breakfast' ? '\ud83c\udf73' : item.type === 'lunch' ? '\ud83c\udf5c' : item.type === 'dinner' ? '\ud83c\udf77' : item.type === 'nap' ? '\ud83d\udca4' : item.type === 'optional' ? '\u2728' : '\ud83d\udccd';
                        dayPreviewHtml += '<div class="preview-item"><span class="preview-type">' + icon + ' ' + escapeHtml(item.type) + '</span><span>' + escapeHtml(item.name) + '</span></div>';
                    });
                    dayPreviewHtml += '</div>';
                    dayPreviewHtml += '<button class="chat-msg-apply-btn" onclick="applyAiDay()">Apply this schedule</button>';

                    addChatMessage('assistant', 'Here\'s your updated day:' + dayPreviewHtml);
                    return;
                }

                // Fallback: show as text
                addChatMessage('assistant', text);

            } catch(e) {
                removeTypingIndicator();
                chatConversation.pop(); // Remove failed user message
                if (e.message?.includes('Failed to fetch')) {
                    addChatMessage('error', 'Network error. Check your internet connection.');
                } else {
                    addChatMessage('error', 'Error: ' + e.message);
                }
            } finally {
                document.getElementById('chatSendBtn').disabled = false;
                input.disabled = false;
                input.focus();
            }
        }

        // Save an itinerary generated via chat conversation
        function saveChatGeneratedItinerary() {
            if (!chatGeneratedItinerary) { showCopyToast('No itinerary to save'); return; }

            const isMulti = chatGeneratedItinerary.isMultiDestination;
            const prefix = isMulti ? 'gen_multi_' : 'gen_';
            const genCount = Object.keys(itineraryData).filter(k => k.startsWith(prefix)).length;
            const genKey = prefix + (genCount + 1);
            const colorIdx = genCount % GEN_COLORS.length;

            const itinObj = {
                name: chatGeneratedItinerary.name || (isMulti ? 'Multi-Destination Trip' : 'Chat Itinerary'),
                color: GEN_COLORS[colorIdx],
                days: chatGeneratedItinerary.days,
                isGenerated: true
            };

            if (isMulti) {
                itinObj.isMultiDestination = true;
                itinObj.segments = chatGeneratedItinerary.segments || [];
            }

            itineraryData[genKey] = itinObj;
            originalItineraryData[genKey] = JSON.parse(JSON.stringify(itinObj));

            try {
                const storageKey = isMulti
                    ? 'tripMap_genItin_multi_' + (activeRegion || 'global')
                    : 'tripMap_genItin_' + activeDestination;
                const existing = JSON.parse(localStorage.getItem(storageKey) || '{}');
                existing[genKey] = itinObj;
                localStorage.setItem(storageKey, JSON.stringify(existing));
            } catch(e) {
                console.warn('Could not save generated itinerary to localStorage:', e);
            }

            buildTabsUI();
            selectItinerary(genKey);
            if (currentView !== 'itineraries') switchView('itineraries');

            addChatMessage('system', 'Itinerary saved! Check the new "' + escapeHtml(itinObj.name) + '" tab. You can keep refining it here or in the itinerary view.');
            showCopyToast(isMulti ? 'Multi-destination itinerary created!' : 'Itinerary created!');
        }

        function applyAiDay() {
            if (!lastAiDayData || !currentItinerary || !currentDay) return;

            const itin = itineraryData[currentItinerary];
            const dayData = itin.days.find(d => d.day === currentDay);
            if (!dayData) return;

            // Save each original item for reset capability
            dayData.items.forEach((origItem, idx) => {
                const stateKey = currentItinerary + '_' + currentDay + '_' + idx;
                if (!modifiedState[stateKey]) {
                    modifiedState[stateKey] = {
                        newName: origItem.name,
                        newCoord: origItem.coord,
                        newDesc: '',
                        origName: origItem.name,
                        origCoord: origItem.coord,
                        timestamp: Date.now()
                    };
                }
            });

            // Replace the entire day's items
            dayData.items = lastAiDayData.map(item => ({
                type: item.type || 'sightseeing',
                name: item.name,
                coord: item.coord || null
            }));

            // Update modifiedState for all new items
            dayData.items.forEach((newItem, idx) => {
                const stateKey = currentItinerary + '_' + currentDay + '_' + idx;
                const origDay = originalItineraryData[currentItinerary].days.find(d => d.day === currentDay);
                const origItem = origDay && origDay.items[idx] ? origDay.items[idx] : { name: '', coord: null };
                modifiedState[stateKey] = {
                    newName: newItem.name,
                    newCoord: newItem.coord,
                    newDesc: '',
                    origName: origItem.name,
                    origCoord: origItem.coord,
                    timestamp: Date.now()
                };
            });

            saveModifiedState();
            showItinerary(currentItinerary);

            // Disable the apply button
            const btns = document.querySelectorAll('.chat-msg-apply-btn');
            btns.forEach(btn => {
                btn.disabled = true;
                btn.textContent = '\u2713 Applied!';
            });

            addChatMessage('system', 'Day ' + currentDay + ' updated! You can use the \u21bb Reset button on the day card to revert.');
            lastAiDayData = null;
            updateChatContext();
        }



        // ============================================
        // AI ITINERARY GENERATOR
        // ============================================

        let lastGeneratedItinerary = null;  // Holds preview data before save
        const GEN_COLORS = ['#7C3AED', '#EC4899', '#06B6D4', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#14B8A6'];

        // Travel profile management
        function getTravelProfiles() {
            try { return JSON.parse(localStorage.getItem('tripMap_travelProfiles') || '{}'); } catch(e) { return {}; }
        }

        function populateProfileDropdown() {
            const select = document.getElementById('genProfileSelect');
            const profiles = getTravelProfiles();
            select.innerHTML = '<option value="">— Select a saved profile —</option>';
            Object.keys(profiles).sort().forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                select.appendChild(opt);
            });
            document.getElementById('genProfileDeleteBtn').style.display = 'none';
        }

        function loadTravelProfile() {
            const select = document.getElementById('genProfileSelect');
            const name = select.value;
            const deleteBtn = document.getElementById('genProfileDeleteBtn');
            if (!name) { deleteBtn.style.display = 'none'; return; }
            deleteBtn.style.display = '';
            const profiles = getTravelProfiles();
            const p = profiles[name];
            if (!p) return;
            if (p.days) document.getElementById('genDays').value = p.days;
            if (p.party) document.getElementById('genParty').value = p.party;
            if (p.pace) document.getElementById('genPace').value = p.pace;
            if (p.budget) document.getElementById('genBudget').value = p.budget;
            if (p.constraints !== undefined) document.getElementById('genConstraints').value = p.constraints;
            // Set interests
            document.querySelectorAll('.gen-interest-chip').forEach(chip => {
                if (p.interests && p.interests.includes(chip.dataset.interest)) {
                    chip.classList.add('selected');
                } else {
                    chip.classList.remove('selected');
                }
            });
            if (p.webSearch !== undefined) {
                genWebSearch = p.webSearch;
                const toggle = document.getElementById('genWebSearchToggle');
                if (toggle) toggle.classList.toggle('active', genWebSearch);
            }
        }

        function showSaveProfileRow() {
            document.getElementById('genProfileSaveRow').classList.add('active');
            document.getElementById('genProfileNameInput').focus();
        }

        function hideSaveProfileRow() {
            document.getElementById('genProfileSaveRow').classList.remove('active');
            document.getElementById('genProfileNameInput').value = '';
        }

        function saveTravelProfile() {
            const nameInput = document.getElementById('genProfileNameInput');
            const name = nameInput.value.trim();
            if (!name) { showCopyToast('Please enter a profile name'); return; }
            const profiles = getTravelProfiles();
            profiles[name] = {
                days: parseInt(document.getElementById('genDays').value) || 7,
                party: document.getElementById('genParty').value,
                interests: getSelectedInterests(),
                pace: document.getElementById('genPace').value,
                budget: document.getElementById('genBudget').value,
                constraints: document.getElementById('genConstraints').value.trim(),
                webSearch: genWebSearch || false
            };
            try { localStorage.setItem('tripMap_travelProfiles', JSON.stringify(profiles)); } catch(e) {}
            populateProfileDropdown();
            document.getElementById('genProfileSelect').value = name;
            document.getElementById('genProfileDeleteBtn').style.display = '';
            hideSaveProfileRow();
            showCopyToast('Profile "' + name + '" saved!');
        }

        function deleteTravelProfile() {
            const select = document.getElementById('genProfileSelect');
            const name = select.value;
            if (!name) return;
            if (!confirm('Delete profile "' + name + '"?')) return;
            const profiles = getTravelProfiles();
            delete profiles[name];
            try { localStorage.setItem('tripMap_travelProfiles', JSON.stringify(profiles)); } catch(e) {}
            populateProfileDropdown();
            showCopyToast('Profile deleted');
        }

        // ============================================
        // 3-OPTION ITINERARY MODE SELECTOR
        // ============================================

        let currentItinMode = 'menu'; // 'menu', 'curated', 'generate', 'builder'

        function selectItinMode(mode) {
            currentItinMode = mode;
            const selector = document.getElementById('itinModeSelector');
            const curated = document.getElementById('itinCuratedView');
            const generate = document.getElementById('itinGenerateView');
            const builder = document.getElementById('itinBuilderView');
            const itinView = document.getElementById('itinerariesView');
            const catView = document.getElementById('categoriesView');

            // Hide all sub-views
            if (selector) selector.style.display = 'none';
            if (curated) curated.style.display = 'none';
            if (generate) generate.style.display = 'none';
            if (builder) builder.style.display = 'none';
            if (itinView) itinView.style.display = 'none';

            if (mode === 'menu') {
                if (selector) selector.style.display = '';
                if (catView) catView.style.display = 'none';
                clearItineraryMarkers();
            } else if (mode === 'curated') {
                if (curated) curated.style.display = '';
                if (itinView) itinView.style.display = '';
                if (catView) catView.style.display = 'none';
                buildTabsUI();
                if (!currentItinerary) selectItinerary('a');
            } else if (mode === 'generate') {
                if (generate) generate.style.display = '';
                if (catView) catView.style.display = 'none';
                renderInlineGenerator('inlineGenContainer');
            } else if (mode === 'builder') {
                if (builder) builder.style.display = '';
                if (catView) catView.style.display = 'none';
                initStepBuilder('stepBuilderContainer');
            }
        }

        function selectMobileItinMode(mode) {
            currentItinMode = mode;
            const selector = document.getElementById('mobileItinModeSelector');
            const curated = document.getElementById('mobileCuratedView');
            const generate = document.getElementById('mobileGenerateView');
            const builder = document.getElementById('mobileBuilderView');
            const header = document.getElementById('mobileTripsHeader');
            const actions = document.getElementById('mobileTripsActions');
            const panel = document.getElementById('mobileTripsPanel');

            // Hide all sub-views
            if (selector) selector.style.display = 'none';
            if (curated) curated.style.display = 'none';
            if (generate) generate.style.display = 'none';
            if (builder) builder.style.display = 'none';

            if (mode === 'menu') {
                if (selector) selector.style.display = '';
                if (actions) actions.style.display = '';
                if (panel) { panel.classList.remove('sheet-expanded'); panel.classList.add('sheet-half'); }
                clearItineraryMarkers();
            } else if (mode === 'curated') {
                if (curated) curated.style.display = 'flex';
                if (actions) actions.style.display = '';
                if (panel) { panel.classList.remove('sheet-half'); panel.classList.add('sheet-expanded'); }
                buildMobileItinTabs();
                renderMobileItinContent();
                if (!currentItinerary) selectItinerary('a');
            } else if (mode === 'generate') {
                if (generate) generate.style.display = 'flex';
                if (actions) actions.style.display = 'none';
                // Expand the sheet for the form
                if (panel) { panel.classList.remove('sheet-half'); panel.classList.add('sheet-expanded'); }
                renderInlineGenerator('mobileInlineGenContainer');
            } else if (mode === 'builder') {
                if (builder) builder.style.display = 'flex';
                if (actions) actions.style.display = 'none';
                // Expand for builder wizard
                if (panel) { panel.classList.remove('sheet-half'); panel.classList.add('sheet-expanded'); }
                initStepBuilder('mobileStepBuilderContainer');
            }
        }

        function confirmExitBuilder(platform) {
            if (stepBuilderState && stepBuilderState.totalDays > 0) {
                if (!confirm('You have a builder draft in progress. Leave and save your draft?')) return;
                saveBuilderDraft();
            }
            if (platform === 'mobile') {
                selectMobileItinMode('menu');
            } else {
                selectItinMode('menu');
            }
        }

        // ============================================
        // INLINE GENERATOR (Option 2)
        // ============================================

        function renderInlineGenerator(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const dest = destinations[activeDestination];
            const destLabel = dest ? dest.name : (activeDestination || 'this destination');

            container.innerHTML = `
                <div class="gen-modal-title">Generate Custom Itinerary</div>
                <div class="gen-modal-subtitle" id="inlineGenDestLabel">for ${escapeHtml(destLabel)}</div>
                <div class="gen-profile-bar">
                    <select class="gen-profile-select" id="genProfileSelect" onchange="loadTravelProfile()">
                        <option value="">— Select a saved profile —</option>
                    </select>
                    <button class="gen-profile-btn" onclick="showSaveProfileRow()">Save</button>
                    <button class="gen-profile-btn danger" id="genProfileDeleteBtn" onclick="deleteTravelProfile()" style="display:none;">Del</button>
                </div>
                <div class="gen-profile-save-row" id="genProfileSaveRow">
                    <input class="gen-profile-save-input" id="genProfileNameInput" placeholder="Profile name, e.g. 'Family with toddler'" />
                    <button class="gen-profile-btn" onclick="saveTravelProfile()">Save</button>
                    <button class="gen-profile-btn" onclick="hideSaveProfileRow()">Cancel</button>
                </div>
                <div class="gen-field">
                    <label>Trip Type</label>
                    <div style="display:flex;gap:6px;margin-bottom:8px;">
                        <button class="toggle-btn active" id="genTypeSingle" onclick="setGenTripType('single')" style="flex:1;padding:6px;font-size:11px;">Single Destination</button>
                        <button class="toggle-btn" id="genTypeMulti" onclick="setGenTripType('multi')" style="flex:1;padding:6px;font-size:11px;">Multi-Destination</button>
                    </div>
                </div>
                <div class="gen-field" id="genSingleDaysField">
                    <label>Trip Duration (days)</label>
                    <input type="number" id="genDays" min="2" max="21" value="7" />
                </div>
                <div class="gen-field" id="genMultiDestField" style="display:none;">
                    <label>Destinations & Days</label>
                    <div id="genSegmentsList"></div>
                    <button onclick="addGenSegment()" style="width:100%;padding:6px;font-size:11px;border:1px dashed #d1d5db;border-radius:6px;background:white;cursor:pointer;color:#6b7280;margin-top:6px;">+ Add Destination</button>
                    <div id="genMultiTotalDays" style="font-size:11px;color:#6b7280;margin-top:4px;"></div>
                </div>
                <div class="gen-field">
                    <label>Travel Party</label>
                    <select id="genParty">
                        <option value="couple">Couple</option>
                        <option value="family-toddler">Family with toddler (under 4)</option>
                        <option value="family-kids">Family with kids (4-12)</option>
                        <option value="family-teens">Family with teens</option>
                        <option value="solo">Solo traveler</option>
                        <option value="friends">Group of friends</option>
                    </select>
                </div>
                <div class="gen-field">
                    <label>Interests (click to select)</label>
                    <div class="gen-interests" id="genInterests">
                        <span class="gen-interest-chip selected" data-interest="food">Food &amp; Dining</span>
                        <span class="gen-interest-chip" data-interest="culture">Culture &amp; History</span>
                        <span class="gen-interest-chip" data-interest="adventure">Adventure</span>
                        <span class="gen-interest-chip" data-interest="shopping">Shopping</span>
                        <span class="gen-interest-chip" data-interest="relaxation">Relaxation</span>
                        <span class="gen-interest-chip" data-interest="nightlife">Nightlife</span>
                        <span class="gen-interest-chip" data-interest="nature">Nature &amp; Outdoors</span>
                        <span class="gen-interest-chip" data-interest="photography">Photography</span>
                        <span class="gen-interest-chip" data-interest="art">Art &amp; Design</span>
                        <span class="gen-interest-chip" data-interest="kid-friendly">Kid-Friendly</span>
                    </div>
                </div>
                <div class="gen-field">
                    <label>Pace</label>
                    <select id="genPace">
                        <option value="slow">Slow &amp; relaxed (lots of downtime)</option>
                        <option value="moderate" selected>Moderate (balanced)</option>
                        <option value="fast">Fast-paced (pack it all in)</option>
                    </select>
                </div>
                <div class="gen-field">
                    <label>Budget</label>
                    <select id="genBudget">
                        <option value="budget">Budget-friendly</option>
                        <option value="moderate" selected>Moderate</option>
                        <option value="luxury">Luxury</option>
                    </select>
                </div>
                <div class="gen-field">
                    <label>Special requests or constraints (optional)</label>
                    <textarea id="genConstraints" placeholder="e.g., 'We need nap time 1-3pm', 'vegetarian', 'mobility issues'"></textarea>
                </div>
                <div class="gen-field" style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                    <span style="font-size:11px; font-weight:600; color:#555;">Web search for current info</span>
                    <div class="web-search-toggle">
                        <button class="web-search-switch" id="genWebSearchToggle" onclick="toggleGenWebSearch()" title="Enable web search"></button>
                    </div>
                </div>
                <div id="genPreviewArea" style="display:none;"></div>
                <div id="genError" style="display:none; color:#DC2626; font-size:12px; margin-top:8px; padding:8px; background:#FEF2F2; border-radius:8px;"></div>
                <button class="gen-btn primary gen-generate-btn" id="genSubmitBtn" onclick="submitGeneratorForm()">Generate Itinerary</button>
                <div class="gen-actions">
                    <button class="gen-btn primary" id="genSaveBtn" onclick="saveGeneratedItineraryInline()" style="display:none;">Save &amp; Load Itinerary</button>
                </div>
            `;

            // Initialize profile dropdown and web search state
            populateProfileDropdown();
            hideSaveProfileRow();
            genWebSearch = false;
            const wsToggle = document.getElementById('genWebSearchToggle');
            if (wsToggle) wsToggle.classList.remove('active');
            lastGeneratedItinerary = null;
        }

        function saveGeneratedItineraryInline() {
            saveGeneratedItinerary();
            // After saving, switch to curated mode to show the new itinerary
            if (isMobile()) {
                selectMobileItinMode('curated');
            } else {
                selectItinMode('curated');
            }
        }

        // ============================================
        // STEP-BY-STEP BUILDER (Option 3)
        // ============================================

        let stepBuilderState = {
            totalDays: 0,
            arrival: { time: '', flightNo: '', station: '' },
            departure: { time: '', flightNo: '', station: '' },
            hotels: [],       // [{name, coord, nights, startDay, desc}]
            days: [],         // [{day, hotel, slots: [{type, name, coord, source}]}]
            currentStep: 0,
            destination: ''
        };

        let activeBuilderContainer = null;

        function getBuilderDraftKey() {
            return 'tripMap_stepBuilder_' + (activeDestination || 'default');
        }

        function saveBuilderDraft() {
            try {
                localStorage.setItem(getBuilderDraftKey(), JSON.stringify(stepBuilderState));
            } catch(e) { console.warn('Could not save builder draft:', e); }
        }

        function loadBuilderDraft() {
            try {
                const saved = localStorage.getItem(getBuilderDraftKey());
                if (saved) return JSON.parse(saved);
            } catch(e) {}
            return null;
        }

        function clearBuilderDraft() {
            try { localStorage.removeItem(getBuilderDraftKey()); } catch(e) {}
        }

        function resetBuilderState() {
            stepBuilderState = {
                totalDays: 0,
                arrival: { time: '', flightNo: '', station: '' },
                departure: { time: '', flightNo: '', station: '' },
                hotels: [],
                days: [],
                currentStep: 0,
                destination: activeDestination || ''
            };
        }

        function initStepBuilder(containerId) {
            activeBuilderContainer = containerId;
            const draft = loadBuilderDraft();

            if (draft && draft.totalDays > 0 && draft.destination === activeDestination) {
                // Show resume prompt
                const container = document.getElementById(containerId);
                if (!container) return;
                container.innerHTML = `
                    <div class="step-draft-prompt">
                        <p><strong>You have a saved draft</strong> — ${draft.totalDays}-day trip with ${draft.hotels.length} hotel(s) and ${draft.days.filter(d => d.slots.some(s => s.name)).length} days planned.</p>
                        <div class="step-draft-prompt-actions">
                            <button class="step-draft-resume" onclick="resumeBuilderDraft()">Resume Draft</button>
                            <button class="step-draft-new" onclick="startFreshBuilder()">Start Fresh</button>
                        </div>
                    </div>
                `;
            } else {
                startFreshBuilder();
            }
        }

        function resumeBuilderDraft() {
            const draft = loadBuilderDraft();
            if (draft) {
                stepBuilderState = draft;
            }
            renderBuilderStep(stepBuilderState.currentStep);
        }

        function startFreshBuilder() {
            resetBuilderState();
            clearBuilderDraft();
            renderBuilderStep(0);
        }

        function getTotalBuilderSteps() {
            // Steps: 0=setup, 1=arrival, 2=departure, 3=hotels, 4...(3+totalDays)=day planning, last=review
            return 3 + stepBuilderState.totalDays + 1 + 1; // setup + arrival + departure + hotels + days + review
        }

        function renderBuilderProgress(currentStep) {
            const total = getTotalBuilderSteps();
            let html = '';
            for (let i = 0; i < total; i++) {
                if (i > 0) {
                    html += '<div class="step-line' + (i <= currentStep ? ' completed' : '') + '"></div>';
                }
                let label = '';
                if (i === 0) label = '1';
                else if (i === 1) label = '✈';
                else if (i === 2) label = '✈';
                else if (i === 3) label = '🏨';
                else if (i < total - 1) label = 'D' + (i - 3);
                else label = '✓';

                const isCompleted = i < currentStep;
                const isActive = i === currentStep;
                html += '<div class="step-dot' + (isActive ? ' active' : '') + (isCompleted ? ' completed' : '') + '" onclick="navigateBuilderStep(' + i + ')">' + (isCompleted ? '' : label) + '</div>';
            }
            return html;
        }

        function navigateBuilderStep(step) {
            // Only allow navigating to completed steps or the current step
            if (step <= stepBuilderState.currentStep || step === stepBuilderState.currentStep) {
                renderBuilderStep(step);
            }
        }

        function renderBuilderStep(step) {
            const container = document.getElementById(activeBuilderContainer);
            if (!container) return;

            stepBuilderState.currentStep = step;

            let html = '<div class="step-builder-progress">' + renderBuilderProgress(step) + '</div>';

            if (step === 0) {
                html += renderBuilderSetup();
            } else if (step === 1) {
                html += renderBuilderArrival();
            } else if (step === 2) {
                html += renderBuilderDeparture();
            } else if (step === 3) {
                html += renderBuilderHotels();
            } else if (step >= 4 && step < 4 + stepBuilderState.totalDays) {
                html += renderBuilderDay(step - 3); // day 1, 2, 3...
            } else {
                html += renderBuilderReview();
            }

            container.innerHTML = html;
            saveBuilderDraft();
        }

        function builderNext() {
            const nextStep = stepBuilderState.currentStep + 1;
            // If moving past setup, initialize days array
            if (stepBuilderState.currentStep === 0) {
                const daysInput = document.getElementById('builderDaysInput');
                if (daysInput) {
                    stepBuilderState.totalDays = Math.max(2, Math.min(21, parseInt(daysInput.value) || 7));
                }
                // Initialize days array
                stepBuilderState.days = [];
                for (let i = 1; i <= stepBuilderState.totalDays; i++) {
                    stepBuilderState.days.push({
                        day: i,
                        hotel: '',
                        slots: [
                            { type: 'breakfast', name: '', coord: null, source: '' },
                            { type: 'morning', name: '', coord: null, source: '' },
                            { type: 'lunch', name: '', coord: null, source: '' },
                            { type: 'afternoon', name: '', coord: null, source: '' },
                            { type: 'dinner', name: '', coord: null, source: '' }
                        ]
                    });
                }
            }
            // Save arrival/departure data
            if (stepBuilderState.currentStep === 1) {
                const t = document.getElementById('builderArrivalTime');
                const f = document.getElementById('builderArrivalFlight');
                const s = document.getElementById('builderArrivalStation');
                if (t) stepBuilderState.arrival.time = t.value;
                if (f) stepBuilderState.arrival.flightNo = f.value;
                if (s) stepBuilderState.arrival.station = s.value;
            }
            if (stepBuilderState.currentStep === 2) {
                const t = document.getElementById('builderDepartureTime');
                const f = document.getElementById('builderDepartureFlight');
                const s = document.getElementById('builderDepartureStation');
                if (t) stepBuilderState.departure.time = t.value;
                if (f) stepBuilderState.departure.flightNo = f.value;
                if (s) stepBuilderState.departure.station = s.value;
            }
            renderBuilderStep(nextStep);
        }

        function builderPrev() {
            if (stepBuilderState.currentStep > 0) {
                renderBuilderStep(stepBuilderState.currentStep - 1);
            }
        }

        // Step 0: Trip Setup
        function renderBuilderSetup() {
            const dest = destinations[activeDestination];
            const destName = dest ? dest.name : activeDestination;
            return `
                <div class="step-builder-title">Trip Setup</div>
                <div class="step-builder-subtitle">Plan your trip to ${escapeHtml(destName)}</div>
                <div class="step-builder-field">
                    <label>How many days is your trip?</label>
                    <input type="number" id="builderDaysInput" min="2" max="21" value="${stepBuilderState.totalDays || 7}" />
                </div>
                <div class="step-builder-nav">
                    <button class="step-nav-next" onclick="builderNext()">Next →</button>
                </div>
            `;
        }

        // Step 1: Arrival Info
        function renderBuilderArrival() {
            return `
                <div class="step-builder-title">Arrival Information</div>
                <div class="step-builder-subtitle">When and how are you arriving?</div>
                <div class="step-builder-field">
                    <label>Arrival Time</label>
                    <input type="time" id="builderArrivalTime" value="${stepBuilderState.arrival.time || ''}" />
                </div>
                <div class="step-builder-field">
                    <label>Flight / Train Number (optional)</label>
                    <input type="text" id="builderArrivalFlight" placeholder="e.g., AA123 or Shinkansen Nozomi 7" value="${escapeHtml(stepBuilderState.arrival.flightNo || '')}" />
                </div>
                <div class="step-builder-field">
                    <label>Airport / Station</label>
                    <input type="text" id="builderArrivalStation" placeholder="e.g., NRT, Haneda, Roma Termini" value="${escapeHtml(stepBuilderState.arrival.station || '')}" />
                </div>
                <div class="step-builder-nav">
                    <button class="step-nav-prev" onclick="builderPrev()">← Back</button>
                    <button class="step-nav-next" onclick="builderNext()">Next →</button>
                </div>
            `;
        }

        // Step 2: Departure Info
        function renderBuilderDeparture() {
            return `
                <div class="step-builder-title">Departure Information</div>
                <div class="step-builder-subtitle">When and how are you leaving?</div>
                <div class="step-builder-field">
                    <label>Departure Time</label>
                    <input type="time" id="builderDepartureTime" value="${stepBuilderState.departure.time || ''}" />
                </div>
                <div class="step-builder-field">
                    <label>Flight / Train Number (optional)</label>
                    <input type="text" id="builderDepartureFlight" placeholder="e.g., UA456" value="${escapeHtml(stepBuilderState.departure.flightNo || '')}" />
                </div>
                <div class="step-builder-field">
                    <label>Airport / Station</label>
                    <input type="text" id="builderDepartureStation" placeholder="e.g., FCO, Tokyo Station" value="${escapeHtml(stepBuilderState.departure.station || '')}" />
                </div>
                <div class="step-builder-nav">
                    <button class="step-nav-prev" onclick="builderPrev()">← Back</button>
                    <button class="step-nav-next" onclick="builderNext()">Next →</button>
                </div>
            `;
        }

        // Step 3: Hotel Selection
        function renderBuilderHotels() {
            const assignedNights = stepBuilderState.hotels.reduce((sum, h) => sum + (h.nights || 0), 0);
            const remaining = stepBuilderState.totalDays - assignedNights;

            let hotelsHtml = '';
            stepBuilderState.hotels.forEach((h, idx) => {
                hotelsHtml += `
                    <div class="step-hotel-entry">
                        <div>
                            <div class="hotel-name">🏨 ${escapeHtml(h.name)}</div>
                            <div class="hotel-nights">Nights ${h.startDay}–${h.startDay + h.nights - 1} (${h.nights} night${h.nights > 1 ? 's' : ''})</div>
                        </div>
                        <button class="hotel-remove" onclick="removeBuilderHotel(${idx})">×</button>
                    </div>
                `;
            });

            let pickerHtml = '';
            if (remaining > 0) {
                pickerHtml = `
                    <div style="margin-top:10px; padding:10px; background:#f0fdf4; border:1px solid #bbf7d0; border-radius:8px;">
                        <div style="font-size:12px; font-weight:600; color:#166534; margin-bottom:8px;">
                            ${assignedNights === 0 ? 'Select your hotel' : 'Select your next hotel'} (${remaining} night${remaining > 1 ? 's' : ''} remaining)
                        </div>
                        <div class="step-builder-field" style="margin-bottom:8px;">
                            <label>Number of nights at this hotel</label>
                            <input type="number" id="builderHotelNights" min="1" max="${remaining}" value="${remaining}" class="step-nights-input" style="width:100%;" />
                        </div>
                        <input class="step-poi-search" id="builderHotelSearch" placeholder="Search hotels..." oninput="filterBuilderHotels()" />
                        <div class="step-poi-list" id="builderHotelList"></div>
                    </div>
                `;
            }

            const canProceed = remaining === 0;

            return `
                <div class="step-builder-title">Hotel Selection</div>
                <div class="step-builder-subtitle">Where are you staying? (${stepBuilderState.totalDays} nights total)</div>
                ${hotelsHtml}
                ${pickerHtml}
                <div class="step-builder-nav">
                    <button class="step-nav-prev" onclick="builderPrev()">← Back</button>
                    <button class="step-nav-next" onclick="builderNext()" ${canProceed ? '' : 'disabled'}>Next →</button>
                </div>
            `;
        }

        // Store hotels data for delegation
        let _builderHotelItems = [];

        function populateBuilderHotelList(filter) {
            const listEl = document.getElementById('builderHotelList');
            if (!listEl) return;

            const q = (filter || '').toLowerCase();
            _builderHotelItems = [];
            let html = '';
            let idx = 0;
            hotels.forEach(h => {
                if (q && !h.name.toLowerCase().includes(q) && !(h.desc || '').toLowerCase().includes(q)) return;
                const poiInfo = lookupPoi(h.name);
                const tags = (poiInfo.tags || []).slice(0, 3);
                const tagsHtml = tags.map(t => '<span class="step-poi-tag">' + escapeHtml(t) + '</span>').join('');
                _builderHotelItems.push({ name: h.name, coord: h.coord || null, desc: h.desc || '' });
                html += '<div class="step-poi-item" data-hotel-idx="' + idx + '">' +
                    '<div class="step-poi-name">' + escapeHtml(h.name) + '</div>' +
                    (h.desc ? '<div class="step-poi-desc">' + escapeHtml(h.desc) + '</div>' : '') +
                    (tagsHtml ? '<div class="step-poi-tags">' + tagsHtml + '</div>' : '') +
                    '</div>';
                idx++;
            });
            if (!html) html = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:12px;">No hotels found</div>';
            listEl.innerHTML = html;

            // Event delegation for hotel clicks
            listEl.onclick = function(e) {
                const item = e.target.closest('.step-poi-item[data-hotel-idx]');
                if (!item) return;
                const i = parseInt(item.dataset.hotelIdx);
                const h = _builderHotelItems[i];
                if (h) selectBuilderHotel(h.name, h.coord, h.desc);
            };
        }

        function filterBuilderHotels() {
            const search = document.getElementById('builderHotelSearch');
            populateBuilderHotelList(search ? search.value : '');
        }

        function selectBuilderHotel(name, coord, desc) {
            const nightsInput = document.getElementById('builderHotelNights');
            const assignedNights = stepBuilderState.hotels.reduce((sum, h) => sum + (h.nights || 0), 0);
            const remaining = stepBuilderState.totalDays - assignedNights;
            const nights = Math.max(1, Math.min(remaining, parseInt(nightsInput ? nightsInput.value : remaining) || remaining));
            const startDay = assignedNights + 1;

            stepBuilderState.hotels.push({ name, coord, nights, startDay, desc: desc || '' });

            // Auto-assign hotels to days
            assignHotelsToDays();

            renderBuilderStep(3); // Re-render hotels step
        }

        function removeBuilderHotel(idx) {
            stepBuilderState.hotels.splice(idx);
            // Recalculate startDays
            let dayCounter = 1;
            stepBuilderState.hotels.forEach(h => {
                h.startDay = dayCounter;
                dayCounter += h.nights;
            });
            assignHotelsToDays();
            renderBuilderStep(3);
        }

        function assignHotelsToDays() {
            stepBuilderState.days.forEach((day, i) => {
                day.hotel = '';
                for (const h of stepBuilderState.hotels) {
                    if (i + 1 >= h.startDay && i + 1 < h.startDay + h.nights) {
                        day.hotel = h.name;
                        break;
                    }
                }
            });
        }

        // After hotel step renders, populate the list
        const _origRenderBuilderStep = renderBuilderStep;
        renderBuilderStep = function(step) {
            _origRenderBuilderStep(step);
            // After render, populate hotel list if on hotels step
            if (step === 3) {
                setTimeout(() => populateBuilderHotelList(''), 10);
            }
        };

        // Day Planning (Steps 4+)
        function renderBuilderDay(dayNum) {
            const dayData = stepBuilderState.days[dayNum - 1];
            if (!dayData) return '<div>Invalid day</div>';

            const isFirstDay = dayNum === 1;
            const isLastDay = dayNum === stepBuilderState.totalDays;
            const hotelName = dayData.hotel || 'Not assigned';
            const arrivalTime = stepBuilderState.arrival.time;
            const departureTime = stepBuilderState.departure.time;

            let contextNote = '';
            if (isFirstDay && arrivalTime) {
                const hour = parseInt(arrivalTime.split(':')[0]);
                if (hour >= 17) contextNote = 'Arriving in the evening — focus on dinner and settling in';
                else if (hour >= 12) contextNote = 'Arriving in the afternoon — plan for afternoon and evening';
                else contextNote = 'Arriving in the morning — full day available';
            }
            if (isLastDay && departureTime) {
                const hour = parseInt(departureTime.split(':')[0]);
                if (hour <= 10) contextNote = 'Early departure — limited morning activities';
                else if (hour <= 14) contextNote = 'Midday departure — morning activities only';
                else contextNote = 'Afternoon departure — morning and early afternoon available';
            }

            const slotIcons = {
                breakfast: '🍳', morning: '🌅', lunch: '🍽️',
                afternoon: '🏛️', dinner: '🌙'
            };
            const slotLabels = {
                breakfast: 'Breakfast', morning: 'Morning Activity',
                lunch: 'Lunch', afternoon: 'Afternoon Activity', dinner: 'Dinner'
            };

            let slotsHtml = '<div class="step-day-slots">';
            dayData.slots.forEach((slot, idx) => {
                const icon = slotIcons[slot.type] || '📌';
                const label = slotLabels[slot.type] || slot.type;
                const filled = slot.name ? true : false;
                slotsHtml += `
                    <div class="step-day-slot${filled ? ' filled' : ''}">
                        <div class="slot-icon">${icon}</div>
                        <div class="slot-info">
                            <div class="slot-label">${label}</div>
                            <div class="slot-content${filled ? '' : ' empty'}">${filled ? escapeHtml(slot.name) : 'Tap to choose...'}</div>
                        </div>
                        <div class="slot-actions">
                            ${filled ? '<button class="slot-clear-btn" onclick="clearBuilderSlot(' + dayNum + ',' + idx + ')">×</button>' : ''}
                            <button class="slot-choose-btn" onclick="openBuilderPoiPicker(${dayNum}, ${idx})">${filled ? 'Change' : 'Choose'}</button>
                        </div>
                    </div>
                `;
            });
            slotsHtml += '</div>';

            return `
                <div class="step-day-header">
                    <div>
                        <div class="day-label">Day ${dayNum}</div>
                        <div class="day-hotel">🏨 ${escapeHtml(hotelName)}</div>
                    </div>
                    ${isFirstDay && arrivalTime ? '<div style="font-size:11px;color:#6b7280;">Arriving ' + arrivalTime + '</div>' : ''}
                    ${isLastDay && departureTime ? '<div style="font-size:11px;color:#6b7280;">Departing ' + departureTime + '</div>' : ''}
                </div>
                ${contextNote ? '<div style="font-size:11px;color:#D97706;background:#FFFBEB;padding:6px 10px;border-radius:6px;margin-bottom:8px;">💡 ' + contextNote + '</div>' : ''}
                ${slotsHtml}
                <button class="step-ai-recommend-btn" id="builderAiBtn" onclick="requestAIDayPlan(${dayNum})">
                    ✨ AI Recommend Full Day
                </button>
                <div class="step-builder-nav">
                    <button class="step-nav-prev" onclick="builderPrev()">← Back</button>
                    <button class="step-nav-next" onclick="builderNext()">Next →</button>
                </div>
            `;
        }

        function clearBuilderSlot(dayNum, slotIdx) {
            const day = stepBuilderState.days[dayNum - 1];
            if (day && day.slots[slotIdx]) {
                day.slots[slotIdx].name = '';
                day.slots[slotIdx].coord = null;
                day.slots[slotIdx].source = '';
            }
            renderBuilderStep(stepBuilderState.currentStep);
        }

        // POI Picker for builder
        let builderPickerCallback = null;

        function openBuilderPoiPicker(dayNum, slotIdx) {
            const day = stepBuilderState.days[dayNum - 1];
            if (!day) return;
            const slot = day.slots[slotIdx];
            if (!slot) return;

            const slotType = slot.type;
            // Determine which POIs to show
            let pois = [];
            if (slotType === 'breakfast' || slotType === 'lunch' || slotType === 'dinner') {
                pois = restaurants.map(r => ({ name: r.name, desc: r.desc, coord: r.coord, category: 'restaurants' }));
            } else if (slotType === 'morning' || slotType === 'afternoon') {
                pois = [
                    ...experiences.map(e => ({ name: e.name, desc: e.desc, coord: e.coord, category: 'experiences' })),
                    ...(typeof kidFriendly !== 'undefined' ? kidFriendly : []).map(k => ({ name: k.name, desc: k.desc, coord: k.coord, category: 'kidFriendly' })),
                    ...(typeof markets !== 'undefined' ? markets : []).map(m => ({ name: m.name, desc: m.desc, coord: m.coord, category: 'markets' }))
                ];
            }

            // Build picker HTML in an overlay within the builder container
            const container = document.getElementById(activeBuilderContainer);
            if (!container) return;

            const slotLabels = {
                breakfast: 'Breakfast', morning: 'Morning Activity',
                lunch: 'Lunch', afternoon: 'Afternoon Activity', dinner: 'Dinner'
            };

            let html = `
                <div id="builderPoiPickerOverlay" style="margin-bottom:12px;">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
                        <div style="font-size:13px;font-weight:700;color:#111;">Choose ${slotLabels[slotType] || slotType}</div>
                        <button onclick="closeBuilderPoiPicker(${dayNum})" style="background:none;border:none;font-size:18px;color:#9ca3af;cursor:pointer;">&times;</button>
                    </div>
                    <input class="step-poi-search" id="builderPoiSearch" placeholder="Search..." oninput="filterBuilderPois()" />
                    <div class="step-poi-list" id="builderPoiList"></div>
                </div>
            `;

            // Store pois globally for filtering
            window._builderPickerPois = pois;
            window._builderPickerDayNum = dayNum;
            window._builderPickerSlotIdx = slotIdx;

            // Insert picker at top of container
            const pickerDiv = document.createElement('div');
            pickerDiv.id = 'builderPoiPickerWrapper';
            pickerDiv.innerHTML = html;
            container.insertBefore(pickerDiv, container.firstChild);

            // Populate
            populateBuilderPoiList('');
        }

        // Store filtered POIs for delegation
        let _builderPoiItems = [];

        function populateBuilderPoiList(filter) {
            const listEl = document.getElementById('builderPoiList');
            if (!listEl) return;
            const pois = window._builderPickerPois || [];
            const q = (filter || '').toLowerCase();

            _builderPoiItems = [];
            let html = '';
            let idx = 0;
            pois.forEach(p => {
                if (q && !p.name.toLowerCase().includes(q) && !(p.desc || '').toLowerCase().includes(q)) return;
                const poiInfo = lookupPoi(p.name);
                const tags = (poiInfo.tags || []).slice(0, 3);
                const tagsHtml = tags.map(t => '<span class="step-poi-tag">' + escapeHtml(t) + '</span>').join('');
                _builderPoiItems.push({ name: p.name, coord: p.coord || null });
                html += '<div class="step-poi-item" data-poi-idx="' + idx + '">' +
                    '<div class="step-poi-name">' + escapeHtml(p.name) + '</div>' +
                    (p.desc ? '<div class="step-poi-desc">' + escapeHtml(p.desc) + '</div>' : '') +
                    (tagsHtml ? '<div class="step-poi-tags">' + tagsHtml + '</div>' : '') +
                    '</div>';
                idx++;
            });
            if (!html) html = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:12px;">No results found</div>';
            listEl.innerHTML = html;

            // Event delegation for POI clicks
            listEl.onclick = function(e) {
                const item = e.target.closest('.step-poi-item[data-poi-idx]');
                if (!item) return;
                const i = parseInt(item.dataset.poiIdx);
                const p = _builderPoiItems[i];
                if (p) selectBuilderPoi(p.name, p.coord);
            };
        }

        function filterBuilderPois() {
            const search = document.getElementById('builderPoiSearch');
            populateBuilderPoiList(search ? search.value : '');
        }

        function selectBuilderPoi(name, coord) {
            const dayNum = window._builderPickerDayNum;
            const slotIdx = window._builderPickerSlotIdx;
            const day = stepBuilderState.days[dayNum - 1];
            if (day && day.slots[slotIdx]) {
                day.slots[slotIdx].name = name;
                day.slots[slotIdx].coord = coord;
                day.slots[slotIdx].source = 'manual';
            }
            closeBuilderPoiPicker(dayNum);
        }

        function closeBuilderPoiPicker(dayNum) {
            const wrapper = document.getElementById('builderPoiPickerWrapper');
            if (wrapper) wrapper.remove();
            window._builderPickerPois = null;
            // Re-render the day step
            renderBuilderStep(stepBuilderState.currentStep);
        }

        // AI Day Recommendation
        async function requestAIDayPlan(dayNum) {
            const btn = document.getElementById('builderAiBtn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="gen-spinner"></span> Generating recommendations...';
            }

            if (!chatApiKey) {
                chatApiKey = localStorage.getItem('tripMap_apiKey') || localStorage.getItem('japanTrip_apiKey');
            }
            if (!chatApiKey) {
                showCopyToast('API key required — open the Chat panel first to set it up');
                if (btn) { btn.disabled = false; btn.innerHTML = '✨ AI Recommend Full Day'; }
                return;
            }

            const dayData = stepBuilderState.days[dayNum - 1];
            if (!dayData) return;

            const dest = destinations[activeDestination];
            const destName = dest ? dest.name : activeDestination;
            const hotelName = dayData.hotel || 'not specified';
            const isFirstDay = dayNum === 1;
            const isLastDay = dayNum === stepBuilderState.totalDays;

            // Build available POIs list
            const restaurantNames = restaurants.slice(0, 40).map(r => r.name + (r.desc ? ' (' + r.desc + ')' : ''));
            const activityNames = [
                ...experiences.slice(0, 30).map(e => e.name + (e.desc ? ' (' + e.desc + ')' : '')),
                ...(typeof kidFriendly !== 'undefined' ? kidFriendly.slice(0, 15) : []).map(k => k.name + (k.desc ? ' (' + k.desc + ')' : ''))
            ];

            let timeContext = '';
            if (isFirstDay && stepBuilderState.arrival.time) {
                timeContext = 'Arriving at ' + stepBuilderState.arrival.time + ' at ' + (stepBuilderState.arrival.station || 'airport/station') + '. ';
            }
            if (isLastDay && stepBuilderState.departure.time) {
                timeContext += 'Departing at ' + stepBuilderState.departure.time + ' from ' + (stepBuilderState.departure.station || 'airport/station') + '. ';
            }

            const systemPrompt = `You are a travel planner for ${destName}. Generate a day plan for Day ${dayNum} of a ${stepBuilderState.totalDays}-day trip.
Hotel: ${hotelName}
${timeContext}

Available restaurants (pick from these for meals):
${restaurantNames.join('\n')}

Available activities/sightseeing (pick from these):
${activityNames.join('\n')}

Return ONLY a JSON object with this exact format:
{
  "slots": [
    {"type": "breakfast", "name": "exact restaurant name from list"},
    {"type": "morning", "name": "exact activity name from list"},
    {"type": "lunch", "name": "exact restaurant name from list"},
    {"type": "afternoon", "name": "exact activity name from list"},
    {"type": "dinner", "name": "exact restaurant name from list"}
  ]
}

IMPORTANT: Use EXACT names from the provided lists. If it's the arrival day with a late arrival, you can leave early slots with name="" and focus on evening. If it's a departure day with early departure, leave later slots empty.`;

            try {
                const modelId = (typeof getModelId === 'function') ? getModelId() : 'claude-sonnet-4-5-20250929';
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': chatApiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: modelId,
                        max_tokens: 1024,
                        system: systemPrompt,
                        messages: [{ role: 'user', content: 'Generate the day plan for Day ' + dayNum + '. Output raw JSON only.' }]
                    })
                });

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(errData.error?.message || 'API error ' + response.status);
                }

                const data = await response.json();
                let text = '';
                if (data.content) {
                    data.content.forEach(block => {
                        if (block.type === 'text') text += block.text;
                    });
                }

                let jsonStr = text.trim();
                if (jsonStr.startsWith('```')) {
                    jsonStr = jsonStr.replace(/^```(?:json)?\n?/, '').replace(/\n?```$/, '').trim();
                }

                const parsed = JSON.parse(jsonStr);
                if (parsed.slots && Array.isArray(parsed.slots)) {
                    parsed.slots.forEach(aiSlot => {
                        if (!aiSlot.name) return;
                        const matchIdx = dayData.slots.findIndex(s => s.type === aiSlot.type);
                        if (matchIdx >= 0) {
                            // Find coord from POI data
                            let coord = null;
                            const allPois = [...restaurants, ...experiences, ...(typeof kidFriendly !== 'undefined' ? kidFriendly : []), ...(typeof markets !== 'undefined' ? markets : [])];
                            const match = allPois.find(p => p.name === aiSlot.name);
                            if (match && match.coord) coord = match.coord;

                            dayData.slots[matchIdx].name = aiSlot.name;
                            dayData.slots[matchIdx].coord = coord;
                            dayData.slots[matchIdx].source = 'ai';
                        }
                    });
                }

                showCopyToast('AI recommendations loaded! You can edit any slot.');
            } catch(e) {
                showCopyToast('AI error: ' + e.message);
            }

            renderBuilderStep(stepBuilderState.currentStep);
        }

        // Review & Save Step
        function renderBuilderReview() {
            let html = '<div class="step-builder-title">Review Your Itinerary</div>';
            html += '<div class="step-builder-subtitle">Review and save your ' + stepBuilderState.totalDays + '-day trip</div>';

            // Travel info summary
            if (stepBuilderState.arrival.time || stepBuilderState.departure.time) {
                html += '<div class="step-review-card"><div class="step-review-card-header">✈️ Travel Info</div><div class="step-review-card-body">';
                if (stepBuilderState.arrival.time) {
                    html += '<div class="step-review-item">Arriving: ' + stepBuilderState.arrival.time;
                    if (stepBuilderState.arrival.flightNo) html += ' (' + escapeHtml(stepBuilderState.arrival.flightNo) + ')';
                    if (stepBuilderState.arrival.station) html += ' at ' + escapeHtml(stepBuilderState.arrival.station);
                    html += '</div>';
                }
                if (stepBuilderState.departure.time) {
                    html += '<div class="step-review-item">Departing: ' + stepBuilderState.departure.time;
                    if (stepBuilderState.departure.flightNo) html += ' (' + escapeHtml(stepBuilderState.departure.flightNo) + ')';
                    if (stepBuilderState.departure.station) html += ' at ' + escapeHtml(stepBuilderState.departure.station);
                    html += '</div>';
                }
                html += '</div></div>';
            }

            // Day cards
            const slotLabels = { breakfast: 'Breakfast', morning: 'Morning', lunch: 'Lunch', afternoon: 'Afternoon', dinner: 'Dinner' };

            stepBuilderState.days.forEach(day => {
                html += '<div class="step-review-card">';
                html += '<div class="step-review-card-header">Day ' + day.day + ' — 🏨 ' + escapeHtml(day.hotel || 'No hotel') + '</div>';
                html += '<div class="step-review-card-body">';
                day.slots.forEach(slot => {
                    if (slot.name) {
                        html += '<div class="step-review-item"><span class="review-type">' + (slotLabels[slot.type] || slot.type) + '</span>' + escapeHtml(slot.name) + '</div>';
                    }
                });
                if (!day.slots.some(s => s.name)) {
                    html += '<div class="step-review-item" style="color:#9ca3af;font-style:italic;">No activities planned</div>';
                }
                html += '</div></div>';
            });

            html += '<button class="step-save-btn" onclick="saveBuilderItinerary()">Save Itinerary</button>';
            html += '<div class="step-builder-nav"><button class="step-nav-prev" onclick="builderPrev()">← Back to editing</button></div>';

            return html;
        }

        function saveBuilderItinerary() {
            // Convert builder state to itinerary format
            const slotTypeMap = {
                breakfast: 'breakfast', morning: 'sightseeing', lunch: 'lunch',
                afternoon: 'sightseeing', dinner: 'dinner'
            };

            const days = stepBuilderState.days.map(day => {
                const items = [];
                // Add hotel first
                if (day.hotel) {
                    const hotelData = stepBuilderState.hotels.find(h => h.name === day.hotel);
                    items.push({
                        type: 'hotel',
                        name: day.hotel,
                        coord: hotelData ? hotelData.coord : null
                    });
                }
                // Add slots
                day.slots.forEach(slot => {
                    if (slot.name) {
                        items.push({
                            type: slotTypeMap[slot.type] || slot.type,
                            name: slot.name,
                            coord: slot.coord
                        });
                    }
                });
                return {
                    day: day.day,
                    title: day.hotel ? ('Day ' + day.day + ' — ' + day.hotel) : ('Day ' + day.day),
                    items: items
                };
            });

            // Generate a unique key
            const GEN_COLORS = ['#06b6d4', '#8b5cf6', '#ec4899', '#f97316', '#14b8a6', '#a855f7', '#f43f5e', '#eab308'];
            const prefix = 'gen_builder_';
            const builderCount = Object.keys(itineraryData).filter(k => k.startsWith(prefix)).length;
            const genKey = prefix + (builderCount + 1);
            const colorIdx = builderCount % GEN_COLORS.length;

            const dest = destinations[activeDestination];
            const itinName = (dest ? dest.name : activeDestination) + ' — Custom Plan';

            const itinObj = {
                name: itinName,
                color: GEN_COLORS[colorIdx],
                days: days,
                isGenerated: true,
                isBuilderMade: true,
                arrivalInfo: stepBuilderState.arrival,
                departureInfo: stepBuilderState.departure
            };

            // Add to itinerary data
            normalizeItineraryDays({ [genKey]: itinObj });
            itineraryData[genKey] = itinObj;
            originalItineraryData[genKey] = JSON.parse(JSON.stringify(itinObj));

            // Persist to localStorage
            try {
                const storageKey = 'tripMap_genItin_' + activeDestination;
                const existing = JSON.parse(localStorage.getItem(storageKey) || '{}');
                existing[genKey] = itinObj;
                localStorage.setItem(storageKey, JSON.stringify(existing));
            } catch(e) { console.warn('Could not save builder itinerary:', e); }

            // Clear draft
            clearBuilderDraft();

            // Switch to curated mode and select
            buildTabsUI();
            selectItinerary(genKey);
            if (isMobile()) {
                selectMobileItinMode('curated');
            } else {
                selectItinMode('curated');
                if (currentView !== 'itineraries') switchView('itineraries');
            }

            showCopyToast('Itinerary saved! Check the new tab.');
        }

        // ============================================
        // END 3-OPTION ITINERARY MODE SELECTOR
        // ============================================

        let genWebSearch = false;

        function toggleGenWebSearch() {
            genWebSearch = !genWebSearch;
            document.getElementById('genWebSearchToggle').classList.toggle('active', genWebSearch);
        }

        let refineConversation = []; // Tracks multi-turn refinement messages

        function openGeneratorModal() {
            if (!activeDestination) {
                showCopyToast('Please select a destination first');
                return;
            }
            if (!chatApiKey) {
                chatApiKey = localStorage.getItem('tripMap_apiKey') || localStorage.getItem('japanTrip_apiKey');
            }
            if (!chatApiKey) {
                showCopyToast('API key required — open the chat panel first to set it up');
                return;
            }
            const dest = destinations[activeDestination];
            document.getElementById('genDestLabel').textContent = 'for ' + (dest ? dest.name : activeDestination);
            document.getElementById('genPreviewArea').style.display = 'none';
            document.getElementById('genPreviewArea').innerHTML = '';
            document.getElementById('genError').style.display = 'none';
            document.getElementById('genSaveBtn').style.display = 'none';
            document.getElementById('genSubmitBtn').style.display = '';
            document.getElementById('genSubmitBtn').disabled = false;
            document.getElementById('genSubmitBtn').innerHTML = 'Generate Itinerary';
            lastGeneratedItinerary = null;
            populateProfileDropdown();
            hideSaveProfileRow();
            genWebSearch = false;
            document.getElementById('genWebSearchToggle').classList.remove('active');
            document.getElementById('genOverlay').classList.add('active');
        }

        function closeGeneratorModal() {
            document.getElementById('genOverlay').classList.remove('active');
        }

        // Interest chip toggle
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('gen-interest-chip')) {
                e.target.classList.toggle('selected');
            }
        });

        function getSelectedInterests() {
            return Array.from(document.querySelectorAll('.gen-interest-chip.selected')).map(el => el.dataset.interest);
        }

        // Multi-destination generator controls
        let genTripType = 'single';
        let genSegments = [];

        function setGenTripType(type) {
            genTripType = type;
            document.getElementById('genTypeSingle').classList.toggle('active', type === 'single');
            document.getElementById('genTypeMulti').classList.toggle('active', type === 'multi');
            document.getElementById('genSingleDaysField').style.display = type === 'single' ? '' : 'none';
            document.getElementById('genMultiDestField').style.display = type === 'multi' ? '' : 'none';
            if (type === 'multi' && genSegments.length === 0) {
                // Pre-populate with current destination
                addGenSegment(activeDestination, 5);
                addGenSegment(null, 5);
            }
            // Update label
            const label = document.getElementById('genDestLabel');
            if (label) label.textContent = type === 'multi' ? 'Multi-Destination Trip' : 'for ' + (destinations[activeDestination] ? destinations[activeDestination].name : 'this destination');
        }

        function addGenSegment(presetDest, presetDays) {
            const idx = genSegments.length;
            genSegments.push({ destination: presetDest || '', days: presetDays || 5 });
            renderGenSegments();
        }

        function removeGenSegment(idx) {
            genSegments.splice(idx, 1);
            renderGenSegments();
        }

        function updateGenSegment(idx, field, value) {
            genSegments[idx][field] = field === 'days' ? parseInt(value) || 1 : value;
            updateGenTotalDays();
        }

        function updateGenTotalDays() {
            const total = genSegments.reduce((sum, s) => sum + (s.days || 0), 0);
            document.getElementById('genMultiTotalDays').textContent = 'Total: ' + total + ' days';
        }

        function renderGenSegments() {
            const container = document.getElementById('genSegmentsList');
            container.innerHTML = '';
            genSegments.forEach(function(seg, idx) {
                const row = document.createElement('div');
                row.style.cssText = 'display:flex;gap:6px;align-items:center;margin-bottom:4px;';

                // Destination dropdown
                const sel = document.createElement('select');
                sel.style.cssText = 'flex:1;padding:5px;border:1px solid #d1d5db;border-radius:6px;font-size:11px;';
                sel.innerHTML = '<option value="">Select...</option>';
                if (manifestData) {
                    // Group by region
                    manifestData.regions.forEach(function(region) {
                        const optGroup = document.createElement('optgroup');
                        optGroup.label = region.flag + ' ' + region.name;
                        region.destinations.forEach(function(destKey) {
                            const entry = manifestData.destinations.find(d => d.key === destKey);
                            if (!entry) return;
                            const opt = document.createElement('option');
                            opt.value = destKey;
                            opt.textContent = entry.flag + ' ' + entry.name;
                            if (destKey === seg.destination) opt.selected = true;
                            optGroup.appendChild(opt);
                        });
                        sel.appendChild(optGroup);
                    });
                }
                sel.onchange = function() { updateGenSegment(idx, 'destination', this.value); };
                row.appendChild(sel);

                // Days input
                const daysInput = document.createElement('input');
                daysInput.type = 'number';
                daysInput.min = '1';
                daysInput.max = '21';
                daysInput.value = seg.days;
                daysInput.style.cssText = 'width:50px;padding:5px;border:1px solid #d1d5db;border-radius:6px;font-size:11px;text-align:center;';
                daysInput.onchange = function() { updateGenSegment(idx, 'days', this.value); };
                row.appendChild(daysInput);

                const daysLabel = document.createElement('span');
                daysLabel.style.cssText = 'font-size:10px;color:#9ca3af;';
                daysLabel.textContent = 'days';
                row.appendChild(daysLabel);

                // Remove button
                if (genSegments.length > 1) {
                    const removeBtn = document.createElement('button');
                    removeBtn.textContent = '\u00d7';
                    removeBtn.style.cssText = 'width:22px;height:22px;border-radius:50%;border:1px solid #e5e7eb;background:white;cursor:pointer;font-size:14px;color:#9ca3af;display:flex;align-items:center;justify-content:center;';
                    removeBtn.onclick = function() { removeGenSegment(idx); };
                    row.appendChild(removeBtn);
                }

                container.appendChild(row);
            });
            updateGenTotalDays();
        }

        // Build multi-destination system prompt
        function buildMultiDestGeneratorPrompt() {
            const party = document.getElementById('genParty').value;
            const interests = getSelectedInterests();
            const pace = document.getElementById('genPace').value;
            const budget = document.getElementById('genBudget').value;
            const constraints = document.getElementById('genConstraints').value.trim();
            const totalDays = genSegments.reduce((sum, s) => sum + (s.days || 0), 0);

            const partyDesc = {
                'couple': 'a couple',
                'family-toddler': 'a family with a toddler (under 4 years old) — nap time 1:00-3:00 PM is essential',
                'family-kids': 'a family with kids aged 4-12',
                'family-teens': 'a family with teenagers',
                'solo': 'a solo traveler',
                'friends': 'a group of friends'
            }[party] || party;

            const paceDesc = {
                'slow': 'Slow and relaxed — no more than 2-3 activities per day, plenty of downtime',
                'moderate': 'Moderate — 3-4 activities per day with breaks',
                'fast': 'Fast-paced — maximize activities and experiences each day'
            }[pace] || pace;

            let prompt = 'You are a multi-destination travel itinerary planner. Generate a ' + totalDays + '-day itinerary spanning multiple countries.\n\n';
            prompt += 'TRAVELERS: ' + partyDesc + '\n';
            prompt += 'INTERESTS: ' + (interests.length ? interests.join(', ') : 'general sightseeing') + '\n';
            prompt += 'PACE: ' + paceDesc + '\n';
            prompt += 'BUDGET: ' + budget + '\n';
            if (constraints) prompt += 'SPECIAL REQUESTS: ' + constraints + '\n';

            // Trip structure
            prompt += '\nTRIP STRUCTURE:\n';
            let dayCounter = 1;
            genSegments.forEach(function(seg) {
                const dest = destinations[seg.destination];
                const destName = dest ? dest.name : seg.destination;
                prompt += '- Days ' + dayCounter + '-' + (dayCounter + seg.days - 1) + ': ' + destName + ' (' + seg.days + ' days)\n';
                dayCounter += seg.days;
            });

            // POI sections per destination
            genSegments.forEach(function(seg) {
                const dest = destinations[seg.destination];
                if (!dest) return;
                const destName = dest.name;

                // Group POIs by city center (same logic as single-dest)
                const cityPois = {};
                const allPois = [
                    ...(dest.hotels || []).map(h => ({...h, cat: 'hotel'})),
                    ...(dest.restaurants || []).map(r => ({...r, cat: 'restaurant'})),
                    ...(dest.experiences || []).map(e => ({...e, cat: 'experience'})),
                    ...(dest.kidFriendly || []).map(k => ({...k, cat: 'kid-friendly'})),
                    ...(dest.markets || []).map(m => ({...m, cat: 'market'}))
                ];

                Object.entries(dest.cityCenters || {}).forEach(([city, coords]) => {
                    cityPois[city] = { hotels: [], restaurants: [], experiences: [], kidFriendly: [], markets: [] };
                    const r = coords[2] || 0.15;
                    allPois.forEach(poi => {
                        if (!poi.coord) return;
                        if (Math.abs(poi.coord[0] - coords[0]) < r && Math.abs(poi.coord[1] - coords[1]) < r) {
                            const catKey = poi.cat === 'hotel' ? 'hotels' : poi.cat === 'restaurant' ? 'restaurants' : poi.cat === 'experience' ? 'experiences' : poi.cat === 'kid-friendly' ? 'kidFriendly' : 'markets';
                            const tagStr = (poi.tags && poi.tags.length) ? ' [' + poi.tags.join(', ') + ']' : '';
                            if (cityPois[city][catKey].length < 10) {
                                cityPois[city][catKey].push(poi.name + (poi.desc ? ' (' + poi.desc + ')' : '') + tagStr);
                            }
                        }
                    });
                });

                prompt += '\n## ' + destName + ' (' + dest.flag + ')\n';
                Object.entries(cityPois).forEach(([city, cats]) => {
                    const total = cats.hotels.length + cats.restaurants.length + cats.experiences.length + cats.kidFriendly.length + cats.markets.length;
                    if (total === 0) return;
                    prompt += '### ' + city + '\n';
                    if (cats.hotels.length) prompt += 'Hotels: ' + cats.hotels.join(' | ') + '\n';
                    if (cats.restaurants.length) prompt += 'Restaurants: ' + cats.restaurants.join(' | ') + '\n';
                    if (cats.experiences.length) prompt += 'Experiences: ' + cats.experiences.join(' | ') + '\n';
                    if (cats.kidFriendly.length) prompt += 'Kid-Friendly: ' + cats.kidFriendly.join(' | ') + '\n';
                    if (cats.markets.length) prompt += 'Markets: ' + cats.markets.join(' | ') + '\n';
                });
            });

            prompt += '\nRULES:\n';
            prompt += '- Use places from the AVAILABLE PLACES list above whenever possible.\n';
            prompt += '- Each day should have a logical geographic flow.\n';
            prompt += '- Include hotel, breakfast, lunch, dinner each day. Add sightseeing, optional, and nap items as appropriate.\n';
            prompt += '- On transition days between countries, include a transit item (type "info") describing the travel method and estimated time.\n';
            prompt += '- The first day should account for arrival, the last day for departure.\n';
            if (party === 'family-toddler') {
                prompt += '- MANDATORY: Include a "nap" item from 1:00-3:00 PM every day. Keep distances short.\n';
            }

            prompt += '\nRESPONSE FORMAT: Respond with ONLY valid JSON (no markdown, no code fences). The JSON must be:\n';
            prompt += '{\n';
            prompt += '  "name": "Itinerary Name",\n';
            prompt += '  "isMultiDestination": true,\n';
            prompt += '  "segments": [\n';
            prompt += '    {"destination": "' + (genSegments[0] ? genSegments[0].destination : 'country-key') + '", "days": ' + (genSegments[0] ? genSegments[0].days : 5) + '}\n';
            prompt += '  ],\n';
            prompt += '  "days": [\n';
            prompt += '    {\n';
            prompt += '      "day": 1,\n';
            prompt += '      "title": "City Name (Theme)",\n';
            prompt += '      "destination": "country-key",\n';
            prompt += '      "items": [\n';
            prompt += '        {"type": "hotel", "name": "Hotel Name"},\n';
            prompt += '        {"type": "breakfast", "name": "Restaurant Name"},\n';
            prompt += '        {"type": "sightseeing", "name": "Place Name"},\n';
            prompt += '        {"type": "info", "name": "Flight/Train to Next Country (Xhr)"},\n';
            prompt += '        {"type": "dinner", "name": "Restaurant Name"}\n';
            prompt += '      ]\n';
            prompt += '    }\n';
            prompt += '  ]\n';
            prompt += '}\n';
            prompt += 'Valid types: hotel, breakfast, lunch, dinner, sightseeing, optional, nap, info.\n';
            prompt += 'IMPORTANT: Each day MUST have a "destination" field with the country key (e.g., "italy", "france").\n';
            prompt += 'Do NOT include coordinates. Output raw JSON only.';

            return prompt;
        }

        function buildGeneratorSystemPrompt() {
            const dest = destinations[activeDestination];
            const destName = dest ? dest.name : activeDestination;
            const days = parseInt(document.getElementById('genDays').value) || 7;
            const party = document.getElementById('genParty').value;
            const interests = getSelectedInterests();
            const pace = document.getElementById('genPace').value;
            const budget = document.getElementById('genBudget').value;
            const constraints = document.getElementById('genConstraints').value.trim();

            // Build compact POI list grouped by city
            const cityPois = {};
            const allPois = [
                ...hotels.map(h => ({...h, cat: 'hotel'})),
                ...restaurants.map(r => ({...r, cat: 'restaurant'})),
                ...experiences.map(e => ({...e, cat: 'experience'})),
                ...kidFriendly.map(k => ({...k, cat: 'kid-friendly'})),
                ...markets.map(m => ({...m, cat: 'market'}))
            ];

            // Group POIs by nearest city center
            Object.entries(cityCenters).forEach(([city, coords]) => {
                cityPois[city] = { hotels: [], restaurants: [], experiences: [], kidFriendly: [], markets: [] };
                const r = coords[2] || 0.15;
                allPois.forEach(poi => {
                    if (!poi.coord) return;
                    if (Math.abs(poi.coord[0] - coords[0]) < r && Math.abs(poi.coord[1] - coords[1]) < r) {
                        const catKey = poi.cat === 'hotel' ? 'hotels' : poi.cat === 'restaurant' ? 'restaurants' : poi.cat === 'experience' ? 'experiences' : poi.cat === 'kid-friendly' ? 'kidFriendly' : 'markets';
                        const tagStr = (poi.tags && poi.tags.length) ? ' [' + poi.tags.join(', ') + ']' : '';
                        const entry = poi.name + (poi.desc ? ' (' + poi.desc + ')' : '') + tagStr;
                        if (cityPois[city][catKey].length < 15) {
                            cityPois[city][catKey].push(entry);
                        }
                    }
                });
            });

            // Build POI section
            let poiSection = '';
            Object.entries(cityPois).forEach(([city, cats]) => {
                const total = cats.hotels.length + cats.restaurants.length + cats.experiences.length + cats.kidFriendly.length + cats.markets.length;
                if (total === 0) return;
                poiSection += '\n## ' + city + '\n';
                if (cats.hotels.length) poiSection += 'Hotels: ' + cats.hotels.join(' | ') + '\n';
                if (cats.restaurants.length) poiSection += 'Restaurants: ' + cats.restaurants.join(' | ') + '\n';
                if (cats.experiences.length) poiSection += 'Experiences: ' + cats.experiences.join(' | ') + '\n';
                if (cats.kidFriendly.length) poiSection += 'Kid-Friendly: ' + cats.kidFriendly.join(' | ') + '\n';
                if (cats.markets.length) poiSection += 'Markets: ' + cats.markets.join(' | ') + '\n';
            });

            // City centers for reference
            let cityCentersList = Object.entries(cityCenters).map(([city, coords]) => city + ': [' + coords[0] + ', ' + coords[1] + ']').join(', ');

            // Party description
            const partyDesc = {
                'couple': 'a couple',
                'family-toddler': 'a family with a toddler (under 4 years old) — nap time 1:00-3:00 PM is essential',
                'family-kids': 'a family with kids aged 4-12',
                'family-teens': 'a family with teenagers',
                'solo': 'a solo traveler',
                'friends': 'a group of friends'
            }[party] || party;

            const paceDesc = {
                'slow': 'Slow and relaxed — no more than 2-3 activities per day, plenty of downtime',
                'moderate': 'Moderate — 3-4 activities per day with breaks',
                'fast': 'Fast-paced — maximize activities and experiences each day'
            }[pace] || pace;

            let prompt = 'You are a travel itinerary planner. Generate a ' + days + '-day itinerary for ' + destName + '.\n\n';
            prompt += 'TRAVELERS: ' + partyDesc + '\n';
            prompt += 'INTERESTS: ' + (interests.length ? interests.join(', ') : 'general sightseeing') + '\n';
            prompt += 'PACE: ' + paceDesc + '\n';
            prompt += 'BUDGET: ' + budget + '\n';
            if (constraints) prompt += 'SPECIAL REQUESTS: ' + constraints + '\n';

            prompt += '\nAVAILABLE PLACES (use these by name where possible):\n' + poiSection;
            prompt += '\nCITY CENTERS: ' + cityCentersList + '\n';

            prompt += '\nRULES:\n';
            prompt += '- Use places from the AVAILABLE PLACES list above whenever possible. You may add well-known places not in the list if needed.\n';
            prompt += '- Each day should have a logical geographic flow (group nearby activities).\n';
            prompt += '- Include hotel, breakfast, lunch, dinner each day. Add sightseeing, optional, and nap items as appropriate.\n';
            if (party === 'family-toddler') {
                prompt += '- MANDATORY: Include a "nap" item from 1:00-3:00 PM every day. Keep distances between stops short and walkable.\n';
            }
            prompt += '- For multi-city trips, group days by city and minimize transit days.\n';
            prompt += '- The first day should account for arrival, the last day for departure.\n';

            prompt += '\nRESPONSE FORMAT: Respond with ONLY valid JSON (no markdown, no explanation, no code fences). The JSON must be an object:\n';
            prompt += '{\n';
            prompt += '  "name": "Itinerary Name (short, descriptive, e.g. \'Foodie Family Adventure\')",\n';
            prompt += '  "days": [\n';
            prompt += '    {\n';
            prompt += '      "day": 1,\n';
            prompt += '      "title": "City Name (Theme)",\n';
            prompt += '      "items": [\n';
            prompt += '        {"type": "hotel", "name": "Hotel Name"},\n';
            prompt += '        {"type": "breakfast", "name": "Restaurant Name"},\n';
            prompt += '        {"type": "sightseeing", "name": "Place Name"},\n';
            prompt += '        {"type": "lunch", "name": "Restaurant Name"},\n';
            prompt += '        {"type": "nap", "name": "Nap / Rest Time"},\n';
            prompt += '        {"type": "sightseeing", "name": "Place Name"},\n';
            prompt += '        {"type": "dinner", "name": "Restaurant Name"},\n';
            prompt += '        {"type": "optional", "name": "Optional Activity"}\n';
            prompt += '      ]\n';
            prompt += '    }\n';
            prompt += '  ]\n';
            prompt += '}\n';
            prompt += 'Valid types: hotel, breakfast, lunch, dinner, sightseeing, optional, nap.\n';
            prompt += 'Do NOT include coordinates — they will be looked up automatically.\n';
            prompt += 'IMPORTANT: Output raw JSON only. No markdown code blocks, no backticks, no explanation text.';

            return prompt;
        }

        async function submitGeneratorForm() {
            const submitBtn = document.getElementById('genSubmitBtn');
            const errorDiv = document.getElementById('genError');
            const previewArea = document.getElementById('genPreviewArea');
            const saveBtn = document.getElementById('genSaveBtn');

            errorDiv.style.display = 'none';
            previewArea.style.display = 'none';
            saveBtn.style.display = 'none';
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="gen-spinner"></span>Generating...';

            refineConversation = []; // Reset refinement conversation

            const isMulti = genTripType === 'multi';
            let systemPrompt, days, userMessage;

            if (isMulti) {
                // Multi-destination mode
                if (genSegments.length < 2) {
                    errorDiv.textContent = 'Add at least 2 destinations for a multi-destination trip.';
                    errorDiv.style.display = 'block';
                    submitBtn.innerHTML = 'Generate Itinerary';
                    submitBtn.disabled = false;
                    return;
                }
                // Ensure all segment destinations are loaded
                for (const seg of genSegments) {
                    if (!destinations[seg.destination] && !destinationCache[seg.destination]) {
                        submitBtn.innerHTML = '<span class="gen-spinner"></span>Loading ' + seg.destination + '...';
                        await fetchAndLoadDestination(seg.destination);
                    }
                }
                systemPrompt = buildMultiDestGeneratorPrompt();
                days = genSegments.reduce((sum, s) => sum + (s.days || 0), 0);
                userMessage = 'Generate the ' + days + '-day multi-destination itinerary now. Output raw JSON only.';
            } else {
                systemPrompt = buildGeneratorSystemPrompt();
                days = parseInt(document.getElementById('genDays').value) || 7;
                userMessage = 'Generate the ' + days + '-day itinerary now. Output raw JSON only.';
            }

            try {
                const modelId = (typeof getModelId === 'function') ? getModelId() : 'claude-sonnet-4-5-20250929';
                const maxTokens = modelId.includes('haiku') ? 4096 : 8192;

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': chatApiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: (function() {
                        var reqBody = {
                            model: modelId,
                            max_tokens: maxTokens,
                            system: systemPrompt,
                            messages: [{ role: 'user', content: userMessage }]
                        };
                        if (genWebSearch) {
                            reqBody.tools = [{ type: 'web_search_20250305', name: 'web_search', max_uses: 5 }];
                        }
                        return JSON.stringify(reqBody);
                    })()
                });

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(errData.error?.message || 'API error ' + response.status);
                }

                const data = await response.json();

                // Extract text from response
                let text = '';
                if (data.content) {
                    data.content.forEach(block => {
                        if (block.type === 'text') text += block.text;
                    });
                }

                if (!text) throw new Error('Empty response from AI');

                // Parse JSON (handle code fences if present)
                let jsonStr = text.trim();
                if (jsonStr.startsWith('```')) {
                    jsonStr = jsonStr.replace(/^```(?:json)?\n?/, '').replace(/\n?```$/, '').trim();
                }

                let parsed;
                try {
                    parsed = JSON.parse(jsonStr);
                } catch(e) {
                    throw new Error('AI response was not valid JSON. Try again or use a different model.');
                }

                // Validate structure
                if (!parsed.days || !Array.isArray(parsed.days) || parsed.days.length === 0) {
                    throw new Error('Invalid itinerary structure — no days found');
                }

                // Look up coordinates for all items
                if (isMulti) {
                    // Multi-dest: resolve coords per day's destination
                    parsed.days.forEach(day => {
                        if (!day.items) day.items = [];
                        const dayDest = day.destination || genSegments[0]?.destination;
                        day.items.forEach(item => {
                            if (!item.coord && item.type !== 'info') {
                                // Try the day's destination first
                                item.coord = findCoordInDest(item.name, dayDest);
                                // Fallback: search all segment destinations
                                if (!item.coord) {
                                    for (const seg of genSegments) {
                                        item.coord = findCoordInDest(item.name, seg.destination);
                                        if (item.coord) break;
                                    }
                                }
                                // Final fallback: active dest lookup
                                if (!item.coord) {
                                    item.coord = findCoordForName(item.name);
                                }
                            }
                            if (!item.type) item.type = 'sightseeing';
                        });
                    });
                    // Ensure multi-dest metadata is present
                    parsed.isMultiDestination = true;
                    if (!parsed.segments) {
                        parsed.segments = genSegments.map(s => ({ destination: s.destination, days: s.days }));
                    }
                } else {
                    parsed.days.forEach(day => {
                        if (!day.items) day.items = [];
                        day.items.forEach(item => {
                            if (!item.coord) {
                                item.coord = findCoordForName(item.name);
                            }
                            if (!item.type) item.type = 'sightseeing';
                        });
                    });
                }

                // Normalize day format (label → day + title) for form-generated itineraries
                normalizeItineraryDays({ _form: parsed });

                // Store for saving
                lastGeneratedItinerary = parsed;

                // Render preview using shared function
                renderGeneratorPreview(parsed);

                saveBtn.style.display = '';
                submitBtn.innerHTML = 'Regenerate';
                submitBtn.disabled = false;

            } catch(e) {
                errorDiv.textContent = e.message;
                errorDiv.style.display = 'block';
                submitBtn.innerHTML = 'Try Again';
                submitBtn.disabled = false;
            }
        }

        function saveGeneratedItinerary() {
            if (!lastGeneratedItinerary) return;

            // Generate unique key
            const isMulti = lastGeneratedItinerary.isMultiDestination;
            const prefix = isMulti ? 'gen_multi_' : 'gen_';
            const genCount = Object.keys(itineraryData).filter(k => k.startsWith(prefix)).length;
            const genKey = prefix + (genCount + 1);

            // Pick a color
            const colorIdx = genCount % GEN_COLORS.length;

            const itinObj = {
                name: lastGeneratedItinerary.name || (isMulti ? 'Multi-Destination Trip' : 'Custom Itinerary'),
                color: GEN_COLORS[colorIdx],
                days: lastGeneratedItinerary.days,
                isGenerated: true
            };

            // Preserve multi-destination metadata
            if (isMulti) {
                itinObj.isMultiDestination = true;
                itinObj.segments = lastGeneratedItinerary.segments || [];
            }

            // Normalize day format and add to itineraryData
            normalizeItineraryDays({ [genKey]: itinObj });
            itineraryData[genKey] = itinObj;
            originalItineraryData[genKey] = JSON.parse(JSON.stringify(itinObj));

            // Persist to localStorage
            try {
                const storageKey = isMulti
                    ? 'tripMap_genItin_multi_' + (activeRegion || 'global')
                    : 'tripMap_genItin_' + activeDestination;
                const existing = JSON.parse(localStorage.getItem(storageKey) || '{}');
                existing[genKey] = itinObj;
                localStorage.setItem(storageKey, JSON.stringify(existing));
            } catch(e) {
                console.warn('Could not save generated itinerary to localStorage:', e);
            }

            // Rebuild tabs and select the new one
            buildTabsUI();
            selectItinerary(genKey);
            if (currentView !== 'itineraries') switchView('itineraries');

            closeGeneratorModal();
            showCopyToast(isMulti ? 'Multi-destination itinerary created!' : 'Itinerary created! Check the new tab.');
            lastGeneratedItinerary = null;
        }

        function loadSavedGeneratedItineraries() {
            // Called after destination loads to restore any generated itineraries from localStorage
            try {
                // Load single-destination generated itineraries
                const storageKey = 'tripMap_genItin_' + activeDestination;
                const saved = JSON.parse(localStorage.getItem(storageKey) || '{}');
                Object.entries(saved).forEach(([key, itinObj]) => {
                    if (!itineraryData[key]) {
                        itinObj.isGenerated = true;
                        normalizeItineraryDays({ [key]: itinObj });
                        itineraryData[key] = itinObj;
                        originalItineraryData[key] = JSON.parse(JSON.stringify(itinObj));
                    }
                });

                // Also load multi-destination itineraries for the active region
                if (activeRegion) {
                    const multiKey = 'tripMap_genItin_multi_' + activeRegion;
                    const multiSaved = JSON.parse(localStorage.getItem(multiKey) || '{}');
                    Object.entries(multiSaved).forEach(([key, itinObj]) => {
                        if (!itineraryData[key]) {
                            itinObj.isGenerated = true;
                            itinObj.isMultiDestination = true;
                            normalizeItineraryDays({ [key]: itinObj });
                            itineraryData[key] = itinObj;
                            originalItineraryData[key] = JSON.parse(JSON.stringify(itinObj));
                        }
                    });
                }
            } catch(e) {}
        }

        function deleteGeneratedItinerary(key) {
            if (!confirm('Delete this generated itinerary?')) return;

            const isMulti = itineraryData[key] && itineraryData[key].isMultiDestination;
            delete itineraryData[key];
            delete originalItineraryData[key];

            // Remove from localStorage (check both single and multi-dest storage)
            try {
                if (isMulti && activeRegion) {
                    const multiKey = 'tripMap_genItin_multi_' + activeRegion;
                    const multiSaved = JSON.parse(localStorage.getItem(multiKey) || '{}');
                    delete multiSaved[key];
                    localStorage.setItem(multiKey, JSON.stringify(multiSaved));
                } else {
                    const storageKey = 'tripMap_genItin_' + activeDestination;
                    const saved = JSON.parse(localStorage.getItem(storageKey) || '{}');
                    delete saved[key];
                    localStorage.setItem(storageKey, JSON.stringify(saved));
                }
            } catch(e) {}

            // Rebuild tabs, switch to first available
            buildTabsUI();
            const firstKey = Object.keys(itineraryData)[0];
            if (firstKey && currentView === 'itineraries') {
                selectItinerary(firstKey);
            }

            showCopyToast('Itinerary deleted');
        }

        async function refineGeneratedItinerary() {
            const input = document.getElementById('genRefineInput');
            const msg = input.value.trim();
            if (!msg) return;
            if (!lastGeneratedItinerary) { showCopyToast('No itinerary to refine'); return; }

            const refineBtn = document.getElementById('genRefineBtn');
            refineBtn.disabled = true;
            refineBtn.innerHTML = '<span class="gen-spinner"></span>Refining...';
            input.disabled = true;
            const errorDiv = document.getElementById('genError');
            errorDiv.style.display = 'none';

            try {
                const dest = destinations[activeDestination];
                const destName = dest ? dest.name : activeDestination;

                // Build a compact system prompt for refinement
                let systemPrompt = 'You are a travel itinerary planner helping refine an existing itinerary for ' + destName + '.\n\n';
                systemPrompt += 'CURRENT ITINERARY:\n' + JSON.stringify(lastGeneratedItinerary, null, 0) + '\n\n';

                // Include available POIs for reference
                const allPois = [...hotels, ...restaurants, ...experiences, ...kidFriendly, ...markets];
                const poiNames = allPois.slice(0, 200).map(p => p.name + (p.desc ? ' (' + p.desc + ')' : '')).join(' | ');
                systemPrompt += 'AVAILABLE PLACES (use these when adding new activities): ' + poiNames + '\n\n';

                systemPrompt += 'RULES:\n';
                systemPrompt += '- Modify only the parts the user asks about. Keep everything else exactly the same.\n';
                systemPrompt += '- If user asks to change a specific day, only change that day.\n';
                systemPrompt += '- If user asks to add/remove activities, adjust accordingly while keeping the itinerary balanced.\n';
                systemPrompt += '- Maintain hotel, breakfast, lunch, dinner structure each day.\n';
                systemPrompt += '- Use places from the AVAILABLE PLACES list when possible.\n';
                systemPrompt += '\nRESPONSE FORMAT: Respond with ONLY the complete updated itinerary as valid JSON (same format as the current itinerary). Include ALL days, not just modified ones. No markdown, no explanation, no code fences.\n';
                systemPrompt += 'IMPORTANT: Output raw JSON only.';

                // Build conversation messages for multi-turn
                refineConversation.push({ role: 'user', content: msg });

                const modelId = (typeof getModelId === 'function') ? getModelId() : 'claude-sonnet-4-5-20250929';
                const maxTokens = modelId.includes('haiku') ? 4096 : 8192;

                const reqBody = {
                    model: modelId,
                    max_tokens: maxTokens,
                    system: systemPrompt,
                    messages: refineConversation.slice(-6) // Keep last 6 messages for context window management
                };

                if (genWebSearch) {
                    reqBody.tools = [{ type: 'web_search_20250305', name: 'web_search', max_uses: 3 }];
                }

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': chatApiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify(reqBody)
                });

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(errData.error?.message || 'API error ' + response.status);
                }

                const data = await response.json();
                let text = '';
                if (data.content) {
                    data.content.forEach(block => {
                        if (block.type === 'text') text += block.text;
                    });
                }
                if (!text) throw new Error('Empty response from AI');

                let jsonStr = text.trim();
                if (jsonStr.startsWith('```')) {
                    jsonStr = jsonStr.replace(/^```(?:json)?\n?/, '').replace(/\n?```$/, '').trim();
                }

                let parsed;
                try {
                    parsed = JSON.parse(jsonStr);
                } catch(e) {
                    throw new Error('AI response was not valid JSON. Try rephrasing your request.');
                }

                if (!parsed.days || !Array.isArray(parsed.days) || parsed.days.length === 0) {
                    throw new Error('Invalid itinerary structure — no days found');
                }

                // Look up coordinates
                parsed.days.forEach(day => {
                    if (!day.items) day.items = [];
                    day.items.forEach(item => {
                        if (!item.coord) item.coord = findCoordForName(item.name);
                        if (!item.type) item.type = 'sightseeing';
                    });
                });

                // Track assistant response for multi-turn
                refineConversation.push({ role: 'assistant', content: text });

                // Update the stored itinerary
                lastGeneratedItinerary = parsed;

                // Re-render preview
                renderGeneratorPreview(parsed);
                input.value = '';
                showCopyToast('Itinerary refined!');

            } catch(e) {
                errorDiv.textContent = e.message;
                errorDiv.style.display = 'block';
                // Remove the failed user message from conversation
                refineConversation.pop();
            } finally {
                refineBtn.disabled = false;
                refineBtn.innerHTML = 'Refine';
                input.disabled = false;
                input.focus();
            }
        }

        function renderGeneratorPreview(parsed) {
            const previewArea = document.getElementById('genPreviewArea');
            let previewHtml = '<div class="gen-preview">';
            previewHtml += '<div style="font-size:13px;font-weight:700;color:#333;margin-bottom:8px;">' + escapeHtml(parsed.name || 'Generated Itinerary') + '</div>';
            parsed.days.forEach(day => {
                previewHtml += '<div class="gen-preview-day">';
                previewHtml += '<div class="gen-preview-day-title">Day ' + day.day + ' \u2014 ' + escapeHtml(day.title || '') + '</div>';
                (day.items || []).forEach(item => {
                    const icon = item.type === 'hotel' ? '\uD83C\uDFE8' : item.type === 'breakfast' ? '\uD83C\uDF73' : item.type === 'lunch' ? '\uD83C\uDF5C' : item.type === 'dinner' ? '\uD83C\uDF77' : item.type === 'nap' ? '\uD83D\uDCA4' : item.type === 'optional' ? '\u2728' : '\uD83D\uDCCD';
                    const coordStatus = item.coord ? '' : ' <span style="color:#F59E0B;font-size:10px;">(no coords)</span>';
                    previewHtml += '<div class="gen-preview-item"><span class="type-badge">' + icon + ' ' + escapeHtml(item.type) + '</span> ' + escapeHtml(item.name) + coordStatus + '</div>';
                });
                previewHtml += '</div>';
            });
            previewHtml += '</div>';
            // Add refinement input
            previewHtml += '<div class="gen-refine-bar">';
            previewHtml += '<input class="gen-refine-input" id="genRefineInput" placeholder="e.g. Make day 3 more adventurous, add a beach day..." onkeydown="if(event.key===\'Enter\' && !event.shiftKey){event.preventDefault();refineGeneratedItinerary();}" />';
            previewHtml += '<button class="gen-refine-btn" id="genRefineBtn" onclick="refineGeneratedItinerary()">Refine</button>';
            previewHtml += '</div>';
            previewHtml += '<div class="gen-refine-hint">Ask to modify specific days, swap activities, change pace, add rest days, etc.</div>';
            previewArea.innerHTML = previewHtml;
            previewArea.style.display = 'block';
        }

        // ============================================
        // MOBILE TAB-BASED NAVIGATION
        // ============================================

        let mobileActiveTab = 'map';
        let mobileSearchFilter = 'all';
        let mobileSearchDebounce = null;
        let mobileSheetState = 'hidden'; // 'hidden', 'half', 'expanded'

        function isMobile() {
            return window.innerWidth <= 768;
        }

        // Returns fitBounds padding to account for the bottom sheet covering part of the map
        function getMobileMapPadding() {
            if (!isMobile()) return {};
            const visibleSheet = document.querySelector('.mobile-tab-panel.sheet-visible');
            if (!visibleSheet) return {};
            const sheetH = visibleSheet.offsetHeight || 0;
            // paddingBottomRight pushes the effective map viewport up so the center isn't hidden behind the sheet
            return { paddingBottomRight: [0, sheetH], paddingTopLeft: [0, 0] };
        }

        // ---- Sheet State Management ----
        function showMobileSheet(panelId, state) {
            const panel = document.getElementById(panelId);
            const backdrop = document.getElementById('mobileSheetBackdrop');
            if (!panel) return;

            // Reset classes
            panel.classList.remove('sheet-half', 'sheet-expanded', 'sheet-visible');

            // Set the height class (half or expanded)
            if (state === 'half') {
                panel.classList.add('sheet-half', 'sheet-visible');
                mobileSheetState = 'half';
            } else if (state === 'expanded') {
                panel.classList.add('sheet-expanded', 'sheet-visible');
                mobileSheetState = 'expanded';
            }

            // Force transform directly via inline style to guarantee visibility
            panel.style.transform = 'translateY(0)';

            // Show subtle backdrop when expanded
            if (backdrop) {
                backdrop.classList.toggle('visible', state === 'expanded');
            }
        }

        function hideMobileSheet(panelId) {
            const panel = document.getElementById(panelId);
            const backdrop = document.getElementById('mobileSheetBackdrop');
            if (panel) {
                panel.classList.remove('sheet-visible');
                panel.style.transform = ''; // clear inline, fall back to CSS translateY(100%)
            }
            if (backdrop) backdrop.classList.remove('visible');
            mobileSheetState = 'hidden';
        }

        function hideAllMobileSheets() {
            ['mobileTripsPanel', 'mobileSearchPanel', 'mobileChatPanel'].forEach(id => {
                hideMobileSheet(id);
            });
        }

        function closeMobileSheet() {
            // Close any visible sheet and return to map tab
            hideAllMobileSheets();
            mobileActiveTab = 'map';
            document.querySelectorAll('.mobile-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === 'map');
            });
            const mapControls = document.getElementById('mobileMapControls');
            if (mapControls) mapControls.style.display = '';
            setTimeout(() => { if (map) map.invalidateSize(); }, 100);
        }

        function collapseMobileSheet() {
            // Collapse expanded sheet back to half
            const activePanel = document.querySelector('.mobile-tab-panel.sheet-visible');
            if (activePanel && mobileSheetState === 'expanded') {
                activePanel.classList.remove('sheet-expanded');
                activePanel.classList.add('sheet-half');
                mobileSheetState = 'half';
                const backdrop = document.getElementById('mobileSheetBackdrop');
                if (backdrop) backdrop.classList.remove('visible');
            }
        }

        function toggleSheetExpand(panelId) {
            const panel = document.getElementById(panelId);
            if (!panel) return;
            if (mobileSheetState === 'half') {
                panel.classList.remove('sheet-half');
                panel.classList.add('sheet-expanded');
                mobileSheetState = 'expanded';
                const backdrop = document.getElementById('mobileSheetBackdrop');
                if (backdrop) backdrop.classList.add('visible');
            } else if (mobileSheetState === 'expanded') {
                panel.classList.remove('sheet-expanded');
                panel.classList.add('sheet-half');
                mobileSheetState = 'half';
                const backdrop = document.getElementById('mobileSheetBackdrop');
                if (backdrop) backdrop.classList.remove('visible');
            }
        }

        // ---- Tab Switching ----
        function switchMobileTab(tab) {
            if (!isMobile()) return;

            // If tapping the already-active tab (that has a visible sheet), toggle it
            if (tab === mobileActiveTab && tab !== 'map') {
                const panelIds = { trips: 'mobileTripsPanel', search: 'mobileSearchPanel', chat: 'mobileChatPanel' };
                const panelId = panelIds[tab];
                const panel = panelId ? document.getElementById(panelId) : null;
                if (panel && panel.classList.contains('sheet-visible')) {
                    hideAllMobileSheets();
                    mobileActiveTab = 'map';
                    document.querySelectorAll('.mobile-tab').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.tab === 'map');
                    });
                    const mapControls = document.getElementById('mobileMapControls');
                    if (mapControls) mapControls.style.display = '';
                    setTimeout(() => { if (map) map.invalidateSize(); }, 100);
                    return;
                }
            }

            mobileActiveTab = tab;

            // Update tab bar active states
            document.querySelectorAll('.mobile-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });

            // Hide all panels first
            hideAllMobileSheets();

            // Hide/show map-related elements
            const mapControls = document.getElementById('mobileMapControls');

            if (tab === 'map') {
                if (mapControls) mapControls.style.display = '';
                setTimeout(() => { if (map) map.invalidateSize(); }, 100);
            } else {
                // Map stays visible underneath! Just hide the category chips
                if (mapControls) mapControls.style.display = 'none';

                if (tab === 'trips') {
                    showMobileSheet('mobileTripsPanel', 'half');
                    refreshMobileTripsUI();
                } else if (tab === 'search') {
                    showMobileSheet('mobileSearchPanel', 'half');
                    setTimeout(() => {
                        const input = document.getElementById('mobileSearchInput');
                        if (input) input.focus();
                    }, 350);
                } else if (tab === 'chat') {
                    showMobileSheet('mobileChatPanel', 'expanded');
                    initMobileChat();
                }
            }

            // Close POI detail sheet when switching tabs
            hideMobilePOIDetail();
        }

        // ---- Destination Bar ----
        function updateMobileDestBar() {
            if (!isMobile()) return;
            if (!activeDestination || !destinations[activeDestination]) return;
            const dest = destinations[activeDestination];
            const flag = document.getElementById('mobileDestFlag');
            const name = document.getElementById('mobileDestName');
            if (flag) flag.textContent = dest.flag || '🗺️';
            // Show region context if a region is active
            if (activeRegion && manifestData && manifestData.regions) {
                const region = manifestData.regions.find(r => r.key === activeRegion);
                if (region && name) {
                    name.textContent = dest.name + ' · ' + region.name;
                    return;
                }
            }
            if (name) name.textContent = dest.name || 'Travel Map';
        }

        function toggleMobileDestPicker() {
            // Reuse the manifest data to show destination options
            if (!manifestData || !manifestData.destinations) return;

            // Build region-grouped picker modal
            let html = '<div style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:flex-end;justify-content:center;" onclick="if(event.target===this)this.remove()" id="mobileDestPickerOverlay">';
            html += '<div style="background:white;border-radius:16px 16px 0 0;width:100%;max-height:75vh;overflow-y:auto;padding:16px 12px;-webkit-overflow-scrolling:touch;">';
            html += '<div style="font-size:16px;font-weight:700;margin-bottom:14px;text-align:center;">Choose Destination</div>';

            if (manifestData.regions && manifestData.regions.length > 0) {
                // Region-based grouping
                manifestData.regions.forEach(region => {
                    // Region header with "Load All" button
                    html += '<div style="display:flex;align-items:center;gap:8px;padding:10px 4px 6px;border-bottom:1px solid #f0f0f0;margin-top:8px;">';
                    html += '<span style="font-size:18px;">' + (region.flag || '') + '</span>';
                    html += '<span style="font-size:13px;font-weight:700;color:#374151;flex:1;">' + region.name + '</span>';
                    const isActiveRegion = activeRegion === region.key;
                    html += '<button onclick="event.stopPropagation();document.getElementById(\'mobileDestPickerOverlay\').remove();onRegionSelectChange(\'' + region.key + '\');loadRegion(\'' + region.key + '\');" style="font-size:11px;padding:3px 10px;border:1px solid ' + (isActiveRegion ? '#2563EB' : '#d1d5db') + ';border-radius:12px;background:' + (isActiveRegion ? '#eff6ff' : 'white') + ';color:' + (isActiveRegion ? '#2563EB' : '#6b7280') + ';cursor:pointer;font-weight:500;">' + (isActiveRegion ? '✓ Loaded' : 'Load All') + '</button>';
                    html += '</div>';

                    // Country list under this region
                    region.destinations.forEach(destKey => {
                        const d = manifestData.destinations.find(dd => dd.key === destKey);
                        if (!d) return;
                        const isActive = d.key === activeDestination;
                        const isLoaded = loadedRegionDests.has(d.key) || !!destinations[d.key];
                        html += '<button onclick="document.getElementById(\'mobileDestPickerOverlay\').remove();fetchAndLoadDestination(\'' + d.key + '\')" style="display:flex;align-items:center;gap:10px;width:100%;padding:10px 12px;border:none;background:' + (isActive ? '#eff6ff' : 'white') + ';border-radius:10px;font-size:14px;cursor:pointer;text-align:left;font-weight:' + (isActive ? '600' : '400') + ';color:#111;">';
                        html += '<span style="font-size:20px;">' + (d.flag || '') + '</span>';
                        html += '<span style="flex:1;">' + d.name + '</span>';
                        if (isActive) {
                            html += '<span style="color:#2563EB;font-size:11px;font-weight:600;">✓ Active</span>';
                        } else if (isLoaded) {
                            html += '<span style="color:#059669;font-size:11px;">Loaded</span>';
                        }
                        html += '</button>';
                    });
                });
            } else {
                // Flat list fallback
                manifestData.destinations.forEach(d => {
                    const isActive = d.key === activeDestination;
                    html += '<button onclick="document.getElementById(\'mobileDestPickerOverlay\').remove();fetchAndLoadDestination(\'' + d.key + '\')" style="display:flex;align-items:center;gap:10px;width:100%;padding:12px;border:none;background:' + (isActive ? '#eff6ff' : 'white') + ';border-radius:10px;font-size:14px;cursor:pointer;text-align:left;font-weight:' + (isActive ? '600' : '400') + ';color:#111;">';
                    html += '<span style="font-size:24px;">' + (d.flag || '') + '</span>';
                    html += '<span>' + d.name + '</span>';
                    if (isActive) html += '<span style="margin-left:auto;color:#2563EB;font-size:12px;">✓ Active</span>';
                    html += '</button>';
                });
            }

            html += '</div></div>';

            const div = document.createElement('div');
            div.innerHTML = html;
            document.body.appendChild(div.firstChild);
        }

        // ---- POI Detail Bottom Sheet ----
        function showMobilePOIDetail(poi, categoryLabel) {
            if (!isMobile()) return;

            const sheet = document.getElementById('mobilePoiSheet');
            const overlay = document.getElementById('mobilePoiOverlay');
            const content = document.getElementById('mobilePoiContent');
            if (!sheet || !content) return;

            // Build content (reuse existing popup HTML builder)
            let html = buildPoiPopupHtml(poi, categoryLabel);
            content.innerHTML = html;

            // Show sheet
            overlay.classList.add('active');
            sheet.classList.add('active');

            // Pan map to POI
            if (poi.coord && map) {
                map.panTo(poi.coord);
            }
        }

        function hideMobilePOIDetail() {
            const sheet = document.getElementById('mobilePoiSheet');
            const overlay = document.getElementById('mobilePoiOverlay');
            if (sheet) sheet.classList.remove('active');
            if (overlay) overlay.classList.remove('active');
        }

        // Swipe-to-dismiss for POI sheet
        function initPOISheetGestures() {
            const sheet = document.getElementById('mobilePoiSheet');
            const handle = sheet ? sheet.querySelector('.mobile-poi-drag-handle') : null;
            if (!handle) return;

            let startY = 0, startTransform = 0, dragging = false;

            handle.addEventListener('touchstart', (e) => {
                startY = e.touches[0].clientY;
                startTransform = 0;
                dragging = true;
                sheet.style.transition = 'none';
            }, { passive: true });

            handle.addEventListener('touchmove', (e) => {
                if (!dragging) return;
                const diff = e.touches[0].clientY - startY;
                if (diff > 0) { // Only allow downward drag
                    startTransform = diff;
                    sheet.style.transform = 'translateY(' + diff + 'px)';
                }
            }, { passive: true });

            handle.addEventListener('touchend', () => {
                dragging = false;
                sheet.style.transition = '';
                if (startTransform > 80) {
                    hideMobilePOIDetail();
                } else {
                    sheet.style.transform = '';
                    sheet.classList.add('active');
                }
            }, { passive: true });
        }

        // ---- Sheet Drag Gestures ----
        function initSheetDragGestures(handleId, panelId) {
            const handle = document.getElementById(handleId);
            const panel = document.getElementById(panelId);
            if (!handle || !panel) return;

            let startY = 0, startH = 0, dragging = false;

            handle.addEventListener('touchstart', (e) => {
                startY = e.touches[0].clientY;
                startH = panel.offsetHeight;
                dragging = true;
                panel.style.transition = 'none';
            }, { passive: true });

            handle.addEventListener('touchmove', (e) => {
                if (!dragging) return;
                const diff = startY - e.touches[0].clientY; // positive = drag up
                const newH = Math.max(100, Math.min(window.innerHeight - 100, startH + diff));
                panel.style.height = newH + 'px';
                // Remove preset height classes while dragging
                panel.classList.remove('sheet-half', 'sheet-expanded');
            }, { passive: true });

            handle.addEventListener('touchend', (e) => {
                if (!dragging) return;
                dragging = false;
                panel.style.transition = '';
                const currentH = panel.offsetHeight;
                const viewH = window.innerHeight - 44 - 56; // viewport minus dest bar and tab bar
                const halfH = window.innerHeight * 0.5;

                // Snap to nearest detent: dismiss (< 15%), half (~50%), expanded (~90%)
                if (currentH < viewH * 0.15) {
                    // Dismiss — snap back to map
                    panel.style.height = '';
                    hideAllMobileSheets();
                    mobileActiveTab = 'map';
                    document.querySelectorAll('.mobile-tab').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.tab === 'map');
                    });
                    const mapControls = document.getElementById('mobileMapControls');
                    if (mapControls) mapControls.style.display = '';
                } else if (currentH < viewH * 0.7) {
                    // Snap to half
                    panel.style.height = '';
                    panel.classList.add('sheet-half');
                    panel.classList.remove('sheet-expanded');
                    mobileSheetState = 'half';
                    const backdrop = document.getElementById('mobileSheetBackdrop');
                    if (backdrop) backdrop.classList.remove('visible');
                } else {
                    // Snap to expanded
                    panel.style.height = '';
                    panel.classList.add('sheet-expanded');
                    panel.classList.remove('sheet-half');
                    mobileSheetState = 'expanded';
                    const backdrop = document.getElementById('mobileSheetBackdrop');
                    if (backdrop) backdrop.classList.add('visible');
                }

                setTimeout(() => { if (map) map.invalidateSize(); }, 100);
            }, { passive: true });
        }

        // ---- Floating Category Toggles ----
        function toggleMobileCat(catKey, btn) {
            if (!categoryGroups[catKey]) return;
            btn.classList.toggle('active');
            if (btn.classList.contains('active')) {
                categoryGroups[catKey].addTo(map);
            } else {
                categoryGroups[catKey].removeFrom(map);
            }
            // Re-apply tag filters after category toggle
            if (activeTagFilters.size > 0) applyTagFiltersCategories();
        }

        function syncMobileCatChips() {
            // Sync chip active states with actual category visibility
            document.querySelectorAll('.mobile-cat-chip').forEach(chip => {
                const cat = chip.dataset.cat;
                if (cat && categoryGroups[cat]) {
                    chip.classList.toggle('active', map.hasLayer(categoryGroups[cat]));
                }
            });
        }

        // ---- Search Tab ----
        function onMobileSearch() {
            const input = document.getElementById('mobileSearchInput');
            const clearBtn = document.getElementById('mobileSearchClear');
            if (!input) return;

            const query = input.value.trim();
            if (clearBtn) clearBtn.style.display = query ? 'flex' : 'none';

            // Debounce
            if (mobileSearchDebounce) clearTimeout(mobileSearchDebounce);
            mobileSearchDebounce = setTimeout(() => renderMobileSearchResults(query), 200);
        }

        function clearMobileSearch() {
            const input = document.getElementById('mobileSearchInput');
            if (input) { input.value = ''; input.focus(); }
            document.getElementById('mobileSearchClear').style.display = 'none';
            renderMobileSearchResults('');
        }

        function setMobileSearchFilter(filter, btn) {
            mobileSearchFilter = filter;
            document.querySelectorAll('.mobile-search-chip').forEach(c => c.classList.remove('active'));
            if (btn) btn.classList.add('active');
            const query = (document.getElementById('mobileSearchInput') || {}).value || '';
            renderMobileSearchResults(query.trim());
        }

        function renderMobileSearchResults(query) {
            const container = document.getElementById('mobileSearchResults');
            if (!container) return;

            if (!activeDestination) {
                container.innerHTML = '<div class="mobile-search-empty">Select a destination first</div>';
                return;
            }

            // Gather all POIs
            const allPois = [
                ...hotels.map(p => ({...p, _cat: 'hotels', _catLabel: 'Hotel'})),
                ...restaurants.map(p => ({...p, _cat: 'restaurants', _catLabel: 'Restaurant'})),
                ...experiences.map(p => ({...p, _cat: 'experiences', _catLabel: 'Experience'})),
                ...kidFriendly.map(p => ({...p, _cat: 'kidFriendly', _catLabel: 'Kid-Friendly'})),
                ...markets.map(p => ({...p, _cat: 'markets', _catLabel: 'Market'}))
            ];

            // Filter by category
            let filtered = allPois;
            if (mobileSearchFilter !== 'all') {
                filtered = filtered.filter(p => p._cat === mobileSearchFilter);
            }

            // Filter by active tags (AND logic — POI must have ALL selected tags)
            if (activeTagFilters.size > 0) {
                filtered = filtered.filter(p => {
                    const poiTags = p.tags || [];
                    for (const reqTag of activeTagFilters) {
                        if (!poiTags.includes(reqTag)) return false;
                    }
                    return true;
                });
            }

            // Filter by query
            if (query) {
                const q = query.toLowerCase();
                filtered = filtered.filter(p =>
                    (p.name && p.name.toLowerCase().includes(q)) ||
                    (p.desc && p.desc.toLowerCase().includes(q)) ||
                    (p.longDesc && p.longDesc.toLowerCase().includes(q))
                );
            }

            // Sort: by rating (desc) then alphabetical
            filtered.sort((a, b) => {
                if (b.rating && a.rating) return b.rating - a.rating;
                if (b.rating) return 1;
                if (a.rating) return -1;
                return (a.name || '').localeCompare(b.name || '');
            });

            if (filtered.length === 0) {
                container.innerHTML = '<div class="mobile-search-empty">' + (query ? 'No results for "' + escapeHtml(query) + '"' : 'No places found') + '</div>';
                return;
            }

            // Show count
            let html = '<div style="font-size:11px;color:#9ca3af;padding:4px 0 8px 0;">' + filtered.length + ' places</div>';

            filtered.forEach(poi => {
                const ratingHtml = poi.rating ? '<span class="mobile-search-card-rating">★ ' + poi.rating.toFixed(1) + '</span>' : '';
                const priceHtml = poi.priceLevel ? '<span style="font-size:11px;color:#6b7280;">' + escapeHtml(poi.priceLevel) + '</span>' : '';

                html += '<div class="mobile-search-card" onclick="mobileSearchCardTap(\'' + escapeHtml(poi.name).replace(/'/g, "\\'") + '\',\'' + poi._cat + '\')">';
                html += '<div class="mobile-search-card-body">';
                html += '<div class="mobile-search-card-name">' + escapeHtml(poi.name) + '</div>';
                html += '<div class="mobile-search-card-desc">' + escapeHtml(poi.desc || poi.longDesc || '') + '</div>';
                html += '<div class="mobile-search-card-meta">';
                html += '<span class="mobile-search-card-badge cat-' + poi._cat + '">' + poi._catLabel + '</span>';
                html += ratingHtml + priceHtml;
                html += '</div></div></div>';
            });

            container.innerHTML = html;
        }

        function mobileSearchCardTap(poiName, catKey) {
            // Find the POI
            const arrays = { hotels, restaurants, experiences, kidFriendly, markets };
            const labels = { hotels: 'Hotel', restaurants: 'Restaurant', experiences: 'Experience', kidFriendly: 'Kid-Friendly', markets: 'Market' };
            const arr = arrays[catKey] || [];
            const poi = arr.find(p => p.name === poiName);
            if (!poi) return;

            // Switch to map tab and show POI detail
            switchMobileTab('map');

            // Small delay to let map render
            setTimeout(() => {
                showMobilePOIDetail(poi, labels[catKey] || catKey);
            }, 200);
        }

        // ---- Trips Tab ----
        function refreshMobileTripsUI() {
            if (!isMobile()) return;
            // Show mode selector by default when entering trips
            selectMobileItinMode('menu');
        }

        function buildMobileItinTabs() {
            const container = document.getElementById('mobileTripsTabsContainer');
            if (!container) return;

            let html = '';
            const itinColors = { a: '#2563EB', b: '#059669', c: '#D97706', d: '#DC2626', e: '#7C3AED' };
            const GEN_COLORS = ['#06b6d4', '#8b5cf6', '#ec4899', '#f97316', '#14b8a6', '#a855f7', '#f43f5e', '#eab308'];

            // Built-in itineraries
            Object.keys(itineraryData).forEach(key => {
                if (key.startsWith('gen_') || key.startsWith('shared_')) return;
                const itin = itineraryData[key];
                if (!itin) return;
                const name = itin.name || itin.title || ('Itinerary ' + key.toUpperCase());
                const color = itinColors[key] || itin.color || '#2563EB';
                const isActive = key === currentItinerary;
                html += '<button class="mobile-trips-tab' + (isActive ? ' active' : '') + '" style="' + (isActive ? 'background:' + color + ';border-color:' + color + ';' : 'border-color:' + color + ';color:' + color + ';') + '" onclick="selectMobileItinerary(\'' + key + '\')">' + escapeHtml(name) + '</button>';
            });

            // Generated itineraries (single-dest and multi-dest)
            let genIdx = 0;
            Object.keys(itineraryData).forEach(key => {
                if (!key.startsWith('gen_')) return;
                const itin = itineraryData[key];
                if (!itin) return;
                const isMulti = itin.isMultiDestination;
                const name = itin.name || itin.title || (isMulti ? 'Multi-Destination Trip' : 'Generated');
                const color = GEN_COLORS[genIdx % GEN_COLORS.length];
                genIdx++;
                const isActive = key === currentItinerary;
                const prefix = isMulti ? '🌍 ' : '✨ ';
                html += '<button class="mobile-trips-tab gen-tab' + (isActive ? ' active' : '') + '" style="' + (isActive ? 'background:' + color + ';border-color:' + color + ';' : 'border-color:' + color + ';color:' + color + ';') + '" onclick="selectMobileItinerary(\'' + key + '\')">' + prefix + escapeHtml(name) + '</button>';
            });

            container.innerHTML = html;
        }

        function selectMobileItinerary(key) {
            // Use the existing selectItinerary function which updates map markers too
            selectItinerary(key);
            // Then refresh our mobile UI
            buildMobileItinTabs();
            renderMobileItinContent();

            // Re-fit map bounds with sheet padding after a tick (so layout has settled)
            setTimeout(() => {
                if (map) map.invalidateSize();
                const allCoords = itineraryMarkers.map(m => m.coord);
                if (allCoords.length > 0) {
                    const bounds = L.latLngBounds(allCoords);
                    map.fitBounds(bounds.pad(0.1), getMobileMapPadding());
                }
            }, 100);
        }

        function renderMobileItinContent() {
            const container = document.getElementById('mobileDaysContainer');
            if (!container) return;

            if (!currentItinerary || !itineraryData[currentItinerary]) {
                container.innerHTML = '<div style="text-align:center;color:#9ca3af;padding:30px;">Select an itinerary above</div>';
                return;
            }

            const key = currentItinerary;
            const itin = itineraryData[key];
            if (!itin || !itin.days) return;

            const isMultiDest = itin.isMultiDestination;

            // Build day cards directly for mobile (with proper event handlers)
            container.innerHTML = '';
            let prevDayDest = null;

            itin.days.forEach(dayData => {
                // Insert destination segment header for multi-dest itineraries
                if (isMultiDest && dayData.destination && dayData.destination !== prevDayDest) {
                    prevDayDest = dayData.destination;
                    const destConfig = destinations[dayData.destination];
                    const destEntry = manifestData ? (manifestData.destinations || []).find(d => d.key === dayData.destination) : null;
                    const destFlag = destConfig ? destConfig.flag : (destEntry ? destEntry.flag : '');
                    const destName = destConfig ? destConfig.name : (destEntry ? destEntry.name : dayData.destination);

                    const segHeader = document.createElement('div');
                    segHeader.style.cssText = 'background:linear-gradient(135deg,#0d9488,#14b8a6);color:white;padding:10px 14px;border-radius:10px;margin:12px 0 6px;display:flex;align-items:center;gap:8px;font-weight:700;font-size:14px;';
                    segHeader.innerHTML = '<span style="font-size:20px;">' + destFlag + '</span><span>' + escapeHtml(destName) + '</span>';
                    container.appendChild(segHeader);
                }

                const dayCard = document.createElement('div');
                dayCard.className = 'day-card';

                const header = document.createElement('div');
                header.className = 'day-card-header';
                header.id = 'mobile-day-header-' + key + '-' + dayData.day;
                header.innerHTML = '<span>Day ' + dayData.day + ' — ' + escapeHtml(dayData.title) + '</span><span class="day-card-toggle">▼</span>';

                // Tap to expand/collapse
                header.onclick = function() {
                    const content = header.nextElementSibling;
                    content.classList.toggle('open');
                    header.classList.toggle('active');
                    const toggle = header.querySelector('.day-card-toggle');
                    if (toggle) toggle.classList.toggle('open');

                    if (content.classList.contains('open')) {
                        showDay(key, dayData.day);
                    }
                };

                const content = document.createElement('div');
                content.className = 'day-card-content';

                dayData.items.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'day-item ' + (item.type || '');
                    if (item.coord) {
                        itemEl.classList.add('has-coord');
                        itemEl.onclick = function(e) {
                            e.stopPropagation();
                            panToMarker(item.coord[0], item.coord[1], item.name);
                        };
                    }
                    itemEl.innerHTML = '<span class="day-item-type">' + formatType(item.type) + '</span><span class="day-item-name">' + escapeHtml(item.name) + '</span>';
                    content.appendChild(itemEl);
                });

                dayCard.appendChild(header);
                dayCard.appendChild(content);
                container.appendChild(dayCard);
            });
        }

        // ---- Trips Sub-Views (Notes/Bookings) ----
        function showMobileTripsSubView(type) {
            const itinView = document.getElementById('mobileTripsItinView');
            const subView = document.getElementById('mobileTripsSubView');
            const subContent = document.getElementById('mobileTripsSubContent');
            if (!itinView || !subView || !subContent) return;

            itinView.style.display = 'none';
            subView.style.display = 'block';

            if (type === 'notes') {
                // Build notes content (simplified from showNotesPanel)
                let html = '<div style="font-size:16px;font-weight:700;margin-bottom:12px;">📝 Notes</div>';
                const allNotes = getAllNotes ? getAllNotes(activeDestination) : {};
                const noteKeys = Object.keys(allNotes);

                if (noteKeys.length === 0) {
                    html += '<div style="color:#9ca3af;text-align:center;padding:20px;">No notes yet. Add notes from POI popups on the map.</div>';
                } else {
                    noteKeys.forEach(key => {
                        html += '<div style="background:white;border-radius:10px;padding:12px;margin-bottom:8px;box-shadow:0 1px 3px rgba(0,0,0,0.06);">';
                        html += '<div style="font-size:13px;font-weight:600;color:#111;">' + escapeHtml(key) + '</div>';
                        html += '<div style="font-size:12px;color:#6b7280;margin-top:4px;white-space:pre-wrap;">' + escapeHtml(allNotes[key]) + '</div>';
                        html += '</div>';
                    });
                }
                subContent.innerHTML = html;

            } else if (type === 'bookings') {
                let html = '<div style="font-size:16px;font-weight:700;margin-bottom:12px;">🔖 Bookings</div>';
                const allAnns = getAllAnnotations ? getAllAnnotations(activeDestination) : [];

                if (allAnns.length === 0) {
                    html += '<div style="color:#9ca3af;text-align:center;padding:20px;">No bookings yet. Add bookings from POI popups on the map.</div>';
                } else {
                    const today = new Date().toISOString().split('T')[0];
                    const upcoming = allAnns.filter(a => !a.date || a.date >= today);
                    const past = allAnns.filter(a => a.date && a.date < today);

                    if (upcoming.length > 0) {
                        html += '<div style="font-size:12px;font-weight:600;color:#2563EB;margin:12px 0 6px 0;">UPCOMING</div>';
                        upcoming.forEach(ann => {
                            html += buildMobileBookingCard(ann);
                        });
                    }
                    if (past.length > 0) {
                        html += '<div style="font-size:12px;font-weight:600;color:#9ca3af;margin:12px 0 6px 0;">PAST</div>';
                        past.forEach(ann => {
                            html += buildMobileBookingCard(ann);
                        });
                    }
                }
                subContent.innerHTML = html;
            }
        }

        function buildMobileBookingCard(ann) {
            const typeIcons = { reservation: '🍽', booking: '🏨', flight: '✈️', activity: '🎭', transit: '🚂', note: '📝' };
            const icon = typeIcons[ann.type] || '📌';
            let html = '<div style="background:white;border-radius:10px;padding:12px;margin-bottom:8px;box-shadow:0 1px 3px rgba(0,0,0,0.06);">';
            html += '<div style="display:flex;align-items:center;gap:8px;">';
            html += '<span style="font-size:18px;">' + icon + '</span>';
            html += '<div style="flex:1;min-width:0;">';
            html += '<div style="font-size:13px;font-weight:600;color:#111;">' + escapeHtml(ann.poiName || '') + '</div>';
            if (ann.date) html += '<div style="font-size:11px;color:#6b7280;">' + ann.date + (ann.endDate ? ' → ' + ann.endDate : '') + '</div>';
            html += '</div>';
            if (ann.status) {
                const statusColors = { confirmed: '#059669', pending: '#d97706', cancelled: '#dc2626' };
                html += '<span style="font-size:10px;font-weight:600;padding:2px 6px;border-radius:4px;background:' + (statusColors[ann.status] || '#6b7280') + '20;color:' + (statusColors[ann.status] || '#6b7280') + ';">' + ann.status + '</span>';
            }
            html += '</div>';
            if (ann.details) html += '<div style="font-size:12px;color:#6b7280;margin-top:6px;">' + escapeHtml(ann.details) + '</div>';
            html += '</div>';
            return html;
        }

        function hideMobileTripsSubView() {
            const itinView = document.getElementById('mobileTripsItinView');
            const subView = document.getElementById('mobileTripsSubView');
            if (itinView) itinView.style.display = 'block';
            if (subView) subView.style.display = 'none';
        }

        // ---- Mobile Chat ----
        function initMobileChat() {
            // Mirror the desktop chat setup
            loadApiKey();
            const setupEl = document.getElementById('mobileChatSetup');
            const messagesEl = document.getElementById('mobileChatMessages');
            const inputArea = document.getElementById('mobileChatInputArea');
            const settingsEl = document.getElementById('mobileChatSettings');

            if (chatApiKey) {
                if (setupEl) setupEl.style.display = 'none';
                if (messagesEl) messagesEl.style.display = 'block';
                if (inputArea) inputArea.style.display = 'flex';
                if (settingsEl) settingsEl.style.display = 'flex';

                // Sync messages from desktop chat
                syncChatMessages();
            } else {
                if (setupEl) setupEl.style.display = 'block';
                if (messagesEl) messagesEl.style.display = 'none';
                if (inputArea) inputArea.style.display = 'none';
                if (settingsEl) settingsEl.style.display = 'none';
            }
        }

        function syncChatMessages() {
            const desktopMessages = document.getElementById('chatMessages');
            const mobileMessages = document.getElementById('mobileChatMessages');
            if (desktopMessages && mobileMessages) {
                mobileMessages.innerHTML = desktopMessages.innerHTML;
                mobileMessages.scrollTop = mobileMessages.scrollHeight;
            }
        }

        function saveMobileApiKey() {
            const input = document.getElementById('mobileApiKeyInput');
            if (!input || !input.value.trim()) return;
            chatApiKey = input.value.trim();
            try { localStorage.setItem('japanTrip_apiKey', chatApiKey); } catch(e) {}
            try { localStorage.setItem('tripMap_apiKey', chatApiKey); } catch(e) {}
            initMobileChat();
        }

        function mobileChatKeyHandler(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMobileChatMessage();
            }
        }

        function sendMobileChatMessage() {
            const input = document.getElementById('mobileChatInput');
            if (!input || !input.value.trim()) return;

            // Set the desktop chat input and trigger send
            const desktopInput = document.getElementById('chatInput');
            if (desktopInput) {
                desktopInput.value = input.value;
            }
            input.value = '';

            // Call the existing send function
            sendChatMessage();

            // Sync messages after a delay
            setTimeout(syncChatMessages, 500);
            setTimeout(syncChatMessages, 2000);
            setTimeout(syncChatMessages, 5000);
        }

        // ---- Hook into existing functions ----

        // Override loadDestination's UI updates to also update mobile
        const _origLoadDest = typeof loadDestination === 'function' ? null : null; // Will be patched in init

        function updateMobileAfterDestLoad() {
            if (!isMobile()) return;
            updateMobileDestBar();
            syncMobileCatChips();
            if (mobileActiveTab === 'trips') {
                refreshMobileTripsUI();
            }
            if (mobileActiveTab === 'search') {
                renderMobileSearchResults((document.getElementById('mobileSearchInput') || {}).value || '');
            }
        }

        // ---- Navigate from itinerary item to map ----
        function mobileItinItemTap(poiName) {
            if (!isMobile()) return;
            // Find the POI across all categories
            const categories = { hotels: 'Hotel', restaurants: 'Restaurant', experiences: 'Experience', kidFriendly: 'Kid-Friendly', markets: 'Market' };
            let foundPoi = null, foundLabel = '';
            for (const [catKey, label] of Object.entries(categories)) {
                const arr = window[catKey] || [];
                const poi = arr.find(p => p.name === poiName);
                if (poi) { foundPoi = poi; foundLabel = label; break; }
            }

            // Also check itinerary items directly for coord
            if (!foundPoi && currentItinerary && itineraryData[currentItinerary]) {
                const itin = itineraryData[currentItinerary];
                for (const day of (itin.days || [])) {
                    for (const item of (day.items || [])) {
                        if (item.name === poiName && item.coord) {
                            // Enrich itinerary item with full POI data from lookup
                            const poiInfo = lookupPoi(item.name);
                            foundPoi = { name: item.name, coord: item.coord, desc: poiInfo.desc, longDesc: poiInfo.longDesc, gmapsUrl: poiInfo.gmapsUrl, rating: poiInfo.rating, ratingCount: poiInfo.ratingCount, priceLevel: poiInfo.priceLevel, website: poiInfo.website, hours: poiInfo.hours, photoRef: poiInfo.photoRef, photoAttribution: poiInfo.photoAttribution, tags: poiInfo.tags };
                            foundLabel = formatType(item.type) || 'Place';
                            break;
                        }
                    }
                    if (foundPoi) break;
                }
            }

            if (!foundPoi || !foundPoi.coord) return;

            // Switch to map tab
            hideAllMobileSheets();
            mobileActiveTab = 'map';
            document.querySelectorAll('.mobile-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === 'map');
            });
            const mapControls = document.getElementById('mobileMapControls');
            if (mapControls) mapControls.style.display = '';

            // Fly to POI and show detail sheet
            setTimeout(() => {
                if (map) {
                    map.invalidateSize();
                    map.flyTo(foundPoi.coord, 16, { duration: 0.5 });
                }
                setTimeout(() => {
                    showMobilePOIDetail(foundPoi, foundLabel);
                }, 300);
            }, 100);
        }

        // ---- Initialize Mobile UI ----
        function initMobileUI() {
            if (!isMobile()) return;

            // Show mobile-only elements
            const destBar = document.getElementById('mobileDestBar');
            const tabBar = document.getElementById('mobileTabBar');
            if (destBar) destBar.style.display = '';
            if (tabBar) tabBar.style.display = '';

            // Start on map tab
            switchMobileTab('map');

            // Initialize POI sheet gestures
            initPOISheetGestures();

            // Initialize sheet panel drag gestures
            initSheetDragGestures('tripsDragHandle', 'mobileTripsPanel');
            initSheetDragGestures('searchDragHandle', 'mobileSearchPanel');

            // Update dest bar
            updateMobileDestBar();
        }

        // ============================================
        // INITIALIZATION
        // ============================================

        document.addEventListener('DOMContentLoaded', async function() {
            await loadConfig();
            initMap();
            loadManifest();

            // Initialize mobile UI if on mobile
            if (window.innerWidth <= 768) {
                initMobileUI();
            }

            // Register service worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').then(reg => {
                    reg.addEventListener('updatefound', () => {
                        const newWorker = reg.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'activated' && navigator.serviceWorker.controller) {
                                showCopyToast('New version available — refresh to update');
                            }
                        });
                    });
                }).catch(err => console.log('SW registration failed:', err));
            }
        });
    </script>
</body>
</html>
